# 築未科技 — 影像到報表端到端流程

**目的**：從影像輸入到最終報告自動歸檔的完整鏈條說明。

---

## 流程總覽

| 步驟 | 名稱 | 負責組件 | 說明 |
|------|------|----------|------|
| 1 | **影像輸入** | WebSocket → brain_server | 透過 WebSocket 傳送至 brain_server（Port 8000） |
| 2 | **視覺辨識** | 地端 YOLOv8 + RTX 4060 Ti | 地端 YOLOv8 利用 RTX 4060 Ti 快速產出基礎數據 |
| 3 | **邏輯編排** | Gemini Pro | 解構這些數據，並產出初步報告 |
| 4 | **代碼／深度修復** | Claude 3.5 + Cursor Pro / Windsurf | 若需修改 Python 腳本，Claude 3.5 在 D 槽進行實體重構，隨後以 Cursor Pro / Windsurf 微調 |
| 5 | **異構檢核** | 元寶 (Tencent) / 千問 (Alibaba) | 針對中文工程術語進行第二次確認，確保無誤 |
| 6 | **自動化存檔** | report_generator + Z 槽 | 最終報告以 LaTeX 格式（如：完成度 $95\%$）自動歸檔至 Z 槽 |

---

## 1. 影像輸入（WebSocket → brain_server）

- **入口**：`ws://<IP>:8000/ws`，送 `{"text":"幫我分析 input/xxx.jpg 並產出 LPC 標記報表"}` 或 `{"message":"..."}`。
- **brain_server.py**：接收後交給 `AgentManager.run(user_request, send_to_client)`，即時回傳 step / info / result / error。

---

## 2. 視覺辨識（地端 YOLOv8 + RTX 4060 Ti）

- **執行**：`agent_tools.run_vision_engine(image_path)` → subprocess 呼叫 **D:\brain_workspace\venv_vision**（Python 3.12）執行 **vision_worker.py**，`cwd=BRAIN_WORKSPACE`。
- **vision_worker.py**：載入 `D:\brain_workspace\models\best.pt`（或 yolov8n.pt），`device="0"`（CUDA），產出 JSON（detected、detected_classes、progress、device）至 stdout。
- **產出**：基礎數據（偵測物件、信心度、bbox、進度）回傳給 ReAct 循環。

---

## 3. 邏輯編排（Gemini Pro）

- **引擎**：視覺任務強制 **Gemini**（agent_logic 引擎分流）。
- **職責**：解構視覺數據、決定是否呼叫 `generate_progress_report(detected)`、產出初步報告文案；ReAct 循環中由 Gemini 決策與組裝。

---

## 4. 代碼／深度修復（Claude 3.5 + Cursor Pro / Windsurf）

- **Claude 3.5**：若需修改 Python 腳本，可在 agent_logic 注入 `claude_service`，由 Claude 在 **D 槽**進行實體重構（經 TOOLS 寫入 D:\ 或 Z:\）。
- **Cursor Pro / Windsurf**：產出落地 **D:\brain_workspace** 後，以 **Composer** 對這些檔案下達「根據階段 6 的修正建議進行重構」等微調指令。

---

## 5. 異構檢核（元寶 / 千問）

- **階段 7**：`AgentManager._cross_validate_results(raw_vision_data)` — 將地端辨識結果送 Gemini 深度分析，再送第二意見（Claude／元寶／千問）檢核。
- **元寶 (Tencent)** 或 **千問 (Alibaba)**：針對中文工程術語進行第二次確認；與主線一致則通過，有分歧則標註「待確認」並回傳 Gemini Pro 裁決。
- **對應**：ai_service 預留 TencentService、AliyunService；可接線後在階段 7 使用。

---

## 6. 自動化存檔（LaTeX 格式 → Z 槽）

- **報表**：`report_generator.generate_progress_report(vision_results)` 寫入 **Z:/Zhewei_Brain/Reports/**（Daily_Log_YYYYMMDD.jsonl、Weekly_Progress_Summary.csv）。
- **格式**：進度以 **LaTeX** 呈現，例如：完成度 **$95\%$**、**$100\%$**；report_entry 含「進度」欄位為 `_latex_percent(progress)`。
- **語音報表**：`generate_voice_report` 寫入 Daily_Voice_Logs.md，prompt 要求進度以 $X\%$ 表示。

---

## 與系統彙整對照

| 步驟 | 對應檔案／組件 |
|------|----------------|
| 1 | brain_server.py、WebSocket /ws |
| 2 | agent_tools.run_vision_engine、vision_worker.py、venv_vision |
| 3 | agent_logic 引擎分流、Gemini、ReAct |
| 4 | agent_tools 寫入 D 槽、Cursor / Windsurf 索引 D:\brain_workspace |
| 5 | agent_logic._cross_validate_results、_is_logical_gap、ai_service 預留元寶/千問 |
| 6 | report_generator、agent_tools.generate_progress_report、Z 槽 Reports |

---

*實際實作請遵守架構守則與全系統架構鎖定規則（D/Z 分流、報表路徑、LaTeX 進度）。*
