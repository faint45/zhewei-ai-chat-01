# 築未科技大腦 — 外部接入說明

供您的**設備、軟件、網頁**接入大腦做運算，預留擴充介面。

**若要把大腦 API 上架到網路**（讓手機／遠端電腦透過網址連線），請見 **[上架到網路說明.md](上架到網路說明.md)**（Render／Railway／自建等方式，不需從零建站）。  
**產品架構與商用訂閱**（一套 AI 模組、軟件/APP 接入、訂閱制），請見 **[築未科技大腦_產品架構與商用訂閱.md](築未科技大腦_產品架構與商用訂閱.md)**。

---

## 前置條件

1. 啟動 Brain Bridge API：`run-local-robot-full.bat` 或執行
   ```bash
   gunicorn -c gunicorn.conf.py brain_bridge_fastapi:app
   ```
2. 預設 port：**5100**（可設 `BRAIN_BRIDGE_PORT`）
3. 認證方式（擇一）：
   - **API Key**：在 `.env` 設定 `BRAIN_BRIDGE_API_KEY`，請求帶 `X-API-Key`
   - **帳號/密碼**：在 `.env` 設定 `AUTH_USERS=user1:pass1,user2:pass2`，網頁使用 `/login` 登入取得 Session

---

## API 端點

| 端點 | 方法 | 說明 |
|------|------|------|
| `/health` | GET | 健康檢查 |
| `/compute` | POST | **統一運算介面**（設備/軟件/網頁） |
| `/chat` | POST | 對話 |
| `/agent` | POST | Agent 執行 |
| `/weather` | GET | 天氣 |
| `/time` | GET | 時間 |
| `/integrations/info` | GET | 接入資訊 |
| `/integrations/query` | POST | 知識庫查詢 |

---

## 1. 統一運算介面 `/compute`

**適用**：設備、軟件、網頁

```http
POST http://127.0.0.1:5100/compute
Content-Type: application/json
X-API-Key: your-api-key   # 若已設定

{
  "message": "台北天氣",
  "user_id": "my-device-001",
  "source": "device",      # device | software | web
  "device_id": "sensor-01" # 可選
}
```

**回應：**
```json
{
  "reply": "[即時天氣] 溫度 25°C...",
  "type": "brain",
  "source": "device"
}
```

---

## 2. 網頁 JavaScript 範例

```javascript
const BRAIN_URL = 'http://127.0.0.1:5100';

async function askBrain(message, userId = 'web') {
  const res = await fetch(`${BRAIN_URL}/compute`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      message,
      user_id: userId,
      source: 'web'
    })
  });
  const data = await res.json();
  return data.reply;
}

// 使用
askBrain('現在幾點').then(console.log);
```

---

## 3. 軟件（Python）範例

```python
import requests

BRAIN_URL = "http://127.0.0.1:5100"

def ask_brain(message: str, user_id: str = "software"):
    r = requests.post(
        f"{BRAIN_URL}/compute",
        json={"message": message, "user_id": user_id, "source": "software"},
        timeout=30,
    )
    return r.json()["reply"]

# 使用
print(ask_brain("台北天氣"))
```

---

## 4. 設備（IoT / 硬體）範例

```c
// 偽代碼：設備端 HTTP POST
POST /compute
{
  "message": "檢查系統狀態",
  "device_id": "sensor-floor1",
  "source": "device"
}
```

或使用 MQTT / WebSocket 轉發至本地 API（需自行架設轉接層）。

---

## 5. 知識庫查詢

```http
POST http://127.0.0.1:5100/integrations/query
Content-Type: application/json

{
  "query": "ollama 安裝",
  "limit": 5
}
```

**回應：**
```json
{
  "query": "ollama 安裝",
  "results": ["相關知識片段..."]
}
```

---

## 6. 接入資訊

```http
GET http://127.0.0.1:5100/integrations/info
```

回傳端點列表、版本、支援來源（device / software / web）。

---

## 網頁登入頁面

- **登入**：`http://127.0.0.1:5100/login`
- **運算 Demo**（需先登入）：`http://127.0.0.1:5100/demo`

設定 `AUTH_USERS=帳號:密碼` 後，遠端電腦或手機開啟上述網址即可登入使用。

## 安全建議

- 僅在內網使用時可不設 API Key
- 對外暴露時請設定 `BRAIN_BRIDGE_API_KEY` 或 `AUTH_USERS`（帳號密碼）
- 可透過 `BRAIN_BRIDGE_RATE_LIMIT` 限制每分鐘請求數
