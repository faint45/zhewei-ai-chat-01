# 築未科技 — 系統運作方式彙整

**彙整日期**：2026-02-08  
**目的**：單一文件說明全系統架構、資料流、組件分工與操作方式。

---

## 一、架構總覽

### 1.1 核心結構（禁止修改）

| 項目 | 說明 |
|------|------|
| **D 槽** | `D:\brain_workspace` — 主腦與視覺根目錄；熱資料（input、processed、models、venv） |
| **Z 槽** | `Z:\Zhewei_Brain` — 雲端報表與長期記憶（Google Drive / Rclone 掛載） |
| **主腦環境** | Python 3.14 或專案預設 — 執行 brain_server、agent_logic、ai_service、agent_tools |
| **視覺環境** | Python 3.12、`D:\brain_workspace\venv_vision` — YOLOv8、ultralytics、torch |

### 1.2 儲存分流（熱／溫／冷）

| 類型 | 位置 | 內容 |
|------|------|------|
| **熱資料** | D 槽 808GB | `input/`、`processed/`、`models/`、`venv` |
| **溫資料** | 外接 5.1TB | 原始影片 `raw_footage/` |
| **冷資料** | Z 槽 4.1TB | `Reports/`、長期記憶（Rules、Experience、Construction_Logs） |

### 1.3 雲地分流與多模型確認

- **雲地分流（成本優化）**：地端 Ollama / Qwen 2.5 負責初稿閱讀、簡單格式轉換、基礎代碼檢索（RTX 4060 Ti，免費且保護隱私）；雲端 Claude / Gemini 僅在高難度邏輯推理、長文本合約分析、複雜影像辨識時啟動。
- **實體開發同步**：agent_logic 經 TOOLS 產出的檔案落地 **D:\brain_workspace**；Cursor Pro / Windsurf 可索引這些 Draft，並以 Composer 對產出下達「根據階段 6 修正建議重構」等指令。
- **多模型交叉確認（Step 7）**：正式報表前可將結果同時送元寶（騰訊）或千問（阿里）檢核；與主線一致則判定 $100\%$ 正確並觸發存檔，有分歧則標註「待確認」並回傳 Gemini Pro 裁決。進度以 LaTeX 格式（如 $100\%$）呈現。

詳見 **[雲地分流與多模型確認.md](雲地分流與多模型確認.md)**。

### 1.4 影像到報表端到端流程（六步）

| 步驟 | 名稱 | 負責 |
|------|------|------|
| 1 | **影像輸入** | WebSocket 傳送至 brain_server |
| 2 | **視覺辨識** | 地端 YOLOv8（RTX 4060 Ti）產出基礎數據 |
| 3 | **邏輯編排** | Gemini Pro 解構數據並產出初步報告 |
| 4 | **代碼／深度修復** | Claude 3.5 在 D 槽實體重構，Cursor Pro / Windsurf 微調 |
| 5 | **異構檢核** | 元寶 (Tencent) 或 千問 (Alibaba) 對中文工程術語二次確認 |
| 6 | **自動化存檔** | 最終報告以 LaTeX（如 完成度 $95\%$）歸檔至 Z 槽 |

詳見 **[影像到報表端到端流程.md](影像到報表端到端流程.md)**。

### 1.5 需求到完成八階段流程

| 階段 | 名稱 | 負責 |
|------|------|------|
| 1 | **需求** | 網頁管理員 接收指令 |
| 2 | **整合理解** | 管理員 (Gemini) 從 Z 槽提取記憶，理解任務複雜度 |
| 3 | **安排** | 大腦 (Manager) 產出計畫；影像調度 Grok，程式調度 Claude |
| 4 | **執行** | 編碼 Claude + Windsurf D:/brain_workspace；媒體 Jimeng 3D/影片；本地 Ollama D 槽資料清洗 |
| 5 | **確認 (I)** | 本地代理人 (Ollama) 基礎合規檢核 |
| 6 | **回饋修正** | Claude 3.5 精準修復，Cursor Pro 最終代碼調校 |
| 7 | **確認 (II)** | 管理員 (Gemini) 多模型交叉驗證，邏輯 $100\%$ 正確 |
| 8 | **完成與佈署** | 觸發佈署、LaTeX 報表至 Z 槽、更新網頁後台 |

詳見 **[需求到完成八階段流程.md](需求到完成八階段流程.md)**。

---

## 二、核心組件與職責

### 2.1 對外入口：brain_server.py（Port 8000）

- **FastAPI**：`/` 靜態頁、`/health` 健康檢查、`/static` 靜態檔（管理介面）、`/ws` WebSocket 對話中樞。
- **靜態**：`/static` 掛載 `D:\brain_workspace\static`；本機開發時若專案內 `brain_workspace/static` 存在則優先使用。
- **網頁管理介面**：`http://<IP>:8000/static/index.html` — Vue 3 整合影像生成、佈署與各代理人狀態視覺化；即時日誌與進度（LaTeX 如 $95\%$）。
- **WebSocket**：接收 `{"text":"指令"}` 或 `{"message":"指令"}`，交給 `AgentManager.run()`，即時回傳 `type`（info / step / result / error）。
- **依賴**：ai_service（Gemini + Ollama）、agent_logic（AgentManager）、agent_tools（TOOLS）。

### 2.2 決策與執行：agent_logic.py（AgentManager）

- **任務分類**：`_classify_task()` — 含「分析」「jpg」「辨識」「影片」等關鍵字 → **vision**，否則 **conversation**。
- **引擎分流**：
  - **vision** → 強制 **Gemini**（雲端）；
  - **conversation** → 第一輪複雜關鍵字（架構、設計、優化、debug、修復）或 Observation 有嚴重錯誤 → Gemini，否則 **Ollama**（本地）。
- **ReAct 循環**：長期記憶（Z 槽 master_rules.md）→ AI 決策（JSON：tool + args 或 done）→ 執行 TOOLS → Observation 餵回 → 直至 done。
- **成功後**：`_learn_from_success()` 寫入 Z 槽經驗；複雜任務另呼叫 `_evolve_knowledge()` 寫入核心守則。

### 2.3 AI 引擎：ai_service.py

- **GeminiService**：Google Gemini（.env 之 GEMINI_API_KEY），用於視覺任務與複雜/錯誤修復。
- **OllamaService**：本地 Ollama（預設 qwen2.5-coder:7b），用於一般指令與檔案操作。
- **介面**：`chat(messages)` → 回傳字串；ReAct 歷史會轉成各引擎所需格式。

### 2.4 工具層：agent_tools.py

- **TOOLS 字典**（嚴禁僅改片段，須完整覆蓋）：  
  `run_command`、`read_file`、`write_file`、`list_dir`、  
  `vision_analyze`、`run_vision_engine`、`manage_construction_log`、  
  `generate_progress_report`、`generate_media`、`deploy_service`、`update_web_admin`。  
  `generate_voice_report` 為非同步，在 agent_logic 內單獨呼叫。
- **路徑限制**：讀寫僅允許 D:\ 或 Z:\ 下（`_path_allowed`）。
- **run_vision_engine（213–234 行，禁止修改）**：  
  以 `D:\brain_workspace\venv_vision` 之 Python 執行 `vision_worker.py`，`cwd=BRAIN_WORKSPACE`，傳入影像路徑，回傳 JSON（含 detected）。
- **generate_voice_report**：工地語音逐字稿 → Gemini 產出 Markdown 表格 → 寫入 `Z:/Zhewei_Brain/Reports/Daily_Voice_Logs.md`。

### 2.5 報表分流：report_generator.py（禁止更動分流路徑）

| 類型 | 產出格式 | 寫入路徑 |
|------|----------|----------|
| **影像報表** | JSONL + CSV | `Z:/Zhewei_Brain/Reports/Daily_Log_YYYYMMDD.jsonl`、`Weekly_Progress_Summary.csv` |
| **語音報表** | Markdown 表格 | `Z:/Zhewei_Brain/Reports/Daily_Voice_Logs.md`（由 agent_tools.generate_voice_report 寫入） |

- 進度數值須以 **LaTeX 格式**（如 `$85\%$`）呈現。

### 2.6 視覺與監控：brain_workspace

| 檔案 | 職責 |
|------|------|
| **vision_worker.py** | 以 YOLOv8 辨識工地影像，回傳 JSON（detected 等），由 run_vision_engine 呼叫 |
| **report_tools.py** | 報表工具，與 report_generator 協同 |
| **site_monitor.py** | 工地主動監控中樞 |
| **start_all.ps1** | D 槽全系統啟動：檢查 Z 槽 → 啟動 brain_server → 啟動 site_monitor → 檢查 venv_vision/CUDA |

---

## 三、請求流程（端到端）

1. **用戶**：透過 WebSocket 送 `{"text":"幫我分析 input/test.jpg 並產出 LPC 標記報表"}` 至 `ws://<IP>:8000/ws`。
2. **brain_server**：接收後呼叫 `AgentManager.run(user_request, send_to_client)`。
3. **AgentManager**：  
   - 檢查 Z 槽；載入長期記憶；  
   - `_classify_task` → **vision**；  
   - 附加視覺提示（優先 run_vision_engine，完成後 generate_progress_report）；  
   - 選擇 **Gemini**；進入 ReAct。
4. **ReAct 一輪**：AI 輸出 JSON `{"tool":"run_vision_engine","args":{"image_path":"..."}}` → 執行 `run_vision_engine` → subprocess 呼叫 D:\brain_workspace 下 3.12 venv_vision 的 vision_worker.py → 回傳 detected。
5. **ReAct 下一輪**：AI 輸出 `generate_progress_report(detected)` → report_generator 寫入 Z 槽 Reports（JSONL + CSV）。
6. **ReAct 結束**：AI 輸出 `{"done":true,"result":"..."}` → 回傳客戶端；可觸發 `_learn_from_success` 寫入 Z 槽經驗。

---

## 四、啟動與佈署

| 方式 | 指令／步驟 | 說明 |
|------|------------|------|
| **一鍵啟動** | 執行 `啟動_築未科技大腦_2.1版.bat` | 診斷 → 守護 guardian_master → brain_server (8000) → site_monitor |
| **僅大腦** | `python brain_server.py`（專案根目錄） | 僅 WebSocket 服務 |
| **D 槽全系統** | `cd D:\brain_workspace` → `.\start_all.ps1` | 需已複製 brain_workspace 至 D 槽、venv_vision 已建 |
| **Windows 服務** | 以管理員執行 `安装築未大腦服務.bat` | 需 NSSM 於 `C:\tools\nssm\`，服務名 ZheweiBrain |
| **Docker** | `docker build -t zhewei-brain .` → `docker run -p 8000:8000 --env-file .env zhewei-brain` | 映像執行 brain_server.py |

詳見 ** [佈署指南.md](佈署指南.md)**。

---

## 五、下達指令方式

| 對象 | 方式 |
|------|------|
| **築未大腦** | WebSocket `ws://<IP>:8000/ws`，送 `{"text":"指令"}` 或 `{"message":"指令"}`；健康檢查 `GET http://<IP>:8000/health` |
| **Cursor / Skills** | 對話中用關鍵字觸發技能（如「資料庫」「整理點雲」「先寫計畫」），見 ** [低Token聰明工作流.md](低Token聰明工作流.md)** |
| **服務** | 啟動：`啟動_築未科技大腦_2.1版.bat` 或 `python brain_server.py`；服務：`nssm start/stop ZheweiBrain` |

詳見 ** [如何下達指令.md](如何下達指令.md)**。

---

## 六、鎖定與禁止修改項

- **agent_tools.py 第 213–234 行**：`run_vision_engine` 跨環境呼叫邏輯，禁止修改。  
- **report_generator.py**：影像報表（CSV/JSONL）與語音報表（Markdown）之分流路徑，禁止更動。  
- **D/Z 分流**：嚴禁變動 `D:\brain_workspace` 與 `Z:\Zhewei_Brain` 之架構角色。  
- **主腦 / 視覺環境隔離**：3.14（主腦）與 3.12（視覺）邏輯禁止修改。  
- **代碼產出**：須「完整覆蓋」檔案，嚴禁僅提供修改區段。

---

## 七、相關文件索引

| 文件 | 用途 |
|------|------|
| **架構守則.mdc** | D/Z 分流、完整產出、LaTeX、TOOLS 定義（alwaysApply） |
| **全系統架構鎖定規則.md** | 保護行號、儲存架構、代碼規範 |
| **雲地分流與多模型確認.md** | 雲地分流（成本優化）、實體開發同步（Cursor/Windsurf）、Step 7 多模型交叉確認 |
| **影像到報表端到端流程.md** | 影像輸入→視覺辨識→邏輯編排→代碼修復→異構檢核→自動化存檔（六步） |
| **需求到完成八階段流程.md** | 需求→整合理解→安排→執行→確認 I→回饋修正→確認 II→完成與佈署（八階段） |
| **brain_workspace/DEPLOY.md** | D 槽路徑對齊、venv_vision、start_all 步驟 |
| **佈署指南.md** | 五種佈署方式與前置條件 |
| **如何下達指令.md** | 對大腦／Cursor／服務下達指令 |
| **低Token聰明工作流.md** | Skills 關鍵字、一則一意圖、@ 取代貼文 |
| **全系統功能測試報告_2026-02-05.md** | 環境檢查、模擬請求、驗證鏈條與行號對照 |
| **系統完整度彙整與優化建議_2026-02-08.md** | 完整度總覽、測試與修復、優化建議 |
| **通用執行引擎架構表.md** | 階段引擎組件與 Draft/Fix/Done 路徑約定 |

---

*本彙整供團隊與 AI 快速掌握系統運作；實際實作須遵守架構守則與全系統架構鎖定規則。*
