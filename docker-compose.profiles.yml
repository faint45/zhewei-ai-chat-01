# 築未科技 — 雙模式部署（資源收斂）
# 日常模式：docker compose -f docker-compose.profiles.yml --profile daily up -d
# 開發模式：docker compose -f docker-compose.profiles.yml --profile daily --profile dev up -d

services:
  brain_server:
    build: .
    container_name: zhewei_brain
    profiles: ["daily", "dev"]
    environment:
      BRAIN_WORKSPACE: /app/brain_workspace
      ZHEWEI_MEMORY_ROOT: /memory
      BRAIN_WS_PORT: "8000"
      PORT: "8000"
      PIPER_MODEL_PATH: /app/zhewei_memory/models/piper/zh_CN-huayan-medium.onnx
      OLLAMA_BASE_URL: http://host.docker.internal:11460
    volumes:
      - .:/app
      - ./zhewei_memory:/memory
    ports:
      - "8002:8000"
    restart: unless-stopped

  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: zhe-wei-tech-tunnel-1
    profiles: ["daily", "dev"]
    restart: always
    command: ["tunnel", "run", "--token", "${CLOUDFLARE_TOKEN}"]
    depends_on:
      - brain_server

  ollama:
    image: ollama/ollama:latest
    container_name: zhe-wei-ollama
    profiles: ["daily", "dev"]
    ports:
      - "11460:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: zhewei-qdrant
    profiles: ["daily", "dev"]
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped

  n8n:
    image: n8nio/n8n:latest
    container_name: zhewei-n8n
    profiles: ["dev"]
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    profiles: ["dev"]
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11460
    volumes:
      - open-webui-data:/app/backend/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  mcpo:
    image: masterno12/webui-mcpo:latest
    container_name: webui-mcpo
    profiles: ["dev"]
    ports:
      - "18010:8000"
    volumes:
      - ./mcpo:/opt/mcpo
      - ./brain_workspace:/workspace
    restart: unless-stopped

  openhands:
    image: docker.openhands.dev/openhands/openhands:1.3
    container_name: openhands
    profiles: ["dev"]
    environment:
      AGENT_SERVER_IMAGE_REPOSITORY: ghcr.io/openhands/agent-server
      AGENT_SERVER_IMAGE_TAG: 1.10.0-python
      LOG_ALL_EVENTS: "true"
      SANDBOX_VOLUMES: "${OPENHANDS_WORKSPACE:-/d/zhe-wei-tech}:/workspace:rw"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - openhands-data:/.openhands
    ports:
      - "3001:3000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

volumes:
  ollama_data:
  qdrant_data:
  n8n_data:
  open-webui-data:
  openhands-data:
