# 築未科技 — 全系統功能測試報告

**測試日期**：2026-02-05  
**測試範圍**：D:\brain_workspace 環境檢查、模擬請求「幫我分析 input/test.jpg 並產出 LPC 標記報表」、驗證鏈條（3.12 視覺 / 報表 / Z 槽寫入）

---

## 1. 環境檢查結果（startup_diagnostics.py）

**執行指令**：`python startup_diagnostics.py`（專案根目錄，PYTHONIOENCODING=utf-8）

| 項目 | 結果 | 說明 |
|------|------|------|
| 雲端記憶庫 (Z 槽) | ❌ | 本機未掛載 Z 槽，無法驗證 Z 寫入 |
| Python 環境 | ✅ | 符合 3.10+ |
| 核心檔案 brain_server.py | ✅ | 存在 |
| 核心檔案 ai_service.py | ✅ | 存在 |
| 核心檔案 agent_logic.py | ✅ | 存在 |
| 依賴 (FastAPI / uvicorn) | ✅ | 已安裝 |
| 視覺環境 (venv_vision) | ✅ 可選 | 專案內 brain_workspace 或 D:\brain_workspace |
| GPU 加速 (CUDA) | ✅ 可選 | 依環境 |
| 目錄完整性 input/ processed/ models/ | ✅ 可選 | 已存在 |
| Port 8000 可用 | ✅ 可選 | 可用 |

**診斷結論**：核心項目中 **Z 槽未掛載**，故 `startup_diagnostics.py` 回傳 exit code 1。其餘項目通過。在 D:\brain_workspace 且 Z 槽已掛載的環境下，診斷應可全部通過。

---

## 2. 模擬請求與驗證鏈條說明

### 2.1 請求語句

「幫我分析 input/test.jpg 並產出 LPC 標記報表」

### 2.2 預期流程（程式碼對應）

1. **Agent 決策**（agent_logic.py）  
   - AI 選用工具：`run_vision_engine(image_path)` 或 `vision_analyze(image_path)`，必要時再呼叫 `generate_progress_report(detected)`。

2. **subprocess 呼叫 3.12 視覺環境**  
   - **檔案**：`agent_tools.py`  
   - **行號**：213–234（`run_vision_engine`）  
   - **邏輯**：以 `VENV_VISION_PY`（3.12 venv_vision）執行 `vision_worker.py`，`cwd=BRAIN_WORKSPACE`（預設 `D:\brain_workspace`）。  
   - **關鍵**：第 223 行 `cmd = [str(VENV_VISION_PY), str(VISION_WORKER_SCRIPT), str(p)]`，第 225–234 行 `subprocess.run(..., cwd=str(BRAIN_WORKSPACE))`。  
   - **驗證**：若 3.12 環境與 vision_worker.py 存在且 test.jpg 存在，應回傳含 `detected` 的 JSON。

3. **辨識結果轉為報表（Markdown 表格 vs CSV/JSONL）**  
   - **重要說明**：  
     - **影像分析**產出的報表為 **CSV / JSONL**（`report_generator.py`、`brain_workspace/report_tools.py`），並非 Markdown 表格。  
     - **Markdown 表格**（如 LPC 標記整理成表）僅在 **語音報表** 流程中產出，由 `generate_voice_report(transcript)` 寫入 **Daily_Voice_Logs.md**。  
   - **影像報表寫入**：  
     - **檔案**：`report_generator.py` 第 42–61 行  
     - 寫入：`Z:/Zhewei_Brain/Reports/Daily_Log_YYYYMMDD.jsonl`、`Z:/Zhewei_Brain/Reports/Weekly_Progress_Summary.csv`  
   - **語音報表寫入**：  
     - **檔案**：`agent_tools.py` 第 191–209 行（`generate_voice_report`）  
     - 寫入：`Z:/Zhewei_Brain/Reports/Daily_Voice_Logs.md`

4. **結果寫入 Z 槽**  
   - **影像分析鏈**：寫入 `Z:/Zhewei_Brain/Reports/` 下 **Daily_Log_*.jsonl** 與 **Weekly_Progress_Summary.csv**（非 Daily_Voice_Logs.md）。  
   - **語音報表鏈**：寫入 **Daily_Voice_Logs.md**。  
   - 若 Z 槽未掛載，上述寫入皆會失敗（路徑不可用）。

### 2.3 驗證項目與對應檔案／行號

| 驗證項目 | 對應檔案 | 行號 | 說明 |
|----------|----------|------|------|
| 成功透過 subprocess 呼叫 3.12 視覺環境 | agent_tools.py | 213–234 | `run_vision_engine`：VENV_VISION_PY + VISION_WORKER_SCRIPT，cwd=BRAIN_WORKSPACE |
| 辨識結果轉為報表 | report_generator.py | 17–61 | 產出 JSONL + CSV；Markdown 表格僅在語音報表（generate_voice_report） |
| 影像報表寫入 Z 槽 | report_generator.py | 42–61 | Daily_Log_*.jsonl、Weekly_Progress_Summary.csv |
| 語音報表寫入 Daily_Voice_Logs.md | agent_tools.py | 204 | 僅 `generate_voice_report` 寫入此檔 |

---

## 3. 本機測試限制與結果

- **Z 槽**：未掛載，無法驗證任何 Z 槽寫入。  
- **D:\brain_workspace**：本機為專案目錄，未使用 D:\brain_workspace；視覺腳本 fallback 至專案內 `brain_workspace`。  
- **input/test.jpg**：`brain_workspace/input/` 下目前無 test.jpg，無法執行實際影像辨識。  
- **結論**：  
  - 環境檢查：**Z 槽未通過**，其餘通過。  
  - 驗證鏈條：**程式碼路徑與行號已對應**；實際 E2E（視覺→報表→Z 寫入）需在 **D:\brain_workspace、Z 槽已掛載、且存在 input/test.jpg** 的環境下執行。

---

## 4. 建議：在 D:\brain_workspace 的完整測試步驟

1. 掛載 Z 槽（Rclone），確認 `Z:/Zhewei_Brain` 可寫。  
2. 確認 `D:\brain_workspace` 存在，且內含 `venv_vision`、`vision_worker.py`、`site_monitor.py`、`input/`、`processed/`、`models/`。  
3. 將測試圖放入 `D:\brain_workspace\input\test.jpg`（或專案內 `brain_workspace\input\test.jpg`）。  
4. 在專案根目錄執行：`python startup_diagnostics.py` → 應全部通過。  
5. 啟動 brain_server：`python brain_server.py`。  
6. 透過 WebSocket 或前端發送：「幫我分析 input/test.jpg 並產出 LPC 標記報表」。  
7. 驗證：  
   - 視窗 Log 中出現對 `run_vision_engine` 或 `vision_analyze` 的呼叫及辨識結果。  
   - `Z:/Zhewei_Brain/Reports/Daily_Log_YYYYMMDD.jsonl` 與 `Weekly_Progress_Summary.csv` 有新增一筆。  
   - **Daily_Voice_Logs.md** 僅在發送「語音逐字稿報表」類請求時才會被寫入，影像分析不會寫入此檔。

---

## 5. 測試報告總結

| 項目 | 狀態 | 備註 |
|------|------|------|
| 環境檢查 (startup_diagnostics.py) | ⚠️ 部分通過 | Z 槽未掛載導致 exit 1；其餘通過 |
| subprocess 呼叫 3.12 視覺環境 | ✅ 程式碼就緒 | agent_tools.py 213–234 行 |
| 辨識結果轉為報表 | ✅ 程式碼就緒 | report_generator.py；影像為 CSV/JSONL，非 Markdown |
| 影像報表寫入 Z 槽 (Daily_Log / Weekly_Progress) | ⏳ 待 Z 槽就緒 | 路徑與邏輯已對應 |
| 寫入 Daily_Voice_Logs.md | ⚠️ 不同流程 | 僅語音報表寫入；影像分析不寫此檔 |

**產出**：本報告已標註各驗證環節的 **具體檔案與行號**；在 Z 槽與 D:\brain_workspace 就緒並備妥 test.jpg 後，依上述步驟可完成全系統 E2E 測試。
