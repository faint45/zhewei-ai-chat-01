# 築未科技 — 各項工作流完成說明

**目的**：編碼、撰寫、運算、分配、執行、回饋、生成等各項工作流由誰完成、用何工具、產出何處。對應八階段與 `agent_tools`。

---

## 工作流與完成對照

| 工作流 | 完成方式 | 負責組件 | 工具／動作 | 產出位置 |
|--------|----------|----------|------------|----------|
| **編碼** | 寫入程式碼 | Claude / AgentManager | `write_file(path, content)`、`run_command` | `D:\brain_workspace` 或 `D:\Project\{任務}\Draft` |
| **撰寫** | 寫入文件、報表、日誌 | AgentManager | `write_file`、`manage_construction_log`、`generate_voice_report` | Z 槽 Reports、Daily_Voice_Logs.md；D 槽限 D/Z |
| **運算** | 視覺辨識、資料處理 | vision_worker / Ollama | `run_vision_engine(image_path)`、`run_command`（D 槽清洗） | 辨識結果回傳 JSON；大批資料落 D 槽 |
| **分配** | 任務分類與引擎分流 | AgentManager (階段 2–3) | `_classify_task()`、引擎選擇（Gemini/Ollama/Claude） | 無檔案產出；決定後續執行鏈 |
| **執行** | 實際跑指令、寫檔、呼叫 API | AgentManager | `run_command`、`write_file`、`read_file`、`list_dir`、`run_vision_engine` 等 TOOLS | D 槽 Draft；路徑限 D/Z |
| **回饋** | 錯誤修復、修正覆蓋 | Claude 3.5 / Gemini（Observation 異常時） | `write_file` 覆蓋、ReAct 再一輪 | `D:\Project\{任務}\Fix` 或 D 槽同路徑覆蓋 |
| **生成** | 報表、語音日誌、媒體 | report_generator / agent_tools | `generate_progress_report(detected)`、`generate_voice_report(transcript)`、`generate_media(prompt, type)` | Z 槽 Reports（JSONL/CSV/MD）；媒體 → `D:\brain_workspace\output` |

---

## 工具與工作流對應（agent_tools）

| 工具名 | 工作流 | 說明 |
|--------|--------|------|
| `run_command` | 執行、運算 | 系統指令，cwd 限 D/Z |
| `read_file` | 執行、回饋 | 讀檔，路徑限 D/Z |
| `write_file` | 編碼、撰寫、執行、回饋 | 寫檔，路徑限 D/Z |
| `list_dir` | 執行、分配（探索） | 列目錄，路徑限 D/Z |
| `vision_analyze` | 運算 | 本機 YOLO（若已安裝） |
| `run_vision_engine` | 運算 | subprocess 呼叫 D:\brain_workspace 之 venv_vision / vision_worker.py |
| `manage_construction_log` | 撰寫 | 工地日誌寫入 Z 槽 |
| `generate_progress_report` | 生成 | 影像報表 → Z 槽 Reports（JSONL/CSV），進度 $X\%$ |
| `generate_voice_report` | 生成 | 語音日報 → Z 槽 Daily_Voice_Logs.md |
| `generate_media` | 生成 | 影像/影片 → D:\brain_workspace\output（Jimeng/Grok API） |
| `deploy_service` | 執行（階段 8） | 觸發佈署腳本或 API |
| `update_web_admin` | 生成／完成 | 更新網頁後台狀態，進度可含 LaTeX $X\%$ |

---

## 八階段與工作流對齊

| 階段 | 名稱 | 主要工作流 | 完成標誌 |
|------|------|------------|----------|
| 1 | 需求 | — | 收到 WebSocket 指令 |
| 2 | 整合理解 | 分配（分類） | 載入 Z 槽記憶、任務分類 |
| 3 | 安排 | 分配 | 產出計畫、引擎分流 |
| 4 | 執行 | 編碼、撰寫、運算、執行 | Draft 寫入 D 槽；TOOLS 執行完畢 |
| 5 | 確認 I | 執行（檢核） | Observation 合規或觸發修復 |
| 6 | 回饋修正 | 回饋 | Fix 覆蓋或 ReAct 修復完成 |
| 7 | 確認 II | 運算（多模型檢核） | 交叉驗證通過／定稿 |
| 8 | 完成與佈署 | 生成、執行 | 報表至 Z 槽、佈署觸發、update_web_admin |

---

## 路徑與格式規範

- **產出路徑**：僅 D 槽、Z 槽；報表與長期記憶以 Z 槽為準。
- **進度數值**：LaTeX 格式，例 `$85\%$`（見 `report_generator`、`update_web_admin`）。
- **Draft / Fix / Done**：對齊 `通用執行引擎架構表.md` 時，Draft/Fix 用 D 槽，Done 可搬至 Z 槽 Reports 或專案 Done。

---

**本地執行**：雙擊 `執行_單次任務.bat`、`執行_視覺與報表.bat` 或使用 `scripts/run_workflow_step.py`；詳見 **本地手腳說明.md**。

---

*實作須遵守架構守則與全系統架構鎖定規則；TOOLS 以 agent_tools.py 為準。*
