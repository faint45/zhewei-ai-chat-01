<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e40af">
    <title>èªéŸ³æ—¥å ± â€” ç‡Ÿå»ºè‡ªå‹•åŒ–</title>
    <link rel="manifest" href="/voice-manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.4); opacity: 0; } }
        @keyframes recording-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .pulse-ring { animation: pulse-ring 1.5s ease-out infinite; }
        .recording-dot { animation: recording-dot 1s ease-in-out infinite; }
        .wave-bar { animation: wave 0.6s ease-in-out infinite alternate; }
        @keyframes wave { 0% { height: 8px; } 100% { height: 32px; } }
        body { -webkit-user-select: none; user-select: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="voiceApp()">

    <!-- é ‚éƒ¨å°èˆª -->
    <div class="bg-blue-800 text-white px-4 py-3 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <a href="/" class="text-white/70 hover:text-white text-sm">â† è¿”å›</a>
            <h1 class="font-bold text-lg">ğŸ™ï¸ èªéŸ³æ—¥å ±</h1>
        </div>
        <div class="text-xs text-blue-200" x-text="currentProject ? currentProject.project_name : 'æœªé¸æ“‡å·¥ç¨‹'"></div>
    </div>

    <!-- å·¥ç¨‹é¸æ“‡ -->
    <div x-show="!currentProject" class="p-4">
        <div class="bg-white rounded-xl shadow p-6 text-center">
            <svg class="w-16 h-16 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            <p class="text-gray-500 mb-4">è«‹å…ˆé¸æ“‡å·¥ç¨‹</p>
            <div class="space-y-2">
                <template x-for="p in projects" :key="p.id">
                    <button @click="selectProject(p)" class="w-full px-4 py-3 bg-blue-50 border border-blue-200 rounded-lg text-left hover:bg-blue-100 transition-colors">
                        <div class="font-medium text-blue-800" x-text="p.project_name"></div>
                        <div class="text-xs text-gray-500" x-text="p.contract_number || ''"></div>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <!-- ä¸»ä»‹é¢ -->
    <div x-show="currentProject" class="pb-32">

        <!-- æ¨¡å¼é¸æ“‡ -->
        <div class="px-4 pt-4">
            <div class="grid grid-cols-4 gap-2">
                <button @click="mode = 'daily_log'" :class="mode === 'daily_log' ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-white text-gray-600 border'" class="px-2 py-3 rounded-xl text-center transition-all transform">
                    <div class="text-xl mb-1">ğŸ“‹</div>
                    <div class="text-xs font-medium">æ–½å·¥æ—¥èªŒ</div>
                </button>
                <button @click="mode = 'inspection'" :class="mode === 'inspection' ? 'bg-green-600 text-white shadow-lg scale-105' : 'bg-white text-gray-600 border'" class="px-2 py-3 rounded-xl text-center transition-all transform">
                    <div class="text-xl mb-1">âœ…</div>
                    <div class="text-xs font-medium">è‡ªä¸»æª¢æŸ¥</div>
                </button>
                <button @click="mode = 'photo'" :class="mode === 'photo' ? 'bg-purple-600 text-white shadow-lg scale-105' : 'bg-white text-gray-600 border'" class="px-2 py-3 rounded-xl text-center transition-all transform">
                    <div class="text-xl mb-1">ğŸ“¸</div>
                    <div class="text-xs font-medium">æ‹ç…§è¨˜éŒ„</div>
                </button>
                <button @click="mode = 'material'" :class="mode === 'material' ? 'bg-orange-600 text-white shadow-lg scale-105' : 'bg-white text-gray-600 border'" class="px-2 py-3 rounded-xl text-center transition-all transform">
                    <div class="text-xl mb-1">ğŸ§±</div>
                    <div class="text-xs font-medium">ææ–™é€²å ´</div>
                </button>
            </div>
        </div>

        <!-- æç¤ºæ–‡å­— -->
        <div class="px-4 mt-3">
            <div class="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 text-xs text-blue-700">
                <template x-if="mode === 'daily_log'">
                    <span>ğŸ’¡ è«‹èªªæ˜ï¼šä»Šå¤©å¤©æ°£ã€æ–½å·¥å…§å®¹ã€äººåŠ›æ©Ÿå…·ã€ææ–™ä½¿ç”¨ã€å®‰å…¨å“è³ªäº‹é …</span>
                </template>
                <template x-if="mode === 'inspection'">
                    <span>ğŸ’¡ è«‹èªªæ˜ï¼šæª¢æŸ¥é …ç›®åç¨±ã€ä½ç½®ã€æª¢æŸ¥çµæœï¼ˆåˆæ ¼/ä¸åˆæ ¼ï¼‰ã€ç¼ºå¤±èªªæ˜</span>
                </template>
                <template x-if="mode === 'photo'">
                    <span>ğŸ’¡ è«‹èªªæ˜ï¼šæ‹æ”ä½ç½®ã€å·¥é …åç¨±ã€è¨­è¨ˆå€¼ã€å¯¦æ¸¬å€¼ã€ç…§ç‰‡èªªæ˜</span>
                </template>
                <template x-if="mode === 'material'">
                    <span>ğŸ’¡ è«‹èªªæ˜ï¼šææ–™åç¨±ã€è¦æ ¼ã€æ•¸é‡ã€å–®ä½ã€ä¾›æ‡‰å•†</span>
                </template>
            </div>
        </div>

        <!-- è¾¨è­˜çµæœ -->
        <div x-show="transcript" class="px-4 mt-3">
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-gray-700 text-sm">ğŸ¯ è¾¨è­˜çµæœ</h3>
                    <span class="text-xs text-gray-400" x-text="recognitionDuration + 's'"></span>
                </div>
                <p class="text-sm text-gray-800 leading-relaxed bg-gray-50 rounded-lg p-3" x-text="transcript"></p>
            </div>
        </div>

        <!-- AI çµæ§‹åŒ–çµæœ -->
        <div x-show="structuredData" class="px-4 mt-3">
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-gray-700 text-sm">ğŸ¤– AI çµæ§‹åŒ–çµæœ</h3>
                    <div class="flex gap-2">
                        <button @click="confirmDraft()" class="px-3 py-1 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700" :disabled="confirming">
                            <span x-show="!confirming">âœ“ ç¢ºèªé€å‡º</span>
                            <span x-show="confirming">è™•ç†ä¸­...</span>
                        </button>
                        <button @click="structuredData = null; transcript = ''; draftId = null" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-lg hover:bg-gray-300">âœ• å–æ¶ˆ</button>
                    </div>
                </div>

                <!-- æ—¥å ±è¡¨çµæ§‹åŒ– -->
                <template x-if="mode === 'daily_log' && structuredData">
                    <div class="space-y-2 text-sm">
                        <div class="grid grid-cols-2 gap-2">
                            <div><span class="text-gray-500">æ—¥æœŸï¼š</span><span class="font-medium" x-text="structuredData.log_date"></span></div>
                            <div><span class="text-gray-500">ç‹€æ…‹ï¼š</span><span class="font-medium" x-text="structuredData.day_status"></span></div>
                            <div><span class="text-gray-500">ä¸Šåˆå¤©æ°£ï¼š</span><span x-text="structuredData.weather_am"></span></div>
                            <div><span class="text-gray-500">ä¸‹åˆå¤©æ°£ï¼š</span><span x-text="structuredData.weather_pm"></span></div>
                        </div>
                        <div x-show="structuredData.work_description">
                            <span class="text-gray-500">æ–½å·¥æ¦‚æ³ï¼š</span>
                            <p class="mt-1 bg-gray-50 rounded p-2 text-xs" x-text="structuredData.work_description"></p>
                        </div>
                        <div x-show="structuredData.workers && structuredData.workers.length > 0">
                            <span class="text-gray-500">äººåŠ›ï¼š</span>
                            <template x-for="w in structuredData.workers"><span class="inline-block bg-blue-100 text-blue-700 rounded px-2 py-0.5 text-xs mr-1 mt-1" x-text="w.trade + ' ' + w.count + 'äºº'"></span></template>
                        </div>
                        <div x-show="structuredData.equipment && structuredData.equipment.length > 0">
                            <span class="text-gray-500">æ©Ÿå…·ï¼š</span>
                            <template x-for="e in structuredData.equipment"><span class="inline-block bg-green-100 text-green-700 rounded px-2 py-0.5 text-xs mr-1 mt-1" x-text="e.equipment_name + ' ' + e.count + 'å°'"></span></template>
                        </div>
                        <div x-show="structuredData.materials && structuredData.materials.length > 0">
                            <span class="text-gray-500">ææ–™ï¼š</span>
                            <template x-for="m in structuredData.materials"><span class="inline-block bg-orange-100 text-orange-700 rounded px-2 py-0.5 text-xs mr-1 mt-1" x-text="m.material_name + ' ' + m.quantity + m.unit"></span></template>
                        </div>
                        <div x-show="structuredData.safety_notes"><span class="text-gray-500">å®‰å…¨ï¼š</span><span class="text-xs" x-text="structuredData.safety_notes"></span></div>
                        <div x-show="structuredData.quality_notes"><span class="text-gray-500">å“è³ªï¼š</span><span class="text-xs" x-text="structuredData.quality_notes"></span></div>
                    </div>
                </template>

                <!-- æª¢æŸ¥è¡¨çµæ§‹åŒ– -->
                <template x-if="mode === 'inspection' && structuredData">
                    <div class="space-y-2 text-sm">
                        <div><span class="text-gray-500">æª¢æŸ¥è¡¨ï¼š</span><span class="font-medium" x-text="structuredData.checklist_name"></span></div>
                        <div><span class="text-gray-500">ä½ç½®ï¼š</span><span x-text="structuredData.inspection_location"></span></div>
                        <div x-show="structuredData.items && structuredData.items.length > 0">
                            <span class="text-gray-500">æª¢æŸ¥é …ç›®ï¼š</span>
                            <template x-for="item in structuredData.items">
                                <div class="flex items-center gap-2 mt-1 text-xs bg-gray-50 rounded p-2">
                                    <span :class="item.check_result === 'V' ? 'text-green-600' : item.check_result === 'X' ? 'text-red-600' : 'text-gray-400'" x-text="item.check_result === 'V' ? 'âœ…' : item.check_result === 'X' ? 'âŒ' : 'â¬œ'"></span>
                                    <span x-text="item.item_name"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- æ‹ç…§/ææ–™çµæ§‹åŒ– -->
                <template x-if="(mode === 'photo' || mode === 'material') && structuredData">
                    <div class="text-sm">
                        <pre class="bg-gray-50 rounded p-3 text-xs overflow-x-auto whitespace-pre-wrap" x-text="JSON.stringify(structuredData, null, 2)"></pre>
                    </div>
                </template>
            </div>
        </div>

        <!-- è‰ç¨¿åˆ—è¡¨ -->
        <div class="px-4 mt-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-medium text-gray-700 text-sm">ğŸ“ å¾…æª¢æ ¸è‰ç¨¿</h3>
                <button @click="loadDrafts()" class="text-xs text-blue-600 hover:text-blue-800">é‡æ–°æ•´ç†</button>
            </div>
            <div x-show="drafts.length === 0" class="text-center py-6 text-gray-400 text-sm">
                å°šç„¡èªéŸ³è‰ç¨¿
            </div>
            <div class="space-y-2">
                <template x-for="d in drafts" :key="d.id">
                    <div class="bg-white rounded-lg shadow-sm border p-3" :class="d.status === 'confirmed' ? 'opacity-60' : ''">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-lg" x-text="d.mode === 'daily_log' ? 'ğŸ“‹' : d.mode === 'inspection' ? 'âœ…' : d.mode === 'photo' ? 'ğŸ“¸' : 'ğŸ§±'"></span>
                                <div>
                                    <div class="text-sm font-medium" x-text="d.mode === 'daily_log' ? 'æ–½å·¥æ—¥èªŒ' : d.mode === 'inspection' ? 'è‡ªä¸»æª¢æŸ¥' : d.mode === 'photo' ? 'æ‹ç…§è¨˜éŒ„' : 'ææ–™é€²å ´'"></div>
                                    <div class="text-xs text-gray-400" x-text="d.created_at"></div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs px-2 py-0.5 rounded-full" :class="d.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : d.status === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'" x-text="d.status === 'pending' ? 'å¾…æª¢æ ¸' : d.status === 'confirmed' ? 'å·²ç¢ºèª' : d.status"></span>
                                <button x-show="d.status === 'pending'" @click="reviewDraft(d)" class="text-xs text-blue-600 hover:text-blue-800">æª¢è¦–</button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 line-clamp-2" x-text="d.transcript"></p>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨éŒ„éŸ³æŒ‰éˆ• -->
    <div x-show="currentProject" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t px-4 py-4 z-50" style="-webkit-backdrop-filter: blur(10px);">
        <div class="flex items-center justify-center gap-4">
            <!-- æ–‡å­—è¼¸å…¥åˆ‡æ› -->
            <button @click="showTextInput = !showTextInput" class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>

            <!-- éŒ„éŸ³æŒ‰éˆ• -->
            <div class="relative">
                <div x-show="isRecording" class="absolute inset-0 rounded-full bg-red-400/30 pulse-ring"></div>
                <button @click="toggleRecording()" class="relative w-20 h-20 rounded-full flex items-center justify-center shadow-lg transition-all transform active:scale-95"
                    :class="isRecording ? 'bg-red-500 scale-110' : 'bg-blue-600 hover:bg-blue-700'">
                    <template x-if="!isRecording && !isProcessing">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </template>
                    <template x-if="isRecording">
                        <div class="flex items-center gap-1">
                            <div class="w-1 bg-white rounded-full wave-bar" style="animation-delay: 0s;"></div>
                            <div class="w-1 bg-white rounded-full wave-bar" style="animation-delay: 0.15s;"></div>
                            <div class="w-1 bg-white rounded-full wave-bar" style="animation-delay: 0.3s;"></div>
                            <div class="w-1 bg-white rounded-full wave-bar" style="animation-delay: 0.45s;"></div>
                            <div class="w-1 bg-white rounded-full wave-bar" style="animation-delay: 0.6s;"></div>
                        </div>
                    </template>
                    <template x-if="isProcessing">
                        <svg class="w-8 h-8 text-white animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                    </template>
                </button>
            </div>

            <!-- éŒ„éŸ³æ™‚é–“ -->
            <div class="w-12 text-center">
                <span x-show="isRecording" class="text-red-500 text-sm font-mono recording-dot" x-text="recordingTime + 's'"></span>
            </div>
        </div>

        <!-- æ–‡å­—è¼¸å…¥æ¡† -->
        <div x-show="showTextInput" x-transition class="mt-3">
            <div class="flex gap-2">
                <input x-model="textInput" @keyup.enter="submitText()" class="flex-1 px-3 py-2 border rounded-lg text-sm" placeholder="è¼¸å…¥å£è¿°å…§å®¹ï¼ˆæ¸¬è©¦ç”¨ï¼‰...">
                <button @click="submitText()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700" :disabled="isProcessing || !textInput.trim()">é€å‡º</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ Toast -->
    <div x-show="toast" x-transition class="fixed top-16 left-4 right-4 z-50">
        <div class="rounded-lg shadow-lg px-4 py-3 text-sm text-white" :class="toastType === 'success' ? 'bg-green-600' : toastType === 'error' ? 'bg-red-600' : 'bg-blue-600'" x-text="toast"></div>
    </div>

    <script>
    function voiceApp() {
        return {
            projects: [],
            currentProject: null,
            mode: 'daily_log',
            isRecording: false,
            isProcessing: false,
            recordingTime: 0,
            recordingTimer: null,
            mediaRecorder: null,
            audioChunks: [],
            transcript: '',
            structuredData: null,
            draftId: null,
            drafts: [],
            confirming: false,
            showTextInput: false,
            textInput: '',
            toast: '',
            toastType: 'info',
            recognitionDuration: 0,

            async init() {
                await this.loadProjects();
                // è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹å·¥ç¨‹
                if (this.projects.length === 1) {
                    this.selectProject(this.projects[0]);
                }
            },

            async loadProjects() {
                try {
                    const res = await fetch('/api/projects');
                    const data = await res.json();
                    if (data.success) this.projects = data.data;
                } catch (e) { console.error(e); }
            },

            selectProject(p) {
                this.currentProject = p;
                this.loadDrafts();
            },

            async loadDrafts() {
                if (!this.currentProject) return;
                try {
                    const res = await fetch(`/api/projects/${this.currentProject.id}/voice/drafts`);
                    const data = await res.json();
                    if (data.success) this.drafts = data.data;
                } catch (e) { console.error(e); }
            },

            async toggleRecording() {
                if (this.isProcessing) return;
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording();
                }
            },

            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: { sampleRate: 16000, channelCount: 1, echoCancellation: true, noiseSuppression: true }
                    });
                    this.audioChunks = [];
                    // å„ªå…ˆä½¿ç”¨ webm/opusï¼Œfallback åˆ°ç€è¦½å™¨æ”¯æ´çš„æ ¼å¼
                    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' :
                                     MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' :
                                     MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
                    const options = mimeType ? { mimeType } : {};
                    this.mediaRecorder = new MediaRecorder(stream, options);
                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) this.audioChunks.push(e.data);
                    };
                    this.mediaRecorder.onstop = () => {
                        stream.getTracks().forEach(t => t.stop());
                        this.uploadAudio();
                    };
                    this.mediaRecorder.start(250);
                    this.isRecording = true;
                    this.recordingTime = 0;
                    this.recordingTimer = setInterval(() => { this.recordingTime++; }, 1000);
                    this.transcript = '';
                    this.structuredData = null;
                } catch (e) {
                    this.showToast('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼š' + e.message, 'error');
                }
            },

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    clearInterval(this.recordingTimer);
                }
            },

            async uploadAudio() {
                if (this.audioChunks.length === 0) return;
                this.isProcessing = true;
                this.showToast('æ­£åœ¨è¾¨è­˜èªéŸ³...', 'info');

                const mimeType = this.mediaRecorder.mimeType || 'audio/webm';
                const ext = mimeType.includes('mp4') ? '.m4a' : '.webm';
                const blob = new Blob(this.audioChunks, { type: mimeType });
                const formData = new FormData();
                formData.append('audio', blob, `recording${ext}`);
                formData.append('mode', this.mode);
                formData.append('language', 'auto');

                try {
                    const res = await fetch(`/api/projects/${this.currentProject.id}/voice/transcribe`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        this.transcript = data.transcript;
                        this.structuredData = data.structured_data;
                        this.draftId = data.draft_id;
                        this.recognitionDuration = data.duration;
                        this.showToast('è¾¨è­˜å®Œæˆï¼è«‹æª¢æ ¸çµæœ', 'success');
                        this.loadDrafts();
                    } else {
                        this.showToast(data.message || 'è¾¨è­˜å¤±æ•—', 'error');
                    }
                } catch (e) {
                    this.showToast('ä¸Šå‚³å¤±æ•—ï¼š' + e.message, 'error');
                } finally {
                    this.isProcessing = false;
                }
            },

            async submitText() {
                if (!this.textInput.trim() || this.isProcessing) return;
                this.isProcessing = true;
                this.showToast('AI çµæ§‹åŒ–è™•ç†ä¸­...', 'info');

                try {
                    const res = await fetch(`/api/projects/${this.currentProject.id}/voice/transcribe-text`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: this.textInput, mode: this.mode })
                    });
                    const data = await res.json();
                    if (data.success) {
                        this.transcript = data.transcript;
                        this.structuredData = data.structured_data;
                        this.draftId = data.draft_id;
                        this.textInput = '';
                        this.showToast('çµæ§‹åŒ–å®Œæˆï¼è«‹æª¢æ ¸çµæœ', 'success');
                        this.loadDrafts();
                    } else {
                        this.showToast(data.message || 'è™•ç†å¤±æ•—', 'error');
                    }
                } catch (e) {
                    this.showToast('è™•ç†å¤±æ•—ï¼š' + e.message, 'error');
                } finally {
                    this.isProcessing = false;
                }
            },

            async confirmDraft() {
                if (!this.draftId || this.confirming) return;
                this.confirming = true;
                try {
                    const res = await fetch(`/api/projects/${this.currentProject.id}/voice/drafts/${this.draftId}/confirm`, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        this.showToast(data.message, 'success');
                        this.transcript = '';
                        this.structuredData = null;
                        this.draftId = null;
                        this.loadDrafts();
                    } else {
                        this.showToast(data.message || 'ç¢ºèªå¤±æ•—', 'error');
                    }
                } catch (e) {
                    this.showToast('ç¢ºèªå¤±æ•—ï¼š' + e.message, 'error');
                } finally {
                    this.confirming = false;
                }
            },

            reviewDraft(d) {
                this.transcript = d.transcript;
                this.structuredData = d.structured_data;
                this.draftId = d.id;
                this.mode = d.mode;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            showToast(msg, type = 'info') {
                this.toast = msg;
                this.toastType = type;
                setTimeout(() => { this.toast = ''; }, 3000);
            }
        };
    }
    </script>
</body>
</html>
