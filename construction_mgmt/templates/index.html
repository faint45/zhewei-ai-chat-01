<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿå»ºè‡ªå‹•åŒ–ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; }
        [x-cloak] { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); }
        .field-group:hover { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .term-row:hover { background: #f0f9ff; }
        .upload-zone { border: 2px dashed #cbd5e1; transition: all 0.3s; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
        .btn-primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .btn-primary:hover { background: linear-gradient(135deg, #1d4ed8, #1e40af); }
        .sidebar-item.active { background: linear-gradient(135deg, #2563eb, #3b82f6); color: white; }
        .sidebar-item:not(.active):hover { background: #f1f5f9; }
        textarea { resize: vertical; }
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="cmsApp()" x-init="init()">

<!-- ===== é ‚éƒ¨å°èˆª ===== -->
<header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-[1600px] mx-auto px-4 h-14 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg flex items-center justify-center">
                <span class="text-white text-sm font-bold">ç‡Ÿ</span>
            </div>
            <h1 class="text-lg font-semibold text-gray-800">ç‡Ÿå»ºè‡ªå‹•åŒ–ç®¡ç†ç³»çµ±</h1>
            <span class="text-xs text-gray-400 ml-2">v1.0.0</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-xs text-gray-500" x-text="'å·¥ç¨‹æ•¸: ' + stats.total_projects"></span>
            <div class="w-2 h-2 rounded-full bg-green-500"></div>
            <span class="text-xs text-gray-500">æœ¬åœ°é‹è¡Œ</span>
        </div>
    </div>
</header>

<div class="max-w-[1600px] mx-auto flex" style="min-height: calc(100vh - 56px);">

    <!-- ===== å·¦å´é‚Šæ¬„ï¼šå·¥ç¨‹åˆ—è¡¨ ===== -->
    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
        <div class="p-4 border-b border-gray-100">
            <button @click="showNewProject()" class="w-full btn-primary text-white py-2.5 px-4 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                æ–°å¢å·¥ç¨‹
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-2">
            <template x-if="projects.length === 0">
                <div class="text-center py-12 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    <p class="text-sm">å°šç„¡å·¥ç¨‹</p>
                    <p class="text-xs mt-1">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢</p>
                </div>
            </template>

            <template x-for="p in projects" :key="p.id">
                <div @click="loadProject(p.id)"
                     :class="{'active': currentProject && currentProject.id === p.id}"
                     class="sidebar-item p-3 rounded-lg cursor-pointer mb-1 transition-all">
                    <div class="font-medium text-sm truncate" x-text="p.project_name"></div>
                    <div class="text-xs mt-1 opacity-70 truncate" x-text="p.contractor || p.owner_agency || ''"></div>
                    <div class="flex items-center gap-2 mt-1.5">
                        <span :class="{
                            'bg-green-100 text-green-700': p.status === 'active',
                            'bg-yellow-100 text-yellow-700': p.status === 'pending',
                            'bg-gray-100 text-gray-600': p.status === 'completed'
                        }" class="status-badge" x-text="p.status === 'active' ? 'é€²è¡Œä¸­' : p.status === 'completed' ? 'å·²å®Œå·¥' : 'å¾…é–‹å·¥'"></span>
                        <span class="text-xs opacity-50" x-text="p.created_at ? p.created_at.substring(0,10) : ''"></span>
                    </div>
                </div>
            </template>
        </div>
    </aside>

    <!-- ===== ä¸»å…§å®¹å€ ===== -->
    <main class="flex-1 overflow-y-auto">

        <!-- ç©ºç™½ç‹€æ…‹ -->
        <template x-if="!currentProject && !showForm">
            <div class="flex items-center justify-center h-full">
                <div class="text-center text-gray-400">
                    <svg class="w-20 h-20 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <p class="text-lg">é¸æ“‡æˆ–æ–°å¢ä¸€å€‹å·¥ç¨‹</p>
                    <p class="text-sm mt-2">å¾å·¦å´é¸æ“‡å·¥ç¨‹ï¼Œæˆ–é»æ“Šã€Œæ–°å¢å·¥ç¨‹ã€é–‹å§‹</p>
                </div>
            </div>
        </template>

        <!-- ===== å·¥ç¨‹è¡¨å–®ï¼ˆæ–°å¢/ç·¨è¼¯ï¼‰ ===== -->
        <template x-if="showForm || currentProject">
            <div class="p-6 fade-in" x-data="{ activeTab: 'basic' }">

                <!-- åˆ†é æ¨™ç±¤ -->
                <div class="flex items-center gap-1 mb-6 bg-white rounded-xl p-1 shadow-sm border border-gray-200">
                    <button @click="activeTab = 'basic'" :class="activeTab === 'basic' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“‹ åŸºæœ¬è³‡æ–™
                    </button>
                    <button @click="activeTab = 'terms'" :class="activeTab === 'terms' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“– åè©å®šç¾©
                    </button>
                    <button @click="activeTab = 'personnel'" :class="activeTab === 'personnel' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ‘· å·¥ç¨‹äººå“¡
                    </button>
                    <button @click="activeTab = 'documents'" :class="activeTab === 'documents' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“ æ–‡ä»¶ç®¡ç†
                    </button>
                    <button @click="activeTab = 'contract'; if(currentProject) loadContractItems()" :class="activeTab === 'contract' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“Š å¥‘ç´„è©³ç´°è¡¨
                        <span x-show="currentProject && currentProject.contract_items_count > 0" class="ml-1 bg-blue-100 text-blue-700 text-xs px-1.5 py-0.5 rounded-full" x-text="currentProject ? currentProject.contract_items_count : ''"></span>
                    </button>
                    <button @click="activeTab = 'dailylog'; if(currentProject) loadLogStats()" :class="activeTab === 'dailylog' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“ æ–½å·¥æ—¥èªŒ
                    </button>
                    <button @click="activeTab = 'inspection'; if(currentProject) loadInspections()" :class="activeTab === 'inspection' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        âœ… è‡ªä¸»æª¢æŸ¥
                    </button>
                    <button @click="activeTab = 'photorecord'; if(currentProject) loadPhotoRecords()" :class="activeTab === 'photorecord' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“· æ‹ç…§è¨˜éŒ„
                    </button>
                    <button @click="activeTab = 'progress'; if(currentProject) loadSchedule()" :class="activeTab === 'progress' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“ˆ é€²åº¦ç®¡ç†
                    </button>
                    <button @click="activeTab = 'controls'; if(currentProject) loadSubmittals()" :class="activeTab === 'controls' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“‹ ç®¡åˆ¶è¡¨
                    </button>
                    <button @click="activeTab = 'specialterms'; if(currentProject) loadSpecialTerms()" :class="activeTab === 'specialterms' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“œ ç‰¹è¨‚æ¢æ¬¾
                    </button>
                    <button @click="activeTab = 'techspecs'; if(currentProject) loadTechSpecs()" :class="activeTab === 'techspecs' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“˜ æ–½å·¥è¦ç¯„
                    </button>
                    <button @click="activeTab = 'trafficmanual'; if(currentProject) loadTrafficManual()" :class="activeTab === 'trafficmanual' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“— äº¤é€šæ‰‹å†Š
                    </button>
                    <button @click="activeTab = 'projectplans'; if(currentProject) loadProjectPlans()" :class="activeTab === 'projectplans' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“„ å·¥ç¨‹è¨ˆç•«
                    </button>
                    <button @click="activeTab = 'voice'; if(currentProject) loadVoiceDrafts()" :class="activeTab === 'voice' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ™ï¸ èªéŸ³æ—¥å ±
                    </button>
                    <button @click="activeTab = 'scanner'; if(currentProject) loadScannedDocs()" :class="activeTab === 'scanner' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“· æ–‡ä»¶æƒæ
                    </button>
                    <button @click="activeTab = 'finance'; if(currentProject) loadPettyCash()" :class="activeTab === 'finance' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ’° è²¡å‹™ç®¡ç†
                    </button>
                    <button @click="activeTab = 'regulations'; loadRegulations()" :class="activeTab === 'regulations' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        ğŸ“– åƒè€ƒæ³•è¦
                    </button>
                    <button @click="activeTab = 'custom'" :class="activeTab === 'custom' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        âš™ï¸ è‡ªè¨‚æ¬„ä½
                    </button>
                </div>

                <!-- ========== TAB 1: åŸºæœ¬è³‡æ–™ ========== -->
                <div x-show="activeTab === 'basic'" x-cloak>

                    <!-- æ–‡ä»¶ä¸Šå‚³å€ï¼ˆå¿«é€Ÿå¡«å…¥ï¼‰ -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-5 mb-6 border border-blue-200" x-show="currentProject">
                        <h3 class="text-sm font-semibold text-blue-800 mb-2">ğŸ“„ ä¸Šå‚³å¥‘ç´„æ–‡ä»¶è‡ªå‹•å¡«å…¥</h3>
                        <p class="text-xs text-blue-600 mb-3">æ”¯æ´ Word (.docx)ã€Excel (.xlsx)ã€PDF æª”æ¡ˆï¼Œç³»çµ±æœƒè‡ªå‹•è§£æä¸¦å¡«å…¥å°æ‡‰æ¬„ä½</p>
                        <div class="upload-zone rounded-lg p-4 text-center cursor-pointer bg-white"
                             @click="$refs.autoFillInput.click()"
                             @dragover.prevent="$event.currentTarget.classList.add('dragover')"
                             @dragleave.prevent="$event.currentTarget.classList.remove('dragover')"
                             @drop.prevent="handleAutoFillDrop($event)">
                            <svg class="w-8 h-8 mx-auto mb-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            <p class="text-sm text-gray-600">æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•æˆ–<span class="text-blue-600 font-medium">é»æ“Šé¸æ“‡</span></p>
                            <input type="file" x-ref="autoFillInput" class="hidden" accept=".docx,.xlsx,.xls,.pdf" @change="handleAutoFill($event)">
                        </div>
                        <div x-show="autoFillStatus" class="mt-3 text-sm" :class="autoFillSuccess ? 'text-green-600' : 'text-red-600'" x-text="autoFillStatus"></div>
                    </div>

                    <!-- è¡¨å–®æ¬„ä½ â€” å®Œå…¨å°æ‡‰ä½ çš„ç¯„æœ¬æ ¼å¼ -->
                    <div class="space-y-4">

                        <!-- (ä¸€) å·¥ç¨‹åç¨± -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">ä¸€</span>
                                å·¥ç¨‹åç¨± <span class="text-red-500">*</span>
                            </label>
                            <input type="text" x-model="form.project_name" placeholder="ä¾‹ï¼šåœ‹é“1è™Ÿ265k+286æ’æ°´ç®±æ¶µæ”¹å»ºå·¥ç¨‹"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>

                        <!-- (äºŒ) ä¸»è¾¦å–®ä½ -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">äºŒ</span>
                                ä¸»è¾¦å–®ä½
                            </label>
                            <input type="text" x-model="form.owner_agency" placeholder="ä¾‹ï¼šäº¤é€šéƒ¨é«˜é€Ÿå…¬è·¯å±€å—å€é¤Šè­·åˆ†å±€"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>

                        <!-- (ä¸‰) åŸ·è¡Œå·¥ç¨‹è™• -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">ä¸‰</span>
                                åŸ·è¡Œå·¥ç¨‹è™•
                            </label>
                            <input type="text" x-model="form.execution_office" placeholder="ä¾‹ï¼šäº¤é€šéƒ¨é«˜é€Ÿå…¬è·¯å±€å—å€é¤Šè­·åˆ†å±€"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>

                        <!-- (å››) ç£å°å·¥å‹™æ‰€ -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">å››</span>
                                ç£å°å·¥å‹™æ‰€
                            </label>
                            <input type="text" x-model="form.supervision_office" placeholder="ä¾‹ï¼šäº¤é€šéƒ¨é«˜é€Ÿå…¬è·¯å±€å—å€é¤Šè­·åˆ†å±€æ–°ç‡Ÿå·¥å‹™æ®µ"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>

                        <!-- (äº”) è¨­è¨ˆå–®ä½ -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">äº”</span>
                                è¨­è¨ˆå–®ä½
                            </label>
                            <input type="text" x-model="form.design_unit" placeholder="ä¾‹ï¼šç¾å•†ç¾è¯ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸å°ç£åˆ†å…¬å¸"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>

                        <!-- (å…­) ç›£é€ å–®ä½ -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">å…­</span>
                                ç›£é€ å–®ä½
                            </label>
                            <input type="text" x-model="form.supervision_unit" placeholder="ä¾‹ï¼šç¾å•†ç¾è¯ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸å°ç£åˆ†å…¬å¸"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>

                        <!-- (ä¸ƒ) æ‰¿æ”¬å» å•† -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">ä¸ƒ</span>
                                æ‰¿æ”¬å» å•†
                            </label>
                            <input type="text" x-model="form.contractor" placeholder="ä¾‹ï¼šå¨å‹ç‡Ÿé€ æœ‰é™å…¬å¸"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>

                        <!-- (å…«) å·¥ç¨‹åœ°é» -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">å…«</span>
                                å·¥ç¨‹åœ°é»
                            </label>
                            <input type="text" x-model="form.project_location" placeholder="ä¾‹ï¼šå˜‰ç¾©å¸‚ã€å˜‰ç¾©ç¸£"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>

                        <!-- (ä¹) å¥‘ç´„é‡‘é¡ -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">ä¹</span>
                                å¥‘ç´„é‡‘é¡
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <span class="text-xs text-gray-500 mb-1 block">ä¸­æ–‡å¤§å¯«</span>
                                    <input type="text" x-model="form.contract_amount" placeholder="ä¾‹ï¼šè²³å„„ç–ä»ŸæŸ’ä½°æŒæ‹¾è¬å…ƒæ•´"
                                           class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <span class="text-xs text-gray-500 mb-1 block">æ•¸å­—é‡‘é¡ (NT$)</span>
                                    <input type="number" x-model="form.contract_amount_numeric" placeholder="ä¾‹ï¼š297800000"
                                           class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- (å) å·¥ç¨‹æœŸé™ -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">å</span>
                                å·¥ç¨‹æœŸé™
                            </label>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <span class="text-xs text-gray-500 mb-1 block">æœŸé™æè¿°</span>
                                    <input type="text" x-model="form.construction_period" placeholder="ä¾‹ï¼š840æ—¥æ›†å¤©"
                                           class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <span class="text-xs text-gray-500 mb-1 block">é–‹å·¥æ—¥æœŸ</span>
                                    <input type="date" x-model="form.start_date"
                                           class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <span class="text-xs text-gray-500 mb-1 block">é å®šå®Œå·¥æ—¥æœŸ</span>
                                    <input type="date" x-model="form.expected_end_date"
                                           class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- (åä¸€) å·¥ç¨‹ç¯„åœ -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">åä¸€</span>
                                å·¥ç¨‹ç¯„åœ
                            </label>
                            <textarea x-model="form.project_scope" rows="4" placeholder="ä¾‹ï¼šæœ¬æ¡ˆåŸ¤éº»è…³æ’æ°´ç®±æ¶µæ”¹å»ºå·¥ç¨‹ä½æ–¼åœ‹é“1è™Ÿé‡Œç¨‹265k+286è™•..."
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                        </div>

                        <!-- (åäºŒ) ä¿å›ºæœŸé™ -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <span class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold">åäºŒ</span>
                                ä¿å›ºæœŸé™
                            </label>
                            <textarea x-model="form.warranty_terms" rows="3" placeholder="ä¾‹ï¼šè‡ªå·¥ç¨‹é©—æ”¶åˆæ ¼æ—¥ä¹‹æ¬¡æ—¥èµ·ï¼Œè·¯é¢çµæ§‹3å¹´ã€æ©‹é¢ä¼¸ç¸®ç¸«7å¹´ï¼Œå…¶é¤˜å‡é ˆä¿å›ºä¸€å¹´"
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                        </div>

                        <!-- å‚™è¨» -->
                        <div class="field-group bg-white rounded-xl p-5 border border-gray-200 transition-all">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                å‚™è¨»
                            </label>
                            <textarea x-model="form.notes" rows="2" placeholder="å…¶ä»–å‚™è¨»äº‹é …..."
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                        </div>
                    </div>

                    <!-- å„²å­˜æŒ‰éˆ• -->
                    <div class="flex items-center gap-3 mt-6 sticky bottom-0 bg-gray-50 py-4 border-t border-gray-200 -mx-6 px-6">
                        <button @click="saveProject()" :disabled="saving" class="btn-primary text-white px-8 py-2.5 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all disabled:opacity-50 flex items-center gap-2">
                            <svg x-show="saving" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                            <span x-text="currentProject ? 'æ›´æ–°å·¥ç¨‹' : 'å»ºç«‹å·¥ç¨‹'"></span>
                        </button>
                        <button x-show="currentProject" @click="confirmDelete()" class="text-red-500 hover:text-red-700 hover:bg-red-50 px-4 py-2.5 rounded-lg text-sm transition-all">
                            åˆªé™¤å·¥ç¨‹
                        </button>
                        <span x-show="saveMessage" class="text-sm ml-2" :class="saveSuccess ? 'text-green-600' : 'text-red-600'" x-text="saveMessage"></span>
                    </div>
                </div>

                <!-- ========== TAB 2: åè©å®šç¾© (åä¸‰) ========== -->
                <div x-show="activeTab === 'terms'" x-cloak>
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                            <h3 class="font-semibold text-gray-700">ï¼ˆåä¸‰ï¼‰åè©å®šç¾©</h3>
                            <button @click="addTerm()" class="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                æ–°å¢å®šç¾©
                            </button>
                        </div>

                        <div class="divide-y divide-gray-100">
                            <template x-if="form.term_definitions.length === 0">
                                <div class="p-8 text-center text-gray-400 text-sm">
                                    å°šç„¡åè©å®šç¾©ï¼Œé»æ“Šã€Œæ–°å¢å®šç¾©ã€æˆ–ä¸Šå‚³å¥‘ç´„æ–‡ä»¶è‡ªå‹•è§£æ
                                </div>
                            </template>

                            <template x-for="(term, idx) in form.term_definitions" :key="idx">
                                <div class="term-row p-4 transition-all">
                                    <div class="flex items-start gap-3">
                                        <span class="w-8 h-8 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-1" x-text="'(' + (idx+1) + ')'"></span>
                                        <div class="flex-1 space-y-2">
                                            <input type="text" x-model="term.term_name" placeholder="åè©åç¨±ï¼ˆä¾‹ï¼šä¸»è¾¦æ©Ÿé—œ/æ¥­ä¸»ï¼‰"
                                                   class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                            <textarea x-model="term.term_definition" rows="3" placeholder="åè©å®šç¾©..."
                                                      class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                                        </div>
                                        <button @click="removeTerm(idx)" class="text-red-400 hover:text-red-600 p-1 flex-shrink-0 mt-1" title="åˆªé™¤">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- åè©å®šç¾©å„²å­˜ -->
                    <div class="mt-4">
                        <button @click="saveProject()" class="btn-primary text-white px-6 py-2.5 rounded-lg text-sm font-medium shadow-md">
                            å„²å­˜åè©å®šç¾©
                        </button>
                    </div>
                </div>

                <!-- ========== TAB 3: å·¥ç¨‹äººå“¡ ========== -->
                <div x-show="activeTab === 'personnel'" x-cloak>
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                            <h3 class="font-semibold text-gray-700">å·¥ç¨‹äººå“¡</h3>
                            <button @click="showAddPersonnel = true" class="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                æ–°å¢äººå“¡
                            </button>
                        </div>

                        <!-- äººå“¡åˆ—è¡¨ -->
                        <div class="divide-y divide-gray-100">
                            <template x-if="!currentProject || !currentProject.personnel || currentProject.personnel.length === 0">
                                <div class="p-8 text-center text-gray-400 text-sm">å°šç„¡äººå“¡è³‡æ–™</div>
                            </template>
                            <template x-for="person in (currentProject ? currentProject.personnel || [] : [])" :key="person.id">
                                <div class="p-4 flex items-center justify-between hover:bg-gray-50">
                                    <div>
                                        <span class="inline-block bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded mr-2" x-text="person.role"></span>
                                        <span class="font-medium text-sm" x-text="person.name"></span>
                                        <span class="text-xs text-gray-500 ml-2" x-text="person.company || ''"></span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-gray-500">
                                        <span x-text="person.phone || ''"></span>
                                        <button @click="deletePersonnel(person.id)" class="text-red-400 hover:text-red-600 ml-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- æ–°å¢äººå“¡è¡¨å–® -->
                    <div x-show="showAddPersonnel" class="mt-4 bg-white rounded-xl border border-gray-200 p-5 fade-in">
                        <h4 class="font-semibold text-sm text-gray-700 mb-3">æ–°å¢äººå“¡</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">è·å‹™è§’è‰²</label>
                                <select x-model="personnelForm.role" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="å°ˆä»»å·¥ç¨‹äººå“¡">å°ˆä»»å·¥ç¨‹äººå“¡ï¼ˆä¸»ä»»æŠ€å¸«ï¼‰</option>
                                    <option value="å·¥åœ°ä¸»ä»»">å·¥åœ°ä¸»ä»»</option>
                                    <option value="å“ç®¡äººå“¡">å“ç®¡äººå“¡</option>
                                    <option value="å®‰è¡›äººå“¡">å®‰è¡›äººå“¡</option>
                                    <option value="ç¾å ´å·¥ç¨‹å¸«">ç¾å ´å·¥ç¨‹å¸«</option>
                                    <option value="å·¥ç¨‹å¸">å·¥ç¨‹å¸</option>
                                    <option value="å·¥ç¨‹å¸ä»£è¡¨">å·¥ç¨‹å¸ä»£è¡¨</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">å§“å</label>
                                <input type="text" x-model="personnelForm.name" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">æ‰€å±¬å…¬å¸</label>
                                <input type="text" x-model="personnelForm.company" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">è­‰ç…§è™Ÿç¢¼</label>
                                <input type="text" x-model="personnelForm.license_no" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">é›»è©±</label>
                                <input type="text" x-model="personnelForm.phone" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Email</label>
                                <input type="email" x-model="personnelForm.email" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button @click="savePersonnel()" class="btn-primary text-white px-5 py-2 rounded-lg text-sm font-medium">æ–°å¢</button>
                            <button @click="showAddPersonnel = false" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 4: æ–‡ä»¶ç®¡ç† ========== -->
                <div x-show="activeTab === 'documents'" x-cloak>
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                            <h3 class="font-semibold text-gray-700">æ–‡ä»¶ç®¡ç†</h3>
                        </div>

                        <!-- ä¸Šå‚³å€ -->
                        <div class="p-5">
                            <div class="upload-zone rounded-lg p-6 text-center cursor-pointer"
                                 @click="$refs.docUploadInput.click()"
                                 @dragover.prevent="$event.currentTarget.classList.add('dragover')"
                                 @dragleave.prevent="$event.currentTarget.classList.remove('dragover')"
                                 @drop.prevent="handleDocUpload($event.dataTransfer.files)">
                                <svg class="w-10 h-10 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                <p class="text-sm text-gray-600">æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•æˆ–<span class="text-blue-600 font-medium">é»æ“Šé¸æ“‡</span></p>
                                <p class="text-xs text-gray-400 mt-1">æ”¯æ´ Word, Excel, PDF, åœ–ç‰‡ç­‰æ ¼å¼</p>
                                <input type="file" x-ref="docUploadInput" class="hidden" multiple @change="handleDocUpload($event.target.files)">
                            </div>
                        </div>

                        <!-- æ–‡ä»¶åˆ—è¡¨ -->
                        <div class="divide-y divide-gray-100">
                            <template x-if="!currentProject || !currentProject.documents || currentProject.documents.length === 0">
                                <div class="p-6 text-center text-gray-400 text-sm">å°šç„¡ä¸Šå‚³æ–‡ä»¶</div>
                            </template>
                            <template x-for="doc in (currentProject ? currentProject.documents || [] : [])" :key="doc.id">
                                <div class="p-4 flex items-center justify-between hover:bg-gray-50">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg"
                                             :class="{
                                                 'bg-blue-100': doc.original_filename.endsWith('.docx'),
                                                 'bg-green-100': doc.original_filename.endsWith('.xlsx') || doc.original_filename.endsWith('.xls'),
                                                 'bg-red-100': doc.original_filename.endsWith('.pdf'),
                                                 'bg-gray-100': true
                                             }">
                                            <span x-text="doc.original_filename.endsWith('.docx') ? 'ğŸ“' : doc.original_filename.endsWith('.xlsx') ? 'ğŸ“Š' : doc.original_filename.endsWith('.pdf') ? 'ğŸ“•' : 'ğŸ“'"></span>
                                        </div>
                                        <div>
                                            <div class="text-sm font-medium" x-text="doc.original_filename"></div>
                                            <div class="text-xs text-gray-500">
                                                <span x-text="doc.doc_type"></span> |
                                                <span x-text="formatFileSize(doc.file_size)"></span> |
                                                <span x-text="doc.uploaded_at ? doc.uploaded_at.substring(0,16) : ''"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <a :href="'/api/documents/' + currentProject.id + '/' + doc.stored_filename" download class="text-blue-600 hover:text-blue-800 text-sm">ä¸‹è¼‰</a>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 5: å¥‘ç´„è©³ç´°è¡¨ ========== -->
                <div x-show="activeTab === 'contract'" x-cloak>

                    <!-- ä¸Šå‚³å€ -->
                    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl p-5 mb-6 border border-emerald-200" x-show="currentProject">
                        <h3 class="text-sm font-semibold text-emerald-800 mb-2">ğŸ“Š ä¸Šå‚³å¥‘ç´„è©³ç´°è¡¨ Excel</h3>
                        <p class="text-xs text-emerald-600 mb-3">æ”¯æ´ .xls / .xlsx æ ¼å¼ï¼Œç³»çµ±æœƒè‡ªå‹•è§£æé …æ¬¡ã€é …ç›®ã€å–®ä½ã€æ•¸é‡ã€å–®åƒ¹ã€è¤‡åƒ¹ã€ç·¨ç¢¼</p>
                        <div class="flex items-center gap-3">
                            <div class="upload-zone flex-1 rounded-lg p-3 text-center cursor-pointer bg-white"
                                 @click="$refs.contractUploadInput.click()">
                                <p class="text-sm text-gray-600">é»æ“Šé¸æ“‡å¥‘ç´„æ›¸ Excel æª”æ¡ˆ</p>
                                <input type="file" x-ref="contractUploadInput" class="hidden" accept=".xls,.xlsx" @change="uploadContractXls($event)">
                            </div>
                            <div x-show="contractUploadStatus" class="text-sm" :class="contractUploadSuccess ? 'text-green-600' : 'text-red-600'" x-text="contractUploadStatus"></div>
                        </div>
                    </div>

                    <!-- æ‘˜è¦çµ±è¨ˆ -->
                    <div x-show="contractSummary" class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
                            <div class="text-2xl font-bold text-blue-600" x-text="contractSummary ? contractSummary.work_items : 0"></div>
                            <div class="text-xs text-gray-500">å·¥é …æ•¸</div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
                            <div class="text-2xl font-bold text-emerald-600" x-text="contractSummary ? contractSummary.categories : 0"></div>
                            <div class="text-xs text-gray-500">åˆ†é¡æ•¸</div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
                            <div class="text-2xl font-bold text-purple-600" x-text="contractSummary ? contractSummary.total_rows : 0"></div>
                            <div class="text-xs text-gray-500">ç¸½è¡Œæ•¸</div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
                            <div class="text-lg font-bold text-orange-600" x-text="contractSummary && contractSummary.grand_total ? formatMoney(contractSummary.grand_total) : '-'"></div>
                            <div class="text-xs text-gray-500">å¥‘ç´„ç¸½åƒ¹</div>
                        </div>
                    </div>

                    <!-- ç¯©é¸åˆ— -->
                    <div class="flex items-center gap-2 mb-3" x-show="contractItems.length > 0">
                        <input type="text" x-model="contractFilter" placeholder="æœå°‹é …ç›®åç¨±..." class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm flex-1 focus:ring-2 focus:ring-blue-500 outline-none">
                        <select x-model="contractLevelFilter" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">å…¨éƒ¨å±¤ç´š</option>
                            <option value="cat">åƒ…åˆ†é¡</option>
                            <option value="item">åƒ…å·¥é …</option>
                            <option value="sub">åƒ…å°è¨ˆ</option>
                        </select>
                        <button @click="showAddContractItem = !showAddContractItem" class="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            æ–°å¢é …ç›®
                        </button>
                    </div>

                    <!-- æ–°å¢é …ç›®è¡¨å–® -->
                    <div x-show="showAddContractItem" class="bg-white rounded-xl border border-gray-200 p-4 mb-4 fade-in">
                        <h4 class="font-semibold text-sm text-gray-700 mb-3">æ–°å¢å¥‘ç´„é …ç›®</h4>
                        <div class="grid grid-cols-6 gap-2">
                            <input type="text" x-model="newContractItem.item_number" placeholder="é …æ¬¡" class="border border-gray-300 rounded px-2 py-1.5 text-sm">
                            <input type="text" x-model="newContractItem.item_name" placeholder="é …ç›®åç¨± *" class="col-span-2 border border-gray-300 rounded px-2 py-1.5 text-sm">
                            <input type="text" x-model="newContractItem.unit" placeholder="å–®ä½" class="border border-gray-300 rounded px-2 py-1.5 text-sm">
                            <input type="number" x-model="newContractItem.quantity" placeholder="æ•¸é‡" class="border border-gray-300 rounded px-2 py-1.5 text-sm">
                            <input type="number" x-model="newContractItem.unit_price" placeholder="å–®åƒ¹" class="border border-gray-300 rounded px-2 py-1.5 text-sm">
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button @click="addNewContractItem()" class="btn-primary text-white px-4 py-1.5 rounded-lg text-sm">æ–°å¢</button>
                            <button @click="showAddContractItem = false" class="text-gray-500 hover:bg-gray-100 px-3 py-1.5 rounded-lg text-sm">å–æ¶ˆ</button>
                        </div>
                    </div>

                    <!-- å¥‘ç´„è©³ç´°è¡¨æ ¼ -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden" x-show="contractItems.length > 0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="px-3 py-2.5 text-left text-xs font-semibold text-gray-600 w-16">é …æ¬¡</th>
                                        <th class="px-3 py-2.5 text-left text-xs font-semibold text-gray-600">é …ç›®åŠèªªæ˜</th>
                                        <th class="px-3 py-2.5 text-center text-xs font-semibold text-gray-600 w-16">å–®ä½</th>
                                        <th class="px-3 py-2.5 text-right text-xs font-semibold text-gray-600 w-24">æ•¸é‡</th>
                                        <th class="px-3 py-2.5 text-right text-xs font-semibold text-gray-600 w-24">å–®åƒ¹</th>
                                        <th class="px-3 py-2.5 text-right text-xs font-semibold text-gray-600 w-28">è¤‡åƒ¹</th>
                                        <th class="px-3 py-2.5 text-center text-xs font-semibold text-gray-600 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <template x-for="item in filteredContractItems()" :key="item.id">
                                        <tr :class="{
                                            'bg-blue-50 font-semibold': item.is_category,
                                            'bg-amber-50 font-semibold': item.is_subtotal,
                                            'hover:bg-gray-50': !item.is_category && !item.is_subtotal
                                        }" class="transition-colors">
                                            <td class="px-3 py-2" :class="{'pl-' + (item.level * 3 + 3): true}">
                                                <span :class="{
                                                    'text-blue-700 font-bold': item.is_category,
                                                    'text-amber-700': item.is_subtotal
                                                }" x-text="item.item_number"></span>
                                            </td>
                                            <td class="px-3 py-2">
                                                <span x-show="editingItemId !== item.id" x-text="item.item_name" :class="{'text-blue-700': item.is_category, 'text-amber-700': item.is_subtotal}" class="cursor-pointer" @dblclick="startEditItem(item)"></span>
                                                <input x-show="editingItemId === item.id" type="text" x-model="editingItem.item_name" @keyup.enter="saveEditItem()" @keyup.escape="cancelEditItem()" class="w-full border border-blue-300 rounded px-2 py-1 text-sm">
                                            </td>
                                            <td class="px-3 py-2 text-center text-gray-600" x-text="item.unit"></td>
                                            <td class="px-3 py-2 text-right">
                                                <span x-show="editingItemId !== item.id" x-text="item.quantity != null ? formatNum(item.quantity) : ''" class="cursor-pointer" @dblclick="startEditItem(item)"></span>
                                                <input x-show="editingItemId === item.id" type="number" x-model="editingItem.quantity" @keyup.enter="saveEditItem()" class="w-20 border border-blue-300 rounded px-2 py-1 text-sm text-right">
                                            </td>
                                            <td class="px-3 py-2 text-right">
                                                <span x-show="editingItemId !== item.id" x-text="item.unit_price != null ? formatNum(item.unit_price) : ''" class="cursor-pointer" @dblclick="startEditItem(item)"></span>
                                                <input x-show="editingItemId === item.id" type="number" x-model="editingItem.unit_price" @keyup.enter="saveEditItem()" class="w-20 border border-blue-300 rounded px-2 py-1 text-sm text-right">
                                            </td>
                                            <td class="px-3 py-2 text-right font-medium" :class="{'text-blue-700': item.is_category || item.is_subtotal}" x-text="item.total_price != null ? formatMoney(item.total_price) : ''"></td>
                                            <td class="px-3 py-2 text-center">
                                                <div x-show="editingItemId === item.id" class="flex gap-1">
                                                    <button @click="saveEditItem()" class="text-green-600 hover:text-green-800" title="å„²å­˜">âœ”</button>
                                                    <button @click="cancelEditItem()" class="text-gray-400 hover:text-gray-600" title="å–æ¶ˆ">âœ–</button>
                                                </div>
                                                <button x-show="editingItemId !== item.id && !item.is_category && !item.is_subtotal" @click="deleteContractItem(item.id)" class="text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100" title="åˆªé™¤">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ç©ºç‹€æ…‹ -->
                    <div x-show="contractItems.length === 0 && currentProject" class="text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <p class="text-sm">å°šæœªåŒ¯å…¥å¥‘ç´„è©³ç´°è¡¨</p>
                        <p class="text-xs mt-1">è«‹ä¸Šå‚³å¥‘ç´„æ›¸ Excel æª”æ¡ˆ (.xls / .xlsx)</p>
                    </div>

                    <!-- å°è¨ˆæ‘˜è¦ -->
                    <div x-show="contractSummary && contractSummary.subtotals && contractSummary.subtotals.length > 0" class="mt-4 bg-white rounded-xl border border-gray-200 p-4">
                        <h4 class="font-semibold text-sm text-gray-700 mb-3">å„é¡å°è¨ˆ</h4>
                        <div class="space-y-2">
                            <template x-for="st in (contractSummary ? contractSummary.subtotals || [] : [])" :key="st.name">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600" x-text="st.name"></span>
                                    <span class="font-medium text-gray-800" x-text="st.amount ? formatMoney(st.amount) : '-'"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 6: æ–½å·¥æ—¥èªŒ ========== -->
                <div x-show="activeTab === 'dailylog'" x-cloak>

                    <!-- çµ±è¨ˆå¡ç‰‡ -->
                    <div class="grid grid-cols-4 gap-3 mb-4" x-show="logStats">
                        <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
                            <div class="text-2xl font-bold text-blue-600" x-text="logStats ? logStats.total_logs : 0"></div>
                            <div class="text-xs text-gray-500">ç¸½æ—¥èªŒæ•¸</div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
                            <div class="text-2xl font-bold text-green-600" x-text="logStats ? logStats.working_days : 0"></div>
                            <div class="text-xs text-gray-500">æ–½å·¥æ—¥</div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
                            <div class="text-2xl font-bold text-amber-600" x-text="logStats ? logStats.rain_stop_days : 0"></div>
                            <div class="text-xs text-gray-500">é›¨åœæ—¥</div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
                            <div class="text-2xl font-bold text-gray-500" x-text="logStats ? logStats.holiday_days : 0"></div>
                            <div class="text-xs text-gray-500">ä¼‘å‡æ—¥</div>
                        </div>
                    </div>

                    <!-- æ“ä½œåˆ— -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <input type="month" x-model="logMonth" @change="loadLogs()" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <button @click="logMonth=''; loadLogs()" class="text-gray-500 hover:bg-gray-100 px-2 py-1.5 rounded-lg text-xs">å…¨éƒ¨</button>
                        </div>
                        <button @click="openLogForm()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            æ–°å¢æ—¥èªŒ
                        </button>
                    </div>

                    <!-- æ—¥èªŒè¡¨å–®ï¼ˆæ–°å¢/ç·¨è¼¯ï¼‰ -->
                    <div x-show="showLogForm" class="bg-white rounded-xl border border-gray-200 p-5 mb-4 fade-in">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700" x-text="editingLogId ? 'ç·¨è¼¯æ–½å·¥æ—¥èªŒ' : 'æ–°å¢æ–½å·¥æ—¥èªŒ'"></h3>
                            <button @click="showLogForm = false" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>

                        <!-- æ—¥æœŸ + å¤©æ°£ + ç‹€æ…‹ -->
                        <div class="grid grid-cols-6 gap-3 mb-4">
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æ—¥æœŸ *</label>
                                <input type="date" x-model="logForm.log_date" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">ä¸Šåˆå¤©æ°£</label>
                                <select x-model="logForm.weather_am" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">--</option>
                                    <option value="æ™´">æ™´</option>
                                    <option value="å¤šé›²">å¤šé›²</option>
                                    <option value="é™°">é™°</option>
                                    <option value="å°é›¨">å°é›¨</option>
                                    <option value="å¤§é›¨">å¤§é›¨</option>
                                    <option value="æš´é›¨">æš´é›¨</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">ä¸‹åˆå¤©æ°£</label>
                                <select x-model="logForm.weather_pm" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">--</option>
                                    <option value="æ™´">æ™´</option>
                                    <option value="å¤šé›²">å¤šé›²</option>
                                    <option value="é™°">é™°</option>
                                    <option value="å°é›¨">å°é›¨</option>
                                    <option value="å¤§é›¨">å¤§é›¨</option>
                                    <option value="æš´é›¨">æš´é›¨</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æœ€é«˜æº« (Â°C)</label>
                                <input type="number" x-model="logForm.temperature_high" placeholder="32" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æœ€ä½æº« (Â°C)</label>
                                <input type="number" x-model="logForm.temperature_low" placeholder="25" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æ–½å·¥ç‹€æ…‹</label>
                                <select x-model="logForm.day_status" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="working">æ–½å·¥</option>
                                    <option value="rain_stop">é›¨åœ</option>
                                    <option value="holiday">ä¼‘å‡</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>

                        <!-- é€²åº¦ï¼ˆé™„è¡¨å››ï¼‰ -->
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">å¥‘ç´„å·¥æœŸ(å¤©)</label>
                                <input type="number" x-model="logForm.calendar_days" placeholder="" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æ–½å·¥å¤©æ•¸</label>
                                <input type="number" x-model="logForm.work_days" placeholder="" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">é å®šé€²åº¦ (%)</label>
                                <input type="number" x-model="logForm.scheduled_progress" step="0.1" placeholder="" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">å¯¦éš›é€²åº¦ (%)</label>
                                <input type="number" x-model="logForm.actual_progress" step="0.1" placeholder="" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>

                        <!-- æ–½å·¥æ¦‚æ³ -->
                        <div class="mb-4">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">æ–½å·¥æ¦‚æ³</label>
                            <textarea x-model="logForm.work_description" rows="3" placeholder="ä»Šæ—¥æ–½å·¥å…§å®¹æ¦‚è¿°..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        </div>

                        <!-- äººåŠ› -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-semibold text-gray-600">ğŸ‘· äººåŠ›é…ç½®</label>
                                <button @click="logForm.workers.push({trade:'', count:0, cumulative_count:0, company:''})" class="text-blue-600 text-xs hover:bg-blue-50 px-2 py-1 rounded">+ æ–°å¢</button>
                            </div>
                            <template x-for="(w, wi) in logForm.workers" :key="wi">
                                <div class="flex items-center gap-2 mb-1">
                                    <select x-model="w.trade" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-28">
                                        <option value="">å·¥ç¨®</option>
                                        <option value="å·¥åœ°ä¸»ä»»">å·¥åœ°ä¸»ä»»</option>
                                        <option value="å“ç®¡äººå“¡">å“ç®¡äººå“¡</option>
                                        <option value="å®‰è¡›äººå“¡">å®‰è¡›äººå“¡</option>
                                        <option value="æ¸¬é‡äººå“¡">æ¸¬é‡äººå“¡</option>
                                        <option value="é‹¼ç­‹å·¥">é‹¼ç­‹å·¥</option>
                                        <option value="æ¨¡æ¿å·¥">æ¨¡æ¿å·¥</option>
                                        <option value="æ··å‡åœŸå·¥">æ··å‡åœŸå·¥</option>
                                        <option value="æ°´é›»å·¥">æ°´é›»å·¥</option>
                                        <option value="æ©Ÿå…·æ“ä½œæ‰‹">æ©Ÿå…·æ“ä½œæ‰‹</option>
                                        <option value="æ™®é€šå·¥">æ™®é€šå·¥</option>
                                        <option value="é›œå·¥">é›œå·¥</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                    <input type="number" x-model="w.count" placeholder="æœ¬æ—¥äººæ•¸" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-20">
                                    <input type="number" x-model="w.cumulative_count" placeholder="ç´¯è¨ˆ" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-16">
                                    <input type="text" x-model="w.company" placeholder="å…¬å¸/ç­çµ„" class="border border-gray-300 rounded px-2 py-1.5 text-sm flex-1">
                                    <button @click="logForm.workers.splice(wi, 1)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </template>
                        </div>

                        <!-- æ©Ÿå…· -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-semibold text-gray-600">ğŸšœ æ©Ÿå…·ä½¿ç”¨</label>
                                <button @click="logForm.equipment.push({equipment_name:'', spec:'', count:1, hours:null})" class="text-blue-600 text-xs hover:bg-blue-50 px-2 py-1 rounded">+ æ–°å¢</button>
                            </div>
                            <template x-for="(eq, ei) in logForm.equipment" :key="ei">
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="text" x-model="eq.equipment_name" placeholder="æ©Ÿå…·åç¨±" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-32">
                                    <input type="text" x-model="eq.spec" placeholder="è¦æ ¼" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-24">
                                    <input type="number" x-model="eq.count" placeholder="æ•¸é‡" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-16">
                                    <input type="number" x-model="eq.hours" placeholder="æ™‚æ•¸" step="0.5" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-16">
                                    <button @click="logForm.equipment.splice(ei, 1)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </template>
                        </div>

                        <!-- ææ–™ -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-semibold text-gray-600">ğŸ“¦ ææ–™é€²å ´</label>
                                <button @click="logForm.materials.push({material_name:'', spec:'', unit:'', quantity:null, contract_quantity:null, cumulative_quantity:null, supplier:''})" class="text-blue-600 text-xs hover:bg-blue-50 px-2 py-1 rounded">+ æ–°å¢</button>
                            </div>
                            <template x-for="(m, mi) in logForm.materials" :key="mi">
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="text" x-model="m.material_name" placeholder="ææ–™åç¨±" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-24">
                                    <input type="text" x-model="m.unit" placeholder="å–®ä½" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-12">
                                    <input type="number" x-model="m.contract_quantity" placeholder="å¥‘ç´„æ•¸é‡" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-20">
                                    <input type="number" x-model="m.quantity" placeholder="æœ¬æ—¥ç”¨é‡" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-20">
                                    <input type="number" x-model="m.cumulative_quantity" placeholder="ç´¯è¨ˆç”¨é‡" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-20">
                                    <button @click="logForm.materials.splice(mi, 1)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </template>
                        </div>

                        <!-- æ–½å·¥é …ç›® -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-semibold text-gray-600">ğŸ”¨ æ–½å·¥é …ç›®</label>
                                <button @click="logForm.work_items.push({item_name:'', location:'', quantity:null, unit:'', progress_pct:null, notes:''})" class="text-blue-600 text-xs hover:bg-blue-50 px-2 py-1 rounded">+ æ–°å¢</button>
                            </div>
                            <template x-for="(wi, wii) in logForm.work_items" :key="wii">
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="text" x-model="wi.item_name" placeholder="æ–½å·¥é …ç›®" class="border border-gray-300 rounded px-2 py-1.5 text-sm flex-1">
                                    <input type="text" x-model="wi.location" placeholder="æ–½å·¥ä½ç½®" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-24">
                                    <input type="number" x-model="wi.quantity" placeholder="æ•¸é‡" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-16">
                                    <input type="text" x-model="wi.unit" placeholder="å–®ä½" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-14">
                                    <input type="number" x-model="wi.progress_pct" placeholder="é€²åº¦%" step="1" class="border border-gray-300 rounded px-2 py-1.5 text-sm w-16">
                                    <button @click="logForm.work_items.splice(wii, 1)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </template>
                        </div>

                        <!-- æŠ€è¡“å£«è¨­ç½®ï¼ˆé™„è¡¨å››ç¬¬å››é …ï¼‰ -->
                        <div class="mb-4">
                            <label class="text-xs font-semibold text-gray-600 mb-2 block">å››ã€æŠ€è¡“å£«è¨­ç½®</label>
                            <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                                <input type="checkbox" x-model="logForm.has_technician_required" class="rounded border-gray-300">
                                æœ¬æ—¥æ–½å·¥é …ç›®é ˆè¨­ç½®æŠ€è¡“å£«
                            </label>
                        </div>

                        <!-- å®‰å…¨è¡›ç”Ÿï¼ˆé™„è¡¨å››ç¬¬äº”é …ï¼‰ -->
                        <div class="mb-4">
                            <label class="text-xs font-semibold text-gray-600 mb-2 block">äº”ã€å·¥åœ°è·æ¥­å®‰å…¨è¡›ç”Ÿäº‹é …</label>
                            <div class="flex flex-wrap gap-4 mb-2">
                                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" x-model="logForm.safety_pretask_education" class="rounded border-gray-300">
                                    æ–½å·¥å‰å‹¤å‰æ•™è‚²
                                </label>
                                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" x-model="logForm.safety_insurance_check" class="rounded border-gray-300">
                                    å‹ä¿/å®‰è¡›æ•™è‚²ç¢ºèª
                                </label>
                                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" x-model="logForm.safety_ppe_check" class="rounded border-gray-300">
                                    å€‹äººé˜²è­·å…·æª¢æŸ¥
                                </label>
                            </div>
                            <textarea x-model="logForm.safety_notes" rows="2" placeholder="å…¶ä»–å®‰å…¨è¡›ç”Ÿäº‹é …..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        </div>

                        <!-- æ–½å·¥å–æ¨£è©¦é©—ï¼ˆé™„è¡¨å››ç¬¬å…­é …ï¼‰ -->
                        <div class="mb-4">
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">å…­ã€æ–½å·¥å–æ¨£è©¦é©—ç´€éŒ„</label>
                            <textarea x-model="logForm.sampling_test_notes" rows="2" placeholder="å–æ¨£è©¦é©—ç´€éŒ„..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        </div>

                        <!-- é€šçŸ¥å”åŠ›å» å•†ï¼ˆé™„è¡¨å››ç¬¬ä¸ƒé …ï¼‰ -->
                        <div class="mb-4">
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">ä¸ƒã€é€šçŸ¥å”åŠ›å» å•†è¾¦ç†äº‹é …</label>
                            <textarea x-model="logForm.subcontractor_notices" rows="2" placeholder="é€šçŸ¥å”åŠ›å» å•†äº‹é …..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        </div>

                        <!-- é‡è¦äº‹é …è¨˜éŒ„ï¼ˆé™„è¡¨å››ç¬¬å…«é …ï¼‰+ å“è³ª/å‚™è¨» -->
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">å…«ã€é‡è¦äº‹é …è¨˜éŒ„</label>
                                <textarea x-model="logForm.important_records" rows="2" placeholder="æ©Ÿé—œæŒ‡ç¤ºã€ç•°å¸¸è™•ç†..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">å“è³ªè¨˜éŒ„</label>
                                <textarea x-model="logForm.quality_notes" rows="2" placeholder="å“è³ªäº‹é …..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">å‚™è¨»</label>
                                <textarea x-model="logForm.notes" rows="2" placeholder="å…¶ä»–å‚™è¨»..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                            </div>
                        </div>

                        <!-- å„²å­˜æŒ‰éˆ• -->
                        <div class="flex gap-2">
                            <button @click="saveLog()" class="btn-primary text-white px-6 py-2 rounded-lg text-sm font-medium shadow-md" :disabled="logSaving">
                                <span x-show="!logSaving" x-text="editingLogId ? 'æ›´æ–°æ—¥èªŒ' : 'å„²å­˜æ—¥èªŒ'"></span>
                                <span x-show="logSaving">å„²å­˜ä¸­...</span>
                            </button>
                            <button @click="showLogForm = false" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm">å–æ¶ˆ</button>
                            <span x-show="logSaveMsg" class="text-sm self-center" :class="logSaveOk ? 'text-green-600' : 'text-red-600'" x-text="logSaveMsg"></span>
                        </div>
                    </div>

                    <!-- æ—¥èªŒåˆ—è¡¨ -->
                    <div class="space-y-3" x-show="!showLogForm">
                        <template x-if="dailyLogs.length === 0">
                            <div class="text-center py-12 text-gray-400">
                                <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                <p class="text-sm">å°šç„¡æ–½å·¥æ—¥èªŒ</p>
                                <p class="text-xs mt-1">é»æ“Šã€Œæ–°å¢æ—¥èªŒã€é–‹å§‹è¨˜éŒ„</p>
                            </div>
                        </template>
                        <template x-for="log in dailyLogs" :key="log.id">
                            <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" @click="openLogDetail(log.id)">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="text-center">
                                            <div class="text-lg font-bold text-gray-800" x-text="log.log_date ? log.log_date.substring(8,10) : ''"></div>
                                            <div class="text-xs text-gray-500" x-text="log.log_date ? log.log_date.substring(0,7) : ''"></div>
                                        </div>
                                        <div class="w-px h-10 bg-gray-200"></div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-xs px-2 py-0.5 rounded-full" :class="{
                                                    'bg-green-100 text-green-700': log.day_status === 'working',
                                                    'bg-amber-100 text-amber-700': log.day_status === 'rain_stop',
                                                    'bg-gray-100 text-gray-600': log.day_status === 'holiday',
                                                    'bg-blue-100 text-blue-700': log.day_status === 'other'
                                                }" x-text="{'working':'æ–½å·¥','rain_stop':'é›¨åœ','holiday':'ä¼‘å‡','other':'å…¶ä»–'}[log.day_status] || log.day_status"></span>
                                                <span class="text-xs text-gray-500" x-show="log.weather_am || log.weather_pm" x-text="(log.weather_am || '') + (log.weather_am && log.weather_pm ? '/' : '') + (log.weather_pm || '')"></span>
                                                <span class="text-xs text-gray-400" x-show="log.temperature_high" x-text="(log.temperature_low || '') + '~' + (log.temperature_high || '') + 'Â°C'"></span>
                                            </div>
                                            <div class="text-sm text-gray-700 line-clamp-1" x-text="log.work_description || '(ç„¡æ–½å·¥æ¦‚æ³)'"></div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4 text-xs text-gray-500">
                                        <span x-show="log.total_workers" x-text="'ğŸ‘· ' + (log.total_workers || 0) + 'äºº'"></span>
                                        <span x-show="log.equipment_count" x-text="'ğŸšœ ' + (log.equipment_count || 0) + 'å°'"></span>
                                        <span x-show="log.work_item_count" x-text="'ğŸ”¨ ' + (log.work_item_count || 0) + 'é …'"></span>
                                        <div class="flex gap-1">
                                            <button @click.stop="editLog(log.id)" class="text-blue-500 hover:text-blue-700 p-1" title="ç·¨è¼¯">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                            </button>
                                            <button @click.stop="deleteLog(log.id)" class="text-red-400 hover:text-red-600 p-1" title="åˆªé™¤">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- ========== TAB 7: è‡ªä¸»æª¢æŸ¥è¡¨ ========== -->
                <div x-show="activeTab === 'inspection'" x-cloak>

                    <!-- æª¢æŸ¥è¡¨è¡¨å–® -->
                    <div x-show="showInspectionForm" class="bg-white rounded-xl border border-gray-200 p-5 mb-4">
                        <h3 class="font-semibold text-gray-700 mb-4" x-text="editingInspectionId ? 'ç·¨è¼¯è‡ªä¸»æª¢æŸ¥è¡¨' : 'æ–°å¢è‡ªä¸»æª¢æŸ¥è¡¨'"></h3>

                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æª¢æŸ¥è¡¨åç¨± *</label>
                                <input type="text" x-model="inspForm.checklist_name" placeholder="ä¾‹ï¼šé‹¼ç­‹ç¶ç´®è‡ªä¸»æª¢æŸ¥" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">åˆ†é …å·¥ç¨‹</label>
                                <input type="text" x-model="inspForm.sub_project" placeholder="ä¾‹ï¼šçµæ§‹å·¥ç¨‹" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æª¢æŸ¥æ—¥æœŸ</label>
                                <input type="date" x-model="inspForm.inspection_date" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æ‰¿æ”¬å» å•†</label>
                                <input type="text" x-model="inspForm.contractor" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">æª¢æŸ¥ä½ç½®</label>
                                <input type="text" x-model="inspForm.inspection_location" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">ç‹€æ…‹</label>
                                <select x-model="inspForm.status" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="draft">è‰ç¨¿</option>
                                    <option value="checked">å·²æª¢æŸ¥</option>
                                    <option value="approved">å·²æ ¸å‡†</option>
                                </select>
                            </div>
                        </div>

                        <!-- æª¢æŸ¥é …ç›® -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-semibold text-gray-600">æª¢æŸ¥é …ç›®</label>
                                <button @click="inspForm.items.push({phase:'during', item_name:'', check_standard:'', actual_result:'', check_result:''})" class="text-blue-600 text-xs hover:bg-blue-50 px-2 py-1 rounded">+ æ–°å¢é …ç›®</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border border-gray-200 rounded">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-2 py-1.5 text-left text-xs font-medium text-gray-500 w-20">æ™‚æ©Ÿ</th>
                                            <th class="px-2 py-1.5 text-left text-xs font-medium text-gray-500">æª¢æŸ¥é …ç›®</th>
                                            <th class="px-2 py-1.5 text-left text-xs font-medium text-gray-500">æª¢æŸ¥æ¨™æº–</th>
                                            <th class="px-2 py-1.5 text-left text-xs font-medium text-gray-500">å¯¦éš›æª¢æŸ¥æƒ…å½¢</th>
                                            <th class="px-2 py-1.5 text-left text-xs font-medium text-gray-500 w-16">çµæœ</th>
                                            <th class="w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(item, idx) in inspForm.items" :key="idx">
                                            <tr class="border-t border-gray-100">
                                                <td class="px-1 py-1">
                                                    <select x-model="item.phase" class="border border-gray-300 rounded px-1 py-1 text-xs w-full">
                                                        <option value="before">æ–½å·¥å‰</option>
                                                        <option value="during">æ–½å·¥ä¸­</option>
                                                        <option value="after">æ–½å·¥å¾Œ</option>
                                                    </select>
                                                </td>
                                                <td class="px-1 py-1"><input type="text" x-model="item.item_name" class="border border-gray-300 rounded px-2 py-1 text-xs w-full"></td>
                                                <td class="px-1 py-1"><input type="text" x-model="item.check_standard" class="border border-gray-300 rounded px-2 py-1 text-xs w-full"></td>
                                                <td class="px-1 py-1"><input type="text" x-model="item.actual_result" class="border border-gray-300 rounded px-2 py-1 text-xs w-full"></td>
                                                <td class="px-1 py-1">
                                                    <select x-model="item.check_result" class="border border-gray-300 rounded px-1 py-1 text-xs w-full">
                                                        <option value="">--</option>
                                                        <option value="pass">â—‹</option>
                                                        <option value="fail">â•³</option>
                                                    </select>
                                                </td>
                                                <td class="px-1 py-1"><button @click="inspForm.items.splice(idx,1)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- å®‰å…¨è¡›ç”ŸæŸ¥é©— -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-semibold text-gray-600">å®‰å…¨è¡›ç”ŸæŸ¥é©—é»</label>
                                <button @click="inspForm.safety_items.push({phase:'during', description:'', check_result:''})" class="text-blue-600 text-xs hover:bg-blue-50 px-2 py-1 rounded">+ æ–°å¢</button>
                            </div>
                            <template x-for="(s, si) in inspForm.safety_items" :key="si">
                                <div class="flex items-center gap-2 mb-1">
                                    <select x-model="s.phase" class="border border-gray-300 rounded px-2 py-1.5 text-xs w-20">
                                        <option value="before">æ–½å·¥å‰</option>
                                        <option value="during">æ–½å·¥ä¸­</option>
                                        <option value="after">æ–½å·¥å¾Œ</option>
                                    </select>
                                    <input type="text" x-model="s.description" placeholder="å®‰å…¨è¡›ç”ŸæŸ¥é©—èªªæ˜" class="border border-gray-300 rounded px-2 py-1.5 text-xs flex-1">
                                    <select x-model="s.check_result" class="border border-gray-300 rounded px-2 py-1.5 text-xs w-16">
                                        <option value="">--</option>
                                        <option value="pass">â—‹</option>
                                        <option value="fail">â•³</option>
                                    </select>
                                    <button @click="inspForm.safety_items.splice(si,1)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </template>
                        </div>

                        <!-- ç¼ºå¤±è¤‡æŸ¥ -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-semibold text-gray-600">ç¼ºå¤±è¤‡æŸ¥çµæœ</label>
                                <button @click="inspForm.deficiencies.push({phase:'during', is_resolved:false, tracking_number:'', notes:''})" class="text-blue-600 text-xs hover:bg-blue-50 px-2 py-1 rounded">+ æ–°å¢</button>
                            </div>
                            <template x-for="(d, di) in inspForm.deficiencies" :key="di">
                                <div class="flex items-center gap-2 mb-1">
                                    <select x-model="d.phase" class="border border-gray-300 rounded px-2 py-1.5 text-xs w-20">
                                        <option value="before">æ–½å·¥å‰</option>
                                        <option value="during">æ–½å·¥ä¸­</option>
                                        <option value="after">æ–½å·¥å¾Œ</option>
                                    </select>
                                    <label class="inline-flex items-center gap-1 text-xs">
                                        <input type="checkbox" x-model="d.is_resolved" class="rounded border-gray-300">
                                        å·²æ”¹å–„
                                    </label>
                                    <input type="text" x-model="d.tracking_number" placeholder="è¿½è¹¤ç·¨è™Ÿ" class="border border-gray-300 rounded px-2 py-1.5 text-xs w-24">
                                    <input type="text" x-model="d.notes" placeholder="å‚™è¨»" class="border border-gray-300 rounded px-2 py-1.5 text-xs flex-1">
                                    <button @click="inspForm.deficiencies.splice(di,1)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </template>
                        </div>

                        <div class="mb-4">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">å‚™è¨»</label>
                            <textarea x-model="inspForm.notes" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        </div>

                        <div class="flex gap-2">
                            <button @click="saveInspection()" class="btn-primary text-white px-6 py-2 rounded-lg text-sm font-medium shadow-md" :disabled="inspSaving">
                                <span x-show="!inspSaving" x-text="editingInspectionId ? 'æ›´æ–°' : 'å„²å­˜'"></span>
                                <span x-show="inspSaving">å„²å­˜ä¸­...</span>
                            </button>
                            <button @click="showInspectionForm = false" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm">å–æ¶ˆ</button>
                            <span x-show="inspSaveMsg" class="text-sm self-center" :class="inspSaveOk ? 'text-green-600' : 'text-red-600'" x-text="inspSaveMsg"></span>
                        </div>
                    </div>

                    <!-- æª¢æŸ¥è¡¨åˆ—è¡¨ -->
                    <div x-show="!showInspectionForm">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">è‡ªä¸»æª¢æŸ¥è¡¨</h3>
                            <button @click="openInspectionForm()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                æ–°å¢æª¢æŸ¥è¡¨
                            </button>
                        </div>
                        <template x-if="inspections.length === 0">
                            <div class="text-center py-12 text-gray-400">
                                <p class="text-sm">å°šç„¡è‡ªä¸»æª¢æŸ¥è¡¨</p>
                            </div>
                        </template>
                        <div class="space-y-2">
                            <template x-for="insp in inspections" :key="insp.id">
                                <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-center justify-between">
                                        <div class="cursor-pointer flex-1" @click="editInspection(insp.id)">
                                            <div class="font-medium text-gray-800" x-text="insp.checklist_name"></div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                <span x-text="insp.inspection_date || 'æœªè¨­å®šæ—¥æœŸ'"></span>
                                                <span class="mx-1">|</span>
                                                <span x-text="insp.sub_project || ''"></span>
                                                <span class="mx-1">|</span>
                                                <span x-text="(insp.item_count || 0) + ' é …'"></span>
                                                <span class="ml-2 px-1.5 py-0.5 rounded text-xs" :class="insp.status === 'approved' ? 'bg-green-100 text-green-700' : insp.status === 'checked' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'" x-text="insp.status === 'approved' ? 'å·²æ ¸å‡†' : insp.status === 'checked' ? 'å·²æª¢æŸ¥' : 'è‰ç¨¿'"></span>
                                            </div>
                                        </div>
                                        <button @click="deleteInspection(insp.id)" class="text-red-400 hover:text-red-600 ml-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 8: æ‹ç…§è¨˜éŒ„è¡¨ ========== -->
                <div x-show="activeTab === 'photorecord'" x-cloak>

                    <!-- æ‹ç…§è¨˜éŒ„è¡¨å–® -->
                    <div x-show="showPhotoForm" class="bg-white rounded-xl border border-gray-200 p-5 mb-4">
                        <h3 class="font-semibold text-gray-700 mb-4" x-text="editingPhotoId ? 'ç·¨è¼¯æ‹ç…§è¨˜éŒ„è¡¨' : 'æ–°å¢æ‹ç…§è¨˜éŒ„è¡¨'"></h3>

                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">è¨˜éŒ„æ¨™é¡Œ</label>
                                <input type="text" x-model="photoForm.record_title" placeholder="ä¾‹ï¼šåŸºç¤é–‹æŒ–æ‹ç…§è¨˜éŒ„" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">è¨˜éŒ„æ—¥æœŸ</label>
                                <input type="date" x-model="photoForm.record_date" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-600 mb-1 block">ç‹€æ…‹</label>
                                <select x-model="photoForm.status" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="draft">è‰ç¨¿</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                </select>
                            </div>
                        </div>

                        <!-- ç…§ç‰‡é …ç›® -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-semibold text-gray-600">ç…§ç‰‡é …ç›®</label>
                                <button @click="photoForm.items.push({photo_date:'', location:'', item_name:'', design_value:'', measured_value:'', photo_path:'', notes:''})" class="text-blue-600 text-xs hover:bg-blue-50 px-2 py-1 rounded">+ æ–°å¢é …ç›®</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <template x-for="(pi, pii) in photoForm.items" :key="pii">
                                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 relative">
                                        <button @click="photoForm.items.splice(pii,1)" class="absolute top-2 right-2 text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                        <div class="text-xs font-medium text-gray-500 mb-2" x-text="'#' + (pii+1)"></div>
                                        <div class="grid grid-cols-2 gap-2 mb-2">
                                            <div>
                                                <label class="text-xs text-gray-500">æ—¥æœŸ</label>
                                                <input type="date" x-model="pi.photo_date" class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-500">ä½ç½®</label>
                                                <input type="text" x-model="pi.location" class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="text-xs text-gray-500">é …ç›®</label>
                                            <input type="text" x-model="pi.item_name" class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 mb-2">
                                            <div>
                                                <label class="text-xs text-gray-500">è¨­è¨ˆå€¼</label>
                                                <input type="text" x-model="pi.design_value" class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-500">æ¸¬é‡å€¼</label>
                                                <input type="text" x-model="pi.measured_value" class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">å‚™è¨»</label>
                                            <input type="text" x-model="pi.notes" class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button @click="savePhotoRecord()" class="btn-primary text-white px-6 py-2 rounded-lg text-sm font-medium shadow-md" :disabled="photoSaving">
                                <span x-show="!photoSaving" x-text="editingPhotoId ? 'æ›´æ–°' : 'å„²å­˜'"></span>
                                <span x-show="photoSaving">å„²å­˜ä¸­...</span>
                            </button>
                            <button @click="showPhotoForm = false" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm">å–æ¶ˆ</button>
                            <span x-show="photoSaveMsg" class="text-sm self-center" :class="photoSaveOk ? 'text-green-600' : 'text-red-600'" x-text="photoSaveMsg"></span>
                        </div>
                    </div>

                    <!-- æ‹ç…§è¨˜éŒ„åˆ—è¡¨ -->
                    <div x-show="!showPhotoForm">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">æ‹ç…§è¨˜éŒ„è¡¨</h3>
                            <button @click="openPhotoForm()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                æ–°å¢è¨˜éŒ„
                            </button>
                        </div>
                        <template x-if="photoRecords.length === 0">
                            <div class="text-center py-12 text-gray-400">
                                <p class="text-sm">å°šç„¡æ‹ç…§è¨˜éŒ„</p>
                            </div>
                        </template>
                        <div class="space-y-2">
                            <template x-for="pr in photoRecords" :key="pr.id">
                                <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-center justify-between">
                                        <div class="cursor-pointer flex-1" @click="editPhotoRecord(pr.id)">
                                            <div class="font-medium text-gray-800" x-text="pr.record_title || 'æœªå‘½åè¨˜éŒ„'"></div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                <span x-text="pr.record_date || 'æœªè¨­å®šæ—¥æœŸ'"></span>
                                                <span class="mx-1">|</span>
                                                <span x-text="(pr.item_count || 0) + ' å¼µç…§ç‰‡'"></span>
                                                <span class="ml-2 px-1.5 py-0.5 rounded text-xs" :class="pr.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'" x-text="pr.status === 'completed' ? 'å·²å®Œæˆ' : 'è‰ç¨¿'"></span>
                                            </div>
                                        </div>
                                        <button @click="deletePhotoRecord(pr.id)" class="text-red-400 hover:text-red-600 ml-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 9: é€²åº¦ç®¡ç† ========== -->
                <div x-show="activeTab === 'progress'" x-cloak>

                    <!-- å­åˆ†é åˆ‡æ› -->
                    <div class="flex gap-2 mb-4">
                        <button @click="progressSubTab = 'schedule'" :class="progressSubTab === 'schedule' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
                            æ–½å·¥ç¶²åœ–
                        </button>
                        <button @click="progressSubTab = 'scurve'; loadScurve()" :class="progressSubTab === 'scurve' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all">
                            S-Curve é€²åº¦æ›²ç·š
                        </button>
                    </div>

                    <!-- æ–½å·¥ç¶²åœ– -->
                    <div x-show="progressSubTab === 'schedule'">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">æ–½å·¥ç¶²åœ–ä»»å‹™ <span class="text-xs text-gray-400 font-normal" x-text="scheduleTasks.length + ' é …'"></span></h3>
                        </div>
                        <template x-if="scheduleTasks.length === 0">
                            <div class="text-center py-12 text-gray-400">
                                <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
                                <p class="text-sm">å°šæœªåŒ¯å…¥æ–½å·¥ç¶²åœ–</p>
                                <p class="text-xs mt-1">è«‹é€é API åŒ¯å…¥æ–½å·¥ç¶²åœ– PDF è³‡æ–™</p>
                            </div>
                        </template>
                        <div x-show="scheduleTasks.length > 0" class="overflow-x-auto">
                            <table class="w-full text-sm border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-10">#</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-16">WBS</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">ä»»å‹™åç¨±</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-16">å·¥æœŸ</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-24">æœ€æ—©é–‹å§‹</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-24">æœ€æ—©å®Œæˆ</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-16">å‰ç½®</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="t in scheduleTasks" :key="t.id">
                                        <tr class="border-t border-gray-100 hover:bg-gray-50">
                                            <td class="px-2 py-1.5 text-xs text-gray-500" x-text="t.task_id"></td>
                                            <td class="px-2 py-1.5 text-xs font-mono" x-text="t.wbs"></td>
                                            <td class="px-2 py-1.5 text-sm" :class="t.wbs && t.wbs.split('.').length <= 2 ? 'font-semibold text-gray-800' : 'text-gray-600 pl-4'" x-text="t.task_name"></td>
                                            <td class="px-2 py-1.5 text-xs text-center" x-text="t.duration_days ? t.duration_days + 'å¤©' : ''"></td>
                                            <td class="px-2 py-1.5 text-xs text-gray-500" x-text="t.early_start"></td>
                                            <td class="px-2 py-1.5 text-xs text-gray-500" x-text="t.early_finish"></td>
                                            <td class="px-2 py-1.5 text-xs text-gray-400" x-text="t.predecessors"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- S-Curve -->
                    <div x-show="progressSubTab === 'scurve'">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">S-Curve é€²åº¦æ›²ç·š</h3>
                        </div>

                        <!-- S-Curve å·¥ä½œé …ç›® -->
                        <div x-show="scurveData.items && scurveData.items.length > 0" class="mb-6">
                            <h4 class="text-xs font-semibold text-gray-500 mb-2">å·¥ä½œé …ç›®æ¬Šé‡</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border border-gray-200 rounded">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-1.5 text-left text-xs font-medium text-gray-500">é …æ¬¡</th>
                                            <th class="px-3 py-1.5 text-left text-xs font-medium text-gray-500">å·¥ä½œé …ç›®</th>
                                            <th class="px-3 py-1.5 text-right text-xs font-medium text-gray-500">é‡‘é¡(å…ƒ)</th>
                                            <th class="px-3 py-1.5 text-right text-xs font-medium text-gray-500">æ¬Šé‡(%)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="it in scurveData.items" :key="it.id">
                                            <tr class="border-t border-gray-100">
                                                <td class="px-3 py-1 text-xs font-mono" x-text="it.item_code"></td>
                                                <td class="px-3 py-1 text-sm" x-text="it.item_name"></td>
                                                <td class="px-3 py-1 text-xs text-right" x-text="it.amount ? Number(it.amount).toLocaleString() : ''"></td>
                                                <td class="px-3 py-1 text-xs text-right" x-text="it.weight_pct ? it.weight_pct.toFixed(2) + '%' : ''"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- S-Curve æœˆé€²åº¦è¡¨ -->
                        <div x-show="scurveData.monthly && scurveData.monthly.length > 0">
                            <h4 class="text-xs font-semibold text-gray-500 mb-2">æœˆé€²åº¦å°ç…§è¡¨</h4>
                            <div class="overflow-x-auto">
                                <table class="text-xs border border-gray-200 rounded">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-2 py-1.5 text-left font-medium text-gray-500 sticky left-0 bg-gray-50">æœˆä»½</th>
                                            <th class="px-2 py-1.5 text-right font-medium text-gray-500">ç´¯è¨ˆå·¥æœŸ</th>
                                            <th class="px-2 py-1.5 text-right font-medium text-gray-500">å·¥æœŸ%</th>
                                            <th class="px-2 py-1.5 text-right font-medium text-blue-600">é å®šç´¯è¨ˆ%</th>
                                            <th class="px-2 py-1.5 text-right font-medium text-green-600">å¯¦éš›ç´¯è¨ˆ%</th>
                                            <th class="px-2 py-1.5 text-right font-medium text-gray-500">å·®ç•°</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="m in scurveData.monthly" :key="m.id">
                                            <tr class="border-t border-gray-100 hover:bg-gray-50">
                                                <td class="px-2 py-1 font-medium sticky left-0 bg-white" x-text="m.year_month"></td>
                                                <td class="px-2 py-1 text-right" x-text="m.cumulative_days"></td>
                                                <td class="px-2 py-1 text-right" x-text="m.cumulative_days_pct ? m.cumulative_days_pct.toFixed(1) + '%' : ''"></td>
                                                <td class="px-2 py-1 text-right text-blue-600 font-medium" x-text="m.planned_cumulative ? m.planned_cumulative.toFixed(2) + '%' : ''"></td>
                                                <td class="px-2 py-1 text-right text-green-600 font-medium" x-text="m.actual_cumulative ? m.actual_cumulative.toFixed(2) + '%' : '-'"></td>
                                                <td class="px-2 py-1 text-right" :class="(m.actual_cumulative - m.planned_cumulative) >= 0 ? 'text-green-600' : 'text-red-600'" x-text="m.actual_cumulative ? ((m.actual_cumulative - m.planned_cumulative).toFixed(2) + '%') : ''"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <template x-if="(!scurveData.items || scurveData.items.length === 0) && (!scurveData.monthly || scurveData.monthly.length === 0)">
                            <div class="text-center py-12 text-gray-400">
                                <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                                <p class="text-sm">å°šæœªåŒ¯å…¥ S-Curve è³‡æ–™</p>
                                <p class="text-xs mt-1">è«‹é€é API åŒ¯å…¥ S-Curve PDF è³‡æ–™</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- ========== TAB 10: ç®¡åˆ¶è¡¨ ========== -->
                <div x-show="activeTab === 'controls'" x-cloak>
                    <div class="flex gap-2 mb-4">
                        <button @click="controlSubTab = 'submittal'" :class="controlSubTab === 'submittal' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all">é€å¯©ç®¡åˆ¶</button>
                        <button @click="controlSubTab = 'test'; loadTests()" :class="controlSubTab === 'test' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all">æª¢è©¦é©—ç®¡åˆ¶</button>
                    </div>

                    <!-- é€å¯©ç®¡åˆ¶ -->
                    <div x-show="controlSubTab === 'submittal'">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">é€å¯©ç®¡åˆ¶è¡¨ <span class="text-xs text-gray-400 font-normal" x-text="submittals.length + ' é …'"></span></h3>
                            <button @click="showSubmittalForm = true; submittalForm = {plan_name:'',submit_date:'',review_date:'',approval_date:'',status:'pending',reviewer:'',notes:''}" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700">+ æ–°å¢</button>
                        </div>

                        <!-- é€å¯©è¡¨å–® -->
                        <div x-show="showSubmittalForm" class="bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200">
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div><label class="text-xs text-gray-500">è¨ˆç•«åç¨± *</label><input x-model="submittalForm.plan_name" class="w-full px-3 py-1.5 border rounded text-sm" placeholder="è¨ˆç•«åç¨±"></div>
                                <div><label class="text-xs text-gray-500">ç‹€æ…‹</label><select x-model="submittalForm.status" class="w-full px-3 py-1.5 border rounded text-sm"><option value="pending">å¾…é€å¯©</option><option value="submitted">å·²é€å¯©</option><option value="reviewing">å¯©æŸ¥ä¸­</option><option value="approved">å·²æ ¸å®š</option><option value="rejected">é€€å›</option></select></div>
                                <div><label class="text-xs text-gray-500">é€å¯©æ—¥æœŸ</label><input x-model="submittalForm.submit_date" type="date" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">æ ¸å®šæ—¥æœŸ</label><input x-model="submittalForm.approval_date" type="date" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">å¯©æŸ¥äºº</label><input x-model="submittalForm.reviewer" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">å‚™è¨»</label><input x-model="submittalForm.notes" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="saveSubmittal()" class="px-4 py-1.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">å„²å­˜</button>
                                <button @click="showSubmittalForm = false" class="px-4 py-1.5 bg-gray-200 text-gray-600 text-xs rounded hover:bg-gray-300">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <template x-if="submittals.length === 0 && !showSubmittalForm">
                            <div class="text-center py-10 text-gray-400"><p class="text-sm">å°šç„¡é€å¯©ç®¡åˆ¶è³‡æ–™</p></div>
                        </template>
                        <div x-show="submittals.length > 0" class="overflow-x-auto">
                            <table class="w-full text-sm border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50"><tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-8">#</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">è¨ˆç•«åç¨±</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-24">é€å¯©æ—¥æœŸ</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-24">æ ¸å®šæ—¥æœŸ</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-16">ç‹€æ…‹</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-16">æ“ä½œ</th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="(s, idx) in submittals" :key="s.id">
                                        <tr class="border-t border-gray-100 hover:bg-gray-50">
                                            <td class="px-2 py-1.5 text-xs text-gray-400" x-text="idx+1"></td>
                                            <td class="px-2 py-1.5" x-text="s.plan_name"></td>
                                            <td class="px-2 py-1.5 text-xs" x-text="s.submit_date"></td>
                                            <td class="px-2 py-1.5 text-xs" x-text="s.approval_date"></td>
                                            <td class="px-2 py-1.5"><span class="text-xs px-1.5 py-0.5 rounded-full" :class="s.status==='approved'?'bg-green-100 text-green-700':s.status==='rejected'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'" x-text="s.status==='approved'?'å·²æ ¸å®š':s.status==='submitted'?'å·²é€å¯©':s.status==='reviewing'?'å¯©æŸ¥ä¸­':s.status==='rejected'?'é€€å›':'å¾…é€å¯©'"></span></td>
                                            <td class="px-2 py-1.5"><button @click="deleteSubmittal(s.id)" class="text-red-400 hover:text-red-600 text-xs">åˆªé™¤</button></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- æª¢è©¦é©—ç®¡åˆ¶ -->
                    <div x-show="controlSubTab === 'test'">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">æª¢è©¦é©—ç®¡åˆ¶ç¸½è¡¨ <span class="text-xs text-gray-400 font-normal" x-text="testControls.length + ' é …'"></span></h3>
                        </div>
                        <template x-if="testControls.length === 0">
                            <div class="text-center py-10 text-gray-400"><p class="text-sm">å°šç„¡æª¢è©¦é©—ç®¡åˆ¶è³‡æ–™</p><p class="text-xs mt-1">è«‹é€é API åŒ¯å…¥è³‡æ–™</p></div>
                        </template>
                        <div x-show="testControls.length > 0" class="overflow-x-auto">
                            <table class="w-full text-xs border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50"><tr>
                                    <th class="px-2 py-1.5 text-left font-medium text-gray-500 w-8">#</th>
                                    <th class="px-2 py-1.5 text-left font-medium text-gray-500">ææ–™åç¨±</th>
                                    <th class="px-2 py-1.5 text-left font-medium text-gray-500 w-20">é å®šæ—¥æœŸ</th>
                                    <th class="px-2 py-1.5 text-left font-medium text-gray-500 w-20">å¯¦éš›æ—¥æœŸ</th>
                                    <th class="px-2 py-1.5 text-left font-medium text-gray-500 w-14">æ•¸é‡</th>
                                    <th class="px-2 py-1.5 text-left font-medium text-gray-500 w-14">çµæœ</th>
                                    <th class="px-2 py-1.5 text-left font-medium text-gray-500">æª¢é©—äºº</th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="(t, idx) in testControls" :key="t.id">
                                        <tr class="border-t border-gray-100 hover:bg-gray-50">
                                            <td class="px-2 py-1 text-gray-400" x-text="t.seq || idx+1"></td>
                                            <td class="px-2 py-1" x-text="t.material_name"></td>
                                            <td class="px-2 py-1" x-text="t.planned_date"></td>
                                            <td class="px-2 py-1" x-text="t.actual_date"></td>
                                            <td class="px-2 py-1" x-text="t.quantity"></td>
                                            <td class="px-2 py-1"><span :class="t.test_result==='åˆæ ¼'?'text-green-600':'text-red-600'" x-text="t.test_result"></span></td>
                                            <td class="px-2 py-1 text-gray-500" x-text="t.inspector"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 11: ç‰¹è¨‚æ¢æ¬¾ ========== -->
                <div x-show="activeTab === 'specialterms'" x-cloak>
                    <div class="flex items-center gap-3 mb-4">
                        <h3 class="font-semibold text-gray-700">ç‰¹è¨‚æ¢æ¬¾ <span class="text-xs text-gray-400 font-normal" x-text="specialTermsList.length + ' æ®µ'"></span></h3>
                        <div class="flex-1 relative">
                            <input x-model="stSearchQuery" @keyup.enter="searchSpecialTerms()" class="w-full px-3 py-2 pl-9 border rounded-lg text-sm" placeholder="æœå°‹æ¢æ¬¾å…§å®¹ï¼ˆå¦‚ï¼šå®‰å…¨è¡›ç”Ÿã€äº¤é€šç¶­æŒã€å“è³ªç®¡åˆ¶...ï¼‰">
                            <svg class="w-4 h-4 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                        <button @click="searchSpecialTerms()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">æœå°‹</button>
                        <button x-show="stSearchResults.length > 0" @click="stSearchResults = []; stSearchQuery = ''" class="px-3 py-2 bg-gray-200 text-gray-600 text-sm rounded-lg hover:bg-gray-300">æ¸…é™¤</button>
                    </div>

                    <!-- æœå°‹çµæœ -->
                    <div x-show="stSearchResults.length > 0" class="mb-4">
                        <p class="text-xs text-gray-500 mb-2">æ‰¾åˆ° <span class="font-medium text-blue-600" x-text="stSearchResults.length"></span> ç­†ç¬¦åˆã€Œ<span class="font-medium" x-text="stSearchQuery"></span>ã€çš„çµæœ</p>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="r in stSearchResults" :key="r.id">
                                <div @click="viewSpecialTerm(r.id)" class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg cursor-pointer hover:bg-yellow-100 transition-colors">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-gray-600" x-text="r.title"></span>
                                        <span class="text-xs text-gray-400" x-text="'P' + r.page_start + '-' + r.page_end"></span>
                                    </div>
                                    <p class="text-sm text-gray-700 leading-relaxed" x-html="r.snippet.replace(new RegExp(stSearchQuery, 'g'), '<mark class=\'bg-yellow-300 px-0.5 rounded\'>' + stSearchQuery + '</mark>')"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- æ¢æ¬¾è©³ç´°å…§å®¹ -->
                    <div x-show="selectedTerm" class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700" x-text="selectedTerm?.title"></h4>
                            <button @click="selectedTerm = null" class="text-xs text-gray-400 hover:text-gray-600">âœ• é—œé–‰</button>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border text-sm text-gray-700 leading-relaxed max-h-96 overflow-y-auto whitespace-pre-wrap" x-text="selectedTerm?.content"></div>
                    </div>

                    <!-- æ¢æ¬¾åˆ—è¡¨ -->
                    <template x-if="specialTermsList.length === 0 && stSearchResults.length === 0">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <p class="text-sm">å°šæœªåŒ¯å…¥ç‰¹è¨‚æ¢æ¬¾</p>
                            <p class="text-xs mt-1">è«‹é€é API åŒ¯å…¥ç‰¹è¨‚æ¢æ¬¾ PDF è§£æè³‡æ–™</p>
                        </div>
                    </template>
                    <div x-show="specialTermsList.length > 0 && stSearchResults.length === 0 && !selectedTerm" class="overflow-x-auto">
                        <table class="w-full text-sm border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-10">#</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">æ®µè½</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-20">é ç¢¼</th>
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-16">å­—æ•¸</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-12">æŸ¥çœ‹</th>
                            </tr></thead>
                            <tbody>
                                <template x-for="t in specialTermsList" :key="t.id">
                                    <tr class="border-t border-gray-100 hover:bg-gray-50">
                                        <td class="px-2 py-1.5 text-xs text-gray-400" x-text="t.seq"></td>
                                        <td class="px-2 py-1.5" x-text="t.title"></td>
                                        <td class="px-2 py-1.5 text-xs text-gray-500" x-text="'P' + t.page_start + '-' + t.page_end"></td>
                                        <td class="px-2 py-1.5 text-right text-xs text-gray-400" x-text="t.content_len"></td>
                                        <td class="px-2 py-1.5"><button @click="viewSpecialTerm(t.id)" class="text-blue-500 hover:text-blue-700 text-xs">æŸ¥çœ‹</button></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ========== TAB 12: æ–½å·¥æŠ€è¡“è¦ç¯„ ========== -->
                <div x-show="activeTab === 'techspecs'" x-cloak>
                    <div class="flex items-center gap-3 mb-4">
                        <h3 class="font-semibold text-gray-700">æ–½å·¥æŠ€è¡“è¦ç¯„ <span class="text-xs text-gray-400 font-normal" x-text="techSpecsList.length + ' æ®µ (Part1+2+3, 880é )'"></span></h3>
                        <div class="flex-1 relative">
                            <input x-model="tsSearchQuery" @keyup.enter="searchTechSpecs()" class="w-full px-3 py-2 pl-9 border rounded-lg text-sm" placeholder="æœå°‹è¦ç¯„å…§å®¹ï¼ˆå¦‚ï¼šæ··å‡åœŸã€é‹¼ç­‹ã€æ’æ°´ã€é‚Šå¡...ï¼‰">
                            <svg class="w-4 h-4 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                        <button @click="searchTechSpecs()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">æœå°‹</button>
                        <button x-show="tsSearchResults.length > 0" @click="tsSearchResults = []; tsSearchQuery = ''" class="px-3 py-2 bg-gray-200 text-gray-600 text-sm rounded-lg hover:bg-gray-300">æ¸…é™¤</button>
                    </div>

                    <!-- æœå°‹çµæœ -->
                    <div x-show="tsSearchResults.length > 0" class="mb-4">
                        <p class="text-xs text-gray-500 mb-2">æ‰¾åˆ° <span class="font-medium text-blue-600" x-text="tsSearchResults.length"></span> ç­†ç¬¦åˆã€Œ<span class="font-medium" x-text="tsSearchQuery"></span>ã€çš„çµæœ</p>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="r in tsSearchResults" :key="r.id">
                                <div @click="viewTechSpec(r.id)" class="p-3 bg-blue-50 border border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-gray-600" x-text="r.title"></span>
                                        <span class="text-xs text-gray-400" x-text="'P' + r.page_start + '-' + r.page_end"></span>
                                    </div>
                                    <p class="text-sm text-gray-700 leading-relaxed" x-html="r.snippet.replace(new RegExp(tsSearchQuery, 'g'), '<mark class=\'bg-yellow-300 px-0.5 rounded\'>' + tsSearchQuery + '</mark>')"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- è¦ç¯„è©³ç´°å…§å®¹ -->
                    <div x-show="selectedSpec" class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700" x-text="selectedSpec?.title"></h4>
                            <button @click="selectedSpec = null" class="text-xs text-gray-400 hover:text-gray-600">âœ• é—œé–‰</button>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border text-sm text-gray-700 leading-relaxed max-h-96 overflow-y-auto whitespace-pre-wrap" x-text="selectedSpec?.content"></div>
                    </div>

                    <!-- è¦ç¯„åˆ—è¡¨ -->
                    <template x-if="techSpecsList.length === 0 && tsSearchResults.length === 0">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                            <p class="text-sm">å°šæœªåŒ¯å…¥æ–½å·¥æŠ€è¡“è¦ç¯„</p>
                            <p class="text-xs mt-1">è«‹é€é API åŒ¯å…¥æ–½å·¥æŠ€è¡“è¦ç¯„ PDF è§£æè³‡æ–™</p>
                        </div>
                    </template>
                    <div x-show="techSpecsList.length > 0 && tsSearchResults.length === 0 && !selectedSpec" class="overflow-x-auto">
                        <table class="w-full text-sm border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-10">#</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">æ®µè½</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-20">é ç¢¼</th>
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-16">å­—æ•¸</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-12">æŸ¥çœ‹</th>
                            </tr></thead>
                            <tbody>
                                <template x-for="t in techSpecsList" :key="t.id">
                                    <tr class="border-t border-gray-100 hover:bg-gray-50">
                                        <td class="px-2 py-1.5 text-xs text-gray-400" x-text="t.seq"></td>
                                        <td class="px-2 py-1.5" x-text="t.title"></td>
                                        <td class="px-2 py-1.5 text-xs text-gray-500" x-text="'P' + t.page_start + '-' + t.page_end"></td>
                                        <td class="px-2 py-1.5 text-right text-xs text-gray-400" x-text="t.content_len"></td>
                                        <td class="px-2 py-1.5"><button @click="viewTechSpec(t.id)" class="text-blue-500 hover:text-blue-700 text-xs">æŸ¥çœ‹</button></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ========== TAB 13: äº¤é€šå·¥ç¨‹æ‰‹å†Š ========== -->
                <div x-show="activeTab === 'trafficmanual'" x-cloak>
                    <div class="flex items-center gap-3 mb-4">
                        <h3 class="font-semibold text-gray-700">äº¤é€šå·¥ç¨‹æ‰‹å†Š <span class="text-xs text-gray-400 font-normal" x-text="trafficManualList.length + ' æ®µ (æ¨™èªŒæ¨™ç·šç¯‡é™„éŒ„1-5)'"></span></h3>
                        <div class="flex-1 relative">
                            <input x-model="tmSearchQuery" @keyup.enter="searchTrafficManual()" class="w-full px-3 py-2 pl-9 border rounded-lg text-sm" placeholder="æœå°‹æ‰‹å†Šå…§å®¹ï¼ˆå¦‚ï¼šæ¨™èªŒã€æ¨™ç·šã€é€Ÿé™ã€äº¤æµé“...ï¼‰">
                            <svg class="w-4 h-4 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                        <button @click="searchTrafficManual()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">æœå°‹</button>
                        <button x-show="tmSearchResults.length > 0" @click="tmSearchResults = []; tmSearchQuery = ''" class="px-3 py-2 bg-gray-200 text-gray-600 text-sm rounded-lg hover:bg-gray-300">æ¸…é™¤</button>
                    </div>

                    <div x-show="tmSearchResults.length > 0" class="mb-4">
                        <p class="text-xs text-gray-500 mb-2">æ‰¾åˆ° <span class="font-medium text-blue-600" x-text="tmSearchResults.length"></span> ç­†ç¬¦åˆã€Œ<span class="font-medium" x-text="tmSearchQuery"></span>ã€çš„çµæœ</p>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="r in tmSearchResults" :key="r.id">
                                <div @click="viewTrafficManual(r.id)" class="p-3 bg-green-50 border border-green-200 rounded-lg cursor-pointer hover:bg-green-100 transition-colors">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-gray-600" x-text="r.title"></span>
                                        <span class="text-xs text-gray-400" x-text="'P' + r.page_start + '-' + r.page_end"></span>
                                    </div>
                                    <p class="text-sm text-gray-700 leading-relaxed" x-html="r.snippet.replace(new RegExp(tmSearchQuery, 'g'), '<mark class=\'bg-yellow-300 px-0.5 rounded\'>' + tmSearchQuery + '</mark>')"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div x-show="selectedManualItem" class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700" x-text="selectedManualItem?.title"></h4>
                            <button @click="selectedManualItem = null" class="text-xs text-gray-400 hover:text-gray-600">âœ• é—œé–‰</button>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border text-sm text-gray-700 leading-relaxed max-h-96 overflow-y-auto whitespace-pre-wrap" x-text="selectedManualItem?.content"></div>
                    </div>

                    <template x-if="trafficManualList.length === 0 && tmSearchResults.length === 0">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                            <p class="text-sm">å°šæœªåŒ¯å…¥äº¤é€šå·¥ç¨‹æ‰‹å†Š</p>
                            <p class="text-xs mt-1">è«‹é€é API åŒ¯å…¥äº¤é€šå·¥ç¨‹æ‰‹å†Š PDF è§£æè³‡æ–™</p>
                        </div>
                    </template>
                    <div x-show="trafficManualList.length > 0 && tmSearchResults.length === 0 && !selectedManualItem" class="overflow-x-auto">
                        <table class="w-full text-sm border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-10">#</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">æ®µè½</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-20">é ç¢¼</th>
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-16">å­—æ•¸</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-12">æŸ¥çœ‹</th>
                            </tr></thead>
                            <tbody>
                                <template x-for="t in trafficManualList" :key="t.id">
                                    <tr class="border-t border-gray-100 hover:bg-gray-50">
                                        <td class="px-2 py-1.5 text-xs text-gray-400" x-text="t.seq"></td>
                                        <td class="px-2 py-1.5" x-text="t.title"></td>
                                        <td class="px-2 py-1.5 text-xs text-gray-500" x-text="'P' + t.page_start + '-' + t.page_end"></td>
                                        <td class="px-2 py-1.5 text-right text-xs text-gray-400" x-text="t.content_len"></td>
                                        <td class="px-2 py-1.5"><button @click="viewTrafficManual(t.id)" class="text-blue-500 hover:text-blue-700 text-xs">æŸ¥çœ‹</button></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ========== TAB 14: å·¥ç¨‹è¨ˆç•« ========== -->
                <div x-show="activeTab === 'projectplans'" x-cloak>
                    <div class="flex items-center gap-3 mb-4">
                        <h3 class="font-semibold text-gray-700">å·¥ç¨‹è¨ˆç•« <span class="text-xs text-gray-400 font-normal" x-text="projectPlansList.length + ' æ®µ (åœŸçŸ³æ–¹+å®‰è¡›+å“è³ª+ç›£é€ )'"></span></h3>
                        <div class="flex-1 relative">
                            <input x-model="ppSearchQuery" @keyup.enter="searchProjectPlans()" class="w-full px-3 py-2 pl-9 border rounded-lg text-sm" placeholder="æœå°‹è¨ˆç•«å…§å®¹ï¼ˆå¦‚ï¼šå“è³ªã€å®‰å…¨è¡›ç”Ÿã€ç›£é€ ã€åœŸçŸ³æ–¹...ï¼‰">
                            <svg class="w-4 h-4 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                        <button @click="searchProjectPlans()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">æœå°‹</button>
                        <button x-show="ppSearchResults.length > 0" @click="ppSearchResults = []; ppSearchQuery = ''" class="px-3 py-2 bg-gray-200 text-gray-600 text-sm rounded-lg hover:bg-gray-300">æ¸…é™¤</button>
                    </div>

                    <div x-show="ppSearchResults.length > 0" class="mb-4">
                        <p class="text-xs text-gray-500 mb-2">æ‰¾åˆ° <span class="font-medium text-blue-600" x-text="ppSearchResults.length"></span> ç­†ç¬¦åˆã€Œ<span class="font-medium" x-text="ppSearchQuery"></span>ã€çš„çµæœ</p>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="r in ppSearchResults" :key="r.id">
                                <div @click="viewProjectPlan(r.id)" class="p-3 bg-orange-50 border border-orange-200 rounded-lg cursor-pointer hover:bg-orange-100 transition-colors">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-gray-600" x-text="r.title"></span>
                                        <span class="text-xs text-gray-400" x-text="'P' + r.page_start + '-' + r.page_end"></span>
                                    </div>
                                    <p class="text-sm text-gray-700 leading-relaxed" x-html="r.snippet.replace(new RegExp(ppSearchQuery, 'g'), '<mark class=\'bg-yellow-300 px-0.5 rounded\'>' + ppSearchQuery + '</mark>')"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div x-show="selectedPlanItem" class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700" x-text="selectedPlanItem?.title"></h4>
                            <button @click="selectedPlanItem = null" class="text-xs text-gray-400 hover:text-gray-600">âœ• é—œé–‰</button>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border text-sm text-gray-700 leading-relaxed max-h-96 overflow-y-auto whitespace-pre-wrap" x-text="selectedPlanItem?.content"></div>
                    </div>

                    <template x-if="projectPlansList.length === 0 && ppSearchResults.length === 0">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <p class="text-sm">å°šæœªåŒ¯å…¥å·¥ç¨‹è¨ˆç•«</p>
                        </div>
                    </template>
                    <div x-show="projectPlansList.length > 0 && ppSearchResults.length === 0 && !selectedPlanItem" class="overflow-x-auto">
                        <table class="w-full text-sm border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-10">#</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">æ®µè½</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-20">é ç¢¼</th>
                                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-16">å­—æ•¸</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-12">æŸ¥çœ‹</th>
                            </tr></thead>
                            <tbody>
                                <template x-for="t in projectPlansList" :key="t.id">
                                    <tr class="border-t border-gray-100 hover:bg-gray-50">
                                        <td class="px-2 py-1.5 text-xs text-gray-400" x-text="t.seq"></td>
                                        <td class="px-2 py-1.5" x-text="t.title"></td>
                                        <td class="px-2 py-1.5 text-xs text-gray-500" x-text="'P' + t.page_start + '-' + t.page_end"></td>
                                        <td class="px-2 py-1.5 text-right text-xs text-gray-400" x-text="t.content_len"></td>
                                        <td class="px-2 py-1.5"><button @click="viewProjectPlan(t.id)" class="text-blue-500 hover:text-blue-700 text-xs">æŸ¥çœ‹</button></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ========== TAB 15: èªéŸ³æ—¥å ± ========== -->
                <div x-show="activeTab === 'voice'" x-cloak>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-700">ğŸ™ï¸ èªéŸ³è‡ªå‹•åŒ–
                            <span class="text-xs text-gray-400 font-normal" x-text="'å¾…æª¢æ ¸ ' + voiceDrafts.filter(d => d.status === 'pending').length + ' ç­†'"></span>
                        </h3>
                        <div class="flex gap-2">
                            <a href="/voice" target="_blank" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 inline-flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                                é–‹å•Ÿæ‰‹æ©ŸéŒ„éŸ³é 
                            </a>
                            <button @click="loadVoiceDrafts()" class="px-3 py-2 bg-gray-100 text-gray-600 text-sm rounded-lg hover:bg-gray-200">é‡æ–°æ•´ç†</button>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿæ–‡å­—è¼¸å…¥ -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-sm font-medium text-blue-700">å¿«é€Ÿæ–‡å­—è¼¸å…¥ï¼ˆæ¸¬è©¦ / æ¡Œé¢ç«¯ï¼‰</span>
                            <select x-model="voiceMode" class="text-xs border rounded px-2 py-1">
                                <option value="daily_log">ğŸ“‹ æ–½å·¥æ—¥èªŒ</option>
                                <option value="inspection">âœ… è‡ªä¸»æª¢æŸ¥</option>
                                <option value="photo">ğŸ“¸ æ‹ç…§è¨˜éŒ„</option>
                                <option value="material">ğŸ§± ææ–™é€²å ´</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <input x-model="voiceTextInput" @keyup.enter="submitVoiceText()" class="flex-1 px-3 py-2 border rounded-lg text-sm" placeholder="è¼¸å…¥å£è¿°å…§å®¹ï¼Œå¦‚ï¼šä»Šå¤©å¤©æ°£æ™´ï¼Œé‹¼ç­‹å·¥5äººã€æ¨¡æ¿å·¥3äººï¼Œåšæ’æ°´ç®±æ¶µæ¨¡æ¿çµ„ç«‹...">
                            <button @click="submitVoiceText()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700" :disabled="voiceProcessing">
                                <span x-show="!voiceProcessing">AI è§£æ</span>
                                <span x-show="voiceProcessing">è™•ç†ä¸­...</span>
                            </button>
                        </div>
                    </div>

                    <!-- ç•¶å‰è§£æçµæœ -->
                    <div x-show="voiceCurrentResult" class="bg-white border rounded-lg p-4 mb-4 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-700 text-sm">ğŸ¤– AI çµæ§‹åŒ–çµæœ</h4>
                            <div class="flex gap-2">
                                <button @click="confirmCurrentDraft()" class="px-3 py-1.5 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700" :disabled="voiceConfirming">âœ“ ç¢ºèªå¯«å…¥</button>
                                <button @click="voiceCurrentResult = null; voiceCurrentDraftId = null" class="px-3 py-1.5 bg-gray-200 text-gray-600 text-xs rounded-lg hover:bg-gray-300">âœ• å–æ¶ˆ</button>
                            </div>
                        </div>
                        <div x-show="voiceCurrentResult?.transcript" class="mb-2">
                            <span class="text-xs text-gray-500">åŸæ–‡ï¼š</span>
                            <p class="text-sm bg-gray-50 rounded p-2 mt-1" x-text="voiceCurrentResult?.transcript"></p>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm" x-show="voiceCurrentResult?.structured_data">
                            <div><span class="text-gray-500 text-xs">æ—¥æœŸï¼š</span><span x-text="voiceCurrentResult?.structured_data?.log_date"></span></div>
                            <div><span class="text-gray-500 text-xs">å¤©æ°£ï¼š</span><span x-text="voiceCurrentResult?.structured_data?.weather_am"></span></div>
                        </div>
                        <div x-show="voiceCurrentResult?.structured_data?.workers?.length > 0" class="mt-2">
                            <span class="text-xs text-gray-500">äººåŠ›ï¼š</span>
                            <template x-for="w in (voiceCurrentResult?.structured_data?.workers || [])"><span class="inline-block bg-blue-100 text-blue-700 rounded px-2 py-0.5 text-xs mr-1 mt-1" x-text="w.trade + ' ' + w.count + 'äºº'"></span></template>
                        </div>
                        <div x-show="voiceCurrentResult?.structured_data?.equipment?.length > 0" class="mt-1">
                            <span class="text-xs text-gray-500">æ©Ÿå…·ï¼š</span>
                            <template x-for="e in (voiceCurrentResult?.structured_data?.equipment || [])"><span class="inline-block bg-green-100 text-green-700 rounded px-2 py-0.5 text-xs mr-1 mt-1" x-text="e.equipment_name + ' ' + e.count + 'å°'"></span></template>
                        </div>
                        <div x-show="voiceCurrentResult?.structured_data?.materials?.length > 0" class="mt-1">
                            <span class="text-xs text-gray-500">ææ–™ï¼š</span>
                            <template x-for="m in (voiceCurrentResult?.structured_data?.materials || [])"><span class="inline-block bg-orange-100 text-orange-700 rounded px-2 py-0.5 text-xs mr-1 mt-1" x-text="m.material_name + ' ' + m.quantity + m.unit"></span></template>
                        </div>
                        <div x-show="voiceCurrentResult?.structured_data?.work_description" class="mt-2">
                            <span class="text-xs text-gray-500">æ–½å·¥æ¦‚æ³ï¼š</span>
                            <p class="text-xs bg-gray-50 rounded p-2 mt-1" x-text="voiceCurrentResult?.structured_data?.work_description"></p>
                        </div>
                    </div>

                    <!-- è‰ç¨¿åˆ—è¡¨ -->
                    <div x-show="voiceDrafts.length > 0">
                        <h4 class="text-sm font-medium text-gray-600 mb-2">è‰ç¨¿è¨˜éŒ„</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50"><tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-10">#</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-20">æ¨¡å¼</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">å£è¿°å…§å®¹</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-20">ç‹€æ…‹</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-28">æ™‚é–“</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-16">æ“ä½œ</th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="d in voiceDrafts" :key="d.id">
                                        <tr class="border-t border-gray-100 hover:bg-gray-50" :class="d.status === 'confirmed' ? 'opacity-50' : ''">
                                            <td class="px-2 py-1.5 text-xs text-gray-400" x-text="d.id"></td>
                                            <td class="px-2 py-1.5 text-xs">
                                                <span x-text="d.mode === 'daily_log' ? 'ğŸ“‹æ—¥èªŒ' : d.mode === 'inspection' ? 'âœ…æª¢æŸ¥' : d.mode === 'photo' ? 'ğŸ“¸æ‹ç…§' : 'ğŸ§±ææ–™'"></span>
                                            </td>
                                            <td class="px-2 py-1.5 text-xs text-gray-600 max-w-xs truncate" x-text="d.transcript"></td>
                                            <td class="px-2 py-1.5">
                                                <span class="text-xs px-1.5 py-0.5 rounded-full" :class="d.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'" x-text="d.status === 'pending' ? 'å¾…æª¢æ ¸' : 'å·²ç¢ºèª'"></span>
                                            </td>
                                            <td class="px-2 py-1.5 text-xs text-gray-400" x-text="d.created_at?.substring(5, 16)"></td>
                                            <td class="px-2 py-1.5">
                                                <button x-show="d.status === 'pending'" @click="reviewVoiceDraft(d)" class="text-blue-500 hover:text-blue-700 text-xs">æª¢è¦–</button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <template x-if="voiceDrafts.length === 0 && !voiceCurrentResult">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                            <p class="text-sm">å°šç„¡èªéŸ³è¨˜éŒ„</p>
                            <p class="text-xs mt-1">ä½¿ç”¨ä¸Šæ–¹æ–‡å­—è¼¸å…¥æˆ–<a href="/voice" target="_blank" class="text-blue-500 hover:underline">æ‰‹æ©ŸéŒ„éŸ³é </a>é–‹å§‹</p>
                        </div>
                    </template>
                </div>

                <!-- ========== TAB 16: æ–‡ä»¶æƒæè¾¨è­˜ ========== -->
                <div x-show="activeTab === 'scanner'" x-cloak>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-700">ğŸ“· æ–‡ä»¶æƒæè¾¨è­˜æ­¸æª”
                            <span class="text-xs text-gray-400 font-normal" x-text="'å…± ' + scannedDocs.length + ' ç­†'"></span>
                        </h3>
                        <div class="flex gap-2">
                            <a href="/scanner" target="_blank" class="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 inline-flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                é–‹å•Ÿæƒæé é¢
                            </a>
                            <button @click="loadScannedDocs()" class="px-3 py-2 bg-gray-100 text-gray-600 text-sm rounded-lg hover:bg-gray-200">é‡æ–°æ•´ç†</button>
                        </div>
                    </div>

                    <!-- ä¸Šå‚³æƒæ -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-sm font-medium text-purple-700">å¿«é€Ÿä¸Šå‚³æ–‡ä»¶åœ–ç‰‡</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="file" x-ref="scanFileInput" accept="image/*" @change="handleScanFile($event)" class="flex-1 text-sm file:mr-2 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-sm file:bg-purple-600 file:text-white hover:file:bg-purple-700">
                            <button @click="uploadScanFile()" class="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700" :disabled="scanProcessing || !scanFileReady">
                                <span x-show="!scanProcessing">è¾¨è­˜æ­¸æª”</span>
                                <span x-show="scanProcessing">è™•ç†ä¸­...</span>
                            </button>
                        </div>
                    </div>

                    <!-- ç•¶å‰è¾¨è­˜çµæœ -->
                    <div x-show="scanCurrentResult" class="bg-white border rounded-lg p-4 mb-4 shadow-sm fade-in">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-700 text-sm">ğŸ·ï¸ AI è¾¨è­˜çµæœ</h4>
                            <button @click="scanCurrentResult = null" class="text-xs text-gray-400 hover:text-gray-600">âœ• é—œé–‰</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-2">
                            <div><span class="text-gray-500">åˆ†é¡ï¼š</span><span class="font-medium text-purple-700" x-text="scanCurrentResult?.classification?.category_name"></span></div>
                            <div><span class="text-gray-500">æ¨™é¡Œï¼š</span><span x-text="scanCurrentResult?.classification?.title"></span></div>
                            <div x-show="scanCurrentResult?.classification?.doc_number"><span class="text-gray-500">æ–‡è™Ÿï¼š</span><span x-text="scanCurrentResult?.classification?.doc_number"></span></div>
                            <div x-show="scanCurrentResult?.classification?.doc_date"><span class="text-gray-500">æ—¥æœŸï¼š</span><span x-text="scanCurrentResult?.classification?.doc_date"></span></div>
                        </div>
                        <div x-show="scanCurrentResult?.ocr?.text">
                            <span class="text-xs text-gray-500">OCR æ–‡å­— (<span x-text="scanCurrentResult?.ocr?.line_count"></span> è¡Œ, ä¿¡å¿ƒåº¦ <span x-text="Math.round((scanCurrentResult?.ocr?.avg_confidence || 0) * 100) + '%'"></span>)ï¼š</span>
                            <pre class="text-xs bg-gray-50 rounded p-2 mt-1 max-h-32 overflow-y-auto whitespace-pre-wrap font-mono text-gray-600" x-text="scanCurrentResult?.ocr?.text"></pre>
                        </div>
                        <div class="mt-2 text-xs text-green-600">âœ“ å·²è‡ªå‹•æ­¸æª”åˆ°æ–‡ä»¶ç®¡ç†</div>
                    </div>

                    <!-- æœå°‹ + ç¯©é¸ -->
                    <div class="flex gap-2 mb-3">
                        <input x-model="scanSearchQuery" @keyup.enter="searchScannedDocs()" class="flex-1 px-3 py-2 border rounded-lg text-sm" placeholder="æœå°‹æ–‡ä»¶å…§å®¹...">
                        <select x-model="scanFilterCategory" @change="loadScannedDocs()" class="px-2 py-2 border rounded-lg text-sm">
                            <option value="">å…¨éƒ¨åˆ†é¡</option>
                            <option value="official_letter">ğŸ“„ å…¬æ–‡</option>
                            <option value="contract">ğŸ“‘ åˆç´„/å¥‘ç´„</option>
                            <option value="test_report">ğŸ§ª è©¦é©—å ±å‘Š</option>
                            <option value="submittal">ğŸ“¤ é€å¯©æ–‡ä»¶</option>
                            <option value="meeting_minutes">ğŸ“ æœƒè­°ç´€éŒ„</option>
                            <option value="material_cert">ğŸ­ ææ–™è­‰æ˜</option>
                            <option value="safety_report">ğŸ¦º å®‰å…¨è¡›ç”Ÿ</option>
                            <option value="quality_report">âœ… å“è³ªæ–‡ä»¶</option>
                            <option value="other">ğŸ“‹ å…¶ä»–</option>
                        </select>
                    </div>

                    <!-- æƒæè¨˜éŒ„åˆ—è¡¨ -->
                    <div x-show="scannedDocs.length > 0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50"><tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-10">#</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-24">åˆ†é¡</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">æ¨™é¡Œ</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-28">æ–‡è™Ÿ</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-28">æ™‚é–“</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-16">æ“ä½œ</th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="d in scannedDocs" :key="d.id">
                                        <tr class="border-t border-gray-100 hover:bg-gray-50">
                                            <td class="px-2 py-1.5 text-xs text-gray-400" x-text="d.id"></td>
                                            <td class="px-2 py-1.5">
                                                <span class="text-xs px-1.5 py-0.5 rounded-full bg-purple-100 text-purple-700" x-text="d.category_name"></span>
                                            </td>
                                            <td class="px-2 py-1.5 text-xs font-medium" x-text="d.title || 'æœªå‘½å'"></td>
                                            <td class="px-2 py-1.5 text-xs text-gray-500" x-text="d.doc_number || '-'"></td>
                                            <td class="px-2 py-1.5 text-xs text-gray-400" x-text="d.created_at?.substring(5, 16)"></td>
                                            <td class="px-2 py-1.5">
                                                <button @click="viewScannedDoc(d)" class="text-purple-500 hover:text-purple-700 text-xs">æŸ¥çœ‹</button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <template x-if="scannedDocs.length === 0 && !scanCurrentResult">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <p class="text-sm">å°šç„¡æƒæè¨˜éŒ„</p>
                            <p class="text-xs mt-1">ä¸Šå‚³æ–‡ä»¶åœ–ç‰‡æˆ–ä½¿ç”¨<a href="/scanner" target="_blank" class="text-purple-500 hover:underline">æ”å½±æ©Ÿæƒæé </a></p>
                        </div>
                    </template>

                    <!-- æ–‡ä»¶è©³æƒ… Modal -->
                    <div x-show="scanSelectedDoc" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center" @click.self="scanSelectedDoc = null">
                        <div class="bg-white rounded-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto shadow-2xl mx-4">
                            <div class="sticky top-0 bg-white px-4 py-3 border-b flex items-center justify-between">
                                <h3 class="font-medium text-gray-700" x-text="scanSelectedDoc?.title || 'æ–‡ä»¶è©³æƒ…'"></h3>
                                <button @click="scanSelectedDoc = null" class="text-gray-400 hover:text-gray-600">âœ•</button>
                            </div>
                            <div class="p-4 space-y-3">
                                <div x-show="scanSelectedDoc?.stored_filename" class="rounded-lg overflow-hidden bg-gray-100">
                                    <img :src="'/api/scanned-image/' + scanSelectedDoc?.stored_filename" class="w-full max-h-80 object-contain" alt="æƒææ–‡ä»¶">
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><span class="text-gray-500">åˆ†é¡ï¼š</span><span class="text-purple-700 font-medium" x-text="scanSelectedDoc?.category_name"></span></div>
                                    <div x-show="scanSelectedDoc?.doc_number"><span class="text-gray-500">æ–‡è™Ÿï¼š</span><span x-text="scanSelectedDoc?.doc_number"></span></div>
                                    <div x-show="scanSelectedDoc?.doc_date"><span class="text-gray-500">æ—¥æœŸï¼š</span><span x-text="scanSelectedDoc?.doc_date"></span></div>
                                    <div x-show="scanSelectedDoc?.sender"><span class="text-gray-500">ç™¼æ–‡å–®ä½ï¼š</span><span x-text="scanSelectedDoc?.sender"></span></div>
                                </div>
                                <div x-show="scanSelectedDoc?.summary"><span class="text-gray-500 text-xs">æ‘˜è¦ï¼š</span><p class="text-sm mt-1" x-text="scanSelectedDoc?.summary"></p></div>
                                <div>
                                    <span class="text-gray-500 text-xs">OCR å…¨æ–‡ï¼š</span>
                                    <pre class="text-xs text-gray-600 bg-gray-50 rounded-lg p-3 mt-1 max-h-48 overflow-y-auto whitespace-pre-wrap font-mono" x-text="scanSelectedDoc?.ocr_text"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 17: è²¡å‹™ç®¡ç† ========== -->
                <div x-show="activeTab === 'finance'" x-cloak>
                    <div class="flex gap-2 mb-4">
                        <button @click="financeSubTab = 'petty'" :class="financeSubTab === 'petty' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all">é›¶ç”¨é‡‘</button>
                        <button @click="financeSubTab = 'estimate'; loadEstimates()" :class="financeSubTab === 'estimate' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all">å·¥ç¨‹ä¼°é©—</button>
                    </div>

                    <!-- é›¶ç”¨é‡‘ -->
                    <div x-show="financeSubTab === 'petty'">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">é›¶ç”¨é‡‘æ˜ç´° <span class="text-xs text-gray-400 font-normal" x-text="'å…± ' + pettyCashItems.length + ' ç­†ï¼Œåˆè¨ˆ ' + Number(pettyCashSummary.total||0).toLocaleString() + ' å…ƒ'"></span></h3>
                            <button @click="showPettyForm = true; pettyForm = {expense_date: new Date().toISOString().substring(0,10), description:'', category:'', amount:0, vendor:'', receipt_no:'', notes:''}" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700">+ æ–°å¢</button>
                        </div>

                        <!-- é›¶ç”¨é‡‘è¡¨å–® -->
                        <div x-show="showPettyForm" class="bg-green-50 rounded-lg p-4 mb-4 border border-green-200">
                            <div class="grid grid-cols-3 gap-3 mb-3">
                                <div><label class="text-xs text-gray-500">æ—¥æœŸ</label><input x-model="pettyForm.expense_date" type="date" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">èªªæ˜ *</label><input x-model="pettyForm.description" class="w-full px-3 py-1.5 border rounded text-sm" placeholder="æ”¯å‡ºèªªæ˜"></div>
                                <div><label class="text-xs text-gray-500">é‡‘é¡</label><input x-model.number="pettyForm.amount" type="number" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">é¡åˆ¥</label><input x-model="pettyForm.category" class="w-full px-3 py-1.5 border rounded text-sm" placeholder="å¦‚ï¼šæ–‡å…·ã€äº¤é€š"></div>
                                <div><label class="text-xs text-gray-500">å» å•†</label><input x-model="pettyForm.vendor" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                                <div><label class="text-xs text-gray-500">æ”¶æ“šè™Ÿ</label><input x-model="pettyForm.receipt_no" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="savePettyCash()" class="px-4 py-1.5 bg-green-600 text-white text-xs rounded hover:bg-green-700">å„²å­˜</button>
                                <button @click="showPettyForm = false" class="px-4 py-1.5 bg-gray-200 text-gray-600 text-xs rounded hover:bg-gray-300">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <template x-if="pettyCashItems.length === 0 && !showPettyForm">
                            <div class="text-center py-10 text-gray-400"><p class="text-sm">å°šç„¡é›¶ç”¨é‡‘è¨˜éŒ„</p></div>
                        </template>
                        <div x-show="pettyCashItems.length > 0" class="overflow-x-auto">
                            <table class="w-full text-sm border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50"><tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-24">æ—¥æœŸ</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">èªªæ˜</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-16">é¡åˆ¥</th>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-20">é‡‘é¡</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-20">å» å•†</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-12">æ“ä½œ</th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="p in pettyCashItems" :key="p.id">
                                        <tr class="border-t border-gray-100 hover:bg-gray-50">
                                            <td class="px-2 py-1.5 text-xs" x-text="p.expense_date"></td>
                                            <td class="px-2 py-1.5" x-text="p.description"></td>
                                            <td class="px-2 py-1.5 text-xs text-gray-500" x-text="p.category"></td>
                                            <td class="px-2 py-1.5 text-right font-medium" x-text="Number(p.amount).toLocaleString()"></td>
                                            <td class="px-2 py-1.5 text-xs text-gray-500" x-text="p.vendor"></td>
                                            <td class="px-2 py-1.5"><button @click="deletePettyCash(p.id)" class="text-red-400 hover:text-red-600 text-xs">åˆªé™¤</button></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- å·¥ç¨‹ä¼°é©— -->
                    <div x-show="financeSubTab === 'estimate'">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">å·¥ç¨‹ä¼°é©— <span class="text-xs text-gray-400 font-normal" x-text="estimates.length + ' æœŸ'"></span></h3>
                        </div>
                        <template x-if="estimates.length === 0">
                            <div class="text-center py-10 text-gray-400"><p class="text-sm">å°šç„¡ä¼°é©—è³‡æ–™</p><p class="text-xs mt-1">è«‹é€é API åŒ¯å…¥ä¼°é©—è³‡æ–™</p></div>
                        </template>
                        <div x-show="estimates.length > 0" class="overflow-x-auto">
                            <table class="w-full text-sm border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50"><tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-12">æœŸåˆ¥</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-28">ä¼°é©—æœŸé–“</th>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-500">æœ¬æœŸä¼°é©—</th>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-500">ç´¯è¨ˆä¼°é©—</th>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-500">ä¿ç•™æ¬¾</th>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-500">æ‡‰ä»˜é‡‘é¡</th>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-16">å®Œæˆ%</th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="e in estimates" :key="e.id">
                                        <tr class="border-t border-gray-100 hover:bg-gray-50">
                                            <td class="px-2 py-1.5 text-center font-medium" x-text="'ç¬¬' + e.period_no + 'æœŸ'"></td>
                                            <td class="px-2 py-1.5 text-xs text-gray-500" x-text="(e.period_start||'') + '~' + (e.period_end||'')"></td>
                                            <td class="px-2 py-1.5 text-right text-xs" x-text="Number(e.this_period||0).toLocaleString()"></td>
                                            <td class="px-2 py-1.5 text-right text-xs font-medium" x-text="Number(e.cumulative_estimate||0).toLocaleString()"></td>
                                            <td class="px-2 py-1.5 text-right text-xs text-gray-500" x-text="Number(e.retention||0).toLocaleString()"></td>
                                            <td class="px-2 py-1.5 text-right text-xs font-medium text-green-600" x-text="Number(e.payable||0).toLocaleString()"></td>
                                            <td class="px-2 py-1.5 text-right text-xs" x-text="e.completion_pct ? (e.completion_pct * 100).toFixed(1) + '%' : ''"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 12: åƒè€ƒæ³•è¦ ========== -->
                <div x-show="activeTab === 'regulations'" x-cloak>

                    <!-- æ³•è¦åˆ—è¡¨ -->
                    <div x-show="!selectedRegCode" class="space-y-3">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-700">åƒè€ƒæ³•è¦åº«</h3>
                            <span class="text-xs text-gray-400" x-text="regulationsList.length + ' éƒ¨æ³•è¦'"></span>
                        </div>
                        <template x-if="regulationsList.length === 0">
                            <div class="text-center py-12 text-gray-400">
                                <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                <p class="text-sm">å°šç„¡åƒè€ƒæ³•è¦</p>
                            </div>
                        </template>
                        <template x-for="reg in regulationsList" :key="reg.reg_code">
                            <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" @click="openRegulation(reg.reg_code)">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-800" x-text="reg.reg_name"></div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span x-text="'ç·¨ç¢¼: ' + reg.reg_code"></span>
                                            <span class="mx-2">|</span>
                                            <span x-text="reg.article_count + ' æ¢æ¢æ–‡'"></span>
                                            <span x-show="reg.effective_date" class="mx-2">|</span>
                                            <span x-show="reg.effective_date" x-text="'ç”Ÿæ•ˆ: ' + reg.effective_date"></span>
                                        </div>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- æ¢æ–‡æª¢è¦– -->
                    <div x-show="selectedRegCode">
                        <div class="flex items-center gap-3 mb-4">
                            <button @click="selectedRegCode = ''; regArticles = []" class="text-gray-500 hover:bg-gray-100 p-1.5 rounded-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            </button>
                            <h3 class="font-semibold text-gray-700" x-text="selectedRegName"></h3>
                            <span class="text-xs text-gray-400" x-text="regArticles.length + ' æ¢'"></span>
                        </div>

                        <!-- æœå°‹ -->
                        <div class="mb-4">
                            <input type="text" x-model="regKeyword" @input.debounce.300ms="searchRegArticles()" placeholder="æœå°‹æ¢æ–‡å…§å®¹..." class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>

                        <!-- æ¢æ–‡åˆ—è¡¨ -->
                        <div class="space-y-2 max-h-[65vh] overflow-y-auto">
                            <template x-for="art in regArticles" :key="art.id">
                                <div class="bg-white rounded-lg border border-gray-200 p-4">
                                    <div class="flex items-start gap-3">
                                        <span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full shrink-0" x-text="art.article_number === 0 ? 'æ²¿é©' : 'ç¬¬' + art.article_number + 'æ¢'"></span>
                                        <div class="flex-1">
                                            <div class="text-sm text-gray-800 whitespace-pre-line leading-relaxed" x-text="art.article_content"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB 8: è‡ªè¨‚æ¬„ä½ ========== -->
                <div x-show="activeTab === 'custom'" x-cloak>
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                            <h3 class="font-semibold text-gray-700">è‡ªè¨‚æ¬„ä½</h3>
                            <button @click="addCustomField()" class="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                æ–°å¢æ¬„ä½
                            </button>
                        </div>
                        <div class="p-4 space-y-3">
                            <template x-if="form.custom_fields.length === 0">
                                <div class="text-center text-gray-400 text-sm py-6">
                                    å¯æ–°å¢ç¯„æœ¬ä»¥å¤–çš„è‡ªè¨‚æ¬„ä½ï¼Œä¾‹å¦‚ï¼šåˆ†åŒ…å•†è³‡è¨Šã€ç‰¹æ®Šæ¢æ¬¾ç­‰
                                </div>
                            </template>
                            <template x-for="(cf, idx) in form.custom_fields" :key="idx">
                                <div class="flex items-center gap-3">
                                    <input type="text" x-model="cf.field_name" placeholder="æ¬„ä½åç¨±"
                                           class="w-1/3 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <input type="text" x-model="cf.field_value" placeholder="æ¬„ä½å€¼"
                                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <button @click="form.custom_fields.splice(idx, 1)" class="text-red-400 hover:text-red-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button @click="saveProject()" class="btn-primary text-white px-6 py-2.5 rounded-lg text-sm font-medium shadow-md">
                            å„²å­˜è‡ªè¨‚æ¬„ä½
                        </button>
                    </div>
                </div>

            </div>
        </template>
    </main>
</div>

<script>
function cmsApp() {
    return {
        // ç‹€æ…‹
        projects: [],
        currentProject: null,
        showForm: false,
        saving: false,
        saveMessage: '',
        saveSuccess: false,
        autoFillStatus: '',
        autoFillSuccess: false,
        showAddPersonnel: false,
        stats: { total_projects: 0, active_projects: 0, total_documents: 0 },

        // å¥‘ç´„è©³ç´°è¡¨
        contractItems: [],
        contractSummary: null,
        contractFilter: '',
        contractLevelFilter: '',
        contractUploadStatus: '',
        contractUploadSuccess: false,
        showAddContractItem: false,
        editingItemId: null,
        editingItem: {},
        newContractItem: { item_number: '', item_name: '', unit: '', quantity: '', unit_price: '' },

        // æ–½å·¥æ—¥èªŒ
        dailyLogs: [],
        logStats: null,
        logMonth: '',
        showLogForm: false,
        editingLogId: null,
        logSaving: false,
        logSaveMsg: '',
        logSaveOk: false,
        logForm: {
            log_date: '', weather_am: '', weather_pm: '',
            temperature_high: null, temperature_low: null,
            work_description: '', safety_notes: '', quality_notes: '', notes: '',
            day_status: 'working', calendar_days: null, work_days: null,
            scheduled_progress: null, actual_progress: null,
            sampling_test_notes: '', subcontractor_notices: '', important_records: '',
            safety_pretask_education: false, safety_insurance_check: false, safety_ppe_check: false,
            has_technician_required: false,
            workers: [], equipment: [], materials: [], work_items: []
        },

        // åƒè€ƒæ³•è¦
        regulationsList: [],
        selectedRegCode: '',
        selectedRegName: '',
        regArticles: [],
        regKeyword: '',

        // è‡ªä¸»æª¢æŸ¥è¡¨
        inspections: [],
        showInspectionForm: false,
        editingInspectionId: null,
        inspSaving: false,
        inspSaveMsg: '',
        inspSaveOk: false,
        inspForm: {
            checklist_name: '', sub_project: '', inspection_date: '',
            contractor: '', inspection_location: '', status: 'draft', notes: '',
            items: [], safety_items: [], deficiencies: []
        },

        // æ‹ç…§è¨˜éŒ„è¡¨
        photoRecords: [],
        showPhotoForm: false,
        editingPhotoId: null,
        photoSaving: false,
        photoSaveMsg: '',
        photoSaveOk: false,
        photoForm: {
            record_title: '', record_date: '', status: 'draft',
            items: []
        },

        // é€²åº¦ç®¡ç†
        progressSubTab: 'schedule',
        scheduleTasks: [],
        scurveData: { items: [], monthly: [] },

        // ç®¡åˆ¶è¡¨
        controlSubTab: 'submittal',
        submittals: [],
        showSubmittalForm: false,
        submittalForm: { plan_name:'', submit_date:'', review_date:'', approval_date:'', status:'pending', reviewer:'', notes:'' },
        testControls: [],

        // ç‰¹è¨‚æ¢æ¬¾
        specialTermsList: [],
        stSearchQuery: '',
        stSearchResults: [],
        selectedTerm: null,

        // æ–½å·¥æŠ€è¡“è¦ç¯„
        techSpecsList: [],
        tsSearchQuery: '',
        tsSearchResults: [],
        selectedSpec: null,

        // äº¤é€šå·¥ç¨‹æ‰‹å†Š
        trafficManualList: [],
        tmSearchQuery: '',
        tmSearchResults: [],
        selectedManualItem: null,

        // å·¥ç¨‹è¨ˆç•«
        projectPlansList: [],
        ppSearchQuery: '',
        ppSearchResults: [],
        selectedPlanItem: null,

        // èªéŸ³æ—¥å ±
        voiceDrafts: [],
        voiceMode: 'daily_log',
        voiceTextInput: '',
        voiceProcessing: false,
        voiceConfirming: false,
        voiceCurrentResult: null,
        voiceCurrentDraftId: null,

        // æ–‡ä»¶æƒæ
        scannedDocs: [],
        scanProcessing: false,
        scanFileReady: false,
        scanFileData: null,
        scanCurrentResult: null,
        scanSearchQuery: '',
        scanFilterCategory: '',
        scanSelectedDoc: null,

        // è²¡å‹™ç®¡ç†
        financeSubTab: 'petty',
        pettyCashItems: [],
        pettyCashSummary: { cnt: 0, total: 0 },
        showPettyForm: false,
        pettyForm: { expense_date:'', description:'', category:'', amount:0, vendor:'', receipt_no:'', notes:'' },
        estimates: [],

        // è¡¨å–®
        form: {
            project_name: '',
            owner_agency: '',
            execution_office: '',
            supervision_office: '',
            design_unit: '',
            supervision_unit: '',
            contractor: '',
            project_location: '',
            contract_amount: '',
            contract_amount_numeric: '',
            construction_period: '',
            construction_period_days: '',
            start_date: '',
            expected_end_date: '',
            project_scope: '',
            warranty_terms: '',
            notes: '',
            status: 'active',
            term_definitions: [],
            custom_fields: []
        },

        personnelForm: {
            role: '', name: '', company: '', license_no: '', phone: '', email: ''
        },

        async init() {
            await this.loadProjects();
            await this.loadStats();
        },

        // ===== API å‘¼å« =====

        async loadProjects() {
            try {
                const res = await fetch('/api/projects');
                const data = await res.json();
                if (data.success) this.projects = data.data;
            } catch (e) { console.error('è¼‰å…¥å·¥ç¨‹åˆ—è¡¨å¤±æ•—:', e); }
        },

        async loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                if (data.success) this.stats = data.data;
            } catch (e) { console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', e); }
        },

        async loadProject(id) {
            try {
                const res = await fetch(`/api/projects/${id}`);
                const data = await res.json();
                if (data.success) {
                    this.currentProject = data.data;
                    this.showForm = true;
                    this.fillFormFromProject(data.data);
                }
            } catch (e) { console.error('è¼‰å…¥å·¥ç¨‹å¤±æ•—:', e); }
        },

        showNewProject() {
            this.currentProject = null;
            this.showForm = true;
            this.resetForm();
        },

        resetForm() {
            this.form = {
                project_name: '', owner_agency: '', execution_office: '',
                supervision_office: '', design_unit: '', supervision_unit: '',
                contractor: '', project_location: '', contract_amount: '',
                contract_amount_numeric: '', construction_period: '',
                construction_period_days: '', start_date: '', expected_end_date: '',
                project_scope: '', warranty_terms: '', notes: '', status: 'active',
                term_definitions: [], custom_fields: []
            };
        },

        fillFormFromProject(project) {
            const fields = [
                'project_name', 'owner_agency', 'execution_office', 'supervision_office',
                'design_unit', 'supervision_unit', 'contractor', 'project_location',
                'contract_amount', 'contract_amount_numeric', 'construction_period',
                'construction_period_days', 'start_date', 'expected_end_date',
                'project_scope', 'warranty_terms', 'notes', 'status'
            ];
            for (const f of fields) {
                this.form[f] = project[f] || '';
            }
            this.form.term_definitions = (project.term_definitions || []).map(t => ({
                term_number: t.term_number,
                term_name: t.term_name || '',
                term_definition: t.term_definition || ''
            }));
            this.form.custom_fields = (project.custom_fields || []).map(cf => ({
                field_name: cf.field_name || '',
                field_value: cf.field_value || ''
            }));
        },

        async saveProject() {
            if (!this.form.project_name.trim()) {
                this.saveMessage = 'å·¥ç¨‹åç¨±ç‚ºå¿…å¡«';
                this.saveSuccess = false;
                return;
            }

            this.saving = true;
            this.saveMessage = '';

            try {
                const payload = { ...this.form };
                // ç¢ºä¿æ•¸å­—æ¬„ä½
                if (payload.contract_amount_numeric) {
                    payload.contract_amount_numeric = parseFloat(payload.contract_amount_numeric) || null;
                }
                if (payload.construction_period_days) {
                    payload.construction_period_days = parseInt(payload.construction_period_days) || null;
                }

                let res;
                if (this.currentProject) {
                    res = await fetch(`/api/projects/${this.currentProject.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    res = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                const data = await res.json();
                if (data.success) {
                    this.saveMessage = data.message;
                    this.saveSuccess = true;

                    if (!this.currentProject && data.project_id) {
                        await this.loadProject(data.project_id);
                    } else if (this.currentProject) {
                        await this.loadProject(this.currentProject.id);
                    }
                    await this.loadProjects();
                    await this.loadStats();
                } else {
                    this.saveMessage = data.detail || 'å„²å­˜å¤±æ•—';
                    this.saveSuccess = false;
                }
            } catch (e) {
                this.saveMessage = 'ç¶²è·¯éŒ¯èª¤: ' + e.message;
                this.saveSuccess = false;
            }

            this.saving = false;
            setTimeout(() => { this.saveMessage = ''; }, 3000);
        },

        async confirmDelete() {
            if (!this.currentProject) return;
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å·¥ç¨‹ã€Œ${this.currentProject.project_name}ã€ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) return;

            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    this.currentProject = null;
                    this.showForm = false;
                    this.resetForm();
                    await this.loadProjects();
                    await this.loadStats();
                }
            } catch (e) { alert('åˆªé™¤å¤±æ•—: ' + e.message); }
        },

        // ===== åè©å®šç¾© =====

        addTerm() {
            this.form.term_definitions.push({
                term_number: this.form.term_definitions.length + 1,
                term_name: '',
                term_definition: ''
            });
        },

        removeTerm(idx) {
            this.form.term_definitions.splice(idx, 1);
            // é‡æ–°ç·¨è™Ÿ
            this.form.term_definitions.forEach((t, i) => { t.term_number = i + 1; });
        },

        // ===== è‡ªè¨‚æ¬„ä½ =====

        addCustomField() {
            this.form.custom_fields.push({ field_name: '', field_value: '' });
        },

        // ===== äººå“¡ =====

        async savePersonnel() {
            if (!this.currentProject || !this.personnelForm.role || !this.personnelForm.name) {
                alert('è«‹å¡«å¯«è·å‹™è§’è‰²å’Œå§“å');
                return;
            }
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/personnel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.personnelForm)
                });
                const data = await res.json();
                if (data.success) {
                    this.showAddPersonnel = false;
                    this.personnelForm = { role: '', name: '', company: '', license_no: '', phone: '', email: '' };
                    await this.loadProject(this.currentProject.id);
                }
            } catch (e) { alert('æ–°å¢å¤±æ•—: ' + e.message); }
        },

        async deletePersonnel(pid) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤äººå“¡ï¼Ÿ')) return;
            try {
                await fetch(`/api/projects/${this.currentProject.id}/personnel/${pid}`, { method: 'DELETE' });
                await this.loadProject(this.currentProject.id);
            } catch (e) { alert('åˆªé™¤å¤±æ•—: ' + e.message); }
        },

        // ===== æ–‡ä»¶ä¸Šå‚³ =====

        async handleAutoFill(event) {
            const file = event.target.files[0];
            if (!file || !this.currentProject) return;
            await this.doAutoFill(file);
        },

        async handleAutoFillDrop(event) {
            const file = event.dataTransfer.files[0];
            if (!file || !this.currentProject) return;
            event.currentTarget.classList.remove('dragover');
            await this.doAutoFill(file);
        },

        async doAutoFill(file) {
            this.autoFillStatus = 'è§£æä¸­...';
            this.autoFillSuccess = false;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/parse-and-fill`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    this.autoFillStatus = data.message;
                    this.autoFillSuccess = true;
                    // é‡æ–°è¼‰å…¥
                    await this.loadProject(this.currentProject.id);
                } else {
                    this.autoFillStatus = data.error || 'è§£æå¤±æ•—';
                    this.autoFillSuccess = false;
                }
            } catch (e) {
                this.autoFillStatus = 'ä¸Šå‚³å¤±æ•—: ' + e.message;
                this.autoFillSuccess = false;
            }

            setTimeout(() => { this.autoFillStatus = ''; }, 5000);
        },

        async handleDocUpload(files) {
            if (!files || !files.length || !this.currentProject) return;

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('doc_type', 'contract');

                try {
                    await fetch(`/api/projects/${this.currentProject.id}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                } catch (e) { console.error('ä¸Šå‚³å¤±æ•—:', e); }
            }
            await this.loadProject(this.currentProject.id);
        },

        // ===== æ–½å·¥æ—¥èªŒ =====

        async loadLogStats() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/logs/stats`);
                const data = await res.json();
                if (data.success) this.logStats = data.data;
            } catch (e) { console.error('è¼‰å…¥æ—¥èªŒçµ±è¨ˆå¤±æ•—:', e); }
            await this.loadLogs();
        },

        async loadLogs() {
            if (!this.currentProject) return;
            try {
                let url = `/api/projects/${this.currentProject.id}/logs`;
                if (this.logMonth) url += `?month=${this.logMonth}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.success) this.dailyLogs = data.data;
            } catch (e) { console.error('è¼‰å…¥æ—¥èªŒå¤±æ•—:', e); }
        },

        resetLogForm() {
            this.logForm = {
                log_date: new Date().toISOString().substring(0, 10),
                weather_am: '', weather_pm: '',
                temperature_high: null, temperature_low: null,
                work_description: '', safety_notes: '', quality_notes: '', notes: '',
                day_status: 'working', calendar_days: null, work_days: null,
                scheduled_progress: null, actual_progress: null,
                sampling_test_notes: '', subcontractor_notices: '', important_records: '',
                safety_pretask_education: false, safety_insurance_check: false, safety_ppe_check: false,
                has_technician_required: false,
                workers: [], equipment: [], materials: [], work_items: []
            };
        },

        openLogForm() {
            this.editingLogId = null;
            this.resetLogForm();
            this.showLogForm = true;
            this.logSaveMsg = '';
        },

        async editLog(logId) {
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/logs/${logId}`);
                const data = await res.json();
                if (data.success && data.data) {
                    const log = data.data;
                    this.editingLogId = logId;
                    this.logForm = {
                        log_date: log.log_date || '',
                        weather_am: log.weather_am || '',
                        weather_pm: log.weather_pm || '',
                        temperature_high: log.temperature_high,
                        temperature_low: log.temperature_low,
                        work_description: log.work_description || '',
                        safety_notes: log.safety_notes || '',
                        quality_notes: log.quality_notes || '',
                        notes: log.notes || '',
                        day_status: log.day_status || 'working',
                        calendar_days: log.calendar_days,
                        work_days: log.work_days,
                        scheduled_progress: log.scheduled_progress,
                        actual_progress: log.actual_progress,
                        sampling_test_notes: log.sampling_test_notes || '',
                        subcontractor_notices: log.subcontractor_notices || '',
                        important_records: log.important_records || '',
                        safety_pretask_education: !!log.safety_pretask_education,
                        safety_insurance_check: !!log.safety_insurance_check,
                        safety_ppe_check: !!log.safety_ppe_check,
                        has_technician_required: !!log.has_technician_required,
                        workers: log.workers || [],
                        equipment: log.equipment || [],
                        materials: log.materials || [],
                        work_items: log.work_items || []
                    };
                    this.showLogForm = true;
                    this.logSaveMsg = '';
                }
            } catch (e) { alert('è¼‰å…¥æ—¥èªŒå¤±æ•—: ' + e.message); }
        },

        async openLogDetail(logId) {
            await this.editLog(logId);
        },

        async saveLog() {
            if (!this.logForm.log_date || !this.currentProject) {
                alert('æ—¥æœŸç‚ºå¿…å¡«');
                return;
            }
            this.logSaving = true;
            this.logSaveMsg = '';

            try {
                const payload = { ...this.logForm };
                if (payload.temperature_high) payload.temperature_high = parseFloat(payload.temperature_high);
                if (payload.temperature_low) payload.temperature_low = parseFloat(payload.temperature_low);
                if (payload.scheduled_progress) payload.scheduled_progress = parseFloat(payload.scheduled_progress);
                if (payload.actual_progress) payload.actual_progress = parseFloat(payload.actual_progress);
                payload.safety_pretask_education = payload.safety_pretask_education ? 1 : 0;
                payload.safety_insurance_check = payload.safety_insurance_check ? 1 : 0;
                payload.safety_ppe_check = payload.safety_ppe_check ? 1 : 0;
                payload.has_technician_required = payload.has_technician_required ? 1 : 0;
                payload.workers = payload.workers.filter(w => w.trade);
                payload.workers.forEach(w => { w.count = parseInt(w.count) || 0; w.cumulative_count = parseInt(w.cumulative_count) || 0; });
                payload.equipment = payload.equipment.filter(e => e.equipment_name);
                payload.materials = payload.materials.filter(m => m.material_name);
                payload.work_items = payload.work_items.filter(w => w.item_name);

                let url, method;
                if (this.editingLogId) {
                    url = `/api/projects/${this.currentProject.id}/logs/${this.editingLogId}`;
                    method = 'PUT';
                } else {
                    url = `/api/projects/${this.currentProject.id}/logs`;
                    method = 'POST';
                }

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    this.logSaveMsg = data.message;
                    this.logSaveOk = true;
                    this.showLogForm = false;
                    await this.loadLogStats();
                } else {
                    this.logSaveMsg = data.detail || data.error || 'å„²å­˜å¤±æ•—';
                    this.logSaveOk = false;
                }
            } catch (e) {
                this.logSaveMsg = 'å„²å­˜å¤±æ•—: ' + e.message;
                this.logSaveOk = false;
            }
            this.logSaving = false;
            setTimeout(() => { this.logSaveMsg = ''; }, 4000);
        },

        async deleteLog(logId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ—¥èªŒï¼Ÿ')) return;
            try {
                await fetch(`/api/projects/${this.currentProject.id}/logs/${logId}`, { method: 'DELETE' });
                await this.loadLogStats();
            } catch (e) { alert('åˆªé™¤å¤±æ•—: ' + e.message); }
        },

        // ===== åƒè€ƒæ³•è¦ =====

        async loadRegulations() {
            try {
                const res = await fetch('/api/regulations');
                const data = await res.json();
                if (data.success) this.regulationsList = data.data;
            } catch (e) { console.error('è¼‰å…¥æ³•è¦å¤±æ•—:', e); }
        },

        async openRegulation(regCode) {
            this.selectedRegCode = regCode;
            const reg = this.regulationsList.find(r => r.reg_code === regCode);
            this.selectedRegName = reg ? reg.reg_name : regCode;
            this.regKeyword = '';
            await this.searchRegArticles();
        },

        async searchRegArticles() {
            try {
                let url = `/api/regulations/${this.selectedRegCode}/articles`;
                if (this.regKeyword) url += `?keyword=${encodeURIComponent(this.regKeyword)}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.success) this.regArticles = data.data;
            } catch (e) { console.error('è¼‰å…¥æ¢æ–‡å¤±æ•—:', e); }
        },

        // ===== è‡ªä¸»æª¢æŸ¥è¡¨ =====

        async loadInspections() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/inspections`);
                const data = await res.json();
                if (data.success) this.inspections = data.data;
            } catch (e) { console.error('è¼‰å…¥æª¢æŸ¥è¡¨å¤±æ•—:', e); }
        },

        resetInspForm() {
            this.inspForm = {
                checklist_name: '', sub_project: '', inspection_date: new Date().toISOString().substring(0, 10),
                contractor: '', inspection_location: '', status: 'draft', notes: '',
                items: [], safety_items: [], deficiencies: []
            };
        },

        openInspectionForm() {
            this.editingInspectionId = null;
            this.resetInspForm();
            this.showInspectionForm = true;
            this.inspSaveMsg = '';
        },

        async editInspection(id) {
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/inspections/${id}`);
                const data = await res.json();
                if (data.success && data.data) {
                    const c = data.data;
                    this.editingInspectionId = id;
                    this.inspForm = {
                        checklist_name: c.checklist_name || '',
                        sub_project: c.sub_project || '',
                        inspection_date: c.inspection_date || '',
                        contractor: c.contractor || '',
                        inspection_location: c.inspection_location || '',
                        status: c.status || 'draft',
                        notes: c.notes || '',
                        items: c.items || [],
                        safety_items: c.safety_items || [],
                        deficiencies: (c.deficiencies || []).map(d => ({...d, is_resolved: !!d.is_resolved}))
                    };
                    this.showInspectionForm = true;
                    this.inspSaveMsg = '';
                }
            } catch (e) { alert('è¼‰å…¥æª¢æŸ¥è¡¨å¤±æ•—: ' + e.message); }
        },

        async saveInspection() {
            if (!this.inspForm.checklist_name || !this.currentProject) { alert('æª¢æŸ¥è¡¨åç¨±ç‚ºå¿…å¡«'); return; }
            this.inspSaving = true;
            this.inspSaveMsg = '';
            try {
                const payload = { ...this.inspForm };
                payload.items = payload.items.filter(i => i.item_name);
                payload.deficiencies = payload.deficiencies.map(d => ({...d, is_resolved: d.is_resolved ? 1 : 0}));

                let url, method;
                if (this.editingInspectionId) {
                    url = `/api/projects/${this.currentProject.id}/inspections/${this.editingInspectionId}`;
                    method = 'PUT';
                } else {
                    url = `/api/projects/${this.currentProject.id}/inspections`;
                    method = 'POST';
                }
                const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) {
                    this.inspSaveMsg = data.message;
                    this.inspSaveOk = true;
                    this.showInspectionForm = false;
                    await this.loadInspections();
                } else {
                    this.inspSaveMsg = data.detail || 'å„²å­˜å¤±æ•—';
                    this.inspSaveOk = false;
                }
            } catch (e) { this.inspSaveMsg = 'å„²å­˜å¤±æ•—: ' + e.message; this.inspSaveOk = false; }
            this.inspSaving = false;
            setTimeout(() => { this.inspSaveMsg = ''; }, 4000);
        },

        async deleteInspection(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æª¢æŸ¥è¡¨ï¼Ÿ')) return;
            try {
                await fetch(`/api/projects/${this.currentProject.id}/inspections/${id}`, { method: 'DELETE' });
                await this.loadInspections();
            } catch (e) { alert('åˆªé™¤å¤±æ•—: ' + e.message); }
        },

        // ===== æ‹ç…§è¨˜éŒ„è¡¨ =====

        async loadPhotoRecords() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/photos`);
                const data = await res.json();
                if (data.success) this.photoRecords = data.data;
            } catch (e) { console.error('è¼‰å…¥æ‹ç…§è¨˜éŒ„å¤±æ•—:', e); }
        },

        resetPhotoForm() {
            this.photoForm = {
                record_title: '', record_date: new Date().toISOString().substring(0, 10), status: 'draft',
                items: []
            };
        },

        openPhotoForm() {
            this.editingPhotoId = null;
            this.resetPhotoForm();
            this.showPhotoForm = true;
            this.photoSaveMsg = '';
        },

        async editPhotoRecord(id) {
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/photos/${id}`);
                const data = await res.json();
                if (data.success && data.data) {
                    const r = data.data;
                    this.editingPhotoId = id;
                    this.photoForm = {
                        record_title: r.record_title || '',
                        record_date: r.record_date || '',
                        status: r.status || 'draft',
                        items: r.items || []
                    };
                    this.showPhotoForm = true;
                    this.photoSaveMsg = '';
                }
            } catch (e) { alert('è¼‰å…¥æ‹ç…§è¨˜éŒ„å¤±æ•—: ' + e.message); }
        },

        async savePhotoRecord() {
            if (!this.currentProject) return;
            this.photoSaving = true;
            this.photoSaveMsg = '';
            try {
                const payload = { ...this.photoForm };
                let url, method;
                if (this.editingPhotoId) {
                    url = `/api/projects/${this.currentProject.id}/photos/${this.editingPhotoId}`;
                    method = 'PUT';
                } else {
                    url = `/api/projects/${this.currentProject.id}/photos`;
                    method = 'POST';
                }
                const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) {
                    this.photoSaveMsg = data.message;
                    this.photoSaveOk = true;
                    this.showPhotoForm = false;
                    await this.loadPhotoRecords();
                } else {
                    this.photoSaveMsg = data.detail || 'å„²å­˜å¤±æ•—';
                    this.photoSaveOk = false;
                }
            } catch (e) { this.photoSaveMsg = 'å„²å­˜å¤±æ•—: ' + e.message; this.photoSaveOk = false; }
            this.photoSaving = false;
            setTimeout(() => { this.photoSaveMsg = ''; }, 4000);
        },

        async deletePhotoRecord(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ‹ç…§è¨˜éŒ„ï¼Ÿ')) return;
            try {
                await fetch(`/api/projects/${this.currentProject.id}/photos/${id}`, { method: 'DELETE' });
                await this.loadPhotoRecords();
            } catch (e) { alert('åˆªé™¤å¤±æ•—: ' + e.message); }
        },

        // ===== é€²åº¦ç®¡ç† =====

        async loadSchedule() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/schedule`);
                const data = await res.json();
                if (data.success) this.scheduleTasks = data.data;
            } catch (e) { console.error('è¼‰å…¥æ–½å·¥ç¶²åœ–å¤±æ•—:', e); }
        },

        async loadScurve() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/scurve`);
                const data = await res.json();
                if (data.success) this.scurveData = data.data;
            } catch (e) { console.error('è¼‰å…¥S-Curveå¤±æ•—:', e); }
        },

        // ===== é€å¯©ç®¡åˆ¶ =====

        async loadSubmittals() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/submittals`);
                const data = await res.json();
                if (data.success) this.submittals = data.data;
            } catch (e) { console.error('è¼‰å…¥é€å¯©ç®¡åˆ¶å¤±æ•—:', e); }
        },

        async saveSubmittal() {
            if (!this.currentProject || !this.submittalForm.plan_name) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/submittals`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(this.submittalForm)
                });
                const data = await res.json();
                if (data.success) { this.showSubmittalForm = false; this.loadSubmittals(); }
            } catch (e) { console.error('å„²å­˜é€å¯©å¤±æ•—:', e); }
        },

        async deleteSubmittal(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é€å¯©é …ç›®ï¼Ÿ')) return;
            try {
                await fetch(`/api/projects/${this.currentProject.id}/submittals/${id}`, { method: 'DELETE' });
                this.loadSubmittals();
            } catch (e) { console.error('åˆªé™¤é€å¯©å¤±æ•—:', e); }
        },

        // ===== æª¢è©¦é©—ç®¡åˆ¶ =====

        async loadTests() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/tests`);
                const data = await res.json();
                if (data.success) this.testControls = data.data;
            } catch (e) { console.error('è¼‰å…¥æª¢è©¦é©—å¤±æ•—:', e); }
        },

        // ===== ç‰¹è¨‚æ¢æ¬¾ =====

        async loadSpecialTerms() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/special-terms`);
                const data = await res.json();
                if (data.success) this.specialTermsList = data.data;
            } catch (e) { console.error('è¼‰å…¥ç‰¹è¨‚æ¢æ¬¾å¤±æ•—:', e); }
        },

        async searchSpecialTerms() {
            if (!this.currentProject || !this.stSearchQuery) return;
            this.selectedTerm = null;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/special-terms/search?q=${encodeURIComponent(this.stSearchQuery)}`);
                const data = await res.json();
                if (data.success) this.stSearchResults = data.data;
            } catch (e) { console.error('æœå°‹ç‰¹è¨‚æ¢æ¬¾å¤±æ•—:', e); }
        },

        async viewSpecialTerm(id) {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/special-terms/${id}`);
                const data = await res.json();
                if (data.success) this.selectedTerm = data.data;
            } catch (e) { console.error('è¼‰å…¥æ¢æ¬¾å…§å®¹å¤±æ•—:', e); }
        },

        // ===== æ–½å·¥æŠ€è¡“è¦ç¯„ =====

        async loadTechSpecs() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/tech-specs`);
                const data = await res.json();
                if (data.success) this.techSpecsList = data.data;
            } catch (e) { console.error('è¼‰å…¥æ–½å·¥è¦ç¯„å¤±æ•—:', e); }
        },

        async searchTechSpecs() {
            if (!this.currentProject || !this.tsSearchQuery) return;
            this.selectedSpec = null;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/tech-specs/search?q=${encodeURIComponent(this.tsSearchQuery)}`);
                const data = await res.json();
                if (data.success) this.tsSearchResults = data.data;
            } catch (e) { console.error('æœå°‹æ–½å·¥è¦ç¯„å¤±æ•—:', e); }
        },

        async viewTechSpec(id) {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/tech-specs/${id}`);
                const data = await res.json();
                if (data.success) this.selectedSpec = data.data;
            } catch (e) { console.error('è¼‰å…¥è¦ç¯„å…§å®¹å¤±æ•—:', e); }
        },

        // ===== äº¤é€šå·¥ç¨‹æ‰‹å†Š =====

        async loadTrafficManual() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/traffic-manual`);
                const data = await res.json();
                if (data.success) this.trafficManualList = data.data;
            } catch (e) { console.error('è¼‰å…¥äº¤é€šæ‰‹å†Šå¤±æ•—:', e); }
        },

        async searchTrafficManual() {
            if (!this.currentProject || !this.tmSearchQuery) return;
            this.selectedManualItem = null;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/traffic-manual/search?q=${encodeURIComponent(this.tmSearchQuery)}`);
                const data = await res.json();
                if (data.success) this.tmSearchResults = data.data;
            } catch (e) { console.error('æœå°‹äº¤é€šæ‰‹å†Šå¤±æ•—:', e); }
        },

        async viewTrafficManual(id) {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/traffic-manual/${id}`);
                const data = await res.json();
                if (data.success) this.selectedManualItem = data.data;
            } catch (e) { console.error('è¼‰å…¥æ‰‹å†Šå…§å®¹å¤±æ•—:', e); }
        },

        // ===== å·¥ç¨‹è¨ˆç•« =====

        async loadProjectPlans() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/project-plans`);
                const data = await res.json();
                if (data.success) this.projectPlansList = data.data;
            } catch (e) { console.error('è¼‰å…¥å·¥ç¨‹è¨ˆç•«å¤±æ•—:', e); }
        },

        async searchProjectPlans() {
            if (!this.currentProject || !this.ppSearchQuery) return;
            this.selectedPlanItem = null;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/project-plans/search?q=${encodeURIComponent(this.ppSearchQuery)}`);
                const data = await res.json();
                if (data.success) this.ppSearchResults = data.data;
            } catch (e) { console.error('æœå°‹å·¥ç¨‹è¨ˆç•«å¤±æ•—:', e); }
        },

        async viewProjectPlan(id) {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/project-plans/${id}`);
                const data = await res.json();
                if (data.success) this.selectedPlanItem = data.data;
            } catch (e) { console.error('è¼‰å…¥è¨ˆç•«å…§å®¹å¤±æ•—:', e); }
        },

        // ===== èªéŸ³æ—¥å ± =====

        async loadVoiceDrafts() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/voice/drafts`);
                const data = await res.json();
                if (data.success) this.voiceDrafts = data.data;
            } catch (e) { console.error('è¼‰å…¥èªéŸ³è‰ç¨¿å¤±æ•—:', e); }
        },

        async submitVoiceText() {
            if (!this.currentProject || !this.voiceTextInput.trim() || this.voiceProcessing) return;
            this.voiceProcessing = true;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/voice/transcribe-text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: this.voiceTextInput, mode: this.voiceMode })
                });
                const data = await res.json();
                if (data.success) {
                    this.voiceCurrentResult = { transcript: data.transcript, structured_data: data.structured_data };
                    this.voiceCurrentDraftId = data.draft_id;
                    this.voiceTextInput = '';
                    this.loadVoiceDrafts();
                } else {
                    alert(data.message || 'è™•ç†å¤±æ•—');
                }
            } catch (e) { alert('è™•ç†å¤±æ•—ï¼š' + e.message); }
            finally { this.voiceProcessing = false; }
        },

        async confirmCurrentDraft() {
            if (!this.voiceCurrentDraftId || this.voiceConfirming) return;
            this.voiceConfirming = true;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/voice/drafts/${this.voiceCurrentDraftId}/confirm`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    this.voiceCurrentResult = null;
                    this.voiceCurrentDraftId = null;
                    this.loadVoiceDrafts();
                } else {
                    alert(data.message || 'ç¢ºèªå¤±æ•—');
                }
            } catch (e) { alert('ç¢ºèªå¤±æ•—ï¼š' + e.message); }
            finally { this.voiceConfirming = false; }
        },

        reviewVoiceDraft(d) {
            this.voiceCurrentResult = { transcript: d.transcript, structured_data: d.structured_data };
            this.voiceCurrentDraftId = d.id;
            this.voiceMode = d.mode;
        },

        // ===== æ–‡ä»¶æƒæ =====

        async loadScannedDocs() {
            if (!this.currentProject) return;
            try {
                let url = `/api/projects/${this.currentProject.id}/scanner/list`;
                if (this.scanFilterCategory) url += `?category=${this.scanFilterCategory}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.success) this.scannedDocs = data.data;
            } catch (e) { console.error('è¼‰å…¥æƒæè¨˜éŒ„å¤±æ•—:', e); }
        },

        handleScanFile(e) {
            const file = e.target.files[0];
            this.scanFileData = file || null;
            this.scanFileReady = !!file;
        },

        async uploadScanFile() {
            if (!this.currentProject || !this.scanFileData || this.scanProcessing) return;
            this.scanProcessing = true;
            const formData = new FormData();
            formData.append('image', this.scanFileData);
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/scanner/scan`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    this.scanCurrentResult = data;
                    this.loadScannedDocs();
                    alert(data.message);
                } else {
                    alert(data.message || 'OCR è¾¨è­˜å¤±æ•—');
                }
            } catch (e) { alert('è™•ç†å¤±æ•—ï¼š' + e.message); }
            finally {
                this.scanProcessing = false;
                this.scanFileReady = false;
                this.scanFileData = null;
                if (this.$refs.scanFileInput) this.$refs.scanFileInput.value = '';
            }
        },

        async searchScannedDocs() {
            if (!this.currentProject) return;
            if (!this.scanSearchQuery.trim()) { this.loadScannedDocs(); return; }
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/scanner/search?q=${encodeURIComponent(this.scanSearchQuery)}`);
                const data = await res.json();
                if (data.success) this.scannedDocs = data.data;
            } catch (e) { console.error(e); }
        },

        viewScannedDoc(d) {
            this.scanSelectedDoc = d;
        },

        // ===== é›¶ç”¨é‡‘ =====

        async loadPettyCash() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/petty-cash`);
                const data = await res.json();
                if (data.success) { this.pettyCashItems = data.data; this.pettyCashSummary = data.summary; }
            } catch (e) { console.error('è¼‰å…¥é›¶ç”¨é‡‘å¤±æ•—:', e); }
        },

        async savePettyCash() {
            if (!this.currentProject || !this.pettyForm.description) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/petty-cash`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(this.pettyForm)
                });
                const data = await res.json();
                if (data.success) { this.showPettyForm = false; this.loadPettyCash(); }
            } catch (e) { console.error('å„²å­˜é›¶ç”¨é‡‘å¤±æ•—:', e); }
        },

        async deletePettyCash(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é›¶ç”¨é‡‘é …ç›®ï¼Ÿ')) return;
            try {
                await fetch(`/api/projects/${this.currentProject.id}/petty-cash/${id}`, { method: 'DELETE' });
                this.loadPettyCash();
            } catch (e) { console.error('åˆªé™¤é›¶ç”¨é‡‘å¤±æ•—:', e); }
        },

        // ===== å·¥ç¨‹ä¼°é©— =====

        async loadEstimates() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/estimates`);
                const data = await res.json();
                if (data.success) this.estimates = data.data;
            } catch (e) { console.error('è¼‰å…¥ä¼°é©—å¤±æ•—:', e); }
        },

        // ===== å¥‘ç´„è©³ç´°è¡¨ =====

        async loadContractItems() {
            if (!this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/contract/items`);
                const data = await res.json();
                if (data.success) this.contractItems = data.data;
            } catch (e) { console.error('è¼‰å…¥å¥‘ç´„é …ç›®å¤±æ•—:', e); }

            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/contract/summary`);
                const data = await res.json();
                if (data.success) this.contractSummary = data.data;
            } catch (e) { console.error('è¼‰å…¥æ‘˜è¦å¤±æ•—:', e); }
        },

        filteredContractItems() {
            let items = this.contractItems;
            if (this.contractLevelFilter === 'cat') items = items.filter(i => i.is_category);
            else if (this.contractLevelFilter === 'item') items = items.filter(i => !i.is_category && !i.is_subtotal && i.unit);
            else if (this.contractLevelFilter === 'sub') items = items.filter(i => i.is_subtotal);

            if (this.contractFilter) {
                const kw = this.contractFilter.toLowerCase();
                items = items.filter(i => (i.item_name || '').toLowerCase().includes(kw) || (i.item_number || '').toLowerCase().includes(kw));
            }
            return items;
        },

        async uploadContractXls(event) {
            const file = event.target.files[0];
            if (!file || !this.currentProject) return;

            this.contractUploadStatus = 'è§£æä¸­...';
            this.contractUploadSuccess = false;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/contract/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    this.contractUploadStatus = data.message;
                    this.contractUploadSuccess = true;
                    await this.loadContractItems();
                    await this.loadProject(this.currentProject.id);
                } else {
                    this.contractUploadStatus = data.error || 'è§£æå¤±æ•—';
                }
            } catch (e) {
                this.contractUploadStatus = 'ä¸Šå‚³å¤±æ•—: ' + e.message;
            }
            setTimeout(() => { this.contractUploadStatus = ''; }, 5000);
        },

        startEditItem(item) {
            this.editingItemId = item.id;
            this.editingItem = { ...item };
        },

        cancelEditItem() {
            this.editingItemId = null;
            this.editingItem = {};
        },

        async saveEditItem() {
            if (!this.editingItemId || !this.currentProject) return;
            try {
                const res = await fetch(`/api/projects/${this.currentProject.id}/contract/items/${this.editingItemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_name: this.editingItem.item_name,
                        quantity: this.editingItem.quantity ? parseFloat(this.editingItem.quantity) : null,
                        unit_price: this.editingItem.unit_price ? parseFloat(this.editingItem.unit_price) : null
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.editingItemId = null;
                    this.editingItem = {};
                    await this.loadContractItems();
                }
            } catch (e) { alert('æ›´æ–°å¤±æ•—: ' + e.message); }
        },

        async addNewContractItem() {
            if (!this.newContractItem.item_name || !this.currentProject) {
                alert('é …ç›®åç¨±ç‚ºå¿…å¡«');
                return;
            }
            try {
                const payload = { ...this.newContractItem };
                if (payload.quantity) payload.quantity = parseFloat(payload.quantity);
                if (payload.unit_price) payload.unit_price = parseFloat(payload.unit_price);

                const res = await fetch(`/api/projects/${this.currentProject.id}/contract/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    this.newContractItem = { item_number: '', item_name: '', unit: '', quantity: '', unit_price: '' };
                    this.showAddContractItem = false;
                    await this.loadContractItems();
                }
            } catch (e) { alert('æ–°å¢å¤±æ•—: ' + e.message); }
        },

        async deleteContractItem(itemId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å¥‘ç´„é …ç›®ï¼Ÿ')) return;
            try {
                await fetch(`/api/projects/${this.currentProject.id}/contract/items/${itemId}`, { method: 'DELETE' });
                await this.loadContractItems();
            } catch (e) { alert('åˆªé™¤å¤±æ•—: ' + e.message); }
        },

        // ===== å·¥å…· =====

        formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) { bytes /= 1024; i++; }
            return bytes.toFixed(1) + ' ' + units[i];
        },

        formatMoney(val) {
            if (val == null) return '-';
            return 'NT$' + Math.round(val).toLocaleString();
        },

        formatNum(val) {
            if (val == null) return '';
            if (Number.isInteger(val)) return val.toLocaleString();
            return val.toLocaleString(undefined, { maximumFractionDigits: 2 });
        }
    };
}
</script>

</body>
</html>
