<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>çµæ§‹è¨ˆç®—æ¨¡æ“¬å™¨ | ç¯‰æœªç§‘æŠ€</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { --accent: #10b981; --danger: #ef4444; --warn: #f59e0b; --safe: #22c55e; }
  body { background: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; }
  .tab-btn { transition: all .2s; }
  .tab-btn.active { background: linear-gradient(135deg, #10b981, #059669); color: #fff; box-shadow: 0 0 20px rgba(16,185,129,.3); }
  .param-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #334155; outline: none; }
  .param-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #10b981; cursor: pointer; box-shadow: 0 0 6px rgba(16,185,129,.5); }
  .param-slider::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: #10b981; cursor: pointer; border: none; }
  .gauge-ring { transition: stroke-dashoffset 0.6s ease; }
  canvas { border-radius: 12px; background: #1e293b; }
  .result-card { background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid #334155; border-radius: 12px; padding: 12px; }
  .code-ref { background: #1a2332; border-left: 3px solid #10b981; padding: 8px 12px; border-radius: 0 8px 8px 0; font-size: 12px; }
  .detail-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 4px 0; border-bottom: 1px solid #1e293b; }
  @keyframes pulse-green { 0%,100% { box-shadow: 0 0 0 0 rgba(34,197,94,.4); } 50% { box-shadow: 0 0 12px 4px rgba(34,197,94,.2); } }
  @keyframes pulse-red { 0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,.4); } 50% { box-shadow: 0 0 12px 4px rgba(239,68,68,.2); } }
  .verdict-safe { animation: pulse-green 2s infinite; }
  .verdict-fail { animation: pulse-red 2s infinite; }
  .calc-step { font-family: 'Consolas', 'Courier New', monospace; font-size: 13px; line-height: 1.6; }
  select { background: #1e293b; color: #e2e8f0; border: 1px solid #334155; border-radius: 6px; padding: 4px 8px; }
</style>
</head>
<body class="min-h-screen">

<!-- Header -->
<header class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-xl">ğŸ—ï¸</div>
    <div>
      <h1 class="text-lg font-bold">çµæ§‹è¨ˆç®—æ¨¡æ“¬å™¨</h1>
      <p class="text-xs text-slate-400">å³æ™‚äº’å‹• Â· è¦ç¯„æª¢æ ¸ Â· è¦–è¦ºåŒ–</p>
    </div>
  </div>
  <div class="flex gap-2">
    <button onclick="exportCalc()" class="px-3 py-1.5 text-sm bg-slate-700 hover:bg-slate-600 rounded-lg transition">ğŸ“‹ åŒ¯å‡º</button>
    <a href="/" class="px-3 py-1.5 text-sm bg-slate-700 hover:bg-slate-600 rounded-lg transition">â† è¿”å› CMS</a>
  </div>
</header>

<!-- Tab Navigation -->
<nav class="px-6 py-3 flex gap-2 border-b border-slate-800">
  <button class="tab-btn active px-4 py-2 rounded-lg text-sm font-medium" onclick="switchTab('wall')">ğŸ§± æ“‹åœŸç‰†</button>
  <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 hover:bg-slate-700" onclick="switchTab('beam')">ğŸ“ æ¢åˆ†æ</button>
  <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 hover:bg-slate-700" onclick="switchTab('foundation')">ğŸ›ï¸ åŸºç¤</button>
  <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 hover:bg-slate-700" onclick="switchTab('slope')">â›°ï¸ é‚Šå¡</button>
</nav>

<!-- ============ RETAINING WALL TAB ============ -->
<main id="tab-wall" class="p-4">
<div class="grid grid-cols-12 gap-4" style="height: calc(100vh - 180px);">

  <!-- Left: Parameters -->
  <div class="col-span-3 overflow-y-auto pr-2 space-y-3">
    <div class="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-1">ç‰†é«”åƒæ•¸</div>

    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>ç‰†é«˜ H (m)</span><span id="v_H" class="text-emerald-400 font-mono">5.0</span></label>
      <input type="range" class="param-slider" id="s_H" min="2" max="12" step="0.5" value="5" oninput="updateWall()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>åº•å¯¬ B (m)</span><span id="v_B" class="text-emerald-400 font-mono">3.0</span></label>
      <input type="range" class="param-slider" id="s_B" min="1" max="8" step="0.25" value="3" oninput="updateWall()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>é ‚å¯¬ t (m)</span><span id="v_t" class="text-emerald-400 font-mono">1.0</span></label>
      <input type="range" class="param-slider" id="s_t" min="0.3" max="4" step="0.1" value="1" oninput="updateWall()">
    </div>

    <div class="text-xs font-bold text-amber-400 uppercase tracking-wider mt-4 mb-1">åœŸå£¤åƒæ•¸</div>

    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>æ‘©æ“¦è§’ Ï† (Â°)</span><span id="v_phi" class="text-emerald-400 font-mono">30</span></label>
      <input type="range" class="param-slider" id="s_phi" min="15" max="45" step="1" value="30" oninput="updateWall()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>åœŸå£¤å–®ä½é‡ Î³s (kN/mÂ³)</span><span id="v_gs" class="text-emerald-400 font-mono">18</span></label>
      <input type="range" class="param-slider" id="s_gs" min="14" max="22" step="0.5" value="18" oninput="updateWall()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>å‡èšåŠ› c (kPa)</span><span id="v_c" class="text-emerald-400 font-mono">0</span></label>
      <input type="range" class="param-slider" id="s_c" min="0" max="50" step="2" value="0" oninput="updateWall()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>è¶…è¼‰ q (kPa)</span><span id="v_q" class="text-emerald-400 font-mono">10</span></label>
      <input type="range" class="param-slider" id="s_q" min="0" max="50" step="2" value="10" oninput="updateWall()">
    </div>

    <div class="text-xs font-bold text-blue-400 uppercase tracking-wider mt-4 mb-1">æ°´å£“ & åŸ‹å…¥</div>

    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>æ°´ä½é«˜ Hw (m)</span><span id="v_Hw" class="text-emerald-400 font-mono">0.0</span></label>
      <input type="range" class="param-slider" id="s_Hw" min="0" max="10" step="0.5" value="0" oninput="updateWall()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>åŸ‹å…¥æ·± D (m)</span><span id="v_D" class="text-emerald-400 font-mono">1.0</span></label>
      <input type="range" class="param-slider" id="s_D" min="0" max="4" step="0.25" value="1" oninput="updateWall()">
    </div>

    <div class="text-xs font-bold text-purple-400 uppercase tracking-wider mt-4 mb-1">ææ–™ & åœ°åŸº</div>

    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>æ··å‡åœŸ Î³c (kN/mÂ³)</span><span id="v_gc" class="text-emerald-400 font-mono">24</span></label>
      <input type="range" class="param-slider" id="s_gc" min="20" max="26" step="0.5" value="24" oninput="updateWall()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>å®¹è¨±æ‰¿è¼‰åŠ› qa (kPa)</span><span id="v_qa" class="text-emerald-400 font-mono">200</span></label>
      <input type="range" class="param-slider" id="s_qa" min="50" max="600" step="25" value="200" oninput="updateWall()">
    </div>

    <div class="mt-3 space-y-1">
      <label class="text-xs text-slate-400">ç‰†å‹</label>
      <select id="wall_type" onchange="updateWall()" class="w-full text-sm">
        <option value="gravity">é‡åŠ›å¼</option>
        <option value="cantilever">æ‡¸è‡‚å¼</option>
      </select>
    </div>
    <div class="space-y-1">
      <label class="text-xs text-slate-400">å·¥æ³</label>
      <select id="load_case" onchange="updateWall()" class="w-full text-sm">
        <option value="normal">å¸¸æ™‚ (FS: 2.0/1.5/3.0)</option>
        <option value="seismic">åœ°éœ‡æ™‚ (FS: 1.5/1.2/2.0)</option>
      </select>
    </div>
  </div>

  <!-- Center: Canvas -->
  <div class="col-span-6 flex flex-col">
    <canvas id="wallCanvas" class="w-full flex-1"></canvas>
  </div>

  <!-- Right: Results -->
  <div class="col-span-3 overflow-y-auto pl-2 space-y-3">

    <!-- Verdict -->
    <div id="verdict" class="result-card text-center py-3 verdict-safe">
      <div id="verdict-icon" class="text-3xl mb-1">âœ…</div>
      <div id="verdict-text" class="text-sm font-bold text-green-400">çµæ§‹å®‰å…¨</div>
    </div>

    <!-- 3 Gauges -->
    <div class="grid grid-cols-3 gap-2">
      <div class="text-center">
        <svg viewBox="0 0 80 80" class="w-full">
          <circle cx="40" cy="40" r="34" fill="none" stroke="#334155" stroke-width="6"/>
          <circle id="g_ot" cx="40" cy="40" r="34" fill="none" stroke="#22c55e" stroke-width="6"
                  stroke-dasharray="213.6" stroke-dashoffset="213.6" stroke-linecap="round"
                  transform="rotate(-90 40 40)" class="gauge-ring"/>
          <text x="40" y="38" text-anchor="middle" fill="#e2e8f0" font-size="14" font-weight="bold" id="gt_ot">2.0</text>
          <text x="40" y="52" text-anchor="middle" fill="#94a3b8" font-size="8">å‚¾è¦†</text>
        </svg>
      </div>
      <div class="text-center">
        <svg viewBox="0 0 80 80" class="w-full">
          <circle cx="40" cy="40" r="34" fill="none" stroke="#334155" stroke-width="6"/>
          <circle id="g_sl" cx="40" cy="40" r="34" fill="none" stroke="#22c55e" stroke-width="6"
                  stroke-dasharray="213.6" stroke-dashoffset="213.6" stroke-linecap="round"
                  transform="rotate(-90 40 40)" class="gauge-ring"/>
          <text x="40" y="38" text-anchor="middle" fill="#e2e8f0" font-size="14" font-weight="bold" id="gt_sl">1.5</text>
          <text x="40" y="52" text-anchor="middle" fill="#94a3b8" font-size="8">æ»‘å‹•</text>
        </svg>
      </div>
      <div class="text-center">
        <svg viewBox="0 0 80 80" class="w-full">
          <circle cx="40" cy="40" r="34" fill="none" stroke="#334155" stroke-width="6"/>
          <circle id="g_br" cx="40" cy="40" r="34" fill="none" stroke="#22c55e" stroke-width="6"
                  stroke-dasharray="213.6" stroke-dashoffset="213.6" stroke-linecap="round"
                  transform="rotate(-90 40 40)" class="gauge-ring"/>
          <text x="40" y="38" text-anchor="middle" fill="#e2e8f0" font-size="14" font-weight="bold" id="gt_br">3.0</text>
          <text x="40" y="52" text-anchor="middle" fill="#94a3b8" font-size="8">æ‰¿è¼‰</text>
        </svg>
      </div>
    </div>

    <!-- Key Values -->
    <div class="result-card space-y-1 text-xs">
      <div class="text-emerald-400 font-bold text-xs uppercase mb-2">è¨ˆç®—çµæœ</div>
      <div class="detail-row"><span class="text-slate-400">ä¸»å‹•åœŸå£“ä¿‚æ•¸ Ka</span><span id="r_Ka" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">ä¸»å‹•åœŸå£“åŠ› Pa</span><span id="r_Pa" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">è¶…è¼‰åœŸå£“åŠ› Pq</span><span id="r_Pq" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æ°´å£“åŠ› Pw</span><span id="r_Pw" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">è¢«å‹•åœŸå£“åŠ› Pp</span><span id="r_Pp" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">ç‰†é«”è‡ªé‡ W</span><span id="r_W" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">å‚¾è¦†åŠ›çŸ© Mo</span><span id="r_Mo" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æŠµæŠ—åŠ›çŸ© Mr</span><span id="r_Mr" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">åå¿ƒè· e</span><span id="r_e" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æœ€å¤§åŸºåº•å£“åŠ› qmax</span><span id="r_qmax" class="font-mono">-</span></div>
    </div>

    <!-- Code References -->
    <div class="result-card space-y-2">
      <div class="text-purple-400 font-bold text-xs uppercase mb-1">è¦ç¯„ä¾æ“š</div>
      <div class="code-ref">
        <div class="font-bold text-emerald-300">å»ºç¯‰æŠ€è¡“è¦å‰‡ æ§‹é€ ç·¨</div>
        <div class="text-slate-400 mt-1">Â§63 æ“‹åœŸç‰†ï¼šå‚¾è¦† FSâ‰¥2.0ã€æ»‘å‹• FSâ‰¥1.5</div>
      </div>
      <div class="code-ref">
        <div class="font-bold text-emerald-300">å…¬è·¯æ©‹æ¢è¨­è¨ˆè¦ç¯„</div>
        <div class="text-slate-400 mt-1">Â§11.6 æ“‹åœŸçµæ§‹ç‰©ç©©å®šæ€§æª¢æ ¸</div>
      </div>
      <div class="code-ref">
        <div class="font-bold text-emerald-300">åœ°å·¥æŠ€è¡“è¦ç¯„</div>
        <div class="text-slate-400 mt-1">Rankine ä¸»å‹•åœŸå£“åŠ›ç†è«–<br>Ka = tanÂ²(45Â° - Ï†/2)</div>
      </div>
      <div class="code-ref" id="seismic_ref" style="display:none">
        <div class="font-bold text-amber-300">è€éœ‡è¨­è¨ˆè¦ç¯„</div>
        <div class="text-slate-400 mt-1">åœ°éœ‡æ™‚ï¼šå‚¾è¦† FSâ‰¥1.5ã€æ»‘å‹• FSâ‰¥1.2ã€æ‰¿è¼‰ FSâ‰¥2.0</div>
      </div>
    </div>
  </div>
</div>

<!-- Calculation Details (collapsible) -->
<details class="mt-3 bg-slate-800/50 rounded-xl p-4">
  <summary class="cursor-pointer text-sm font-bold text-emerald-400">ğŸ“ è©³ç´°è¨ˆç®—éç¨‹ï¼ˆé»æ“Šå±•é–‹ï¼‰</summary>
  <div id="calc_steps" class="calc-step mt-3 text-slate-300 whitespace-pre-wrap"></div>
</details>
</main>

<!-- ============ BEAM TAB ============ -->
<main id="tab-beam" class="p-4 hidden">
<div class="grid grid-cols-12 gap-4" style="height: calc(100vh - 180px);">

  <!-- Left: Parameters -->
  <div class="col-span-3 overflow-y-auto pr-2 space-y-3">
    <div class="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-1">æ¢åƒæ•¸</div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>è·¨åº¦ L (m)</span><span id="v_bL" class="text-emerald-400 font-mono">6.0</span></label>
      <input type="range" class="param-slider" id="s_bL" min="2" max="16" step="0.5" value="6" oninput="updateBeam()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>å‡ä½ˆè¼‰é‡ w (kN/m)</span><span id="v_bw" class="text-emerald-400 font-mono">20</span></label>
      <input type="range" class="param-slider" id="s_bw" min="1" max="100" step="1" value="20" oninput="updateBeam()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>é›†ä¸­åŠ› P (kN)</span><span id="v_bP" class="text-emerald-400 font-mono">0</span></label>
      <input type="range" class="param-slider" id="s_bP" min="0" max="200" step="5" value="0" oninput="updateBeam()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>é›†ä¸­åŠ›ä½ç½® a/L</span><span id="v_ba" class="text-emerald-400 font-mono">0.50</span></label>
      <input type="range" class="param-slider" id="s_ba" min="0.1" max="0.9" step="0.05" value="0.5" oninput="updateBeam()">
    </div>

    <div class="text-xs font-bold text-amber-400 uppercase tracking-wider mt-4 mb-1">æ–·é¢</div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>å¯¬åº¦ b (mm)</span><span id="v_bb" class="text-emerald-400 font-mono">300</span></label>
      <input type="range" class="param-slider" id="s_bb" min="200" max="600" step="25" value="300" oninput="updateBeam()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>æ·±åº¦ h (mm)</span><span id="v_bh" class="text-emerald-400 font-mono">500</span></label>
      <input type="range" class="param-slider" id="s_bh" min="300" max="1000" step="25" value="500" oninput="updateBeam()">
    </div>

    <div class="text-xs font-bold text-purple-400 uppercase tracking-wider mt-4 mb-1">ææ–™</div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>fc' (MPa)</span><span id="v_bfc" class="text-emerald-400 font-mono">28</span></label>
      <input type="range" class="param-slider" id="s_bfc" min="21" max="56" step="3.5" value="28" oninput="updateBeam()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>fy (MPa)</span><span id="v_bfy" class="text-emerald-400 font-mono">420</span></label>
      <input type="range" class="param-slider" id="s_bfy" min="280" max="520" step="20" value="420" oninput="updateBeam()">
    </div>

    <div class="mt-3 space-y-1">
      <label class="text-xs text-slate-400">æ”¯æ‰¿å‹å¼</label>
      <select id="beam_type" onchange="updateBeam()" class="w-full text-sm">
        <option value="simple">ç°¡æ”¯æ¢</option>
        <option value="cantilever">æ‡¸è‡‚æ¢</option>
        <option value="fixed">å…©ç«¯å›ºå®š</option>
      </select>
    </div>
  </div>

  <!-- Center: Canvas -->
  <div class="col-span-6 flex flex-col">
    <canvas id="beamCanvas" class="w-full flex-1"></canvas>
  </div>

  <!-- Right: Results -->
  <div class="col-span-3 overflow-y-auto pl-2 space-y-3">
    <div class="result-card space-y-1 text-xs">
      <div class="text-emerald-400 font-bold text-xs uppercase mb-2">åˆ†æçµæœ</div>
      <div class="detail-row"><span class="text-slate-400">æœ€å¤§å½çŸ© Mmax</span><span id="r_bM" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æœ€å¤§å‰ªåŠ› Vmax</span><span id="r_bV" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æœ€å¤§æ’“åº¦ Î´max</span><span id="r_bd" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">å®¹è¨±æ’“åº¦ L/360</span><span id="r_bdlim" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æ’“åº¦æª¢æ ¸</span><span id="r_bdchk" class="font-mono">-</span></div>
    </div>
    <div class="result-card space-y-1 text-xs">
      <div class="text-amber-400 font-bold text-xs uppercase mb-2">RC é…ç­‹è¨­è¨ˆ</div>
      <div class="detail-row"><span class="text-slate-400">æœ‰æ•ˆæ·±åº¦ d</span><span id="r_bd2" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æ‰€éœ€é‹¼ç­‹ As</span><span id="r_bAs" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æœ€å°é‹¼ç­‹ As,min</span><span id="r_bAsmin" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">é…ç­‹ç‡ Ï</span><span id="r_brho" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">å»ºè­°é…ç­‹</span><span id="r_brebar" class="font-mono">-</span></div>
    </div>
    <div class="result-card space-y-2">
      <div class="text-purple-400 font-bold text-xs uppercase mb-1">è¦ç¯„ä¾æ“š</div>
      <div class="code-ref">
        <div class="font-bold text-emerald-300">æ··å‡åœŸçµæ§‹è¨­è¨ˆè¦ç¯„</div>
        <div class="text-slate-400 mt-1">ACI 318 / åœŸæœ¨401<br>Ï†Mn â‰¥ Mu, Ï†=0.9(å½çŸ©)</div>
      </div>
      <div class="code-ref">
        <div class="font-bold text-emerald-300">æ’“åº¦é™åˆ¶</div>
        <div class="text-slate-400 mt-1">ä¸€èˆ¬æ¢: L/360<br>æ‡¸è‡‚: L/180</div>
      </div>
    </div>
  </div>
</div>
</main>

<!-- ============ FOUNDATION TAB ============ -->
<main id="tab-foundation" class="p-4 hidden">
<div class="grid grid-cols-12 gap-4" style="height: calc(100vh - 180px);">
  <div class="col-span-3 overflow-y-auto pr-2 space-y-3">
    <div class="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-1">åŸºç¤åƒæ•¸</div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>åŸºç¤å¯¬åº¦ B (m)</span><span id="v_fB" class="text-emerald-400 font-mono">2.0</span></label>
      <input type="range" class="param-slider" id="s_fB" min="0.5" max="6" step="0.25" value="2" oninput="updateFoundation()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>åŸºç¤é•·åº¦ L (m)</span><span id="v_fL" class="text-emerald-400 font-mono">2.0</span></label>
      <input type="range" class="param-slider" id="s_fL" min="0.5" max="6" step="0.25" value="2" oninput="updateFoundation()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>åŸ‹å…¥æ·±åº¦ Df (m)</span><span id="v_fDf" class="text-emerald-400 font-mono">1.5</span></label>
      <input type="range" class="param-slider" id="s_fDf" min="0.5" max="4" step="0.25" value="1.5" oninput="updateFoundation()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>å‚ç›´è¼‰é‡ V (kN)</span><span id="v_fV" class="text-emerald-400 font-mono">500</span></label>
      <input type="range" class="param-slider" id="s_fV" min="100" max="3000" step="50" value="500" oninput="updateFoundation()">
    </div>
    <div class="text-xs font-bold text-amber-400 uppercase tracking-wider mt-4 mb-1">åœŸå£¤åƒæ•¸</div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>æ‘©æ“¦è§’ Ï† (Â°)</span><span id="v_fphi" class="text-emerald-400 font-mono">30</span></label>
      <input type="range" class="param-slider" id="s_fphi" min="15" max="45" step="1" value="30" oninput="updateFoundation()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>å‡èšåŠ› c (kPa)</span><span id="v_fc2" class="text-emerald-400 font-mono">10</span></label>
      <input type="range" class="param-slider" id="s_fc2" min="0" max="100" step="5" value="10" oninput="updateFoundation()">
    </div>
    <div class="space-y-1">
      <label class="flex justify-between text-xs"><span>åœŸå£¤å–®ä½é‡ Î³ (kN/mÂ³)</span><span id="v_fg" class="text-emerald-400 font-mono">18</span></label>
      <input type="range" class="param-slider" id="s_fg" min="14" max="22" step="0.5" value="18" oninput="updateFoundation()">
    </div>
  </div>
  <div class="col-span-6 flex flex-col">
    <canvas id="foundCanvas" class="w-full flex-1"></canvas>
  </div>
  <div class="col-span-3 overflow-y-auto pl-2 space-y-3">
    <div id="fVerdict" class="result-card text-center py-3 verdict-safe">
      <div id="fVerdict-icon" class="text-3xl mb-1">âœ…</div>
      <div id="fVerdict-text" class="text-sm font-bold text-green-400">æ‰¿è¼‰å®‰å…¨</div>
    </div>
    <div class="result-card space-y-1 text-xs">
      <div class="text-emerald-400 font-bold text-xs uppercase mb-2">Terzaghi æ‰¿è¼‰åŠ›</div>
      <div class="detail-row"><span class="text-slate-400">Nc</span><span id="r_fNc" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">Nq</span><span id="r_fNq" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">NÎ³</span><span id="r_fNg" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">æ¥µé™æ‰¿è¼‰åŠ› qu</span><span id="r_fqu" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">å®¹è¨±æ‰¿è¼‰åŠ› qa</span><span id="r_fqa" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">å¯¦éš›å£“åŠ› q</span><span id="r_fqact" class="font-mono">-</span></div>
      <div class="detail-row"><span class="text-slate-400">å®‰å…¨ä¿‚æ•¸ FS</span><span id="r_fFS" class="font-mono">-</span></div>
    </div>
    <div class="result-card space-y-2">
      <div class="text-purple-400 font-bold text-xs uppercase mb-1">è¦ç¯„ä¾æ“š</div>
      <div class="code-ref">
        <div class="font-bold text-emerald-300">å»ºç¯‰æŠ€è¡“è¦å‰‡ Â§63</div>
        <div class="text-slate-400 mt-1">æ·ºåŸºç¤æ‰¿è¼‰åŠ› FS â‰¥ 3.0</div>
      </div>
    </div>
  </div>
</div>
</main>

<!-- ============ SLOPE TAB (placeholder) ============ -->
<main id="tab-slope" class="p-4 hidden">
  <div class="flex items-center justify-center" style="height: calc(100vh - 180px);">
    <div class="text-center text-slate-500">
      <div class="text-6xl mb-4">â›°ï¸</div>
      <div class="text-xl font-bold">é‚Šå¡ç©©å®šåˆ†æ</div>
      <div class="text-sm mt-2">é–‹ç™¼ä¸­ â€” å°‡æ”¯æ´ Bishop ç°¡åŒ–æ³•</div>
    </div>
  </div>
</main>

<script>
// ===== TAB SWITCHING =====
function switchTab(tab) {
  document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
  document.getElementById('tab-' + tab).classList.remove('hidden');
  document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('bg-slate-800'); });
  event.target.classList.add('active');
  event.target.classList.remove('bg-slate-800');
  if (tab === 'wall') updateWall();
  if (tab === 'beam') updateBeam();
  if (tab === 'foundation') updateFoundation();
}

// ===== UTILITY =====
const $ = id => document.getElementById(id);
const deg2rad = d => d * Math.PI / 180;
const fmt = (v, d=2) => v.toFixed(d);

function setGauge(id, textId, value, reqMin) {
  const maxVal = reqMin * 2.5;
  const ratio = Math.min(value / maxVal, 1);
  const circ = 213.6;
  $(id).setAttribute('stroke-dashoffset', circ * (1 - ratio));
  $(textId).textContent = fmt(value, 1);
  const color = value >= reqMin ? '#22c55e' : value >= reqMin * 0.8 ? '#f59e0b' : '#ef4444';
  $(id).setAttribute('stroke', color);
}

// ===== RETAINING WALL CALCULATION ENGINE =====
function calcWall() {
  const H = parseFloat($('s_H').value);
  const B = parseFloat($('s_B').value);
  const t = Math.min(parseFloat($('s_t').value), B - 0.1);
  const phi = parseFloat($('s_phi').value);
  const gs = parseFloat($('s_gs').value);
  const c = parseFloat($('s_c').value);
  const q = parseFloat($('s_q').value);
  const Hw = Math.min(parseFloat($('s_Hw').value), H);
  const D = parseFloat($('s_D').value);
  const gc = parseFloat($('s_gc').value);
  const qa = parseFloat($('s_qa').value);
  const isSeismic = $('load_case').value === 'seismic';

  const phiRad = deg2rad(phi);
  const Ka = Math.pow(Math.tan(deg2rad(45) - phiRad / 2), 2);
  const Kp = Math.pow(Math.tan(deg2rad(45) + phiRad / 2), 2);

  // Forces (per meter run)
  const Pa = 0.5 * gs * H * H * Ka;
  const Pq = q * Ka * H;
  const Pw = 0.5 * 9.81 * Hw * Hw;
  const Pp = 0.5 * gs * D * D * Kp;

  // Wall self-weight (trapezoid: front slopes, back vertical)
  const Arect = t * H;
  const Atri = (B - t) * H / 2;
  const Atotal = Arect + Atri;
  const W = Atotal * gc;

  // Centroid from toe
  const xRect = B - t / 2;
  const xTri = (B - t) * 2 / 3;
  const xBar = (Arect * xRect + Atri * xTri) / Atotal;

  // Soil weight on heel (above base, behind wall top) â€” for cantilever
  const wType = $('wall_type').value;
  let Ws = 0, xWs = 0;
  if (wType === 'cantilever') {
    // Soil above heel slab
    Ws = gs * H * (B - t) * 0.5;
    xWs = B - (B - t) / 3;
  }

  // Overturning moments about toe
  const Mo = Pa * (H / 3) + Pq * (H / 2) + Pw * (Hw / 3);
  const Mr = W * xBar + Pp * (D / 3) + (Ws > 0 ? Ws * xWs : 0);

  const FS_ot = Mo > 0 ? Mr / Mo : 99;

  // Sliding
  const delta = phi * 2 / 3;
  const deltaRad = deg2rad(delta);
  const resist = (W + Ws) * Math.tan(deltaRad) + c * B + Pp;
  const driving = Pa + Pq + Pw;
  const FS_sl = driving > 0 ? resist / driving : 99;

  // Bearing capacity
  const Vtotal = W + Ws;
  const Mnet = Mr - Mo;
  const e = B / 2 - Mnet / Vtotal;
  let qmax;
  if (Math.abs(e) <= B / 6) {
    qmax = Vtotal / B * (1 + 6 * e / B);
  } else {
    qmax = 2 * Vtotal / (3 * (B / 2 - e));
  }
  const FS_br = qmax > 0 ? qa / qmax : 99;

  // Required FS
  const req_ot = isSeismic ? 1.5 : 2.0;
  const req_sl = isSeismic ? 1.2 : 1.5;
  const req_br = isSeismic ? 2.0 : 3.0;

  return {
    H, B, t, phi, gs, c, q, Hw, D, gc, qa, Ka, Kp,
    Pa, Pq, Pw, Pp, W, Ws, xBar,
    Mo, Mr, FS_ot, FS_sl, FS_br,
    e, qmax, Vtotal,
    req_ot, req_sl, req_br,
    isSeismic, wType,
    safe: FS_ot >= req_ot && FS_sl >= req_sl && FS_br >= req_br
  };
}

function updateWall() {
  // Update value displays
  ['H','B','t','phi','gs','c','q','Hw','D','gc','qa'].forEach(k => {
    const map = {H:'H',B:'B',t:'t',phi:'phi',gs:'gs',c:'c',q:'q',Hw:'Hw',D:'D',gc:'gc',qa:'qa'};
    $('v_' + map[k]).textContent = parseFloat($('s_' + map[k]).value).toFixed(k==='phi'||k==='c'||k==='q'||k==='qa' ? 0 : 1);
  });

  const r = calcWall();

  // Gauges
  setGauge('g_ot', 'gt_ot', r.FS_ot, r.req_ot);
  setGauge('g_sl', 'gt_sl', r.FS_sl, r.req_sl);
  setGauge('g_br', 'gt_br', r.FS_br, r.req_br);

  // Values
  $('r_Ka').textContent = fmt(r.Ka, 3);
  $('r_Pa').textContent = fmt(r.Pa, 1) + ' kN/m';
  $('r_Pq').textContent = fmt(r.Pq, 1) + ' kN/m';
  $('r_Pw').textContent = fmt(r.Pw, 1) + ' kN/m';
  $('r_Pp').textContent = fmt(r.Pp, 1) + ' kN/m';
  $('r_W').textContent = fmt(r.W, 1) + ' kN/m';
  $('r_Mo').textContent = fmt(r.Mo, 1) + ' kNÂ·m/m';
  $('r_Mr').textContent = fmt(r.Mr, 1) + ' kNÂ·m/m';
  $('r_e').textContent = fmt(r.e, 3) + ' m';
  $('r_qmax').textContent = fmt(r.qmax, 1) + ' kPa';

  // Verdict
  if (r.safe) {
    $('verdict').className = 'result-card text-center py-3 verdict-safe';
    $('verdict-icon').textContent = 'âœ…';
    $('verdict-text').textContent = 'çµæ§‹å®‰å…¨';
    $('verdict-text').className = 'text-sm font-bold text-green-400';
  } else {
    $('verdict').className = 'result-card text-center py-3 verdict-fail';
    $('verdict-icon').textContent = 'âŒ';
    $('verdict-text').textContent = 'éœ€è¦èª¿æ•´';
    $('verdict-text').className = 'text-sm font-bold text-red-400';
  }

  // Seismic ref
  $('seismic_ref').style.display = r.isSeismic ? 'block' : 'none';

  // Calc steps
  const steps = `â”â”â” æ“‹åœŸç‰†ç©©å®šæ€§åˆ†æ â”â”â”

ã€è¼¸å…¥åƒæ•¸ã€‘
  ç‰†é«˜ H = ${fmt(r.H,1)} m, åº•å¯¬ B = ${fmt(r.B,1)} m, é ‚å¯¬ t = ${fmt(r.t,1)} m
  åœŸå£¤: Ï† = ${r.phi}Â°, Î³s = ${r.gs} kN/mÂ³, c = ${r.c} kPa
  è¶…è¼‰ q = ${r.q} kPa, æ°´ä½ Hw = ${fmt(r.Hw,1)} m, åŸ‹å…¥ D = ${fmt(r.D,1)} m
  æ··å‡åœŸ Î³c = ${r.gc} kN/mÂ³, å®¹è¨±æ‰¿è¼‰åŠ› qa = ${r.qa} kPa

ã€Step 1ã€‘ä¸»å‹•åœŸå£“ä¿‚æ•¸ (Rankine)
  Ka = tanÂ²(45Â° - Ï†/2) = tanÂ²(45Â° - ${r.phi/2}Â°) = ${fmt(r.Ka,4)}

ã€Step 2ã€‘ä½œç”¨åŠ›
  Pa = Â½ Ã— Î³s Ã— HÂ² Ã— Ka = Â½ Ã— ${r.gs} Ã— ${fmt(r.H,1)}Â² Ã— ${fmt(r.Ka,4)} = ${fmt(r.Pa,2)} kN/m
  Pq = q Ã— Ka Ã— H = ${r.q} Ã— ${fmt(r.Ka,4)} Ã— ${fmt(r.H,1)} = ${fmt(r.Pq,2)} kN/m
  Pw = Â½ Ã— Î³w Ã— HwÂ² = Â½ Ã— 9.81 Ã— ${fmt(r.Hw,1)}Â² = ${fmt(r.Pw,2)} kN/m
  Pp = Â½ Ã— Î³s Ã— DÂ² Ã— Kp = Â½ Ã— ${r.gs} Ã— ${fmt(r.D,1)}Â² Ã— ${fmt(r.Kp,4)} = ${fmt(r.Pp,2)} kN/m

ã€Step 3ã€‘ç‰†é«”è‡ªé‡
  æˆªé¢ç© A = (B + t)/2 Ã— H = (${fmt(r.B,1)} + ${fmt(r.t,1)})/2 Ã— ${fmt(r.H,1)} = ${fmt((r.B+r.t)/2*r.H,2)} mÂ²
  W = A Ã— Î³c = ${fmt(r.W,2)} kN/m
  é‡å¿ƒè·è¶¾ç«¯ xÌ„ = ${fmt(r.xBar,3)} m

ã€Step 4ã€‘å‚¾è¦†æª¢æ ¸ï¼ˆå°è¶¾ç«¯å–çŸ©ï¼‰
  å‚¾è¦†åŠ›çŸ© Mo = PaÃ—H/3 + PqÃ—H/2 + PwÃ—Hw/3 = ${fmt(r.Mo,2)} kNÂ·m/m
  æŠµæŠ—åŠ›çŸ© Mr = WÃ—xÌ„ + PpÃ—D/3 = ${fmt(r.Mr,2)} kNÂ·m/m
  FSå‚¾è¦† = Mr/Mo = ${fmt(r.FS_ot,2)} ${r.FS_ot >= r.req_ot ? 'â‰¥' : '<'} ${r.req_ot} â†’ ${r.FS_ot >= r.req_ot ? 'âœ… OK' : 'âŒ NG'}

ã€Step 5ã€‘æ»‘å‹•æª¢æ ¸
  Î´ = 2Ï†/3 = ${fmt(r.phi*2/3,1)}Â°
  æŠµæŠ—åŠ› = WÃ—tan(Î´) + cÃ—B + Pp = ${fmt(r.W*Math.tan(deg2rad(r.phi*2/3))+r.c*r.B+r.Pp,2)} kN/m
  é©…å‹•åŠ› = Pa + Pq + Pw = ${fmt(r.Pa+r.Pq+r.Pw,2)} kN/m
  FSæ»‘å‹• = ${fmt(r.FS_sl,2)} ${r.FS_sl >= r.req_sl ? 'â‰¥' : '<'} ${r.req_sl} â†’ ${r.FS_sl >= r.req_sl ? 'âœ… OK' : 'âŒ NG'}

ã€Step 6ã€‘æ‰¿è¼‰åŠ›æª¢æ ¸
  åˆåŠ›åå¿ƒ e = B/2 - (Mr-Mo)/V = ${fmt(r.e,3)} m ${Math.abs(r.e)<=r.B/6 ? '(åœ¨æ ¸å¿ƒå…§ B/6=' + fmt(r.B/6,3) + ')' : '(è¶…å‡ºæ ¸å¿ƒ!)'}
  æœ€å¤§åŸºåº•å£“åŠ› qmax = ${fmt(r.qmax,1)} kPa
  FSæ‰¿è¼‰ = qa/qmax = ${r.qa}/${fmt(r.qmax,1)} = ${fmt(r.FS_br,2)} ${r.FS_br >= r.req_br ? 'â‰¥' : '<'} ${r.req_br} â†’ ${r.FS_br >= r.req_br ? 'âœ… OK' : 'âŒ NG'}

ã€çµè«–ã€‘${r.safe ? 'âœ… ä¸‰é …æª¢æ ¸å‡é€šéï¼Œçµæ§‹å®‰å…¨' : 'âŒ æœ‰é …ç›®æœªé€šéï¼Œéœ€èª¿æ•´è¨­è¨ˆ'}`;

  $('calc_steps').textContent = steps;
  drawWall(r);
}

// ===== RETAINING WALL CANVAS =====
function drawWall(r) {
  const canvas = $('wallCanvas');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * 2;
  canvas.height = rect.height * 2;
  const ctx = canvas.getContext('2d');
  ctx.scale(2, 2);
  const W = rect.width, HH = rect.height;

  ctx.clearRect(0, 0, W, HH);

  const margin = 50;
  const drawW = W - margin * 2;
  const drawH = HH - margin * 2;

  const totalH = r.H + r.D + 1;
  const totalW = r.B * 2.5;
  const scale = Math.min(drawW / totalW, drawH / totalH);

  const groundY = margin + (r.H + 1) * scale;
  const wallLeft = margin + r.B * 0.6 * scale;

  // Draw sky/ground background
  ctx.fillStyle = '#1a2a1a';
  ctx.fillRect(0, groundY, W, HH - groundY);

  // Ground line
  ctx.strokeStyle = '#4a6741';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, groundY);
  ctx.lineTo(W, groundY);
  ctx.stroke();

  // Soil behind wall (right side, above ground)
  const wallRight = wallLeft + r.B * scale;
  const wallTop = groundY - r.H * scale;
  ctx.fillStyle = 'rgba(194, 160, 96, 0.3)';
  ctx.fillRect(wallRight, wallTop, W - wallRight, r.H * scale);

  // Soil pattern (dots)
  ctx.fillStyle = 'rgba(194, 160, 96, 0.4)';
  for (let y = wallTop + 10; y < groundY; y += 15) {
    for (let x = wallRight + 10; x < W - 20; x += 15) {
      if (Math.random() > 0.3) {
        ctx.beginPath();
        ctx.arc(x + Math.random() * 5, y + Math.random() * 5, 1.5, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }

  // Water behind wall
  if (r.Hw > 0) {
    const waterTop = groundY - r.Hw * scale;
    ctx.fillStyle = 'rgba(30, 144, 255, 0.2)';
    ctx.fillRect(wallRight, waterTop, W - wallRight, r.Hw * scale);
    // Water level line
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(wallRight, waterTop);
    ctx.lineTo(W - 20, waterTop);
    ctx.stroke();
    ctx.setLineDash([]);
    // Label
    ctx.fillStyle = '#60a5fa';
    ctx.font = '11px sans-serif';
    ctx.fillText('â–½ Hw=' + fmt(r.Hw, 1) + 'm', wallRight + 5, waterTop - 4);
  }

  // Wall (trapezoid)
  const topLeft = wallRight - r.t * scale;
  ctx.fillStyle = '#6b7280';
  ctx.strokeStyle = '#9ca3af';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(wallLeft, groundY);         // bottom-left (toe)
  ctx.lineTo(wallRight, groundY);        // bottom-right (heel)
  ctx.lineTo(wallRight, wallTop);        // top-right
  ctx.lineTo(topLeft, wallTop);          // top-left
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  // Wall texture lines
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  for (let y = wallTop + 20; y < groundY; y += 20) {
    ctx.beginPath();
    const lx = wallLeft + (wallRight - wallLeft - r.t * scale) * (groundY - y) / (r.H * scale);
    ctx.moveTo(Math.max(wallLeft, topLeft + (wallLeft - topLeft) * (y - wallTop) / (r.H * scale)), y);
    ctx.lineTo(wallRight, y);
    ctx.stroke();
  }

  // Embedment
  if (r.D > 0) {
    const embedBottom = groundY + r.D * scale;
    ctx.fillStyle = 'rgba(107, 114, 128, 0.5)';
    ctx.fillRect(wallLeft, groundY, (wallRight - wallLeft), r.D * scale);
    ctx.strokeStyle = '#9ca3af';
    ctx.strokeRect(wallLeft, groundY, (wallRight - wallLeft), r.D * scale);
  }

  // ---- FORCE ARROWS ----
  const arrowSize = 8;

  function drawArrow(x1, y1, x2, y2, color, label) {
    ctx.strokeStyle = color;
    ctx.fillStyle = color;
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    // Arrowhead
    const angle = Math.atan2(y2 - y1, x2 - x1);
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - arrowSize * Math.cos(angle - 0.4), y2 - arrowSize * Math.sin(angle - 0.4));
    ctx.lineTo(x2 - arrowSize * Math.cos(angle + 0.4), y2 - arrowSize * Math.sin(angle + 0.4));
    ctx.closePath();
    ctx.fill();
    // Label
    if (label) {
      ctx.font = 'bold 11px sans-serif';
      ctx.fillText(label, (x1 + x2) / 2 + 5, (y1 + y2) / 2 - 5);
    }
  }

  // Active earth pressure (red arrows - triangular distribution)
  const paScale = Math.min(80, r.Pa * 0.8);
  ctx.fillStyle = 'rgba(239, 68, 68, 0.15)';
  ctx.beginPath();
  ctx.moveTo(wallRight, wallTop);
  ctx.lineTo(wallRight, groundY);
  ctx.lineTo(wallRight + paScale, groundY);
  ctx.closePath();
  ctx.fill();

  for (let i = 0; i <= 4; i++) {
    const frac = i / 4;
    const y = wallTop + frac * r.H * scale;
    const len = frac * paScale;
    if (len > 3) {
      drawArrow(wallRight + len, y, wallRight + 2, y, '#ef4444', i === 4 ? 'Pa=' + fmt(r.Pa, 0) : '');
    }
  }

  // Water pressure (blue arrows)
  if (r.Pw > 0) {
    const pwScale = Math.min(60, r.Pw * 0.6);
    const waterTop = groundY - r.Hw * scale;
    ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
    ctx.beginPath();
    ctx.moveTo(wallRight, waterTop);
    ctx.lineTo(wallRight, groundY);
    ctx.lineTo(wallRight + pwScale, groundY);
    ctx.closePath();
    ctx.fill();
    drawArrow(wallRight + pwScale * 0.7, groundY - r.Hw * scale * 0.3, wallRight + 2, groundY - r.Hw * scale * 0.3, '#3b82f6', 'Pw=' + fmt(r.Pw, 0));
  }

  // Wall weight (green arrow downward)
  const cx = (wallLeft + wallRight) / 2;
  const cy = (wallTop + groundY) / 2;
  drawArrow(cx, cy - 25, cx, cy + 25, '#22c55e', 'W=' + fmt(r.W, 0));

  // Passive pressure (green arrows at embedment)
  if (r.Pp > 0 && r.D > 0) {
    const ppLen = Math.min(40, r.Pp * 0.5);
    const embedMid = groundY + r.D * scale * 0.5;
    drawArrow(wallLeft - ppLen, embedMid, wallLeft - 2, embedMid, '#22c55e', 'Pp=' + fmt(r.Pp, 0));
  }

  // ---- DIMENSIONS ----
  ctx.strokeStyle = '#64748b';
  ctx.fillStyle = '#94a3b8';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 3]);
  ctx.font = '11px sans-serif';

  // H dimension (left side)
  const dimX = wallLeft - 25;
  ctx.beginPath();
  ctx.moveTo(dimX, wallTop);
  ctx.lineTo(dimX, groundY);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillText('H=' + fmt(r.H, 1) + 'm', dimX - 40, (wallTop + groundY) / 2 + 4);

  // B dimension (bottom)
  ctx.setLineDash([4, 3]);
  const dimY = groundY + (r.D > 0 ? r.D * scale + 15 : 15);
  ctx.beginPath();
  ctx.moveTo(wallLeft, dimY);
  ctx.lineTo(wallRight, dimY);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillText('B=' + fmt(r.B, 1) + 'm', (wallLeft + wallRight) / 2 - 20, dimY + 14);

  // t dimension (top)
  ctx.setLineDash([4, 3]);
  ctx.beginPath();
  ctx.moveTo(topLeft, wallTop - 10);
  ctx.lineTo(wallRight, wallTop - 10);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillText('t=' + fmt(r.t, 1), (topLeft + wallRight) / 2 - 10, wallTop - 14);

  // FS labels at bottom-right
  ctx.font = 'bold 13px sans-serif';
  const lx = W - 150, ly = 30;
  ctx.fillStyle = r.FS_ot >= r.req_ot ? '#22c55e' : '#ef4444';
  ctx.fillText('FSå‚¾è¦† = ' + fmt(r.FS_ot, 2), lx, ly);
  ctx.fillStyle = r.FS_sl >= r.req_sl ? '#22c55e' : '#ef4444';
  ctx.fillText('FSæ»‘å‹• = ' + fmt(r.FS_sl, 2), lx, ly + 18);
  ctx.fillStyle = r.FS_br >= r.req_br ? '#22c55e' : '#ef4444';
  ctx.fillText('FSæ‰¿è¼‰ = ' + fmt(r.FS_br, 2), lx, ly + 36);
}

// ===== BEAM CALCULATION ENGINE =====
function calcBeam() {
  const L = parseFloat($('s_bL').value);
  const w = parseFloat($('s_bw').value);
  const P = parseFloat($('s_bP').value);
  const aRatio = parseFloat($('s_ba').value);
  const a = aRatio * L;
  const b_sec = parseFloat($('s_bb').value);
  const h = parseFloat($('s_bh').value);
  const fc = parseFloat($('s_bfc').value);
  const fy = parseFloat($('s_bfy').value);
  const type = $('beam_type').value;
  const cover = 40;
  const d = h - cover - 10; // effective depth (mm)
  const Ec = 4700 * Math.sqrt(fc); // MPa
  const I = b_sec * Math.pow(h, 3) / 12; // mm^4

  let Mmax, Vmax, deltaMax;
  const pts = 50;
  const Mdiag = [], Vdiag = [], Ddiag = [];

  if (type === 'simple') {
    // Uniform + point load on simply supported beam
    const Ra_w = w * L / 2;
    const Ra_P = P * (L - a) / L;
    const Rb_P = P * a / L;

    for (let i = 0; i <= pts; i++) {
      const x = (i / pts) * L;
      let M = Ra_w * x - w * x * x / 2 + (x <= a ? Ra_P * x : Ra_P * x - P * (x - a));
      // Actually let's be more careful
      const Ra = Ra_w + Ra_P;
      M = Ra * x - w * x * x / 2;
      if (x > a) M -= P * (x - a);
      let V = Ra - w * x;
      if (x >= a) V -= P;
      Mdiag.push({ x, M });
      Vdiag.push({ x, V });
    }
    Mmax = Math.max(...Mdiag.map(p => Math.abs(p.M)));
    Vmax = Math.max(...Vdiag.map(p => Math.abs(p.V)));
    // Deflection (superposition)
    const d_w = 5 * w * Math.pow(L * 1000, 4) / (384 * Ec * I); // mm
    const d_P = P > 0 ? P * 1000 * a * 1000 * (L * 1000 - a * 1000) * Math.sqrt(Math.pow(L * 1000, 2) - Math.pow(a * 1000, 2) - Math.pow(L * 1000 - a * 1000, 2) || 0) / (24 * Ec * I * L * 1000) : 0;
    // Simplified: P*L^3/(48EI) for midspan
    const d_P_simple = P > 0 ? P * 1000 * Math.pow(L * 1000, 3) / (48 * Ec * I) : 0;
    deltaMax = d_w + d_P_simple;

  } else if (type === 'cantilever') {
    for (let i = 0; i <= pts; i++) {
      const x = (i / pts) * L;
      let M = -w * Math.pow(L - x, 2) / 2;
      if (a <= L && x <= a) M -= P * (a - x);
      else if (x <= a) M -= P * (a - x);
      // Actually for cantilever (fixed at left, free at right):
      // Fixed at x=0, free at x=L
      const M2 = -w * (L - x) * (L - x) / 2 - (x < (L - a + 0.001) ? 0 : 0);
      // Let me simplify: fixed at left
      const Mfix = -w * Math.pow(L - x, 2) / 2;
      const Vfix = w * (L - x);
      let Mp = 0, Vp = 0;
      if (P > 0 && x < a) { Mp = -P * (a - x); Vp = P; }
      Mdiag.push({ x, M: Mfix + Mp });
      Vdiag.push({ x, V: Vfix + Vp });
    }
    Mmax = Math.max(...Mdiag.map(p => Math.abs(p.M)));
    Vmax = Math.max(...Vdiag.map(p => Math.abs(p.V)));
    deltaMax = w * Math.pow(L * 1000, 4) / (8 * Ec * I);

  } else { // fixed both ends
    for (let i = 0; i <= pts; i++) {
      const x = (i / pts) * L;
      // Fixed-fixed uniform load: M = w*LÂ²/12 at ends, -w*LÂ²/24 at midspan
      const M = w * x / 12 * (6 * L - 6 * x - L * L / L);
      // M(x) = w/12 * (6Lx - 6xÂ² - LÂ²) ... let me use the standard formula
      // M(x) = w*LÂ²/12 - w*xÂ²/2 + w*L*x/2 - w*LÂ²/12 ... 
      // Actually: M(x) = w*L*x/2 - w*xÂ²/2 - w*LÂ²/12
      const Mf = w * L * x / 2 - w * x * x / 2 - w * L * L / 12;
      const Vf = w * L / 2 - w * x;
      Mdiag.push({ x, M: Mf });
      Vdiag.push({ x, V: Vf });
    }
    Mmax = Math.max(...Mdiag.map(p => Math.abs(p.M)));
    Vmax = Math.max(...Vdiag.map(p => Math.abs(p.V)));
    deltaMax = w * Math.pow(L * 1000, 4) / (384 * Ec * I);
  }

  // RC Design
  const Mu = Mmax * 1e6; // NÂ·mm
  const phi = 0.9;
  // Iterative: As = Mu / (phi * fy * (d - a/2)), a = As*fy/(0.85*fc*b)
  let As = Mu / (phi * fy * 0.9 * d);
  for (let iter = 0; iter < 10; iter++) {
    const a_block = As * fy / (0.85 * fc * b_sec);
    As = Mu / (phi * fy * (d - a_block / 2));
  }
  const As_min = Math.max(0.25 * Math.sqrt(fc) / fy, 1.4 / fy) * b_sec * d;
  As = Math.max(As, As_min);
  const rho = As / (b_sec * d);

  // Suggest rebar
  const rebarAreas = { '#4(D13)': 127, '#5(D16)': 199, '#6(D19)': 287, '#7(D22)': 387, '#8(D25)': 507, '#10(D32)': 819 };
  let suggestion = '';
  for (const [name, area] of Object.entries(rebarAreas)) {
    const n = Math.ceil(As / area);
    if (n <= 6) { suggestion = n + '-' + name; break; }
  }

  const deflLim = type === 'cantilever' ? L * 1000 / 180 : L * 1000 / 360;
  const deflOK = deltaMax <= deflLim;

  return {
    L, w, P, a, b_sec, h, fc, fy, d, type,
    Mdiag, Vdiag, Mmax, Vmax, deltaMax,
    As, As_min, rho, suggestion, deflLim, deflOK, Ec, I
  };
}

function updateBeam() {
  ['bL','bw','bP','ba','bb','bh','bfc','bfy'].forEach(k => {
    $('v_' + k).textContent = parseFloat($('s_' + k).value).toFixed(k === 'ba' ? 2 : 0);
  });

  const r = calcBeam();

  $('r_bM').textContent = fmt(r.Mmax, 1) + ' kNÂ·m';
  $('r_bV').textContent = fmt(r.Vmax, 1) + ' kN';
  $('r_bd').textContent = fmt(r.deltaMax, 2) + ' mm';
  $('r_bdlim').textContent = fmt(r.deflLim, 1) + ' mm';
  $('r_bdchk').innerHTML = r.deflOK ? '<span class="text-green-400">âœ… OK</span>' : '<span class="text-red-400">âŒ NG</span>';
  $('r_bd2').textContent = fmt(r.d, 0) + ' mm';
  $('r_bAs').textContent = fmt(r.As, 0) + ' mmÂ²';
  $('r_bAsmin').textContent = fmt(r.As_min, 0) + ' mmÂ²';
  $('r_brho').textContent = fmt(r.rho * 100, 3) + '%';
  $('r_brebar').textContent = r.suggestion || '-';

  drawBeam(r);
}

// ===== BEAM CANVAS =====
function drawBeam(r) {
  const canvas = $('beamCanvas');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * 2;
  canvas.height = rect.height * 2;
  const ctx = canvas.getContext('2d');
  ctx.scale(2, 2);
  const W = rect.width, H = rect.height;

  ctx.clearRect(0, 0, W, H);

  const mx = 60, my = 30;
  const beamY = H * 0.25;
  const beamLeft = mx;
  const beamRight = W - mx;
  const beamLen = beamRight - beamLeft;
  const scaleX = beamLen / r.L;

  // Beam member
  ctx.fillStyle = '#4b5563';
  ctx.fillRect(beamLeft, beamY - 8, beamLen, 16);
  ctx.strokeStyle = '#9ca3af';
  ctx.lineWidth = 1.5;
  ctx.strokeRect(beamLeft, beamY - 8, beamLen, 16);

  // Supports
  ctx.fillStyle = '#10b981';
  if (r.type === 'simple') {
    drawTriSupport(ctx, beamLeft, beamY + 8, 12);
    drawRollerSupport(ctx, beamRight, beamY + 8, 12);
  } else if (r.type === 'cantilever') {
    drawFixedSupport(ctx, beamLeft, beamY, 20);
  } else {
    drawFixedSupport(ctx, beamLeft, beamY, 20);
    drawFixedSupport(ctx, beamRight, beamY, 20);
  }

  // Uniform load arrows
  if (r.w > 0) {
    ctx.strokeStyle = '#ef4444';
    ctx.fillStyle = '#ef4444';
    const n = Math.min(20, Math.floor(beamLen / 25));
    for (let i = 0; i <= n; i++) {
      const x = beamLeft + (i / n) * beamLen;
      ctx.beginPath();
      ctx.moveTo(x, beamY - 35);
      ctx.lineTo(x, beamY - 10);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, beamY - 10);
      ctx.lineTo(x - 3, beamY - 16);
      ctx.lineTo(x + 3, beamY - 16);
      ctx.fill();
    }
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(beamLeft, beamY - 35);
    ctx.lineTo(beamRight, beamY - 35);
    ctx.stroke();
    ctx.font = '11px sans-serif';
    ctx.fillText('w=' + r.w + ' kN/m', (beamLeft + beamRight) / 2 - 30, beamY - 40);
  }

  // Point load
  if (r.P > 0) {
    const px = beamLeft + r.a * scaleX;
    ctx.strokeStyle = '#f59e0b';
    ctx.fillStyle = '#f59e0b';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(px, beamY - 55);
    ctx.lineTo(px, beamY - 10);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(px, beamY - 10);
    ctx.lineTo(px - 5, beamY - 18);
    ctx.lineTo(px + 5, beamY - 18);
    ctx.fill();
    ctx.font = 'bold 11px sans-serif';
    ctx.fillText('P=' + r.P + 'kN', px + 5, beamY - 50);
  }

  // Moment diagram
  const mZone = { top: H * 0.45, bottom: H * 0.65, mid: H * 0.55 };
  const maxM = r.Mmax || 1;
  const mScale = (mZone.bottom - mZone.top) / 2 / maxM;

  ctx.fillStyle = '#94a3b8';
  ctx.font = '11px sans-serif';
  ctx.fillText('M (kNÂ·m)', beamLeft - 55, mZone.mid + 4);

  // Baseline
  ctx.strokeStyle = '#334155';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(beamLeft, mZone.mid);
  ctx.lineTo(beamRight, mZone.mid);
  ctx.stroke();

  // M curve
  ctx.fillStyle = 'rgba(239, 68, 68, 0.2)';
  ctx.strokeStyle = '#ef4444';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(beamLeft, mZone.mid);
  r.Mdiag.forEach(p => {
    const x = beamLeft + (p.x / r.L) * beamLen;
    ctx.lineTo(x, mZone.mid - p.M * mScale);
  });
  ctx.stroke();

  // Fill
  ctx.beginPath();
  ctx.moveTo(beamLeft, mZone.mid);
  r.Mdiag.forEach(p => {
    const x = beamLeft + (p.x / r.L) * beamLen;
    ctx.lineTo(x, mZone.mid - p.M * mScale);
  });
  ctx.lineTo(beamRight, mZone.mid);
  ctx.closePath();
  ctx.fill();

  // Mmax label
  const mMaxPt = r.Mdiag.reduce((a, b) => Math.abs(b.M) > Math.abs(a.M) ? b : a);
  const mMaxX = beamLeft + (mMaxPt.x / r.L) * beamLen;
  ctx.fillStyle = '#ef4444';
  ctx.font = 'bold 11px sans-serif';
  ctx.fillText('Mmax=' + fmt(r.Mmax, 1), mMaxX - 25, mZone.mid - mMaxPt.M * mScale + (mMaxPt.M > 0 ? -8 : 14));

  // Shear diagram
  const vZone = { top: H * 0.72, bottom: H * 0.92, mid: H * 0.82 };
  const maxV = r.Vmax || 1;
  const vScale = (vZone.bottom - vZone.top) / 2 / maxV;

  ctx.fillStyle = '#94a3b8';
  ctx.font = '11px sans-serif';
  ctx.fillText('V (kN)', beamLeft - 45, vZone.mid + 4);

  ctx.strokeStyle = '#334155';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(beamLeft, vZone.mid);
  ctx.lineTo(beamRight, vZone.mid);
  ctx.stroke();

  ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
  ctx.strokeStyle = '#3b82f6';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(beamLeft, vZone.mid);
  r.Vdiag.forEach(p => {
    const x = beamLeft + (p.x / r.L) * beamLen;
    ctx.lineTo(x, vZone.mid - p.V * vScale);
  });
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(beamLeft, vZone.mid);
  r.Vdiag.forEach(p => {
    const x = beamLeft + (p.x / r.L) * beamLen;
    ctx.lineTo(x, vZone.mid - p.V * vScale);
  });
  ctx.lineTo(beamRight, vZone.mid);
  ctx.closePath();
  ctx.fill();

  // Span label
  ctx.fillStyle = '#64748b';
  ctx.font = '11px sans-serif';
  ctx.fillText('L=' + fmt(r.L, 1) + 'm', (beamLeft + beamRight) / 2 - 20, beamY + 35);
}

function drawTriSupport(ctx, x, y, size) {
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x - size / 2, y + size);
  ctx.lineTo(x + size / 2, y + size);
  ctx.closePath();
  ctx.fillStyle = '#10b981';
  ctx.fill();
}

function drawRollerSupport(ctx, x, y, size) {
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x - size / 2, y + size * 0.7);
  ctx.lineTo(x + size / 2, y + size * 0.7);
  ctx.closePath();
  ctx.fillStyle = '#10b981';
  ctx.fill();
  ctx.beginPath();
  ctx.arc(x, y + size, 4, 0, Math.PI * 2);
  ctx.fill();
}

function drawFixedSupport(ctx, x, y, size) {
  ctx.fillStyle = '#10b981';
  ctx.fillRect(x - 4, y - size / 2, 8, size);
  ctx.strokeStyle = '#10b981';
  ctx.lineWidth = 1.5;
  for (let i = -3; i <= 3; i++) {
    const yy = y + i * (size / 7);
    ctx.beginPath();
    ctx.moveTo(x - 4, yy);
    ctx.lineTo(x - 12, yy + 5);
    ctx.stroke();
  }
}

// ===== FOUNDATION CALCULATION ENGINE =====
function calcFoundation() {
  const B = parseFloat($('s_fB').value);
  const L = parseFloat($('s_fL').value);
  const Df = parseFloat($('s_fDf').value);
  const V = parseFloat($('s_fV').value);
  const phi = parseFloat($('s_fphi').value);
  const c = parseFloat($('s_fc2').value);
  const gamma = parseFloat($('s_fg').value);

  const phiRad = deg2rad(phi);

  // Terzaghi bearing capacity factors
  const Nq = Math.exp(Math.PI * Math.tan(phiRad)) * Math.pow(Math.tan(deg2rad(45) + phiRad / 2), 2);
  const Nc = (Nq - 1) / Math.tan(phiRad || 0.001);
  const Ng = 2 * (Nq + 1) * Math.tan(phiRad);

  // Ultimate bearing capacity (strip footing)
  const qu = c * Nc + gamma * Df * Nq + 0.5 * gamma * B * Ng;
  // Shape factors for rectangular (Meyerhof)
  const sc = 1 + 0.2 * B / L;
  const sq = 1 + 0.2 * B / L;
  const sg = 1 - 0.4 * B / L;
  const qu_rect = c * Nc * sc + gamma * Df * Nq * sq + 0.5 * gamma * B * Ng * sg;

  const qa = qu_rect / 3;
  const qact = V / (B * L);
  const FS = qact > 0 ? qu_rect / qact : 99;

  return { B, L, Df, V, phi, c, gamma, Nc, Nq, Ng, qu: qu_rect, qa, qact, FS, safe: FS >= 3.0 };
}

function updateFoundation() {
  ['fB','fL','fDf','fV','fphi','fc2','fg'].forEach(k => {
    $('v_' + k).textContent = parseFloat($('s_' + k).value).toFixed(k === 'fphi' || k === 'fc2' || k === 'fV' ? 0 : 1);
  });

  const r = calcFoundation();

  $('r_fNc').textContent = fmt(r.Nc, 2);
  $('r_fNq').textContent = fmt(r.Nq, 2);
  $('r_fNg').textContent = fmt(r.Ng, 2);
  $('r_fqu').textContent = fmt(r.qu, 1) + ' kPa';
  $('r_fqa').textContent = fmt(r.qa, 1) + ' kPa';
  $('r_fqact').textContent = fmt(r.qact, 1) + ' kPa';
  $('r_fFS').innerHTML = `<span class="${r.FS >= 3 ? 'text-green-400' : 'text-red-400'}">${fmt(r.FS, 2)} ${r.FS >= 3 ? 'âœ…' : 'âŒ'}</span>`;

  if (r.safe) {
    $('fVerdict').className = 'result-card text-center py-3 verdict-safe';
    $('fVerdict-icon').textContent = 'âœ…';
    $('fVerdict-text').textContent = 'æ‰¿è¼‰å®‰å…¨';
    $('fVerdict-text').className = 'text-sm font-bold text-green-400';
  } else {
    $('fVerdict').className = 'result-card text-center py-3 verdict-fail';
    $('fVerdict-icon').textContent = 'âŒ';
    $('fVerdict-text').textContent = 'æ‰¿è¼‰ä¸è¶³';
    $('fVerdict-text').className = 'text-sm font-bold text-red-400';
  }

  drawFoundation(r);
}

// ===== FOUNDATION CANVAS =====
function drawFoundation(r) {
  const canvas = $('foundCanvas');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * 2;
  canvas.height = rect.height * 2;
  const ctx = canvas.getContext('2d');
  ctx.scale(2, 2);
  const W = rect.width, H = rect.height;
  ctx.clearRect(0, 0, W, H);

  const groundY = H * 0.35;
  const scale = Math.min(80, (H * 0.5) / (r.Df + r.B));
  const cx = W / 2;

  // Ground
  ctx.fillStyle = '#1a2a1a';
  ctx.fillRect(0, groundY, W, H - groundY);
  ctx.strokeStyle = '#4a6741';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, groundY);
  ctx.lineTo(W, groundY);
  ctx.stroke();

  // Soil dots
  ctx.fillStyle = 'rgba(194,160,96,0.3)';
  for (let y = groundY + 8; y < H - 20; y += 12) {
    for (let x = 30; x < W - 30; x += 12) {
      if (Math.random() > 0.4) { ctx.beginPath(); ctx.arc(x, y, 1.2, 0, Math.PI * 2); ctx.fill(); }
    }
  }

  // Foundation
  const fW = r.B * scale;
  const fH = Math.max(15, r.Df * scale * 0.3);
  const fTop = groundY + r.Df * scale - fH;
  ctx.fillStyle = '#6b7280';
  ctx.strokeStyle = '#9ca3af';
  ctx.lineWidth = 2;
  ctx.fillRect(cx - fW / 2, fTop, fW, fH);
  ctx.strokeRect(cx - fW / 2, fTop, fW, fH);

  // Column above
  const colW = fW * 0.3;
  ctx.fillStyle = '#4b5563';
  ctx.fillRect(cx - colW / 2, groundY - 60, colW, fTop - groundY + 60);
  ctx.strokeRect(cx - colW / 2, groundY - 60, colW, fTop - groundY + 60);

  // Load arrow
  ctx.strokeStyle = '#ef4444';
  ctx.fillStyle = '#ef4444';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(cx, groundY - 100);
  ctx.lineTo(cx, groundY - 65);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cx, groundY - 65);
  ctx.lineTo(cx - 6, groundY - 75);
  ctx.lineTo(cx + 6, groundY - 75);
  ctx.fill();
  ctx.font = 'bold 12px sans-serif';
  ctx.fillText('V=' + r.V + 'kN', cx + 10, groundY - 85);

  // Bearing pressure distribution
  const pressH = 40;
  const pressY = fTop + fH;
  const pressColor = r.safe ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)';
  ctx.fillStyle = pressColor;
  ctx.beginPath();
  ctx.moveTo(cx - fW / 2, pressY);
  ctx.lineTo(cx + fW / 2, pressY);
  ctx.lineTo(cx + fW / 2, pressY + pressH);
  ctx.lineTo(cx - fW / 2, pressY + pressH);
  ctx.closePath();
  ctx.fill();

  // Pressure label
  ctx.fillStyle = r.safe ? '#22c55e' : '#ef4444';
  ctx.font = '11px sans-serif';
  ctx.fillText('q=' + fmt(r.qact, 0) + ' kPa', cx + fW / 2 + 8, pressY + pressH / 2);
  ctx.fillText('qa=' + fmt(r.qa, 0) + ' kPa', cx + fW / 2 + 8, pressY + pressH / 2 + 15);

  // Dimensions
  ctx.fillStyle = '#94a3b8';
  ctx.font = '11px sans-serif';
  ctx.fillText('B=' + fmt(r.B, 1) + 'm', cx - 20, fTop + fH + pressH + 20);
  ctx.fillText('Df=' + fmt(r.Df, 1) + 'm', cx + fW / 2 + 30, groundY + r.Df * scale / 2);

  // FS display
  ctx.font = 'bold 14px sans-serif';
  ctx.fillStyle = r.safe ? '#22c55e' : '#ef4444';
  ctx.fillText('FS = ' + fmt(r.FS, 2) + (r.safe ? ' âœ…' : ' âŒ'), W - 140, 30);
}

// ===== EXPORT =====
function exportCalc() {
  const activeTab = document.querySelector('main:not(.hidden)').id;
  let text = '';
  if (activeTab === 'tab-wall') {
    text = $('calc_steps').textContent;
  } else {
    text = 'åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­...';
  }
  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'structural_calc_' + new Date().toISOString().slice(0, 10) + '.txt';
  a.click();
}

// ===== INIT =====
window.addEventListener('load', () => {
  updateWall();
});
window.addEventListener('resize', () => {
  const activeTab = document.querySelector('main:not(.hidden)').id;
  if (activeTab === 'tab-wall') updateWall();
  if (activeTab === 'tab-beam') updateBeam();
  if (activeTab === 'tab-foundation') updateFoundation();
});
</script>

</body>
</html>
