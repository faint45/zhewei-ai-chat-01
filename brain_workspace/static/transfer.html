<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± æª”æ¡ˆå‚³è¼¸ç«™ - é›»è…¦ç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .drop-zone { border: 3px dashed #6366f1; transition: all 0.3s; }
        .drop-zone.dragover { border-color: #22c55e; background: #f0fdf4; }
        .file-card { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ“± æª”æ¡ˆå‚³è¼¸ç«™</h1>
            <p class="text-white/80">å¾é›»è…¦å‚³é€æª”æ¡ˆåˆ°ä½ çš„æ‰‹æ©Ÿ</p>
        </div>

        <!-- QR Code é…å°å€ -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <span>ğŸ”—</span> é…å°æ‰‹æ©Ÿ
            </h2>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1">
                    <div id="qrcode" class="bg-white p-4 rounded-lg inline-block"></div>
                    <p class="text-sm text-gray-500 mt-2">æƒæ QR Code é…å°æ‰‹æ©Ÿ</p>
                </div>
                <div class="flex-1">
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm font-medium text-gray-700">å‚³è¼¸ä»£ç¢¼</label>
                            <div class="flex gap-2 mt-1">
                                <input type="text" id="transferCode" placeholder="è¼¸å…¥6ä½ä»£ç¢¼" maxlength="6" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <button onclick="pairDevice()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">é…å°</button>
                            </div>
                        </div>
                        <div id="pairStatus" class="text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸Šå‚³å€ -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <span>ğŸ“¤</span> ä¸Šå‚³æª”æ¡ˆ
            </h2>
            <div id="dropZone" class="drop-zone rounded-xl p-8 text-center cursor-pointer">
                <div class="text-6xl mb-4">ğŸ“</div>
                <p class="text-lg text-gray-600">æ‹–æ”¾æª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡</p>
                <p class="text-sm text-gray-400 mt-2">æ”¯æ´åœ–ç‰‡ã€å½±ç‰‡ã€æ–‡ä»¶ã€ä»»ä½•æª”æ¡ˆ</p>
                <input type="file" id="fileInput" multiple class="hidden">
            </div>

            <!-- é è¦½å€ -->
            <div id="previewArea" class="mt-6 hidden">
                <h3 class="font-medium mb-3">å¾…å‚³é€æª”æ¡ˆ</h3>
                <div id="fileList" class="space-y-2"></div>
                <div class="flex gap-3 mt-4">
                    <button onclick="uploadFiles()" id="uploadBtn" class="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold hover:opacity-90">
                        ğŸš€ é–‹å§‹å‚³é€
                    </button>
                    <button onclick="clearFiles()" class="px-6 py-3 border border-gray-300 rounded-xl hover:bg-gray-100">æ¸…é™¤</button>
                </div>
            </div>
        </div>

        <!-- å‚³é€æ–‡å­—/é€£çµ -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <span>ğŸ’¬</span> å‚³é€æ–‡å­—/é€£çµ
            </h2>
            <textarea id="textInput" placeholder="è¼¸å…¥è¦å‚³é€åˆ°æ‰‹æ©Ÿçš„æ–‡å­—æˆ–é€£çµ..." rows="3" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500"></textarea>
            <button onclick="sendText()" class="mt-3 w-full py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl font-semibold hover:opacity-90">
                ğŸ“² å‚³é€æ–‡å­—
            </button>
        </div>

        <!-- å·²å‚³é€è¨˜éŒ„ -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <span>ğŸ“‹</span> å‚³é€è¨˜éŒ„
            </h2>
            <div id="historyList" class="space-y-2 max-h-64 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let deviceId = null;

        // åˆå§‹åŒ– QR Code
        function initQR() {
            const transferId = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: `${window.location.origin}/transfer-receive.html#${transferId}`,
                width: 150,
                height: 150
            });
        }

        // é…å°è¨­å‚™
        async function pairDevice() {
            const code = document.getElementById('transferCode').value.toUpperCase();
            if (code.length !== 6) {
                alert('è«‹è¼¸å…¥6ä½å‚³è¼¸ä»£ç¢¼');
                return;
            }
            try {
                const res = await fetch('/api/transfer/pair', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pairCode: code })
                });
                const data = await res.json();
                if (data.success) {
                    deviceId = data.deviceId;
                    document.getElementById('pairStatus').innerHTML = '<span class="text-green-600">âœ… å·²é…å°ï¼š' + data.deviceName + '</span>';
                } else {
                    document.getElementById('pairStatus').innerHTML = '<span class="text-red-600">âŒ ' + data.error + '</span>';
                }
            } catch (e) {
                document.getElementById('pairStatus').innerHTML = '<span class="text-red-600">âŒ é€£ç·šå¤±æ•—</span>';
            }
        }

        // æ‹–æ”¾ä¸Šå‚³
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        };
        fileInput.onchange = (e) => handleFiles(e.target.files);

        function handleFiles(files) {
            selectedFiles = [...selectedFiles, ...Array.from(files)];
            updatePreview();
        }

        function updatePreview() {
            const previewArea = document.getElementById('previewArea');
            const fileList = document.getElementById('fileList');
            previewArea.classList.remove('hidden');
            fileList.innerHTML = selectedFiles.map((file, i) => `
                <div class="file-card flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <span class="text-2xl">${getFileIcon(file.type)}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${file.name}</p>
                        <p class="text-sm text-gray-500">${formatSize(file.size)}</p>
                    </div>
                    <button onclick="removeFile(${i})" class="text-red-500 hover:text-red-700">âœ•</button>
                </div>
            `).join('');
        }

        function removeFile(i) {
            selectedFiles.splice(i, 1);
            updatePreview();
        }

        function clearFiles() {
            selectedFiles = [];
            updatePreview();
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return alert('è«‹é¸æ“‡æª”æ¡ˆ');
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ å‚³é€ä¸­...';

            const formData = new FormData();
            selectedFiles.forEach(f => formData.append('files', f));
            formData.append('deviceId', deviceId || 'any');

            try {
                const res = await fetch('/api/transfer/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… å‚³é€æˆåŠŸï¼æ‰‹æ©Ÿå°‡æ”¶åˆ°é€šçŸ¥');
                    clearFiles();
                    loadHistory();
                } else {
                    alert('âŒ ' + data.error);
                }
            } catch (e) {
                alert('âŒ å‚³é€å¤±æ•—');
            }
            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ é–‹å§‹å‚³é€';
        }

        async function sendText() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) return alert('è«‹è¼¸å…¥æ–‡å­—');
            try {
                const res = await fetch('/api/transfer/text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, deviceId: deviceId || 'any' })
                });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… å·²å‚³é€ï¼');
                    document.getElementById('textInput').value = '';
                    loadHistory();
                }
            } catch (e) {
                alert('âŒ å‚³é€å¤±æ•—');
            }
        }

        async function loadHistory() {
            const res = await fetch('/api/transfer/history');
            const data = await res.json();
            document.getElementById('historyList').innerHTML = data.items.map(item => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <span class="text-xl">${item.type === 'text' ? 'ğŸ’¬' : 'ğŸ“'}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${item.name || item.text.substring(0, 30)}</p>
                        <p class="text-sm text-gray-500">${new Date(item.createdAt).toLocaleString()}</p>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-500 text-center py-4">æš‚æ— å‚³é€è¨˜éŒ„</p>';
        }

        function getFileIcon(type) {
            if (type?.includes('image')) return 'ğŸ–¼ï¸';
            if (type?.includes('video')) return 'ğŸ¬';
            if (type?.includes('audio')) return 'ğŸµ';
            if (type?.includes('pdf')) return 'ğŸ“•';
            if (type?.includes('text')) return 'ğŸ“„';
            return 'ğŸ“';
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        initQR();
        loadHistory();
    </script>
</body>
</html>
