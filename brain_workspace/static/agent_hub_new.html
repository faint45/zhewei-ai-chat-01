<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¯‰æœªç§‘æŠ€ï½œAgent Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    body { background: #0b1020; color: #e5e7eb; }
    .card { background: rgba(17,24,39,.8); border: 1px solid rgba(55,65,81,.8); }
    .active { border-color: #3b82f6; color: #93c5fd; }
    .browser-frame { background: #1e1e1e; border-radius: 8px; overflow: hidden; }
    .browser-toolbar { background: #2d2d2d; padding: 8px 12px; display: flex; align-items: center; gap: 8px; }
    .browser-url { background: #3d3d3d; border: none; border-radius: 4px; padding: 4px 12px; color: #fff; flex: 1; font-size: 12px; }
    .browser-content { background: #fff; min-height: 280px; color: #333; padding: 12px; }
    .sim-window { background: #1a1a2e; border: 1px solid #3d3d5c; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .token-badge { background: linear-gradient(90deg, #06b6d4, #3b82f6); padding: 2px 8px; border-radius: 12px; font-size: 10px; }
    .compact-msg { padding: 4px 8px; border-radius: 4px; margin: 2px 0; font-size: 12px; }
    .compact-msg.ai { background: rgba(59, 130, 246, 0.2); border-left: 3px solid #3b82f6; }
    .compact-msg.user { background: rgba(16, 185, 129, 0.2); border-left: 3px solid #10b981; }
    .compact-msg.system { background: rgba(245, 158, 11, 0.2); border-left: 3px solid #f59e0b; }
    .mini-browser { font-size: 11px; line-height: 1.4; }
    .mini-browser h3 { font-size: 13px; font-weight: bold; margin-bottom: 8px; }
    .mini-browser button { padding: 2px 6px; margin: 2px; font-size: 10px; }
    .mini-browser input { padding: 2px 4px; font-size: 10px; }
    .data-compression { font-family: monospace; font-size: 10px; color: #6b7280; }
    .sync-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .sync-active { background: #10b981; animation: pulse 2s infinite; }
    .sync-idle { background: #6b7280; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-xl md:text-2xl font-semibold">Agent Hub<span class="text-xs text-slate-400 ml-2">ï½œä¸‰æ¬„å¼ä½ˆå±€</span></h1>
      <div class="flex items-center gap-4">
        <div class="text-xs text-slate-400">
          <span class="sync-indicator" :class="wsConnected ? 'sync-active' : 'sync-idle'"></span>
          [[ wsConnected ? 'å³æ™‚åŒæ­¥' : 'é›¢ç·šæ¨¡å¼' ]]
        </div>
        <div class="text-xs text-cyan-400">Token ç¯€çœ: <span class="token-badge">[[ tokenSavings ]]%</span></div>
      </div>
    </div>

    <!-- ä¸‰æ¬„å¼ä½ˆå±€ -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      
      <!-- ç¬¬ä¸€æ¬„ï¼šæ§åˆ¶å° (3æ ¼) -->
      <div class="lg:col-span-3 space-y-4">
        <div class="card rounded-xl p-4">
          <div class="text-sm text-slate-300 mb-3">æ¨¡å¼åˆ‡æ›</div>
          <div class="flex gap-2 mb-3">
            <button class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs" @click="switchMode('daily')">Daily</button>
            <button class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs" @click="switchMode('dev')">Dev</button>
          </div>
          <div class="text-xs text-slate-400">æ¨¡å¼ï¼š<span class="text-cyan-300">[[ mode ]]</span></div>
          <pre class="text-xs text-slate-400 whitespace-pre-wrap mt-2">[[ modeOutput ]]</pre>
        </div>

        <div class="card rounded-xl p-4">
          <div class="text-sm text-slate-300 mb-3">ä»£ç†é€šé“</div>
          <div class="grid grid-cols-2 gap-2">
            <button v-for="p in providers" :key="p" @click="provider=p"
              :class="['px-3 py-2 rounded-lg border bg-slate-800 hover:bg-slate-700 text-xs', provider===p ? 'active' : 'border-slate-700']">
              [[ p ]]
            </button>
          </div>
        </div>

        <div class="card rounded-xl p-4">
          <div class="text-sm text-slate-300 mb-3">ä»»å‹™æ´¾å·¥</div>
          <input v-model="taskObjective" class="w-full mb-2 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs" placeholder="ä»»å‹™ç›®æ¨™" />
          <textarea v-model="taskContext" class="w-full mb-2 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs min-h-[60px]" placeholder="ä¸Šä¸‹æ–‡"></textarea>
          <label class="text-xs text-slate-400 flex items-center gap-2 mb-3">
            <input type="checkbox" v-model="taskAutoRun" />
            å»ºç«‹å¾Œè‡ªå‹•åŸ·è¡Œ
          </label>
          <button @click="createTask" class="w-full px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-xs">å»ºç«‹ä»»å‹™</button>
        </div>

        <div class="card rounded-xl p-4">
          <div class="text-sm text-slate-300 mb-3">Smart GUI</div>
          <textarea v-model="smartGuiInstruction" class="w-full mb-2 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs min-h-[60px]" placeholder="æŒ‡ä»¤"></textarea>
          <div class="flex gap-2 mb-2">
            <input v-model.number="smartGuiMaxActions" type="number" class="w-20 bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 text-xs" placeholder="æ­¥æ•¸" />
            <label class="text-xs text-slate-300 flex items-center gap-1">
              <input type="checkbox" v-model="smartGuiExecute" />
              åŸ·è¡Œ
            </label>
          </div>
          <button @click="createSmartGuiTask" class="w-full px-3 py-2 rounded-lg bg-orange-700 hover:bg-orange-600 text-xs">åŸ·è¡Œ Smart GUI</button>
        </div>

        <div class="card rounded-xl p-4">
          <div class="text-sm text-slate-300 mb-3">èªç¾©è·¯ç”±</div>
          <textarea v-model="semanticText" class="w-full mb-2 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs min-h-[60px]" placeholder="è‡ªç„¶èªå¥"></textarea>
          <button @click="createSemanticRouteTask" class="w-full px-3 py-2 rounded-lg bg-sky-700 hover:bg-sky-600 text-xs">è‡ªå‹•æ‹†è§£</button>
        </div>
      </div>

      <!-- ç¬¬äºŒæ¬„ï¼šè¨è«–å€ (5æ ¼) -->
      <div class="lg:col-span-5 card rounded-xl p-4 flex flex-col min-h-[70vh]">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm text-slate-300">è¨è«–å€</div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500">å£“ç¸®æ ¼å¼:</span>
            <select v-model="dataFormat" class="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
              <option value="compact">Compact JSON</option>
              <option value="binary">Binary</option>
              <option value="token">Token-Optimized</option>
            </select>
          </div>
        </div>
        
        <!-- å£“ç¸®æ•¸æ“šé è¦½ -->
        <div class="bg-slate-900 rounded-lg p-2 mb-3 data-compression">
          <div class="text-[10px] text-slate-500 mb-1">AI æ•¸æ“šæ ¼å¼ (Token-Optimized):</div>
          <pre class="whitespace-pre-wrap text-[10px]">[[ compactDataPreview ]]</pre>
        </div>

        <div class="flex-1 overflow-y-auto space-y-2 pr-1 max-h-[350px]">
          <div v-for="(m,i) in logs" :key="i" class="compact-msg" :class="m.role">
            <div class="text-[10px] text-slate-500">[[ m.time ]] Â· [[ m.role ]]</div>
            <div class="whitespace-pre-wrap">[[ m.text ]]</div>
          </div>
        </div>
        
        <div class="mt-3 flex gap-2">
          <input v-model="input" @keyup.enter="send" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs" placeholder="è¼¸å…¥éœ€æ±‚..." />
          <button @click="send" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-xs">é€å‡º</button>
        </div>
        
        <!-- ä»»å‹™ä½‡åˆ— -->
        <div class="mt-4 border-t border-slate-800 pt-3">
          <div class="text-xs text-slate-300 mb-2">ä»»å‹™ä½‡åˆ—</div>
          <div class="space-y-1 max-h-40 overflow-y-auto">
            <div v-for="t in tasks" :key="t.id" class="text-xs bg-slate-900 border border-slate-800 rounded p-2">
              <div class="flex items-center justify-between">
                <span class="text-slate-200">[[ t.id.substring(0,8) ]]</span>
                <span class="text-slate-400">[[ t.status ]]</span>
              </div>
              <div class="text-slate-500 truncate">[[ t.objective ]]</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ç¬¬ä¸‰æ¬„ï¼šè»Ÿä»¶æ¨¡æ“¬ç€è¦½å™¨ (4æ ¼) -->
      <div class="lg:col-span-4 space-y-4">
        <div class="card rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm text-slate-300">è»Ÿä»¶æ¨¡æ“¬ç€è¦½å™¨</div>
            <div class="flex gap-1">
              <button @click="browserBack" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs">â†</button>
              <button @click="browserForward" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs">â†’</button>
              <button @click="refreshBrowser" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs">â†»</button>
            </div>
          </div>
          
          <!-- ç€è¦½å™¨æ¡†æ¶ -->
          <div class="browser-frame">
            <div class="browser-toolbar">
              <span class="text-xs text-slate-400">ğŸ”’</span>
              <input v-model="browserUrl" @keyup.enter="navigateBrowser" class="browser-url" placeholder="è¼¸å…¥ç¶²å€æˆ–è»Ÿä»¶åç¨±..." />
              <button @click="navigateBrowser" class="px-3 py-1 rounded bg-blue-600 text-xs">å‰å¾€</button>
            </div>
            <div class="browser-content mini-browser">
              <!-- è»Ÿä»¶æ¨¡æ“¬å…§å®¹ -->
              <div v-if="browserContent.type === 'software'">
                <h3>[[ browserContent.title ]]</h3>
                <div class="bg-slate-100 rounded p-3 mb-3">
                  <div class="flex gap-2 mb-2">
                    <button v-for="btn in browserContent.buttons" :key="btn" @click="simulateAction(btn)"
                      class="px-3 py-1 rounded bg-blue-500 text-white text-xs hover:bg-blue-600">
                      [[ btn ]]
                    </button>
                  </div>
                  <div v-for="(field, idx) in browserContent.fields" :key="idx" class="mb-2">
                    <label class="text-xs text-slate-600 block mb-1">[[ field.label ]]</label>
                    <input v-model="field.value" class="border rounded px-2 py-1 text-xs w-full" :placeholder="field.placeholder" />
                  </div>
                </div>
                <div class="text-xs text-slate-500">
                  æ¨¡æ“¬å»¶é²: [[ browserContent.latency ]]ms | Token: [[ browserContent.tokenCount ]]
                </div>
              </div>
              
              <!-- ç©ºç™½ç‹€æ…‹ -->
              <div v-else class="text-center text-slate-400 py-8">
                <div class="text-3xl mb-2">ğŸ“±</div>
                <div class="text-xs">è¼¸å…¥è»Ÿä»¶åç¨±æˆ–åŠŸèƒ½é–‹å§‹æ¨¡æ“¬</div>
                <div class="text-[10px] text-slate-500 mt-2">
                  æ”¯æ´: Excel, Word, LINE, Email, ç€è¦½å™¨...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- åŒæ­¥æ•¸æ“šæµ -->
        <div class="card rounded-xl p-4">
          <div class="text-sm text-slate-300 mb-3">åŒæ­¥æ•¸æ“šæµ</div>
          <div class="space-y-2">
            <div class="flex items-center justify-between text-xs">
              <span class="text-slate-400">è¨è«– â†’ ç€è¦½å™¨</span>
              <span :class="syncDiscussionToBrowser ? 'text-green-400' : 'text-slate-500'">
                [[ syncDiscussionToBrowser ? 'å·²åŒæ­¥' : 'æœªåŒæ­¥' ]]
              </span>
            </div>
            <div class="flex items-center justify-between text-xs">
              <span class="text-slate-400">ç€è¦½å™¨ â†’ AI</span>
              <span :class="syncBrowserToAi ? 'text-green-400' : 'text-slate-500'">
                [[ syncBrowserToAi ? 'å·²åŒæ­¥' : 'æœªåŒæ­¥' ]]
              </span>
            </div>
            <div class="flex items-center justify-between text-xs">
              <span class="text-slate-400">Token ä½¿ç”¨</span>
              <span class="text-cyan-400">[[ tokenUsage ]] / [[ tokenLimit ]]</span>
            </div>
          </div>
        </div>

        <!-- å¿«æ·è»Ÿä»¶æ¨¡æ¿ -->
        <div class="card rounded-xl p-4">
          <div class="text-sm text-slate-300 mb-3">å¿«æ·è»Ÿä»¶</div>
          <div class="grid grid-cols-2 gap-2">
            <button v-for="soft in softwareTemplates" :key="soft.name" @click="openSoftware(soft)"
              class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs border border-slate-700">
              <span class="block">[[ soft.icon ]]</span>
              <span class="text-slate-300">[[ soft.name ]]</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, watch } = Vue;
    createApp({
      setup() {
        // ç‹€æ…‹
        const providers = ['ollama', 'cursor', 'gemini', 'claude', 'codebuddy'];
        const provider = ref('ollama');
        const mode = ref('daily');
        const modeOutput = ref('');
        const sessionId = ref('hub-' + Date.now());
        const input = ref('');
        const logs = ref([]);
        const taskObjective = ref('');
        const taskContext = ref('');
        const taskAutoRun = ref(true);
        const tasks = ref([]);
        const semanticText = ref('');
        const smartGuiInstruction = ref('');
        const smartGuiExecute = ref(true);
        const smartGuiMaxActions = ref(8);
        const dataFormat = ref('token');
        const wsConnected = ref(false);
        
        // ç€è¦½å™¨ç‹€æ…‹
        const browserUrl = ref('');
        const browserContent = ref({ type: 'blank' });
        const browserHistory = ref([]);
        const historyIndex = ref(-1);
        
        // åŒæ­¥ç‹€æ…‹
        const syncDiscussionToBrowser = ref(true);
        const syncBrowserToAi = ref(true);
        const tokenUsage = ref(0);
        const tokenLimit = ref(100000);
        const tokenSavings = ref(65);
        
        // è»Ÿä»¶æ¨¡æ¿
        const softwareTemplates = ref([
          { name: 'Excel', icon: 'ğŸ“Š', type: 'spreadsheet' },
          { name: 'Word', icon: 'ğŸ“', type: 'document' },
          { name: 'LINE', icon: 'ğŸ’¬', type: 'messenger' },
          { name: 'Email', icon: 'ğŸ“§', type: 'email' },
          { name: 'ç€è¦½å™¨', icon: 'ğŸŒ', type: 'browser' },
          { name: 'çµ‚ç«¯æ©Ÿ', icon: 'ğŸ’»', type: 'terminal' },
        ]);

        // å£“ç¸®æ•¸æ“šé è¦½
        const compactDataPreview = computed(() => {
          if (logs.value.length === 0) return '// ç„¡æ•¸æ“š';
          const recent = logs.value.slice(-3);
          // Token-Optimized æ ¼å¼
          const optimized = recent.map(m => ({
            t: m.time.split(':').slice(0,2).join(':'), // ç°¡åŒ–æ™‚é–“
            r: m.role.substring(0,1).toUpperCase(),   // ç°¡åŒ–è§’è‰²
            c: m.text.substring(0, 100) + (m.text.length > 100 ? '...' : '') // æˆªæ–·æ–‡å­—
          }));
          return JSON.stringify(optimized, null, 2);
        });

        const now = () => new Date().toLocaleTimeString();
        const push = (role, text) => logs.value.push({ role, text, time: now() });

        // ç€è¦½å™¨åŠŸèƒ½
        function navigateBrowser() {
          const url = browserUrl.value.toLowerCase();
          let content = { type: 'software', title: '', buttons: [], fields: [], latency: 150, tokenCount: 45 };
          
          if (url.includes('excel') || url.includes('è©¦ç®—è¡¨')) {
            content.title = 'ğŸ“Š Excel æ¨¡æ“¬';
            content.buttons = ['é–‹å•Ÿæª”æ¡ˆ', 'å„²å­˜', 'æ–°å¢åœ–è¡¨', 'ç¯©é¸'];
            content.fields = [
              { label: 'å„²å­˜æ ¼ A1', value: ref(''), placeholder: 'è¼¸å…¥å€¼' },
              { label: 'å„²å­˜æ ¼ B1', value: ref(''), placeholder: 'è¼¸å…¥å€¼' },
            ];
          } else if (url.includes('line') || url.includes('è¨Šæ¯')) {
            content.title = 'ğŸ’¬ LINE æ¨¡æ“¬';
            content.buttons = ['å‚³é€è¨Šæ¯', 'é–‹å•Ÿåœ–ç‰‡', 'èªéŸ³è¼¸å…¥'];
            content.fields = [
              { label: 'è¨Šæ¯å…§å®¹', value: ref(''), placeholder: 'è¼¸å…¥è¨Šæ¯...' },
            ];
          } else if (url.includes('email') || url.includes('éƒµä»¶')) {
            content.title = 'ğŸ“§ Email æ¨¡æ“¬';
            content.buttons = ['å‚³é€', 'åŠ å…¥é™„ä»¶', 'è‰ç¨¿'];
            content.fields = [
              { label: 'æ”¶ä»¶äºº', value: ref(''), placeholder: 'email@example.com' },
              { label: 'ä¸»æ—¨', value: ref(''), placeholder: 'è¼¸å…¥ä¸»æ—¨' },
            ];
          } else if (url.includes('çµ‚ç«¯') || url.includes('terminal')) {
            content.title = 'ğŸ’» çµ‚ç«¯æ©Ÿæ¨¡æ“¬';
            content.buttons = ['åŸ·è¡Œ', 'æ¸…é™¤', 'ä¸­æ–·'];
            content.fields = [
              { label: 'å‘½ä»¤', value: ref(''), placeholder: 'è¼¸å…¥å‘½ä»¤...' },
            ];
          } else {
            content.title = 'ğŸŒ ç€è¦½å™¨æ¨¡æ“¬';
            content.buttons = ['æœå°‹', 'é–‹æ–°åˆ†é ', 'æ›¸ç±¤'];
            content.fields = [
              { label: 'æœå°‹', value: ref(''), placeholder: 'è¼¸å…¥é—œéµå­—...' },
            ];
          }
          
          browserContent.value = content;
          browserHistory.value.push({ url: browserUrl.value, content });
          historyIndex.value = browserHistory.value.length - 1;
          push('system', `å·²é–‹å•Ÿ: ${content.title}`);
        }

        function browserBack() {
          if (historyIndex.value > 0) {
            historyIndex.value--;
            browserUrl.value = browserHistory.value[historyIndex.value].url;
            browserContent.value = browserHistory.value[historyIndex.value].content;
          }
        }

        function browserForward() {
          if (historyIndex.value < browserHistory.value.length - 1) {
            historyIndex.value++;
            browserUrl.value = browserHistory.value[historyIndex.value].url;
            browserContent.value = browserHistory.value[historyIndex.value].content;
          }
        }

        function refreshBrowser() {
          if (browserUrl.value) {
            navigateBrowser();
          }
        }

        function simulateAction(action) {
          push('browser', `åŸ·è¡Œ: ${action}`);
          setTimeout(() => {
            push('system', `${action} å®Œæˆ (å»¶é²: ${browserContent.value.latency}ms)`);
          }, browserContent.value.latency);
        }

        function openSoftware(soft) {
          browserUrl.value = soft.name;
          navigateBrowser();
        }

        // API å‡½æ•¸
        async function send() {
          const text = (input.value || '').trim();
          if (!text) return;
          push('user', text);
          input.value = '';
          
          try {
            const r = await fetch('/api/remote/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                provider: provider.value,
                message: text,
                session_id: sessionId.value,
                max_turns: 12,
                format: dataFormat.value
              })
            });
            const j = await r.json();
            push(j.provider_mapping || provider.value, j.reply || '(no response)');
          } catch (e) {
            push('system', 'å‘¼å«å¤±æ•—: ' + String(e));
          }
        }

        async function createTask() {
          const objective = (taskObjective.value || '').trim();
          if (!objective) return;
          try {
            const r = await fetch('/api/agent/tasks', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                objective,
                context: taskContext.value || '',
                provider: provider.value,
                auto_run: taskAutoRun.value,
                format: dataFormat.value
              })
            });
            const j = await r.json();
            if (j.ok) {
              push('agent', `ä»»å‹™å·²å»ºç«‹: ${j.task.id}`);
              taskObjective.value = '';
              taskContext.value = '';
              await loadTasks();
            }
          } catch (e) {
            push('system', 'å»ºç«‹ä»»å‹™å¤±æ•—: ' + String(e));
          }
        }

        async function createSmartGuiTask() {
          const instruction = (smartGuiInstruction.value || '').trim();
          if (!instruction) return;
          try {
            const r = await fetch('/api/agent/tasks/smart-gui', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                instruction,
                execute: !!smartGuiExecute.value,
                max_actions: Number(smartGuiMaxActions.value || 8),
                format: dataFormat.value
              })
            });
            const j = await r.json();
            if (j.ok) {
              push('agent', `Smart GUI ä»»å‹™: ${j.task.id}`);
            }
          } catch (e) {
            push('system', 'å»ºç«‹å¤±æ•—: ' + String(e));
          }
        }

        async function createSemanticRouteTask() {
          const text = (semanticText.value || '').trim();
          if (!text) return;
          try {
            const r = await fetch('/api/agent/tasks/semantic-route', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text, auto_run: true, format: dataFormat.value })
            });
            const j = await r.json();
            if (j.ok) {
              push('agent', `èªç¾©è·¯ç”±: ${j.route_id}`);
              semanticText.value = '';
            }
          } catch (e) {
            push('system', 'å»ºç«‹å¤±æ•—: ' + String(e));
          }
        }

        async function switchMode(m) {
          modeOutput.value = 'åˆ‡æ›ä¸­...';
          try {
            const r = await fetch('/api/system/mode/switch', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ mode: m })
            });
            const j = await r.json();
            mode.value = m;
            modeOutput.value = (j.output || 'åˆ‡æ›æˆåŠŸ').toString();
          } catch (e) {
            modeOutput.value = String(e);
          }
        }

        async function loadTasks() {
          try {
            const r = await fetch('/api/agent/tasks');
            const j = await r.json();
            tasks.value = j.tasks || [];
          } catch (e) {
            push('system', 'è¼‰å…¥ä»»å‹™å¤±æ•—: ' + String(e));
          }
        }

        // ç›£è½è¨è«–å€è®ŠåŒ–ï¼ŒåŒæ­¥åˆ°ç€è¦½å™¨
        watch(logs, (newLogs) => {
          if (syncDiscussionToBrowser.value && newLogs.length > 0) {
            const lastMsg = newLogs[newLogs.length - 1];
            if (lastMsg.role === 'ai' || lastMsg.role === 'agent') {
              const text = lastMsg.text.toLowerCase();
              if (text.includes('é–‹å•Ÿ') || text.includes('é–‹excel') || text.includes('é–‹line')) {
                const soft = softwareTemplates.value.find(s => text.includes(s.name.toLowerCase()));
                if (soft) openSoftware(soft);
              }
            }
          }
        }, { deep: true });

        onMounted(async () => {
          wsConnected.value = true;
          push('system', 'Agent Hub å·²å°±ç·’ (ä¸‰æ¬„å¼ä½ˆå±€)');
          push('system', 'Token å£“ç¸®æ ¼å¼: ' + dataFormat.value);
          await loadTasks();
          setInterval(loadTasks, 5000);
        });

        return {
          providers, provider, mode, modeOutput, input, logs, send,
          taskObjective, taskContext, taskAutoRun, createTask,
          semanticText, createSemanticRouteTask,
          smartGuiInstruction, smartGuiExecute, smartGuiMaxActions, createSmartGuiTask,
          dataFormat, compactDataPreview,
          browserUrl, browserContent, browserBack, browserForward, refreshBrowser, navigateBrowser, simulateAction, openSoftware,
          softwareTemplates, syncDiscussionToBrowser, syncBrowserToAi, tokenUsage, tokenLimit, tokenSavings, wsConnected,
          switchMode, loadTasks
        };
      },
      delimiters: ['[[', ']]']
    }).mount('#app');
  </script>
</body>
</html>
