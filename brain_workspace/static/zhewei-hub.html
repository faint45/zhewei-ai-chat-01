<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¯‰æœªç§‘æŠ€ â€” çµ±ä¸€æ§åˆ¶ä¸­å¿ƒ</title>
<style>
:root {
  --bg:#0d1117; --bg2:#161b22; --bg3:#21262d; --border:#30363d;
  --fg:#e6edf3; --fg2:#8b949e; --green:#3fb950; --blue:#58a6ff;
  --yellow:#d29922; --red:#f85149; --purple:#bc8cff; --cyan:#39d353;
  --orange:#f0883e; --pink:#ff7b72;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--fg);font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh;}

/* â”€â”€ é ‚æ¬„ â”€â”€ */
.topbar{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 24px;height:52px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100;}
.logo{font-weight:700;font-size:16px;letter-spacing:-.3px;}
.logo span{color:var(--blue);}
.net-badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.5px;}
.net-badge.local{background:rgba(63,185,80,.15);color:var(--green);border:1px solid rgba(63,185,80,.3);}
.net-badge.remote{background:rgba(88,166,255,.15);color:var(--blue);border:1px solid rgba(88,166,255,.3);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:12px;}
.svc-dot{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--fg2);}
.dot{width:7px;height:7px;border-radius:50%;background:var(--fg2);}
.dot.on{background:var(--green);box-shadow:0 0 5px var(--green);}
.dot.off{background:var(--red);}

/* â”€â”€ ä¸»é«” â”€â”€ */
.container{max-width:1100px;margin:0 auto;padding:24px 20px;}
.section-title{font-size:12px;color:var(--fg2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:14px;font-weight:600;}

/* â”€â”€ å¡ç‰‡ç¶²æ ¼ â”€â”€ */
.grid{display:grid;gap:14px;}
.grid-2{grid-template-columns:repeat(2,1fr);}
.grid-3{grid-template-columns:repeat(3,1fr);}
.grid-4{grid-template-columns:repeat(4,1fr);}
@media(max-width:800px){.grid-4,.grid-3{grid-template-columns:repeat(2,1fr);}.grid-2{grid-template-columns:1fr;}}
@media(max-width:480px){.grid-4,.grid-3,.grid-2{grid-template-columns:1fr;}}

.card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:18px;cursor:pointer;transition:all .2s;text-decoration:none;color:inherit;display:flex;flex-direction:column;gap:10px;}
.card:hover{border-color:var(--blue);background:var(--bg3);transform:translateY(-1px);}
.card.disabled{opacity:.45;cursor:not-allowed;pointer-events:none;}
.card-icon{font-size:22px;}
.card-title{font-weight:600;font-size:14px;}
.card-desc{font-size:12px;color:var(--fg2);line-height:1.5;}
.card-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:auto;}
.tag{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;}
.tag-local{background:rgba(63,185,80,.12);color:var(--green);border:1px solid rgba(63,185,80,.25);}
.tag-remote{background:rgba(88,166,255,.12);color:var(--blue);border:1px solid rgba(88,166,255,.25);}
.tag-both{background:rgba(188,140,255,.12);color:var(--purple);border:1px solid rgba(188,140,255,.25);}
.tag-new{background:rgba(240,136,62,.15);color:var(--orange);border:1px solid rgba(240,136,62,.3);}

/* â”€â”€ å¿«æ·å·¥å…·æ¢ â”€â”€ */
.quick-bar{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px 18px;margin-bottom:20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.quick-bar label{font-size:12px;color:var(--fg2);}
.quick-bar input{flex:1;min-width:200px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);border-radius:6px;padding:7px 12px;font-size:13px;}
.quick-bar input:focus{outline:none;border-color:var(--blue);}
.qbtn{padding:7px 16px;border-radius:6px;border:none;cursor:pointer;font-size:13px;font-weight:600;background:var(--blue);color:#000;white-space:nowrap;}
.qbtn:hover{filter:brightness(1.15);}
.qbtn.outline{background:transparent;color:var(--fg2);border:1px solid var(--border);}
.qbtn.outline:hover{border-color:var(--fg);color:var(--fg);}

/* â”€â”€ ç‹€æ…‹é¢æ¿ â”€â”€ */
.status-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:24px;}
.svc-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;display:flex;align-items:center;gap:10px;}
.svc-card .dot{flex-shrink:0;}
.svc-info{flex:1;min-width:0;}
.svc-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.svc-url{font-size:11px;color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* â”€â”€ åˆ†éš”ç·š â”€â”€ */
.divider{height:1px;background:var(--border);margin:24px 0;}

/* â”€â”€ èªªæ˜æ¨™èª â”€â”€ */
.hero{text-align:center;padding:32px 0 24px;}
.hero h2{font-size:24px;font-weight:700;margin-bottom:8px;}
.hero p{font-size:14px;color:var(--fg2);}
.hero .pills{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px;}
.pill{padding:4px 14px;border-radius:20px;font-size:12px;background:var(--bg3);border:1px solid var(--border);color:var(--fg2);}
</style>
</head>
<body>

<div class="topbar">
  <div class="logo">ç¯‰æœªç§‘æŠ€ <span>AI Hub</span></div>
  <span class="net-badge" id="netBadge">åµæ¸¬ä¸­...</span>
  <div class="topbar-right">
    <div class="svc-dot"><div class="dot" id="dotBrain"></div><span>Brain</span></div>
    <div class="svc-dot"><div class="dot" id="dotOllama"></div><span>Ollama</span></div>
    <div class="svc-dot"><div class="dot" id="dotForge"></div><span>Forge</span></div>
    <div class="svc-dot"><div class="dot" id="dotWebUI"></div><span>WebUI</span></div>
    <span id="timeStr" style="font-size:12px;color:var(--fg2);min-width:55px;text-align:right"></span>
  </div>
</div>

<div class="container">

  <div class="hero">
    <h2>ğŸ—ï¸ ç¯‰æœªç§‘æŠ€çµ±ä¸€æ§åˆ¶ä¸­å¿ƒ</h2>
    <p id="heroSub">é€£ç·šä¸­...</p>
    <div class="pills">
      <span class="pill">ğŸ¤– AI ä»£ç†</span>
      <span class="pill">ğŸ§  æ·±åº¦è¨è«–</span>
      <span class="pill">ğŸ¨ ç”Ÿåœ–</span>
      <span class="pill">ğŸ’» ä»£ç¢¼åŸ·è¡Œ</span>
      <span class="pill">ğŸ“¡ MCP å·¥å…·</span>
    </div>
  </div>

  <!-- å¿«æ·ä»£ç†åŸ·è¡Œ -->
  <div class="quick-bar">
    <label>âš¡ å¿«æ·ä»£ç†</label>
    <input type="text" id="quickTask" placeholder="è¼¸å…¥ä»»å‹™ç›´æ¥åŸ·è¡Œ... (Ctrl+Enter)" title="å¿«æ·ä»»å‹™è¼¸å…¥">
    <select id="quickModel" style="background:var(--bg3);border:1px solid var(--border);color:var(--fg);border-radius:6px;padding:7px 10px;font-size:12px;" title="é¸æ“‡æ¨¡å‹">
      <option value="zhewei-qwen3-32b-agent">32b-agent</option>
      <option value="zhewei-brain-v5-structured">brain-v5</option>
      <option value="zhewei-brain-v5">v5-fast</option>
    </select>
    <button class="qbtn" onclick="quickRun()">â–¶ åŸ·è¡Œ</button>
    <button class="qbtn outline" onclick="window.location='/agent'">å®Œæ•´ä»‹é¢</button>
  </div>

  <!-- æœå‹™ç‹€æ…‹ -->
  <div class="section-title">æœå‹™ç‹€æ…‹</div>
  <div class="status-grid" id="statusGrid">
    <div class="svc-card"><div class="dot" id="s-brain"></div><div class="svc-info"><div class="svc-name">Brain Server</div><div class="svc-url" id="su-brain">port 8002</div></div></div>
    <div class="svc-card"><div class="dot" id="s-ollama"></div><div class="svc-info"><div class="svc-name">Ollama</div><div class="svc-url" id="su-ollama">port 11460</div></div></div>
    <div class="svc-card"><div class="dot" id="s-forge"></div><div class="svc-info"><div class="svc-name">Forge ç”Ÿåœ–</div><div class="svc-url" id="su-forge">port 7860</div></div></div>
    <div class="svc-card"><div class="dot" id="s-webui"></div><div class="svc-info"><div class="svc-name">Open WebUI</div><div class="svc-url" id="su-webui">port 3001 (å…§ç¶²)</div></div></div>
    <div class="svc-card"><div class="dot" id="s-mcp"></div><div class="svc-info"><div class="svc-name">MCP Tools</div><div class="svc-url" id="su-mcp">port 18020</div></div></div>
    <div class="svc-card"><div class="dot" id="s-vision"></div><div class="svc-info"><div class="svc-name">Vision AI</div><div class="svc-url" id="su-vision">port 8030</div></div></div>
  </div>

  <div class="divider"></div>

  <!-- æ ¸å¿ƒåŠŸèƒ½ -->
  <div class="section-title">æ ¸å¿ƒåŠŸèƒ½</div>
  <div class="grid grid-3" style="margin-bottom:24px">
    <a class="card" href="/agent">
      <div class="card-icon">ğŸ¤–</div>
      <div class="card-title">ä»£ç†åŸ·è¡Œä¸­å¿ƒ</div>
      <div class="card-desc">ReAct è‡ªä¸»ä»£ç†ï¼Œè‡ªå‹•åŸ·è¡Œå‘½ä»¤ã€è®€å¯«æª”æ¡ˆã€ä¿®å¾© bugï¼Œå³æ™‚ä¸²æµæ­¥é©Ÿ</div>
      <div class="card-tags"><span class="tag tag-both">å…§å¤–ç¶²</span><span class="tag tag-new">æ–°åŠŸèƒ½</span></div>
    </a>
    <a class="card" id="deepCard" href="#" onclick="openDeepDiscussion()">
      <div class="card-icon">ğŸ§ </div>
      <div class="card-title">æ·±åº¦è¨è«– / å…µæ¨</div>
      <div class="card-desc">qwen3:32b æ·±åº¦åˆ†æï¼Œå…µæ¨æ¨¡æ“¬ã€è…³æœ¬æ¨æ¼”ã€æ¶æ§‹è¨è«–ã€é¢¨éšªè©•ä¼°</div>
      <div class="card-tags"><span class="tag tag-both">å…§å¤–ç¶²</span></div>
    </a>
    <a class="card" id="forgeCard" href="/forge-easy">
      <div class="card-icon">ğŸ¨</div>
      <div class="card-title">AI æ–‡å­—ç”Ÿåœ–</div>
      <div class="card-desc">è¼¸å…¥æè¿°ï¼Œä¸€éµç”Ÿæˆåœ–ç‰‡ã€‚æ”¯æ´é¢¨æ ¼é¸æ“‡ã€å°ºå¯¸èª¿æ•´ï¼Œå®Œå…¨æœ¬åœ°é‹ç®—</div>
      <div class="card-tags"><span class="tag tag-both" id="forgeTag">å…§ç¶²ç›´é€£</span><span class="tag tag-new">ç°¡åŒ–ä»‹é¢</span></div>
    </a>
  </div>

  <!-- AI å·¥å…· -->
  <div class="section-title">AI å·¥å…·</div>
  <div class="grid grid-4" style="margin-bottom:24px">
    <a class="card" id="webuiCard" href="http://localhost:3001" target="_blank" rel="noopener noreferrer">
      <div class="card-icon">ğŸŒ</div>
      <div class="card-title">Open WebUI</div>
      <div class="card-desc">å®Œæ•´ AI ä»‹é¢ï¼Œç”Ÿåœ–+ä»£ç¢¼+MCP å·¥å…·æ•´åˆ</div>
      <div class="card-tags"><span class="tag tag-both" id="webuiTag">å…§ç¶²ç›´é€£</span></div>
    </a>
    <a class="card" href="/jarvis">
      <div class="card-icon">âš¡</div>
      <div class="card-title">Jarvis AI</div>
      <div class="card-desc">å¿«é€Ÿ AI å°è©±ï¼Œå¤šæ¨¡å‹è·¯ç”±</div>
      <div class="card-tags"><span class="tag tag-both">å…§å¤–ç¶²</span></div>
    </a>
    <a class="card" href="https://vision.zhe-wei.net" target="_blank" rel="noopener noreferrer">
      <div class="card-icon">ğŸ‘ï¸</div>
      <div class="card-title">è¦–è¦ºè¾¨è­˜</div>
      <div class="card-desc">YOLOv8 + OCRï¼Œå·¥åœ°å®‰å…¨åµæ¸¬</div>
      <div class="card-tags"><span class="tag tag-both">å…§å¤–ç¶²</span></div>
    </a>
    <a class="card" href="/pwa">
      <div class="card-icon">ğŸ“±</div>
      <div class="card-title">PWA è¡Œå‹•ç‰ˆ</div>
      <div class="card-desc">æ‰‹æ©Ÿç€è¦½å™¨å®‰è£ï¼Œé›¢ç·šå¯ç”¨</div>
      <div class="card-tags"><span class="tag tag-both">å…§å¤–ç¶²</span></div>
    </a>
  </div>

  <!-- ç³»çµ±å·¥å…· -->
  <div class="section-title">ç³»çµ±ç®¡ç†</div>
  <div class="grid grid-4">
    <a class="card" href="/admin">
      <div class="card-icon">âš™ï¸</div>
      <div class="card-title">ç³»çµ±ç®¡ç†</div>
      <div class="card-desc">brain_server ç®¡ç†ä»‹é¢</div>
      <div class="card-tags"><span class="tag tag-both">å…§å¤–ç¶²</span></div>
    </a>
    <div class="card" onclick="checkAllServices()">
      <div class="card-icon">ğŸ©º</div>
      <div class="card-title">æœå‹™å¥åº·æª¢æŸ¥</div>
      <div class="card-desc">é‡æ–°æƒææ‰€æœ‰æœå‹™ç‹€æ…‹</div>
      <div class="card-tags"><span class="tag tag-both">å…§å¤–ç¶²</span></div>
    </div>
    <div class="card" onclick="openMcpInfo()">
      <div class="card-icon">ğŸ“¡</div>
      <div class="card-title">MCP å·¥å…·ä¼ºæœå™¨</div>
      <div class="card-desc">port 18020ï¼Œä¾› Open WebUI æ¥å…¥</div>
      <div class="card-tags"><span class="tag tag-local">åƒ…å…§ç¶²</span></div>
    </div>
    <div class="card" onclick="runAgentTask('åˆ—å‡º D:/zhe-wei-tech æ ¹ç›®éŒ„ Python æª”æ¡ˆ')">
      <div class="card-icon">ğŸ”</div>
      <div class="card-title">ç³»çµ±å¿«é€Ÿæƒæ</div>
      <div class="card-desc">åˆ—å‡ºä¸»ç³»çµ± Python æ¨¡çµ„</div>
      <div class="card-tags"><span class="tag tag-both">å…§å¤–ç¶²</span></div>
    </div>
  </div>

</div>

<!-- æ·±åº¦è¨è«–æµ®å±¤ -->
<div id="deepModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;">
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:100%;max-width:680px;max-height:80vh;display:flex;flex-direction:column;">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
      <span style="font-weight:700">ğŸ§  æ·±åº¦è¨è«– â€” zhewei-qwen3-32b-deep</span>
      <button onclick="closeDeep()" style="background:none;border:none;color:var(--fg2);font-size:20px;cursor:pointer;">Ã—</button>
    </div>
    <div id="deepMsgs" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;min-height:200px;">
      <div style="text-align:center;color:var(--fg2);font-size:13px;padding:20px;">è¼¸å…¥å•é¡Œé–‹å§‹æ·±åº¦è¨è«–</div>
    </div>
    <div style="padding:14px 16px;border-top:1px solid var(--border);display:flex;gap:10px;">
      <textarea id="deepInput" placeholder="å…µæ¨ï¼š... / åˆ†æï¼š... / æ¶æ§‹ï¼š..." rows="2"
        style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--fg);border-radius:6px;padding:8px;font-size:13px;resize:none;font-family:inherit"
        onkeydown="if(event.ctrlKey&&event.key==='Enter')sendDeep()"></textarea>
      <button onclick="sendDeep()" style="padding:8px 20px;background:var(--blue);color:#000;border:none;border-radius:6px;font-weight:700;cursor:pointer;align-self:flex-end;">ç™¼é€</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ ç¶²è·¯åµæ¸¬ â”€â”€
const isLocal = ['localhost','127.0.0.1'].includes(location.hostname)
  || /^192\.168\.|^10\.|^172\.(1[6-9]|2\d|3[01])\./.test(location.hostname);
const API_BASE = location.origin;
const WS_PROTO = location.protocol === 'https:' ? 'wss:' : 'ws:';

// æ›´æ–°ç¶²è·¯æ¨™ç¤º
const badge = document.getElementById('netBadge');
const heroSub = document.getElementById('heroSub');
if (isLocal) {
  badge.textContent = 'å…§ç¶²æ¨¡å¼'; badge.className = 'net-badge local';
  heroSub.textContent = 'å…§ç¶²é€£ç·š â€” æ‰€æœ‰åŠŸèƒ½å¯ç”¨ï¼ˆç”Ÿåœ–ã€Open WebUIã€MCPï¼‰';
} else {
  badge.textContent = 'å¤–ç¶²æ¨¡å¼'; badge.className = 'net-badge remote';
  heroSub.textContent = 'å¤–ç¶²é€£ç·š â€” æ‰€æœ‰åŠŸèƒ½é€é brain_server ä»£ç†å¯ç”¨';
  // å¤–ç¶²æ”¹ç”¨ä»£ç†è·¯å¾‘
  document.getElementById('webuiCard').href = '/webui/';
  document.getElementById('forgeCard').removeAttribute('onclick');
  document.getElementById('forgeCard').href = '/forge/';
}

// â”€â”€ æ™‚é˜ â”€â”€
setInterval(() => {
  const n = new Date();
  document.getElementById('timeStr').textContent =
    `${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}`;
}, 1000);

// â”€â”€ æœå‹™ç‹€æ…‹åµæ¸¬ â”€â”€
async function checkSvc(id, url, topId) {
  const dot = document.getElementById(id);
  try {
    const r = await fetch(url, {signal: AbortSignal.timeout(2500)});
    dot.className = r.ok ? 'dot on' : 'dot off';
    if (topId) document.getElementById(topId).className = r.ok ? 'dot on' : 'dot off';
  } catch {
    dot.className = 'dot off';
    if (topId) document.getElementById(topId).className = 'dot off';
  }
}

async function checkAllServices() {
  await Promise.all([
    checkSvc('s-brain', `${API_BASE}/health`, 'dotBrain'),
    checkSvc('s-ollama', 'http://localhost:11460/api/tags', 'dotOllama'),
    checkSvc('s-forge', 'http://localhost:7860', 'dotForge'),
    checkSvc('s-webui', 'http://localhost:3001', 'dotWebUI'),
    checkSvc('s-mcp', 'http://localhost:18020/health', null),
    checkSvc('s-vision', 'http://localhost:8030/healthz', null),
  ]);
}
checkAllServices();
setInterval(checkAllServices, 30000);

// â”€â”€ å¿«æ·ä»£ç†åŸ·è¡Œ â”€â”€
function quickRun() {
  const task = document.getElementById('quickTask').value.trim();
  if (!task) return;
  const model = document.getElementById('quickModel').value;
  const url = `/agent?task=${encodeURIComponent(task)}&model=${encodeURIComponent(model)}`;
  window.location.href = url;
}
document.getElementById('quickTask').addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'Enter') quickRun();
});

function runAgentTask(task) {
  document.getElementById('quickTask').value = task;
  quickRun();
}

// â”€â”€ Forge â”€â”€
function openForge() {
  if (!isLocal) { alert('Forge ç”Ÿåœ–åƒ…é™å…§ç¶²ä½¿ç”¨'); return; }
  window.open('http://localhost:7860', '_blank');
}

// â”€â”€ MCP è³‡è¨Š â”€â”€
function openMcpInfo() {
  window.open('http://localhost:18020/.well-known/mcp', '_blank');
}

// â”€â”€ æ·±åº¦è¨è«– â”€â”€
let deepHistory = [];

function openDeepDiscussion(e) {
  if (e) e.preventDefault();
  document.getElementById('deepModal').style.display = 'flex';
  document.getElementById('deepInput').focus();
}

function closeDeep() {
  document.getElementById('deepModal').style.display = 'none';
}

async function sendDeep() {
  const input = document.getElementById('deepInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  const msgs = document.getElementById('deepMsgs');

  // æ¸…é™¤æç¤º
  if (msgs.children.length === 1 && msgs.children[0].style.textAlign === 'center') {
    msgs.innerHTML = '';
  }

  // ç”¨æˆ¶è¨Šæ¯
  const userDiv = document.createElement('div');
  userDiv.style.cssText = 'padding:10px 14px;background:rgba(88,166,255,.1);border-radius:8px;font-size:13px;align-self:flex-end;max-width:85%;';
  userDiv.textContent = text;
  msgs.appendChild(userDiv);
  msgs.scrollTop = msgs.scrollHeight;

  // æ€è€ƒä¸­
  const thinkDiv = document.createElement('div');
  thinkDiv.style.cssText = 'padding:8px 14px;color:var(--fg2);font-size:12px;font-style:italic;';
  thinkDiv.textContent = 'â³ æ·±åº¦æ¨ç†ä¸­...';
  msgs.appendChild(thinkDiv);

  deepHistory.push({role:'user', content:text});

  try {
    const resp = await fetch(`${API_BASE}/api/jarvis/stream`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        messages: [{role:'system', content:'ä½ æ˜¯ç¯‰æœªç§‘æŠ€çš„æ·±åº¦æˆ°ç•¥åˆ†æå¸«ï¼Œä½¿ç”¨å…µæ¨æ¡†æ¶ã€ä¸‰ç¨®æƒ…å¢ƒæ¨æ¼”ã€é¢¨éšªè©•ä¼°é€²è¡Œæ·±åº¦åˆ†æã€‚'}, ...deepHistory.slice(-8)],
        model: 'zhewei-qwen3-32b-deep',
        stream: true,
      })
    });

    thinkDiv.textContent = '';
    thinkDiv.style.cssText = 'padding:10px 14px;background:var(--bg3);border-radius:8px;font-size:13px;max-width:90%;white-space:pre-wrap;line-height:1.6;';

    if (resp.headers.get('content-type')?.includes('text/event-stream')) {
      const reader = resp.body.getReader();
      const dec = new TextDecoder();
      let full = '';
      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        const chunk = dec.decode(value);
        const lines = chunk.split('\n');
        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = line.slice(6).trim();
            if (data === '[DONE]') break;
            try { const j = JSON.parse(data); full += j.content || j.delta || ''; } catch{}
          }
        }
        thinkDiv.textContent = full;
        msgs.scrollTop = msgs.scrollHeight;
      }
      deepHistory.push({role:'assistant', content:full});
    } else {
      const data = await resp.json();
      const reply = data.content || data.response || data.result || JSON.stringify(data);
      thinkDiv.textContent = reply;
      deepHistory.push({role:'assistant', content:reply});
    }
  } catch(e) {
    thinkDiv.style.color = 'var(--red)';
    thinkDiv.textContent = `âŒ é€£ç·šå¤±æ•—: ${e.message}`;
  }
  msgs.scrollTop = msgs.scrollHeight;
}

// ESC é—œé–‰æµ®å±¤
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDeep();
});
</script>
</body>
</html>
