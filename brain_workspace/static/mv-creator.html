<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™›æ“¬äººç‰© MV è£½ä½œ - Jarvis AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ¬ è™›æ“¬äººç‰© MV è£½ä½œ</h1>
            <p class="text-gray-300">æ•´åˆ LivePortrait + Wav2Lip + ComfyUI</p>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Step 1: Create Project -->
            <div class="card rounded-xl p-6 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ 1. å»ºç«‹å°ˆæ¡ˆ</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                        <input type="text" id="projectName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ä¾‹å¦‚: demo_idol">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è§’è‰²åœ–ç‰‡è·¯å¾‘</label>
                        <input type="text" id="characterPath" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="D:\zhe-wei-tech\mv_projects\...\character.png">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">éŸ³æ¨‚æª”æ¡ˆè·¯å¾‘</label>
                        <input type="text" id="audioPath" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="D:\zhe-wei-tech\mv_projects\...\song.mp3">
                    </div>
                    <button onclick="createProject()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        å»ºç«‹å°ˆæ¡ˆ
                    </button>
                </div>
            </div>

            <!-- Step 2: Generate Character -->
            <div class="card rounded-xl p-6 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ¨ 2. ç”Ÿæˆè§’è‰²</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ­£é¢æç¤ºè©</label>
                        <textarea id="charPrompt" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="portrait of virtual idol, anime style, blue hair, cyberpunk outfit..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è² é¢æç¤ºè©</label>
                        <input type="text" id="charNegative" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" value="text, watermark, blurry, low quality, distorted">
                    </div>
                    <button onclick="generateCharacter()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        ç”Ÿæˆè§’è‰²åœ–ç‰‡
                    </button>
                </div>
            </div>

            <!-- Step 3: Run LivePortrait -->
            <div class="card rounded-xl p-6 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ­ 3. LivePortrait å‹•ç•«</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                        <input type="text" id="lpProject" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="demo_idol">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é©…å‹•å½±ç‰‡è·¯å¾‘ï¼ˆå¯é¸ï¼‰</label>
                        <input type="text" id="drivingVideo" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ç•™ç©ºå‰‡ä½¿ç”¨é è¨­">
                    </div>
                    <button onclick="runLivePortrait()" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        åŸ·è¡Œ LivePortrait
                    </button>
                </div>
            </div>

            <!-- Step 4: Run Wav2Lip -->
            <div class="card rounded-xl p-6 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ¤ 4. Wav2Lip å°å£å‹</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                        <input type="text" id="wlProject" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="demo_idol">
                    </div>
                    <button onclick="runWav2Lip()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        åŸ·è¡Œå°å£å‹
                    </button>
                </div>
            </div>

            <!-- Step 5: Composite -->
            <div class="card rounded-xl p-6 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ¬ 5. åˆæˆæœ€çµ‚ MV</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                        <input type="text" id="compProject" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="demo_idol">
                    </div>
                    <button onclick="runComposite()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        åŸ·è¡Œ FFmpeg åˆæˆ
                    </button>
                </div>
            </div>

            <!-- Status & Projects -->
            <div class="card rounded-xl p-6 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š å°ˆæ¡ˆç‹€æ…‹</h2>
                <button onclick="loadProjects()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition mb-4">
                    é‡æ–°æ•´ç†å°ˆæ¡ˆåˆ—è¡¨
                </button>
                <div id="projectList" class="space-y-3 max-h-64 overflow-y-auto">
                    <p class="text-gray-500 text-center">é»æ“Šä¸Šæ–¹æŒ‰éˆ•è¼‰å…¥å°ˆæ¡ˆ</p>
                </div>
            </div>
        </div>

        <!-- Output Console -->
        <div class="mt-8 card rounded-xl p-6 shadow-xl">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ åŸ·è¡Œè¼¸å‡º</h2>
            <div id="console" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-64 overflow-y-auto">
                ç­‰å¾…æŒ‡ä»¤...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/mv';

        function log(msg, type = 'info') {
            const console = document.getElementById('console');
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                command: 'text-yellow-400'
            };
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `<div class="${colors[type] || 'text-gray-300'}">[${timestamp}] ${msg}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        async function createProject() {
            const name = document.getElementById('projectName').value;
            const character = document.getElementById('characterPath').value;
            const audio = document.getElementById('audioPath').value;
            
            if (!name || !character || !audio) {
                log('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }

            log(`å»ºç«‹å°ˆæ¡ˆ: ${name}...`);
            try {
                const res = await fetch(`${API_BASE}/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, character_path: character, audio_path: audio})
                });
                const data = await res.json();
                if (data.ok) {
                    log(`å°ˆæ¡ˆå»ºç«‹æˆåŠŸ: ${name}`, 'success');
                    loadProjects();
                } else {
                    log(`éŒ¯èª¤: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`ç¶²è·¯éŒ¯èª¤: ${e.message}`, 'error');
            }
        }

        async function generateCharacter() {
            const prompt = document.getElementById('charPrompt').value;
            const negative = document.getElementById('charNegative').value;
            
            if (!prompt) {
                log('è«‹è¼¸å…¥æç¤ºè©', 'error');
                return;
            }

            log('ç”Ÿæˆè§’è‰²åœ–ç‰‡æŒ‡ä»¤...', 'info');
            try {
                const res = await fetch(`${API_BASE}/generate-character`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({prompt, negative_prompt: negative})
                });
                const data = await res.json();
                if (data.status === 'ready') {
                    log('ComfyUI è¨­å®š:', 'command');
                    log(`  æç¤ºè©: ${data.prompt}`, 'command');
                    log(`  å°ºå¯¸: ${data.settings.width}x${data.settings.height}`, 'command');
                    log(`  è¼¸å‡º: ${data.output_path}`, 'success');
                    log('è«‹å•Ÿå‹• ComfyUI ä¸¦è¼‰å…¥ workflows/mv_background.json', 'info');
                } else {
                    log(`éŒ¯èª¤: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`ç¶²è·¯éŒ¯èª¤: ${e.message}`, 'error');
            }
        }

        async function runLivePortrait() {
            const project = document.getElementById('lpProject').value;
            const driving = document.getElementById('drivingVideo').value || null;
            
            if (!project) {
                log('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±', 'error');
                return;
            }

            log(`åŸ·è¡Œ LivePortrait: ${project}...`);
            try {
                const res = await fetch(`${API_BASE}/run-liveportrait`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({project_name: project, driving_video: driving})
                });
                const data = await res.json();
                if (data.status === 'ready_to_run') {
                    log('åŸ·è¡Œå‘½ä»¤:', 'command');
                    log(`  ${data.command}`, 'command');
                    log('è«‹æ‰‹å‹•åŸ·è¡Œä¸Šè¿°å‘½ä»¤', 'info');
                } else {
                    log(`éŒ¯èª¤: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`ç¶²è·¯éŒ¯èª¤: ${e.message}`, 'error');
            }
        }

        async function runWav2Lip() {
            const project = document.getElementById('wlProject').value;
            
            if (!project) {
                log('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±', 'error');
                return;
            }

            log(`åŸ·è¡Œ Wav2Lip: ${project}...`);
            try {
                const res = await fetch(`${API_BASE}/run-wav2lip`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({project_name: project})
                });
                const data = await res.json();
                if (data.status === 'ready_to_run') {
                    log('åŸ·è¡Œå‘½ä»¤:', 'command');
                    log(`  ${data.command}`, 'command');
                    log('è«‹æ‰‹å‹•åŸ·è¡Œä¸Šè¿°å‘½ä»¤', 'info');
                } else {
                    log(`éŒ¯èª¤: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`ç¶²è·¯éŒ¯èª¤: ${e.message}`, 'error');
            }
        }

        async function runComposite() {
            const project = document.getElementById('compProject').value;
            
            if (!project) {
                log('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±', 'error');
                return;
            }

            log(`åŸ·è¡Œ FFmpeg åˆæˆ: ${project}...`);
            try {
                const res = await fetch(`${API_BASE}/run-composite`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({project_name: project})
                });
                const data = await res.json();
                if (data.status === 'ready_to_run') {
                    log('åŸ·è¡Œå‘½ä»¤:', 'command');
                    log(`  ${data.command}`, 'command');
                    log('è«‹æ‰‹å‹•åŸ·è¡Œä¸Šè¿°å‘½ä»¤', 'info');
                } else {
                    log(`éŒ¯èª¤: ${data.error}`, 'error');
                }
            } catch (e) {
                log(`ç¶²è·¯éŒ¯èª¤: ${e.message}`, 'error');
            }
        }

        async function loadProjects() {
            log('è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨...');
            try {
                const res = await fetch(`${API_BASE}/projects`);
                const data = await res.json();
                const container = document.getElementById('projectList');
                
                if (data.projects && Object.keys(data.projects).length > 0) {
                    container.innerHTML = Object.entries(data.projects).map(([name, p]) => `
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <div class="font-bold text-gray-800">${name}</div>
                            <div class="text-sm text-gray-600">ç‹€æ…‹: ${p.status || 'unknown'}</div>
                            <button onclick="checkStatus('${name}')" class="mt-2 text-sm text-blue-600 hover:underline">æŸ¥çœ‹è©³æƒ…</button>
                        </div>
                    `).join('');
                    log(`å·²è¼‰å…¥ ${Object.keys(data.projects).length} å€‹å°ˆæ¡ˆ`, 'success');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-center">å°šç„¡å°ˆæ¡ˆ</p>';
                    log('ç„¡å°ˆæ¡ˆ', 'info');
                }
            } catch (e) {
                log(`ç¶²è·¯éŒ¯èª¤: ${e.message}`, 'error');
            }
        }

        async function checkStatus(name) {
            log(`æª¢æŸ¥å°ˆæ¡ˆç‹€æ…‹: ${name}...`);
            try {
                const res = await fetch(`${API_BASE}/status/${name}`);
                const data = await res.json();
                log(`å°ˆæ¡ˆç‹€æ…‹:`, 'info');
                log(`  è§’è‰²åœ–ç‰‡: ${data.character ? 'âœ“' : 'âœ—'}`, 'success');
                log(`  èƒŒæ™¯åœ–æ•¸é‡: ${data.backgrounds}`, 'info');
                log(`  LivePortrait: ${data.liveportrait ? 'âœ“' : 'âœ—'}`, 'info');
                log(`  Wav2Lip: ${data.wav2lip ? 'âœ“' : 'âœ—'}`, 'info');
                log(`  æœ€çµ‚è¼¸å‡º: ${data.final ? 'âœ“' : 'âœ—'}`, 'info');
            } catch (e) {
                log(`ç¶²è·¯éŒ¯èª¤: ${e.message}`, 'error');
            }
        }

        // Load projects on page load
        loadProjects();
    </script>
</body>
</html>
