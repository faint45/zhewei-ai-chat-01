<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§é™æ§ - æ‰‹æ©Ÿç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; }
        .btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .msg-user { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .msg-bot { background: #f3f4f6; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .quick-btn { transition: all 0.2s; }
        .quick-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen pb-20">
    <!-- é ‚éƒ¨ Header -->
    <header class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 z-50 px-4 py-3">
        <div class="flex items-center justify-between">
            <h1 class="text-lg font-bold">ğŸ¤– æ™ºæ…§é™æ§</h1>
            <div class="flex items-center gap-2">
                <span id="status" class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-400">å°±ç·’</span>
                <button onclick="showSettings()" class="p-2 rounded hover:bg-gray-700">âš™ï¸</button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="pt-16 px-4">
        <!-- å¿«é€ŸæŒ‡ä»¤ -->
        <div class="mb-4">
            <p class="text-xs text-gray-400 mb-2">å¿«é€ŸæŒ‡ä»¤</p>
            <div class="flex flex-wrap gap-2">
                <button onclick="sendQuick('é–‹å•Ÿè¨˜äº‹æœ¬')" class="quick-btn text-xs px-3 py-2 rounded-full bg-blue-600/30 border border-blue-500/50">ğŸ“ è¨˜äº‹æœ¬</button>
                <button onclick="sendQuick('é–‹å•Ÿçµ‚ç«¯æ©Ÿ')" class="quick-btn text-xs px-3 py-2 rounded-full bg-green-600/30 border border-green-500/50">ğŸ’» çµ‚ç«¯æ©Ÿ</button>
                <button onclick="sendQuick('æœå°‹æ¡Œé¢ *.txt æª”æ¡ˆ')" class="quick-btn text-xs px-3 py-2 rounded-full bg-yellow-600/30 border border-yellow-500/50">ğŸ” æ‰¾æª”æ¡ˆ</button>
                <button onclick="sendQuick('åˆ†æç•¶å‰è¢å¹•')" class="quick-btn text-xs px-3 py-2 rounded-full bg-purple-600/30 border border-purple-500/50">ğŸ‘ï¸ è¢å¹•åˆ†æ</button>
                <button onclick="sendQuick('é–‹å•Ÿ Chrome ä¸¦å‰å¾€ google.com')" class="quick-btn text-xs px-3 py-2 rounded-full bg-red-600/30 border border-red-500/50">ğŸŒ Chrome</button>
            </div>
        </div>

        <!-- å°è©±å€ -->
        <div id="chat" class="space-y-3 mb-4">
            <div class="msg-bot p-3 rounded-lg text-sm">
                <p class="text-gray-400">ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯æ™ºæ…§é™æ§åŠ©æ‰‹ã€‚</p>
                <p class="mt-1">å¯ä»¥èªªï¼š</p>
                <ul class="mt-1 text-gray-500 text-xs list-disc list-inside">
                    <li>ã€Œé–‹å•Ÿ VS Codeã€</li>
                    <li>ã€Œæœå°‹ D:\ çš„ Python æª”æ¡ˆã€</li>
                    <li>ã€Œé–‹çµ‚ç«¯æ©Ÿä¸¦åŸ·è¡Œ dirã€</li>
                    <li>ã€Œåˆ†æè¢å¹•æ‰¾å‡ºå¯é»æ“Šçš„æŒ‰éˆ•ã€</li>
                </ul>
            </div>
        </div>

        <!-- æˆªåœ–é è¦½ -->
        <div id="screenshot-container" class="hidden mb-4">
            <p class="text-xs text-gray-400 mb-1">æœ€æ–°æˆªåœ–</p>
            <img id="screenshot" class="w-full rounded-lg border border-gray-700" />
        </div>

        <!-- åˆ†æçµæœ -->
        <div id="analysis-result" class="hidden mb-4 p-3 rounded-lg bg-gray-800 border border-gray-700 text-sm">
        </div>
    </main>

    <!-- åº•éƒ¨è¼¸å…¥å€ -->
    <footer class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-4">
        <div class="flex gap-2">
            <input id="instruction" type="text" placeholder="è¼¸å…¥æŒ‡ä»¤..." 
                class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                onkeypress="if(event.key==='Enter') execute()">
            <button onclick="execute()" class="btn bg-blue-600 hover:bg-blue-700 px-6 rounded-lg font-bold">
                â¤
            </button>
        </div>
        <div class="flex justify-between mt-2 text-xs text-gray-500">
            <span id="provider">Provider: gemini</span>
            <span id="exec-mode">Execute: true</span>
        </div>
    </footer>

    <script>
        const API_BASE = '';
        let token = localStorage.getItem('jarvis_token') || '';
        let history = [];

        function getHeaders() {
            const h = { 'Content-Type': 'application/json' };
            if (token) h['Authorization'] = `Bearer ${token}`;
            return h;
        }

        function addMessage(role, content, extra = '') {
            const div = document.createElement('div');
            div.className = role === 'user' ? 'msg-user p-3 rounded-lg text-sm' : 'msg-bot p-3 rounded-lg text-sm';
            div.innerHTML = content + (extra ? `<div class="mt-2 text-xs text-gray-400">${extra}</div>` : '');
            document.getElementById('chat').appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function showStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        async function execute() {
            const input = document.getElementById('instruction');
            const instruction = input.value.trim();
            if (!instruction) return;

            addMessage('user', instruction);
            input.value = '';
            showStatus('åŸ·è¡Œä¸­...');

            try {
                const res = await fetch(`${API_BASE}/api/smart/execute`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ instruction, execute: true })
                });
                const data = await res.json();

                if (data.ok) {
                    const r = data.result;
                    let content = '';
                    if (r.parsed) {
                        content += `<p class="font-bold">ğŸ“‹ è§£æçµæœï¼š${r.parsed.intent}</p>`;
                        content += `<p class="text-xs text-gray-400">é¡å‹ï¼š${r.parsed.type} | ä¿¡å¿ƒåº¦ï¼š${(r.parsed.confidence * 100).toFixed(0)}%</p>`;
                    }
                    if (r.steps && r.steps.length > 0) {
                        content += `<p class="mt-2">âœ… åŸ·è¡Œ ${r.steps_executed} æ­¥é©Ÿ</p>`;
                    }
                    if (r.vlm_analysis && r.vlm_analysis.elements) {
                        content += `<p class="mt-2 text-blue-400">ğŸ‘ï¸ ç™¼ç¾ ${r.vlm_analysis.elements.length} å€‹å¯äº’å‹•å…ƒç´ </p>`;
                    }
                    if (r.error) {
                        content += `<p class="text-red-400 mt-2">âŒ ${r.error}</p>`;
                    }
                    addMessage('bot', content, `è€—æ™‚ ${r.duration_seconds} ç§’`);
                } else {
                    addMessage('bot', `<p class="text-red-400">âŒ ${data.error}</p>`);
                }
            } catch (e) {
                addMessage('bot', `<p class="text-red-400">âŒ éŒ¯èª¤ï¼š${e.message}</p>`);
            }

            showStatus('å°±ç·’');
        }

        async function sendQuick(cmd) {
            document.getElementById('instruction').value = cmd;
            execute();
        }

        async function analyzeScreen() {
            showStatus('åˆ†æä¸­...');
            try {
                const res = await fetch(`${API_BASE}/api/smart/analyze`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ focus_area: 'å…¨è¢å¹•' })
                });
                const data = await res.json();

                if (data.ok) {
                    const a = data.analysis;
                    let html = `<p class="font-bold">ğŸ‘ï¸ è¢å¹•åˆ†æ</p>`;
                    if (a.elements) {
                        html += `<div class="mt-2 space-y-1">`;
                        a.elements.forEach(el => {
                            html += `<p class="text-xs">â€¢ ${el.type}: ${el.text || 'ç„¡æ–‡å­—'} (${el.x}, ${el.y})</p>`;
                        });
                        html += `</div>`;
                    }
                    if (a.plan) {
                        html += `<p class="mt-2 text-green-400">ğŸ“ å»ºè­°å‹•ä½œï¼š${a.plan.length} æ­¥</p>`;
                    }
                    document.getElementById('analysis-result').innerHTML = html;
                    document.getElementById('analysis-result').classList.remove('hidden');
                }
            } catch (e) {
                alert('åˆ†æå¤±æ•—ï¼š' + e.message);
            }
            showStatus('å°±ç·’');
        }

        async function ask() {
            const q = prompt('è¼¸å…¥å•é¡Œï¼š');
            if (!q) return;
            showStatus('æ€è€ƒä¸­...');
            try {
                const res = await fetch(`${API_BASE}/api/smart/ask`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ question: q })
                });
                const data = await res.json();
                if (data.ok) {
                    addMessage('bot', `<p>${data.answer}</p>`, 'å•ç­”æ¨¡å¼');
                }
            } catch (e) {
                alert('éŒ¯èª¤ï¼š' + e.message);
            }
            showStatus('å°±ç·’');
        }

        function showSettings() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm">
                    <h2 class="text-lg font-bold mb-4">âš™ï¸ è¨­å®š</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400">Provider</label>
                            <select id="provider-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mt-1">
                                <option value="gemini">Gemini</option>
                                <option value="claude">Claude</option>
                                <option value="ollama">Ollama</option>
                                <option value="deepseek">DeepSeek</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">åŸ·è¡Œæ¨¡å¼</label>
                            <select id="exec-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mt-1">
                                <option value="true">ç«‹å³åŸ·è¡Œ</option>
                                <option value="false">åƒ…è¦åŠƒ</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Token (å¯é¸)</label>
                            <input type="password" id="token-input" value="${token}" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mt-1">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="saveSettings()" class="flex-1 bg-blue-600 py-2 rounded">å„²å­˜</button>
                        <button onclick="this.parentElement.parentElement.remove()" class="flex-1 bg-gray-700 py-2 rounded">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSettings() {
            const provider = document.getElementById('provider-select').value;
            const exec = document.getElementById('exec-select').value;
            token = document.getElementById('token-input').value;
            if (token) localStorage.setItem('jarvis_token', token);
            document.getElementById('provider').textContent = `Provider: ${provider}`;
            document.getElementById('exec-mode').textContent = `Execute: ${exec}`;
            document.querySelector('.modal')?.remove();
        }

        // æª¢æŸ¥ç‹€æ…‹
        async function checkStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/smart/status`);
                const data = await res.json();
                if (data.ok) {
                    showStatus('å°±ç·’');
                } else {
                    showStatus('é›¢ç·š');
                }
            } catch (e) {
                showStatus('é›¢ç·š');
            }
        }

        checkStatus();
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
