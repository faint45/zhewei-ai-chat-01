<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¯‰æœªç§‘æŠ€ â€” è¨‚é–±ä»˜æ¬¾</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f172a; color: #e2e8f0; }
.card { background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 24px; transition: all .2s; }
.card:hover { border-color: #0ea5e9; transform: translateY(-2px); }
.card.selected { border-color: #0ea5e9; box-shadow: 0 0 0 2px rgba(14,165,233,.3); }
.btn { padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all .15s; display: inline-flex; align-items: center; gap: 8px; }
.btn-primary { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; font-size: 1.1rem; }
.btn-primary:hover { background: linear-gradient(135deg, #0284c7, #0369a1); transform: scale(1.02); }
.btn-primary:disabled { opacity: .5; cursor: not-allowed; transform: none; }
.btn-outline { border: 1px solid #475569; color: #94a3b8; }
.btn-outline:hover { border-color: #0ea5e9; color: #0ea5e9; }
.badge { padding: 3px 10px; border-radius: 9999px; font-size: 11px; font-weight: 700; }
.badge-green { background: #065f46; color: #6ee7b7; }
.badge-blue { background: #1e3a5f; color: #7dd3fc; }
.badge-purple { background: #4c1d95; color: #c4b5fd; }
.method-card { cursor: pointer; position: relative; }
.method-card.selected::after { content: 'âœ“'; position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: #0ea5e9; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
.plan-card { cursor: pointer; position: relative; }
.plan-card.selected { border-color: #0ea5e9; background: #1e3a5f20; }
.plan-card .popular { position: absolute; top: -10px; right: 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 2px 12px; border-radius: 9999px; font-size: 11px; font-weight: 700; }
.step-indicator { display: flex; gap: 8px; align-items: center; }
.step { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
.step.active { background: #0ea5e9; color: white; }
.step.done { background: #059669; color: white; }
.step.pending { background: #334155; color: #64748b; }
.step-line { width: 40px; height: 2px; background: #334155; }
.step-line.done { background: #059669; }
.fade-in { animation: fadeIn .3s ease; }
@keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
</style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Header -->
<header class="border-b border-slate-700 px-6 py-4 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-sky-500 to-blue-700 flex items-center justify-center text-white font-bold text-lg">ç¯‰</div>
    <div>
      <h1 class="text-lg font-bold text-white">ç¯‰æœªç§‘æŠ€ AI å¹³å°</h1>
      <p class="text-xs text-slate-400">é¸æ“‡æ–¹æ¡ˆï¼Œé–‹å§‹ä½¿ç”¨ AI åŠ é€Ÿå·¥ä½œ</p>
    </div>
  </div>
  <a href="/jarvis" class="btn btn-outline text-sm">â† è¿”å›ç³»çµ±</a>
</header>

<main class="flex-1 max-w-5xl mx-auto w-full px-6 py-8">

<!-- Step Indicator -->
<div class="flex justify-center mb-8">
  <div class="step-indicator">
    <div class="step active" id="step1">1</div>
    <div class="step-line" id="line1"></div>
    <div class="step pending" id="step2">2</div>
    <div class="step-line" id="line2"></div>
    <div class="step pending" id="step3">3</div>
  </div>
</div>
<div class="text-center mb-8">
  <p class="text-sm text-slate-400" id="stepLabel">æ­¥é©Ÿ 1ï¼šé¸æ“‡æ–¹æ¡ˆ</p>
</div>

<!-- ===== Step 1: é¸æ“‡ç”¢å“ & æ–¹æ¡ˆ ===== -->
<div id="view-plans" class="fade-in">
  <!-- ç”¢å“é¸æ“‡å™¨ -->
  <div class="flex justify-center gap-3 mb-6">
    <button onclick="selectProduct('ai_creator')" id="prodBtn_ai_creator" class="card text-center px-5 py-3 cursor-pointer border-pink-500/50 bg-pink-950/20" style="min-width:140px">
      <div class="text-2xl mb-1">ğŸ¨</div><div class="text-sm font-bold text-pink-400">AI å‰µä½œå·¥ä½œå®¤</div><div class="text-[10px] text-slate-500">ç”Ÿåœ– Â· ç”Ÿå½±ç‰‡ Â· NSFW</div>
    </button>
    <button onclick="selectProduct('construction_ai')" id="prodBtn_construction_ai" class="card text-center px-5 py-3 cursor-pointer" style="min-width:140px">
      <div class="text-2xl mb-1">ğŸ—ï¸</div><div class="text-sm font-bold text-amber-400">ç‡Ÿå»º AI åŠ©æ‰‹</div><div class="text-[10px] text-slate-500">çŸ¥è­˜åº« Â· èªéŸ³ Â· è¦–è¦º</div>
    </button>
    <button onclick="selectProduct('llm_api')" id="prodBtn_llm_api" class="card text-center px-5 py-3 cursor-pointer" style="min-width:140px">
      <div class="text-2xl mb-1">ğŸ§ </div><div class="text-sm font-bold text-blue-400">å¤§æ¨¡å‹ API</div><div class="text-[10px] text-slate-500">OpenAI ç›¸å®¹ Â· 70B</div>
    </button>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="planGrid"></div>
</div>

<!-- ===== Step 2: é¸æ“‡æ”¯ä»˜æ–¹å¼ ===== -->
<div id="view-methods" class="hidden fade-in">
  <h2 class="text-xl font-bold text-center mb-6">é¸æ“‡æ”¯ä»˜æ–¹å¼</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="methodGrid"></div>
  <div class="flex justify-center gap-4">
    <button onclick="goStep(1)" class="btn btn-outline">â† ä¸Šä¸€æ­¥</button>
    <button onclick="goStep(3)" id="btnNext2" class="btn btn-primary" disabled>ç¢ºèªä»˜æ¬¾ â†’</button>
  </div>
</div>

<!-- ===== Step 3: ç¢ºèª & ä»˜æ¬¾ ===== -->
<div id="view-confirm" class="hidden fade-in">
  <div class="max-w-lg mx-auto">
    <div class="card mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“‹ è¨‚å–®ç¢ºèª</h2>
      <div class="space-y-3" id="orderSummary"></div>
    </div>
    <div class="flex justify-center gap-4">
      <button onclick="goStep(2)" class="btn btn-outline">â† ä¿®æ”¹</button>
      <button onclick="submitPayment()" id="btnPay" class="btn btn-primary text-lg px-8">
        ğŸ’³ ç«‹å³ä»˜æ¬¾
      </button>
    </div>
    <div id="paymentResult" class="mt-6 hidden"></div>
  </div>
</div>

</main>

<!-- Footer -->
<footer class="border-t border-slate-700 px-6 py-4 text-center text-xs text-slate-500">
  ç¯‰æœªç§‘æŠ€ Â© 2026 â€” ä»˜æ¬¾ç”±ç¬¬ä¸‰æ–¹é‡‘æµå¹³å°å®‰å…¨è™•ç†ï¼Œæˆ‘å€‘ä¸å„²å­˜æ‚¨çš„ä¿¡ç”¨å¡è³‡è¨Š
</footer>

<script>
const API = '';
const TOKEN = localStorage.getItem('jarvis_token') || '';
const HEADERS = { 'Content-Type': 'application/json' };
if (TOKEN) HEADERS['Authorization'] = `Bearer ${TOKEN}`;

let selectedPlan = null;
let selectedMethod = null;
let selectedProduct = 'ai_creator';
let allPlans = [];
let allMethods = [];
let productPlans = {};

async function api(path, opts = {}) {
  try {
    const r = await fetch(API + path, { headers: HEADERS, ...opts });
    return await r.json();
  } catch (e) { return { ok: false, error: e.message }; }
}

// â”€â”€ ç”¢å“æ–¹æ¡ˆå®šç¾© â”€â”€
const PRODUCT_PLANS = {
  ai_creator: {
    gradient: { basic:'from-pink-600 to-rose-700', pro:'from-pink-500 to-violet-600', ultra:'from-violet-600 to-purple-700' },
    plans: [
      { id:'creator_basic', name:'åŸºç¤ç‰ˆ', price:299, period:'monthly', popular:false, features:['200 å¼µåœ–ç‰‡/æœˆ','30 å€‹å½±ç‰‡/æœˆ','12+ é›²ç«¯æ¨¡å‹','ä½œå“åº« + ä¸‹è¼‰'] },
      { id:'creator_pro', name:'å°ˆæ¥­ç‰ˆ', price:799, period:'monthly', popular:true, features:['ç„¡é™åœ–ç‰‡ç”Ÿæˆ','100 å€‹å½±ç‰‡/æœˆ','ç„¡å¯©æŸ¥æ¨¡å¼ (NSFW)','æœ¬åœ° Forge + ComfyUI','æ‰€æœ‰é›²ç«¯æ¨¡å‹','å„ªå…ˆç”Ÿæˆä½‡åˆ—'] },
      { id:'creator_ultra', name:'ç„¡é™ç‰ˆ', price:1999, period:'monthly', popular:false, features:['å…¨éƒ¨ç„¡é™','ç„¡å¯©æŸ¥æ¨¡å¼ (NSFW)','æœ¬åœ°æ¨¡å‹ç„¡é™åˆ¶','å½±ç‰‡ç„¡é™ç”Ÿæˆ','API å­˜å–','å°ˆå±¬æ”¯æ´'] },
    ]
  },
  construction_ai: {
    gradient: { basic:'from-amber-600 to-orange-700', pro:'from-amber-500 to-yellow-600', ultra:'from-orange-600 to-red-700' },
    plans: [
      { id:'cms_pro', name:'å°ˆæ¥­ç‰ˆ', price:1500, period:'monthly', popular:true, features:['50,000 ç­†çŸ¥è­˜åº«','15 ç¨®å°ˆæ¥­è§’è‰²','Whisper èªéŸ³è¾¨è­˜','AI è¦–è¦ºå®‰å…¨åµæ¸¬','æ–½å·¥æ—¥èªŒ + è‡ªä¸»æª¢æŸ¥','å„ªå…ˆæ”¯æ´'] },
      { id:'cms_enterprise', name:'ä¼æ¥­ç‰ˆ', price:8000, period:'monthly', popular:false, features:['ç„¡é™çŸ¥è­˜åº«','å…¨éƒ¨è§’è‰²','èªéŸ³ + è¦–è¦º','æ–½å·¥å‰å¾Œæ¯”å°','OCR æ–‡å­—è¾¨è­˜','å°ˆå±¬å®¢æœ + å®¢è£½åŒ–','å¤šå·¥åœ°ç®¡ç†'] },
    ]
  },
  llm_api: {
    gradient: { basic:'from-blue-600 to-sky-700', pro:'from-blue-500 to-indigo-600', ultra:'from-indigo-600 to-violet-700' },
    plans: [
      { id:'api_starter', name:'å…¥é–€ç‰ˆ', price:299, period:'monthly', popular:false, features:['500K tokens/æœˆ','30 req/min','Qwen3 8B/4B + Gemma3','Embedding API'] },
      { id:'api_pro', name:'å°ˆæ¥­ç‰ˆ', price:999, period:'monthly', popular:true, features:['5M tokens/æœˆ','60 req/min','å…¨éƒ¨æ¨¡å‹','70B æ¨¡å‹å­˜å–','å„ªå…ˆä½‡åˆ—'] },
      { id:'api_business', name:'å•†å‹™ç‰ˆ', price:4999, period:'monthly', popular:false, features:['50M tokens/æœˆ','120 req/min','å…¨éƒ¨æ¨¡å‹ + 70B','å°ˆå±¬ API ç«¯é»','SLA ä¿è­‰','æŠ€è¡“æ”¯æ´'] },
    ]
  }
};

function selectProduct(product) {
  selectedProduct = product;
  ['ai_creator','construction_ai','llm_api'].forEach(p => {
    const btn = document.getElementById('prodBtn_' + p);
    if (p === product) {
      btn.classList.add('selected');
      const colors = { ai_creator:'border-pink-500/50 bg-pink-950/20', construction_ai:'border-amber-500/50 bg-amber-950/20', llm_api:'border-blue-500/50 bg-blue-950/20' };
      btn.className = 'card text-center px-5 py-3 cursor-pointer ' + (colors[p] || '');
    } else {
      btn.classList.remove('selected');
      btn.className = 'card text-center px-5 py-3 cursor-pointer';
    }
  });
  renderProductPlans();
}

function renderProductPlans() {
  const pp = PRODUCT_PLANS[selectedProduct];
  if (!pp) return;
  const grid = document.getElementById('planGrid');
  const gradients = ['from-slate-600 to-slate-700','from-sky-600 to-blue-700','from-purple-600 to-indigo-700'];
  const productGradients = {
    ai_creator: ['from-pink-600 to-rose-700','from-pink-500 to-violet-600','from-violet-600 to-purple-700'],
    construction_ai: ['from-amber-600 to-orange-700','from-amber-500 to-yellow-600','from-orange-600 to-red-700'],
    llm_api: ['from-blue-600 to-sky-700','from-blue-500 to-indigo-600','from-indigo-600 to-violet-700'],
  };
  const grads = productGradients[selectedProduct] || gradients;

  grid.innerHTML = pp.plans.map((p, i) => `
    <div class="plan-card card" onclick="selectPlan('${p.id}')" data-plan="${p.id}">
      ${p.popular ? '<div class="popular">ğŸ”¥ æœ€å—æ­¡è¿</div>' : ''}
      <div class="rounded-lg bg-gradient-to-br ${grads[i] || grads[0]} p-4 mb-4 text-center">
        <h3 class="text-lg font-bold text-white">${p.name}</h3>
        <p class="text-3xl font-black text-white mt-2">NT$${p.price.toLocaleString()}</p>
        <p class="text-sm text-white/70">/æœˆ</p>
      </div>
      <ul class="space-y-2 text-sm">
        ${p.features.map(f => `<li class="flex items-center gap-2"><span class="text-emerald-400">âœ“</span> ${f}</li>`).join('')}
      </ul>
    </div>`).join('');

  allPlans = pp.plans;
}

// â”€â”€ è¼‰å…¥æ–¹æ¡ˆï¼ˆåˆå§‹åŒ–ï¼‰ â”€â”€
async function loadPlans() {
  // å¾ URL åƒæ•¸è®€å–ç”¢å“
  const params = new URLSearchParams(location.search);
  const prod = params.get('product');
  if (prod && PRODUCT_PLANS[prod]) selectedProduct = prod;
  selectProduct(selectedProduct);
}

// â”€â”€ è¼‰å…¥æ”¯ä»˜æ–¹å¼ â”€â”€
async function loadMethods() {
  const r = await api('/api/gateway/methods');
  if (!r.ok) return;
  allMethods = r.methods;
  const grid = document.getElementById('methodGrid');

  const methodLogos = {
    ecpay: 'ğŸ’³',
    alipay: 'ğŸ”µ',
    jkopay: 'ğŸŸ¢',
  };

  grid.innerHTML = allMethods.map(m => {
    const avail = m.available;
    return `
    <div class="method-card card ${avail ? '' : 'opacity-50 cursor-not-allowed'}" 
         onclick="${avail ? `selectMethod('${m.id}')` : ''}" data-method="${m.id}">
      <div class="text-center mb-3">
        <span class="text-4xl">${methodLogos[m.id] || m.icon}</span>
      </div>
      <h3 class="text-lg font-bold text-center">${m.name}</h3>
      <p class="text-sm text-slate-400 text-center mt-1">${m.desc}</p>
      <p class="text-xs text-center mt-2">
        <span class="badge ${avail ? 'badge-green' : 'badge-blue'}">${avail ? 'âœ… å¯ç”¨' : 'âš™ï¸ è¨­å®šä¸­'}</span>
        <span class="badge badge-blue ml-1">${m.region}</span>
      </p>
    </div>`;
  }).join('');
}

// â”€â”€ é¸æ“‡é‚è¼¯ â”€â”€
function selectPlan(planId) {
  selectedPlan = allPlans.find(p => p.id === planId);
  if (selectedPlan) selectedPlan.product = selectedProduct;
  document.querySelectorAll('.plan-card').forEach(el => {
    el.classList.toggle('selected', el.dataset.plan === planId);
  });
  setTimeout(() => goStep(2), 300);
}

function selectMethod(methodId) {
  selectedMethod = allMethods.find(m => m.id === methodId);
  document.querySelectorAll('.method-card').forEach(el => {
    el.classList.toggle('selected', el.dataset.method === methodId);
  });
  document.getElementById('btnNext2')?.disabled = false;
}

// â”€â”€ æ­¥é©Ÿåˆ‡æ› â”€â”€
function goStep(step) {
  document.getElementById('view-plans')?.classList.toggle('hidden', step !== 1);
  document.getElementById('view-methods')?.classList.toggle('hidden', step !== 2);
  document.getElementById('view-confirm')?.classList.toggle('hidden', step !== 3);

  for (let i = 1; i <= 3; i++) {
    const el = document.getElementById('step' + i);
    el.className = 'step ' + (i < step ? 'done' : i === step ? 'active' : 'pending');
    if (i < 3) {
      document.getElementById('line' + i)?.className = 'step-line ' + (i < step ? 'done' : '');
    }
  }

  const labels = { 1: 'æ­¥é©Ÿ 1ï¼šé¸æ“‡æ–¹æ¡ˆ', 2: 'æ­¥é©Ÿ 2ï¼šé¸æ“‡æ”¯ä»˜æ–¹å¼', 3: 'æ­¥é©Ÿ 3ï¼šç¢ºèªä»˜æ¬¾' };
  document.getElementById('stepLabel')?.textContent = labels[step];

  if (step === 3) renderSummary();
}

function renderSummary() {
  if (!selectedPlan || !selectedMethod) return;
  const div = document.getElementById('orderSummary');
  div.innerHTML = `
    <div class="flex justify-between py-2 border-b border-slate-700">
      <span class="text-slate-400">æ–¹æ¡ˆ</span>
      <span class="font-bold">${selectedPlan.name}</span>
    </div>
    <div class="flex justify-between py-2 border-b border-slate-700">
      <span class="text-slate-400">é€±æœŸ</span>
      <span>${selectedPlan.period === 'monthly' ? 'æœˆç¹³' : selectedPlan.period === 'yearly' ? 'å¹´ç¹³' : selectedPlan.period}</span>
    </div>
    <div class="flex justify-between py-2 border-b border-slate-700">
      <span class="text-slate-400">æ”¯ä»˜æ–¹å¼</span>
      <span>${selectedMethod.icon} ${selectedMethod.name}</span>
    </div>
    <div class="flex justify-between py-3 text-lg">
      <span class="font-bold">æ‡‰ä»˜é‡‘é¡</span>
      <span class="font-black text-sky-400">NT$${selectedPlan.price.toLocaleString()}</span>
    </div>
  `;
}

// â”€â”€ æäº¤ä»˜æ¬¾ â”€â”€
async function submitPayment() {
  if (!selectedPlan || !selectedMethod) return;
  const btn = document.getElementById('btnPay');
  btn.disabled = true;
  btn.textContent = 'â³ è™•ç†ä¸­...';

  const r = await api('/api/gateway/create', {
    method: 'POST',
    body: JSON.stringify({
      method: selectedMethod.id,
      plan: selectedPlan.id,
    }),
  });

  const div = document.getElementById('paymentResult');
  div.classList.remove('hidden');

  if (r.ok) {
    // æœ‰è¡¨å–® HTML â†’ è‡ªå‹•è·³è½‰åˆ°é‡‘æµé é¢
    if (r.form_html) {
      div.innerHTML = `
        <div class="card text-center">
          <p class="text-lg font-bold text-emerald-400 mb-2">âœ… è¨‚å–®å·²å»ºç«‹</p>
          <p class="text-sm text-slate-400 mb-4">è¨‚å–®ç·¨è™Ÿ: ${r.order_id}</p>
          <p class="text-sm">æ­£åœ¨è·³è½‰åˆ°ä»˜æ¬¾é é¢...</p>
        </div>`;
      // åœ¨æ–°è¦–çª—ä¸­é–‹å•Ÿä»˜æ¬¾è¡¨å–®
      const w = window.open('', '_blank');
      if (w) {
        w.document.write(r.form_html);
        w.document.close();
      } else {
        // å½ˆçª—è¢«æ“‹ï¼Œé¡¯ç¤ºæ‰‹å‹•æŒ‰éˆ•
        div.innerHTML += `
          <div class="mt-4 p-4 rounded-lg bg-amber-900/30 border border-amber-700">
            <p class="text-amber-400 text-sm mb-2">âš ï¸ ç€è¦½å™¨é˜»æ“‹äº†å½ˆå‡ºè¦–çª—</p>
            <button onclick="manualRedirect()" class="btn btn-primary">æ‰‹å‹•å‰å¾€ä»˜æ¬¾é é¢</button>
          </div>`;
        window._payFormHtml = r.form_html;
      }
    }
    // æœ‰ redirect URLï¼ˆæ”¯ä»˜å¯¶ï¼‰
    else if (r.redirect_url) {
      div.innerHTML = `
        <div class="card text-center">
          <p class="text-lg font-bold text-emerald-400 mb-2">âœ… è¨‚å–®å·²å»ºç«‹</p>
          <p class="text-sm mb-4">æ­£åœ¨è·³è½‰åˆ°æ”¯ä»˜å¯¶...</p>
        </div>`;
      window.open(r.redirect_url, '_blank');
    }
    // æœ‰ payment URLï¼ˆè¡—å£ï¼‰
    else if (r.payment_url) {
      div.innerHTML = `
        <div class="card text-center">
          <p class="text-lg font-bold text-emerald-400 mb-2">âœ… è¨‚å–®å·²å»ºç«‹</p>
          <p class="text-sm mb-2">è«‹ä½¿ç”¨è¡—å£ App æƒæä»¥ä¸‹é€£çµä»˜æ¬¾ï¼š</p>
          <a href="${r.payment_url}" target="_blank" class="btn btn-primary mt-2">ğŸŸ¢ å‰å¾€è¡—å£ä»˜æ¬¾</a>
        </div>`;
    }
  } else {
    div.innerHTML = `
      <div class="card border-red-700">
        <p class="text-red-400 font-bold">âŒ å»ºç«‹è¨‚å–®å¤±æ•—</p>
        <p class="text-sm text-slate-400 mt-1">${r.error || 'æœªçŸ¥éŒ¯èª¤'}</p>
      </div>`;
    btn.disabled = false;
    btn.textContent = 'ğŸ’³ ç«‹å³ä»˜æ¬¾';
  }
}

function manualRedirect() {
  if (window._payFormHtml) {
    const w = window.open('', '_blank');
    w.document.write(window._payFormHtml);
    w.document.close();
  }
}

// â”€â”€ åˆå§‹åŒ– â”€â”€
(async () => {
  await Promise.all([loadPlans(), loadMethods()]);
  const params = new URLSearchParams(location.search);
  const preselect = params.get('plan');
  if (preselect && allPlans.find(p => p.id === preselect)) {
    selectPlan(preselect);
  }
})();
</script>
</body>
</html>
