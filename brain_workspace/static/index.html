<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>築未科技 | AI 指揮中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-blue-400">築未科技 (Zhewei Tech) 系統後台</h1>
            <div class="flex gap-4">
                <span class="px-3 py-1 bg-green-900 text-green-300 rounded text-sm">主腦: Python 3.14</span>
                <span class="px-3 py-1 bg-blue-900 text-blue-300 rounded text-sm">視覺: 3.12 (YOLOv8)</span>
            </div>
        </header>

        <div class="grid grid-cols-12 gap-6">
            <aside class="col-span-3 space-y-4">
                <div v-for="(status, agent) in agents" :key="agent" class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">[[ agent ]]</span>
                        <span :class="status.online ? 'text-green-400' : 'text-red-400'">● [[ status.online ? '在線' : '離線' ]]</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">[[ status.role ]]</p>
                </div>
            </aside>

            <main class="col-span-6 space-y-6">
                <div class="bg-black p-4 rounded border border-blue-500 font-mono text-sm h-96 overflow-y-auto" id="logs">
                    <div v-for="(log, i) in logs" :key="i" :class="log.type === 'error' ? 'text-red-400' : 'text-green-400'">
                        [[ log.time ]] [[ log.content || log.result || '' ]]
                    </div>
                </div>
                <div class="flex gap-2">
                    <input v-model="userInput" @keyup.enter="sendRequest" class="flex-1 bg-gray-800 border border-gray-700 p-3 rounded" placeholder="下達八階段指令 (如: 生成影像並編碼佈署)...">
                    <button @click="sendRequest" class="bg-blue-600 px-6 py-2 rounded hover:bg-blue-500 transition">發送指令</button>
                </div>
            </main>

            <aside class="col-span-3 space-y-4">
                <div class="bg-gray-800 p-6 rounded-lg text-center">
                    <h3 class="text-gray-400 mb-2">當前總進度</h3>
                    <div class="text-4xl font-bold text-blue-400">[[ latexProgress ]]</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="mb-4">常用工具快截</h3>
                    <button @click="shortcut('列出 input 目錄並產出今日影像報表至 Z 槽 Reports')" class="w-full mb-2 p-2 bg-gray-700 rounded text-xs hover:bg-gray-600">產出影像報表 (Z 槽)</button>
                    <button @click="shortcut('請執行 deploy_service 重啟 Ollama 服務')" class="w-full mb-2 p-2 bg-gray-700 rounded text-xs hover:bg-gray-600">重啟 Ollama 地端代理</button>
                    <button @click="shortcut('請提醒：請在本機打開 Cursor 專案')" class="w-full p-2 bg-gray-700 rounded text-xs hover:bg-gray-600">打開 Cursor 專案</button>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        createApp({
            setup() {
                const logs = ref([]);
                const userInput = ref("");
                const latexProgress = ref("$0\\%$");
                const agents = ref({
                    "Gemini Admin": { online: true, role: "複雜決策/管理員" },
                    "Claude Dev": { online: true, role: "編碼/修正" },
                    "Ollama Local": { online: true, role: "地端檢核" },
                    "Media Gen": { online: true, role: "Jimeng/Grok" }
                });

                let socket;
                const parseLatexProgress = (text) => {
                    if (!text || typeof text !== 'string') return null;
                    const m = text.match(/\$(\d+)\s*\\?%\s*\$/);
                    if (m) return '$' + m[1] + '\\%$';
                    return null;
                };
                const origin = () => window.location.origin || (window.location.protocol + '//' + window.location.host);
                onMounted(() => {
                    // 地端用 ws，遠端 https 用 wss（瀏覽器強制要求）
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.host;
                    socket = new WebSocket(`${protocol}//${host}/ws`);
                    socket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        const content = data.content || data.result || '';
                        const latex = data.type === 'progress' ? content : parseLatexProgress(content);
                        if (latex) latexProgress.value = latex.startsWith('$') ? latex : `$${latex}`;
                        else if (data.type === 'step') latexProgress.value = `$${Math.min(100, logs.value.length * 10)}\\%$`;
                        logs.value.push({ time: new Date().toLocaleTimeString(), ...data });
                    };
                    fetch(origin() + '/api/progress').then(r => r.json()).then(d => { if (d.data) latexProgress.value = d.data.startsWith('$') ? d.data : `$${d.data}`; }).catch(() => {});
                    const pollAgents = () => fetch(origin() + '/api/agents').then(r => r.json()).then(d => { agents.value = d; }).catch(() => {});
                    pollAgents();
                    setInterval(pollAgents, 30000);
                });

                const sendRequest = () => {
                    if(!userInput.value) return;
                    if(!socket || socket.readyState !== WebSocket.OPEN) {
                        logs.value.push({ time: new Date().toLocaleTimeString(), type: "error", content: "WebSocket 未連線，請稍後再試" });
                        return;
                    }
                    socket.send(JSON.stringify({ text: userInput.value }));
                    logs.value.push({ time: new Date().toLocaleTimeString(), type: "info", content: `發送請求: ${userInput.value}` });
                    userInput.value = "";
                };
                const shortcut = (cmd) => {
                    userInput.value = cmd;
                    sendRequest();
                };

                return { logs, userInput, agents, sendRequest, shortcut, latexProgress };
            },
            delimiters: ['[[', ']]']
        }).mount('#app');
    </script>
</body>
</html>
