<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#111827">
    <title>築未科技 | AI 指揮中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @media (max-width: 768px) {
            .chat-log { max-height: 50vh; }
            .input-row input { font-size: 16px; }
        }
        .touch-target { min-height: 44px; min-width: 44px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 antialiased">
    <div id="app" class="min-h-screen flex flex-col max-w-7xl mx-auto px-4 sm:p-6 md:p-8">
        <header class="flex flex-wrap justify-between items-center gap-3 py-4 border-b border-gray-700 shrink-0">
            <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-400">築未科技 系統後台</h1>
            <div class="flex gap-2 flex-wrap">
                <span class="px-2 py-1 bg-green-900 text-green-300 rounded text-xs sm:text-sm">主腦 Python</span>
                <span class="px-2 py-1 bg-blue-900 text-blue-300 rounded text-xs sm:text-sm">視覺 YOLOv8</span>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 flex-1 py-4">
            <aside class="order-2 md:order-1 md:col-span-3 space-y-3">
                <div class="text-sm text-gray-400 mb-2">引擎狀態</div>
                <div v-for="(status, agent) in agents" :key="agent" class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-sm">[[ agent ]]</span>
                        <span :class="status.online ? 'text-green-400' : 'text-red-400'" class="text-xs">[[ status.online ? '在線' : '離線' ]]</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-0.5">[[ status.role ]]</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg text-center hidden md:block">
                    <div class="text-gray-400 text-xs mb-1">當前進度</div>
                    <div class="text-2xl font-bold text-blue-400">[[ latexProgress ]]</div>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg hidden md:block">
                    <h3 class="text-xs text-gray-400 mb-2">常用快截</h3>
                    <button @click="shortcut('列出 input 目錄並產出今日影像報表至 Z 槽 Reports')" class="w-full mb-1.5 p-2 bg-gray-700 rounded text-xs hover:bg-gray-600 touch-target">產出影像報表</button>
                    <button @click="shortcut('請執行 deploy_service 重啟 Ollama 服務')" class="w-full mb-1.5 p-2 bg-gray-700 rounded text-xs hover:bg-gray-600 touch-target">重啟 Ollama</button>
                </div>
            </aside>

            <main class="order-1 md:order-2 md:col-span-6 flex flex-col min-h-0">
                <div class="bg-black p-3 sm:p-4 rounded border border-blue-500 font-mono text-xs sm:text-sm chat-log overflow-y-auto flex-1 min-h-[200px] sm:min-h-[280px] md:h-96" id="logs">
                    <div v-for="(log, i) in logs" :key="i" :class="log.type === 'error' ? 'text-red-400' : 'text-green-400'" class="py-0.5 break-words">
                        <span class="text-gray-500">[[ log.time ]]</span> [[ log.content || log.result || '' ]]
                    </div>
                </div>
                <div class="flex gap-2 mt-3 flex-shrink-0">
                    <input v-model="userInput" @keyup.enter="sendRequest" class="flex-1 bg-gray-800 border border-gray-700 p-3 rounded input-row touch-target placeholder-gray-500" placeholder="下達八階段指令...">
                    <button @click="sendRequest" class="bg-blue-600 px-4 sm:px-6 py-3 rounded hover:bg-blue-500 transition touch-target font-medium">發送</button>
                </div>
                <div class="md:hidden mt-2 flex justify-between items-center text-xs text-gray-500">
                    <span>進度 [[ latexProgress ]]</span>
                    <span v-if="!wsConnected" class="text-red-400">未連線</span>
                    <span v-else class="text-green-400">已連線</span>
                </div>
            </main>

            <aside class="order-3 md:col-span-3 space-y-3 hidden md:block">
                <div class="bg-gray-800 p-6 rounded-lg text-center">
                    <h3 class="text-gray-400 mb-2 text-sm">當前總進度</h3>
                    <div class="text-4xl font-bold text-blue-400">[[ latexProgress ]]</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="mb-4 text-sm text-gray-400">常用工具快截</h3>
                    <button @click="shortcut('列出 input 目錄並產出今日影像報表至 Z 槽 Reports')" class="w-full mb-2 p-2 bg-gray-700 rounded text-xs hover:bg-gray-600">產出影像報表 (Z 槽)</button>
                    <button @click="shortcut('請執行 deploy_service 重啟 Ollama 服務')" class="w-full mb-2 p-2 bg-gray-700 rounded text-xs hover:bg-gray-600">重啟 Ollama 地端代理</button>
                    <button @click="shortcut('請列出 D:\\brain_workspace 目錄內容')" class="w-full p-2 bg-gray-700 rounded text-xs hover:bg-gray-600">列出 D 槽目錄</button>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        createApp({
            setup() {
                const logs = ref([]);
                const userInput = ref("");
                const latexProgress = ref("$0\\%$");
                const wsConnected = ref(false);
                const agents = ref({
                    "Gemini Admin": { online: false, role: "複雜決策/管理員" },
                    "Claude Dev": { online: false, role: "編碼/修正" },
                    "Ollama Local": { online: false, role: "地端檢核" },
                    "Media Gen": { online: false, role: "Jimeng/Grok" }
                });

                let socket;
                const parseLatexProgress = (text) => {
                    if (!text || typeof text !== 'string') return null;
                    const m = text.match(/\$(\d+)\s*\\?%\s*\$/);
                    if (m) return '$' + m[1] + '\\%$';
                    return null;
                };
                const origin = () => window.location.origin || (window.location.protocol + '//' + window.location.host);
                const connectWs = () => {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.host;
                    socket = new WebSocket(`${protocol}//${host}/ws`);
                    socket.onopen = () => { wsConnected.value = true; };
                    socket.onclose = () => { wsConnected.value = false; setTimeout(connectWs, 3000); };
                    socket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        const content = data.content || data.result || '';
                        const latex = data.type === 'progress' ? content : parseLatexProgress(content);
                        if (latex) latexProgress.value = latex.startsWith('$') ? latex : `$${latex}`;
                        else if (data.type === 'step') latexProgress.value = `$${Math.min(100, logs.value.length * 10)}\\%$`;
                        logs.value.push({ time: new Date().toLocaleTimeString(), ...data });
                    };
                };
                onMounted(() => {
                    connectWs();
                    fetch(origin() + '/api/progress').then(r => r.json()).then(d => { if (d.data) latexProgress.value = d.data.startsWith('$') ? d.data : `$${d.data}`; }).catch(() => {});
                    const pollAgents = () => fetch(origin() + '/api/agents').then(r => r.json()).then(d => { agents.value = d; }).catch(() => {});
                    pollAgents();
                    setInterval(pollAgents, 30000);
                });

                const sendRequest = () => {
                    if(!userInput.value) return;
                    if(!socket || socket.readyState !== WebSocket.OPEN) {
                        logs.value.push({ time: new Date().toLocaleTimeString(), type: "error", content: "WebSocket 未連線，請稍後再試" });
                        return;
                    }
                    socket.send(JSON.stringify({ text: userInput.value }));
                    logs.value.push({ time: new Date().toLocaleTimeString(), type: "info", content: "發送: " + userInput.value.substring(0, 50) + (userInput.value.length > 50 ? "…" : "") });
                    userInput.value = "";
                };
                const shortcut = (cmd) => {
                    userInput.value = cmd;
                    sendRequest();
                };

                return { logs, userInput, agents, sendRequest, shortcut, latexProgress, wsConnected };
            },
            delimiters: ['[[', ']]']
        }).mount('#app');
    </script>
</body>
</html>
