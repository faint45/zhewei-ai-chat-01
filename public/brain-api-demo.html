<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>築未科技大腦 — 網頁接入</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 2rem; background: #1e1e2e; color: #cdd6f4; }
    .bar { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
    input[type="text"] { padding: 0.5rem; border: 1px solid #45475a; border-radius: 6px; background: #313244; color: #cdd6f4; }
    button { padding: 0.5rem 1rem; background: #89b4fa; color: #1e1e2e; border: none; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #45475a; color: #cdd6f4; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #out { background: #313244; padding: 1rem; border-radius: 8px; white-space: pre-wrap; min-height: 100px; }
    #usage { font-size: 0.9rem; color: #a6e3a1; margin-left: 0.5rem; }
    .err { color: #f38ba8; }
  </style>
</head>
<body>
  <div class="bar">
    <span id="userInfo"></span>
    <span id="usage"></span>
    <input id="msg" placeholder="輸入問題" style="width:200px" />
    <button id="sendBtn" onclick="ask()">送出</button>
    <button class="secondary" onclick="logout()">登出</button>
  </div>
  <pre id="out"></pre>
  <script>
    const url = localStorage.getItem('brain_api_url') || window.location.origin || 'http://127.0.0.1:5100';
    const token = localStorage.getItem('session_token');
    const userId = localStorage.getItem('user_id') || 'web';

    if (!token) {
      window.location.href = (window.location.origin || url) + '/login';
    } else {
      document.getElementById('userInfo').textContent = '已登入: ' + userId;
    }

    async function fetchUsage() {
      try {
        const res = await fetch(url + '/usage');
        const data = await res.json().catch(() => ({}));
        if (data.formatted) document.getElementById('usage').textContent = '當月 ' + data.formatted;
      } catch (_) {}
    }
    fetchUsage();

    const MAX_RETRIES = 2;

    async function ask() {
      const msg = document.getElementById('msg').value.trim();
      const out = document.getElementById('out');
      const sendBtn = document.getElementById('sendBtn');
      if (!msg) return;
      out.textContent = '載入中...';
      out.classList.remove('err');
      sendBtn.disabled = true;
      let lastErr = '';
      for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
        try {
          const res = await fetch(url + '/compute', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Session-Token': token
            },
            body: JSON.stringify({ message: msg, user_id: userId, source: 'web' })
          });
          const data = await res.json().catch(() => ({}));
          if (res.status === 401) {
            localStorage.removeItem('session_token');
            window.location.href = url + '/login';
            return;
          }
          if (res.status >= 500 && attempt < MAX_RETRIES) {
            lastErr = data.detail || res.statusText || '伺服器錯誤';
            await new Promise(r => setTimeout(r, 800));
            continue;
          }
          if (!res.ok) {
            out.textContent = data.detail || data.message || JSON.stringify(data);
            out.classList.add('err');
            break;
          }
          out.textContent = data.reply || JSON.stringify(data);
          fetchUsage();
          break;
        } catch (e) {
          lastErr = e.message;
          if (attempt < MAX_RETRIES) await new Promise(r => setTimeout(r, 800));
          else {
            out.textContent = '錯誤: ' + lastErr + '\n\n可再按一次「送出」重試。';
            out.classList.add('err');
          }
        }
      }
      sendBtn.disabled = false;
    }

    async function logout() {
      try {
        await fetch(url + '/auth/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Session-Token': token },
          body: JSON.stringify({ session_token: token })
        });
      } catch (_) {}
      localStorage.removeItem('session_token');
      localStorage.removeItem('user_id');
      window.location.href = url + '/login';
    }
  </script>
</body>
</html>
