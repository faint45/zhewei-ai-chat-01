# -*- coding: utf-8 -*-
"""
è‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬ - ä¸€éµéƒ¨ç½²æ–°æœå‹™
åªéœ€åœ¨ services.json æ·»åŠ æ–°æœå‹™ï¼Œé‹è¡Œæ­¤è…³æœ¬å³å¯è‡ªå‹•é…ç½®æ‰€æœ‰å…§å®¹
"""

import json
import os
from pathlib import Path

ROOT = Path(__file__).resolve().parent.parent

def load_services():
    """è¼‰å…¥æœå‹™é…ç½®"""
    services_file = ROOT / "services.json"
    with open(services_file, 'r', encoding='utf-8') as f:
        return json.load(f)['services']

def generate_nginx_config(services):
    """ç”Ÿæˆ Nginx é…ç½®"""
    config = """# Auto-generated Nginx Configuration
# Generated by auto_deploy.py - DO NOT EDIT MANUALLY
# Edit services.json and run: python scripts/auto_deploy.py

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥èªŒæ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # WebSocket æ”¯æ´
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

"""

    # ç‚ºæ¯å€‹æœå‹™ç”Ÿæˆ server block
    for service in services:
        if not service.get('enabled', True):
            continue
        
        subdomain = service['subdomain']
        domain = service['domain']
        target = service['target']
        
        if subdomain:
            server_name = f"{subdomain}.{domain}"
        else:
            server_name = f"{domain} www.{domain}" if service['name'] == 'Portal' else domain
        
        config += f"""    # {service['name']} - {service['description']}
    server {{
        listen 80;
        server_name {server_name};

        location / {{
            proxy_pass http://{target};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket æ”¯æ´
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # è¶…æ™‚è¨­å®š
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }}
    }}

"""

    config += "}\n"
    return config

def generate_cloudflare_config(services):
    """ç”Ÿæˆ Cloudflare Tunnel é…ç½®èªªæ˜"""
    config = {
        "ingress": []
    }
    
    for service in services:
        if not service.get('enabled', True):
            continue
        
        subdomain = service['subdomain']
        domain = service['domain']
        
        if subdomain:
            hostname = f"{subdomain}.{domain}"
        else:
            hostname = domain
        
        config["ingress"].append({
            "hostname": hostname,
            "service": "http://gateway:80",
            "originRequest": {}
        })
    
    # æ·»åŠ é»˜èªè·¯ç”±
    config["ingress"].append({
        "service": "http://gateway:80"
    })
    
    config["warp-routing"] = {"enabled": False}
    
    return config

def generate_portal_config(services):
    """ç”Ÿæˆ Portal æœå‹™é…ç½®"""
    portal_services = {}
    
    for service in services:
        if not service.get('enabled', True) or service['name'] in ['Portal', 'Portal WWW']:
            continue
        
        subdomain = service['subdomain']
        domain = service['domain']
        
        service_id = subdomain if subdomain else 'main'
        
        portal_services[service_id] = {
            "name": service['name'],
            "url": f"https://{subdomain}.{domain}" if subdomain else f"https://{domain}",
            "health": f"https://{subdomain}.{domain}/health" if subdomain else f"https://{domain}/health",
            "local": f"http://localhost:{service['port']}/health",
            "icon": subdomain or "home",
            "color": "blue",
            "description": service['description']
        }
    
    return portal_services

def main():
    print("ğŸš€ è‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬\n")
    
    # 1. è¼‰å…¥æœå‹™é…ç½®
    print("ğŸ“‹ è¼‰å…¥æœå‹™é…ç½®...")
    services = load_services()
    enabled_services = [s for s in services if s.get('enabled', True)]
    print(f"âœ… æ‰¾åˆ° {len(enabled_services)} å€‹å•Ÿç”¨çš„æœå‹™\n")
    
    # 2. ç”Ÿæˆ Nginx é…ç½®
    print("ğŸ”§ ç”Ÿæˆ Nginx é…ç½®...")
    nginx_config = generate_nginx_config(services)
    nginx_file = ROOT / "gateway" / "nginx.conf"
    nginx_file.write_text(nginx_config, encoding='utf-8')
    print(f"âœ… å·²ç”Ÿæˆ: {nginx_file}\n")
    
    # 3. ç”Ÿæˆ Cloudflare é…ç½®èªªæ˜
    print("â˜ï¸  ç”Ÿæˆ Cloudflare Tunnel é…ç½®...")
    cf_config = generate_cloudflare_config(services)
    cf_file = ROOT / "cloudflare_tunnel_config.json"
    cf_file.write_text(json.dumps(cf_config, indent=2, ensure_ascii=False), encoding='utf-8')
    print(f"âœ… å·²ç”Ÿæˆ: {cf_file}\n")
    
    # 4. ç”Ÿæˆ Portal é…ç½®
    print("ğŸŒ ç”Ÿæˆ Portal æœå‹™é…ç½®...")
    portal_config = generate_portal_config(services)
    portal_file = ROOT / "portal" / "services_config.json"
    portal_file.write_text(json.dumps(portal_config, indent=2, ensure_ascii=False), encoding='utf-8')
    print(f"âœ… å·²ç”Ÿæˆ: {portal_file}\n")
    
    # 5. é¡¯ç¤ºéœ€è¦åœ¨ Cloudflare æ·»åŠ çš„åŸŸå
    print("=" * 60)
    print("ğŸ“ éœ€è¦åœ¨ Cloudflare Zero Trust æ·»åŠ çš„åŸŸå:")
    print("=" * 60)
    for service in enabled_services:
        subdomain = service['subdomain']
        domain = service['domain']
        hostname = f"{subdomain}.{domain}" if subdomain else domain
        print(f"  âœ… {hostname:30} â†’ gateway:80")
    print("=" * 60)
    
    print("\nğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ:")
    print("  1. é‡å•Ÿ Gateway: docker compose restart gateway")
    print("  2. åœ¨ Cloudflare Zero Trust æ·»åŠ ä¸Šè¿°åŸŸå")
    print("  3. æˆ–é‹è¡Œ: python scripts/sync_cloudflare.py (éœ€è¦ API Token)")
    print("\nâœ¨ å®Œæˆï¼")

if __name__ == "__main__":
    main()
