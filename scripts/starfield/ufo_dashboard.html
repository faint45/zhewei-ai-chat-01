<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UFO Detector â€” Tapo C230</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background: #050510; color: #d0d0e8; font-family: system-ui, sans-serif; }
  .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.06); }
  .tab-btn.active { background: linear-gradient(135deg, #dc2626, #991b1b); color: #fff; }
  .tab-btn:hover:not(.active) { background: rgba(255,255,255,0.08); }
  .glow-red { box-shadow: 0 0 20px rgba(220,38,38,0.3); }
  .glow-green { box-shadow: 0 0 15px rgba(34,197,94,0.3); }
  .slider-track { -webkit-appearance: none; appearance: none; height: 6px; border-radius: 3px; background: #222; outline: none; }
  .slider-track::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #dc2626; cursor: pointer; }
  .cls-airplane { color: #fbbf24; }
  .cls-satellite { color: #9ca3af; }
  .cls-meteor { color: #f97316; }
  .cls-drone { color: #c084fc; }
  .cls-ufo { color: #ef4444; font-weight: bold; }
  .cls-unknown { color: #6b7280; }
  .event-card { transition: all 0.2s; cursor: pointer; }
  .event-card:hover { background: rgba(255,255,255,0.08); transform: translateX(4px); }
  .pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
  .fade-in { animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  select, input[type="number"], input[type="text"] { background: #0f0f1f; border: 1px solid #333; color: #d0d0e8; border-radius: 6px; padding: 6px 10px; }
</style>
</head>
<body class="min-h-screen">

<!-- Header -->
<header class="glass sticky top-0 z-50 px-6 py-3 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <span class="text-2xl">ğŸ›¸</span>
    <h1 class="text-lg font-bold bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">
      UFO Detector â€” Tapo C230
    </h1>
  </div>
  <div class="flex items-center gap-4 text-sm">
    <span id="detectDot" class="w-2.5 h-2.5 rounded-full bg-gray-600 inline-block"></span>
    <span id="detectStatus" class="text-gray-400">å¾…æ©Ÿ</span>
    <span id="fpsText" class="text-gray-500">-- FPS</span>
    <span id="eventCount" class="text-gray-500">0 events</span>
  </div>
</header>

<!-- Tabs -->
<nav class="flex gap-2 px-6 py-3 overflow-x-auto">
  <button class="tab-btn active px-4 py-2 rounded-lg text-sm font-medium" data-tab="live" title="å³æ™‚åµæ¸¬">ğŸ”´ å³æ™‚åµæ¸¬</button>
  <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium" data-tab="events" title="äº‹ä»¶è¨˜éŒ„">ğŸ“‹ äº‹ä»¶è¨˜éŒ„</button>
  <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium" data-tab="stats" title="çµ±è¨ˆåˆ†æ">ğŸ“Š çµ±è¨ˆ</button>
  <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium" data-tab="settings" title="è¨­å®š">âš™ï¸ è¨­å®š</button>
</nav>

<main class="px-6 pb-8">

<!-- ==================== å³æ™‚åµæ¸¬ ==================== -->
<section id="tab-live" class="tab-content fade-in">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
    <!-- ä¸²æµç•«é¢ -->
    <div class="lg:col-span-3">
      <div class="glass rounded-xl p-3">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <span id="liveDot" class="w-3 h-3 rounded-full bg-gray-600 inline-block"></span>
            <span class="text-sm font-medium">å³æ™‚åµæ¸¬ç•«é¢</span>
          </div>
          <div class="flex gap-2">
            <button onclick="toggleDetection()" id="btnDetect" class="px-4 py-1.5 rounded-lg text-sm font-medium bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600">
              â–¶ é–‹å§‹åµæ¸¬
            </button>
          </div>
        </div>
        <img id="streamImg" alt="UFO Detection Stream" class="w-full rounded-lg bg-black" style="min-height:400px"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='640' height='480'%3E%3Crect fill='%23050510' width='640' height='480'/%3E%3Ctext x='50%25' y='45%25' text-anchor='middle' fill='%23333' font-size='24'%3EğŸ›¸%3C/text%3E%3Ctext x='50%25' y='55%25' text-anchor='middle' fill='%23444' font-size='16'%3Eç­‰å¾…åµæ¸¬å•Ÿå‹•...%3C/text%3E%3C/svg%3E">
      </div>
    </div>

    <!-- å³å´é¢æ¿ -->
    <div class="space-y-3">
      <!-- åµæ¸¬çµ±è¨ˆ -->
      <div class="glass rounded-xl p-3">
        <h3 class="text-sm font-semibold mb-2 text-red-400">ğŸ“¡ åµæ¸¬ç‹€æ…‹</h3>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="bg-red-900/20 rounded-lg p-2 text-center">
            <div class="text-gray-400">åµæ¸¬æ•¸</div>
            <div id="statDetections" class="text-lg font-bold text-red-300">0</div>
          </div>
          <div class="bg-orange-900/20 rounded-lg p-2 text-center">
            <div class="text-gray-400">è¿½è¹¤ä¸­</div>
            <div id="statTracks" class="text-lg font-bold text-orange-300">0</div>
          </div>
          <div class="bg-yellow-900/20 rounded-lg p-2 text-center">
            <div class="text-gray-400">äº‹ä»¶</div>
            <div id="statEvents" class="text-lg font-bold text-yellow-300">0</div>
          </div>
          <div class="bg-purple-900/20 rounded-lg p-2 text-center">
            <div class="text-gray-400">UFO</div>
            <div id="statUFO" class="text-lg font-bold text-purple-300">0</div>
          </div>
        </div>
        <div class="mt-2 text-xs text-gray-500">
          <span>æ˜Ÿé»é®ç½©: </span><span id="starMaskStatus" class="text-gray-400">--</span>
        </div>
      </div>

      <!-- éˆæ•åº¦ -->
      <div class="glass rounded-xl p-3">
        <h3 class="text-sm font-semibold mb-2">ğŸšï¸ éˆæ•åº¦</h3>
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-500">ä½</span>
          <input type="range" class="slider-track flex-1" min="0" max="100" value="50" id="sensitivitySlider" title="åµæ¸¬éˆæ•åº¦"
                 oninput="document.getElementById('sensVal').textContent=this.value+'%'; debounceSensitivity(this.value/100)">
          <span class="text-xs text-gray-500">é«˜</span>
        </div>
        <div class="text-center text-xs text-gray-400 mt-1"><span id="sensVal">50%</span></div>
      </div>

      <!-- å½±åƒæ¨¡å¼ -->
      <div class="glass rounded-xl p-3">
        <h3 class="text-sm font-semibold mb-2">ğŸ“· å½±åƒæ¨¡å¼</h3>
        <div class="grid grid-cols-3 gap-1 mb-1">
          <button onclick="setPreset('auto')" id="preAuto" class="px-2 py-1.5 rounded text-xs font-medium bg-red-900/60 border border-red-700" title="è‡ªå‹•åµæ¸¬">ğŸ”„ è‡ªå‹•</button>
          <button onclick="setPreset('daytime')" id="preDaytime" class="px-2 py-1.5 rounded text-xs font-medium bg-gray-800" title="ç™½å¤©æ¨¡å¼">â˜€ï¸ ç™½å¤©</button>
          <button onclick="setPreset('night_sky')" id="preNight" class="px-2 py-1.5 rounded text-xs font-medium bg-gray-800" title="å¤œç©ºå„ªåŒ–">ğŸŒ™ å¤œç©º</button>
        </div>
        <div class="grid grid-cols-3 gap-1 mb-1">
          <button onclick="setPreset('starfield')" id="preStarfield" class="px-2 py-1.5 rounded text-xs font-medium bg-gray-800" title="æ˜Ÿç©ºæ”å½±">â­ æ˜Ÿç©º</button>
          <button onclick="setPreset('ai_enhanced')" id="preAI" class="px-2 py-1.5 rounded text-xs font-medium bg-gray-800" title="æ¼¸é€²å¢å¼·ï¼ˆç–ŠåŠ +AIï¼‰">ï¿½ æ¼¸é€²</button>
          <button onclick="setPreset('raw')" id="preRaw" class="px-2 py-1.5 rounded text-xs font-medium bg-gray-800" title="åŸå§‹ç•«é¢">ğŸ“¹ åŸå§‹</button>
        </div>
        <div class="text-xs text-gray-500 mt-1.5" id="presetDesc">è‡ªå‹•åµæ¸¬äº®åº¦é¸æ“‡æœ€ä½³æ¨¡å¼</div>
        <div class="text-xs text-gray-600 mt-0.5 hidden" id="progressiveInfo">
          <div class="flex items-center gap-2 mb-0.5">
            <span>è¼ªæ¬¡: <b id="progRound">0</b></span>
            <span>ç•«è³ª: <b id="progQuality" class="text-green-400">0</b>/100</span>
          </div>
          <div class="w-full bg-gray-800 rounded-full h-1.5">
            <div id="progBar" class="bg-gradient-to-r from-blue-500 to-green-400 h-1.5 rounded-full transition-all" style="width:0%"></div>
          </div>
          <div class="text-gray-700 mt-0.5">æ”¶é›†ä¸­: <span id="progBuffer">0</span>/16</div>
        </div>
      </div>

      <!-- å³æ™‚äº‹ä»¶ -->
      <div class="glass rounded-xl p-3">
        <h3 class="text-sm font-semibold mb-2 text-yellow-400">âš¡ æœ€æ–°äº‹ä»¶</h3>
        <div id="liveEvents" class="space-y-1 max-h-48 overflow-y-auto text-xs">
          <p class="text-gray-600">ç­‰å¾…åµæ¸¬...</p>
        </div>
      </div>

      <!-- å‘Šè­¦ -->
      <div class="glass rounded-xl p-3">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold">ğŸ”” å‘Šè­¦</h3>
          <label class="flex items-center gap-1 cursor-pointer">
            <input type="checkbox" id="alertToggle" checked class="accent-red-500" title="å‘Šè­¦é–‹é—œ"
                   onchange="setAlert(this.checked)">
            <span class="text-xs">å•Ÿç”¨</span>
          </label>
        </div>
        <div id="alertBanner" class="hidden mt-2 bg-red-900/40 border border-red-800 rounded-lg p-2 text-xs text-red-300 glow-red">
          <span class="pulse">ğŸ›¸</span> <span id="alertText">åµæ¸¬åˆ°ä¸æ˜é£›è¡Œç‰©ï¼</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ==================== äº‹ä»¶è¨˜éŒ„ ==================== -->
<section id="tab-events" class="tab-content hidden fade-in">
  <div class="glass rounded-xl p-4">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-semibold text-lg">ğŸ“‹ äº‹ä»¶è¨˜éŒ„</h2>
      <div class="flex gap-2">
        <select id="filterClass" title="åˆ†é¡ç¯©é¸" class="text-sm" onchange="loadEvents()">
          <option value="">å…¨éƒ¨åˆ†é¡</option>
          <option value="ufo">ğŸ›¸ UFO</option>
          <option value="airplane">âœˆï¸ é£›æ©Ÿ</option>
          <option value="satellite">ğŸ›°ï¸ è¡›æ˜Ÿ</option>
          <option value="meteor">â˜„ï¸ æµæ˜Ÿ</option>
          <option value="drone">ğŸ¤– ç„¡äººæ©Ÿ</option>
        </select>
        <button onclick="loadEvents()" class="px-3 py-1 rounded-lg text-sm bg-gray-800 hover:bg-gray-700">ğŸ”„</button>
      </div>
    </div>
    <div id="eventList" class="space-y-2 max-h-[600px] overflow-y-auto">
      <p class="text-gray-500 text-sm">è¼‰å…¥ä¸­...</p>
    </div>
  </div>

  <!-- äº‹ä»¶è©³æƒ… Modal -->
  <div id="eventModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70" onclick="if(event.target===this)closeModal()">
    <div class="glass rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modalTitle" class="font-bold text-lg text-red-400">äº‹ä»¶è©³æƒ…</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>
      <div id="modalContent" class="space-y-4"></div>
    </div>
  </div>
</section>

<!-- ==================== çµ±è¨ˆ ==================== -->
<section id="tab-stats" class="tab-content hidden fade-in">
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <div class="glass rounded-xl p-4">
      <h3 class="font-semibold mb-3">ğŸ·ï¸ åˆ†é¡çµ±è¨ˆ</h3>
      <div id="classStats" class="space-y-2">
        <p class="text-gray-500 text-sm">è¼‰å…¥ä¸­...</p>
      </div>
    </div>
    <div class="glass rounded-xl p-4">
      <h3 class="font-semibold mb-3">ğŸ“ˆ åµæ¸¬æ¦‚è¦½</h3>
      <div id="overviewStats" class="space-y-2 text-sm">
        <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
      </div>
    </div>
    <div class="glass rounded-xl p-4">
      <h3 class="font-semibold mb-3">ğŸ• æœ€è¿‘æ´»å‹•</h3>
      <div id="recentActivity" class="space-y-1 text-xs max-h-64 overflow-y-auto">
        <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
      </div>
    </div>
  </div>
</section>

<!-- ==================== è¨­å®š ==================== -->
<section id="tab-settings" class="tab-content hidden fade-in">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="glass rounded-xl p-4">
      <h2 class="font-semibold mb-4">ğŸ“¡ æ”å½±æ©Ÿé€£ç·š</h2>
      <div class="space-y-3">
        <div>
          <label for="rtspUrl" class="text-sm text-gray-400">æ”å½±æ©Ÿ URLï¼ˆRTSP / HTTP / æœ¬æ©Ÿï¼‰</label>
          <input type="text" id="rtspUrl" placeholder="rtsp://å¸³è™Ÿ:å¯†ç¢¼@IP:554/stream1"
                 class="w-full mt-1 text-sm">
        </div>
        <div class="text-xs text-gray-600 mb-1">å¿«é€Ÿé¸æ“‡ï¼š</div>
        <div class="grid grid-cols-2 gap-1.5 mb-2">
          <button onclick="window.open('/cam','_blank')"
                  class="px-2 py-1.5 rounded text-xs bg-red-900/60 border border-red-700 hover:bg-red-800/60 text-left col-span-2" title="iPhone é–‹å•Ÿæ­¤ç¶²å€å³å¯ä¸²æµ">ğŸ“± iPhone PWAï¼ˆæ¨è–¦ï¼‰â†’ /cam</button>
          <button onclick="document.getElementById('rtspUrl').value='rtsp://admin:password@192.168.1.x:554/stream1';document.getElementById('rtspUrl').focus()"
                  class="px-2 py-1.5 rounded text-xs bg-gray-800 hover:bg-gray-700 text-left" title="Tapo C230">ğŸ“¹ Tapo C230</button>
          <button onclick="document.getElementById('rtspUrl').value='0';document.getElementById('rtspUrl').focus()"
                  class="px-2 py-1.5 rounded text-xs bg-gray-800 hover:bg-gray-700 text-left" title="æœ¬æ©Ÿæ”å½±æ©Ÿ">ğŸ’» æœ¬æ©Ÿé¡é ­</button>
        </div>
        <div class="flex gap-2">
          <button onclick="connectCam()" class="px-4 py-2 rounded-lg text-sm font-medium bg-green-700 hover:bg-green-600 flex-1">ğŸ”— é€£ç·š</button>
          <button onclick="disconnectCam()" class="px-4 py-2 rounded-lg text-sm bg-gray-700 hover:bg-gray-600">æ–·ç·š</button>
        </div>
        <div id="connMsg" class="text-sm"></div>
        <div id="sourceInfo" class="text-xs text-gray-600 hidden">
          ä¾†æº: <span id="sourceType" class="text-gray-400">-</span> |
          è§£æåº¦: <span id="sourceRes" class="text-gray-400">-</span>
        </div>
      </div>
    </div>
    <div class="glass rounded-xl p-4">
      <h2 class="font-semibold mb-4">ğŸ›ï¸ å½±åƒå‰è™•ç†</h2>
      <p class="text-xs text-gray-500 mb-3">å¯é¸ï¼šåµæ¸¬å‰å…ˆå¥—ç”¨è™›æ“¬åƒæ•¸å¢å¼·å½±åƒ</p>
      <label class="flex items-center gap-2 cursor-pointer mb-3">
        <input type="checkbox" id="useParamsToggle" class="accent-red-500" title="å•Ÿç”¨å½±åƒå‰è™•ç†"
               onchange="sendParams({use_params:this.checked})">
        <span class="text-sm">å•Ÿç”¨å½±åƒå‰è™•ç†</span>
      </label>
      <div class="space-y-2">
        <div>
          <label class="text-xs text-gray-400 flex justify-between"><span>äº®åº¦</span><span id="pBright">0</span></label>
          <input type="range" class="slider-track w-full" min="-100" max="100" value="0" title="äº®åº¦"
                 oninput="document.getElementById('pBright').textContent=this.value; sendParams({brightness:+this.value})">
        </div>
        <div>
          <label class="text-xs text-gray-400 flex justify-between"><span>ä¼½ç‘ª</span><span id="pGamma">1.0</span></label>
          <input type="range" class="slider-track w-full" min="50" max="200" value="100" title="ä¼½ç‘ª"
                 oninput="let v=0.5+(this.value-50)/100; document.getElementById('pGamma').textContent=v.toFixed(1); sendParams({gamma:v})">
        </div>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" class="accent-red-500" title="CLAHE" onchange="sendParams({clahe:this.checked})">
          <span class="text-xs">CLAHE è‡ªé©æ‡‰å°æ¯”</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" class="accent-red-500" title="é™å™ª" onchange="sendParams({denoise:this.checked})">
          <span class="text-xs">é™å™ª</span>
        </label>
      </div>
    </div>
    <div class="glass rounded-xl p-4">
      <h2 class="font-semibold mb-4">ğŸ”” å‘Šè­¦è¨­å®š</h2>
      <div class="space-y-2 text-sm">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" checked class="accent-red-500" title="ç€è¦½å™¨é€šçŸ¥"
                 onchange="if(this.checked)Notification.requestPermission()">
          <span>ç€è¦½å™¨é€šçŸ¥</span>
        </label>
        <p class="text-xs text-gray-500">Ntfy æ¨æ’­ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸ NTFY_SERVER + NTFY_UFO_TOPIC</p>
      </div>
    </div>
    <div class="glass rounded-xl p-4">
      <h2 class="font-semibold mb-4">â„¹ï¸ ç³»çµ±è³‡è¨Š</h2>
      <div class="text-sm text-gray-400 space-y-1">
        <p>ç‰ˆæœ¬ï¼š1.0.0</p>
        <p>å¼•æ“ï¼šèƒŒæ™¯å·®åˆ†(MOG2) + æ˜Ÿé»é®ç½© + å¤šç‰©é«”è¿½è¹¤</p>
        <p>åˆ†é¡ï¼šé£›æ©Ÿ / è¡›æ˜Ÿ / æµæ˜Ÿ / ç„¡äººæ©Ÿ / UFO</p>
        <p>Portï¼š8035</p>
      </div>
    </div>
  </div>
</section>

</main>

<script>
const API = location.origin;
let ws = null;
let detecting = false;
let sensTimer = null;

// --- Tabs ---
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
    const t = document.getElementById('tab-' + btn.dataset.tab);
    if (t) { t.classList.remove('hidden'); }
    if (btn.dataset.tab === 'events') loadEvents();
    if (btn.dataset.tab === 'stats') loadStats();
  });
});

// --- Detection ---
async function toggleDetection() {
  if (detecting) {
    await fetch(API + '/api/detect/stop', { method: 'POST' });
    if (ws) ws.close();
    detecting = false;
    document.getElementById('btnDetect').textContent = 'â–¶ é–‹å§‹åµæ¸¬';
    document.getElementById('detectDot').className = 'w-2.5 h-2.5 rounded-full bg-gray-600 inline-block';
    document.getElementById('detectStatus').textContent = 'å·²åœæ­¢';
    document.getElementById('liveDot').className = 'w-3 h-3 rounded-full bg-gray-600 inline-block';
  } else {
    const r = await fetch(API + '/api/detect/start', { method: 'POST' });
    const d = await r.json();
    if (d.error) { alert(d.error); return; }
    detecting = true;
    document.getElementById('btnDetect').textContent = 'â¹ åœæ­¢åµæ¸¬';
    document.getElementById('detectDot').className = 'w-2.5 h-2.5 rounded-full bg-red-500 inline-block pulse';
    document.getElementById('detectStatus').textContent = 'åµæ¸¬ä¸­';
    document.getElementById('liveDot').className = 'w-3 h-3 rounded-full bg-red-500 inline-block pulse';
    startWS();
  }
}

function startWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws/detect');
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'frame') {
      document.getElementById('streamImg').src = 'data:image/jpeg;base64,' + msg.data;
      document.getElementById('fpsText').textContent = msg.fps + ' FPS';
      // Stats
      const s = msg.stats || {};
      document.getElementById('statDetections').textContent = s.total_frames || 0;
      document.getElementById('statTracks').textContent = s.confirmed_tracks || 0;
      document.getElementById('statEvents').textContent = s.total_events || 0;
      document.getElementById('statUFO').textContent = (s.classification_counts || {}).ufo || 0;
      document.getElementById('eventCount').textContent = (s.total_events || 0) + ' events';
      document.getElementById('starMaskStatus').textContent = s.star_mask_ready ? 'âœ… Ready' : 'å»ºç«‹ä¸­...';
      // Progressive info
      if (msg.progressive && msg.preset === 'ai_enhanced') {
        const p = msg.progressive;
        document.getElementById('progRound').textContent = p.round;
        document.getElementById('progQuality').textContent = p.quality_score;
        document.getElementById('progBuffer').textContent = p.buffer + '/' + p.buffer_max;
        const pct = Math.round((p.buffer / p.buffer_max) * 100);
        document.getElementById('progBar').style.width = pct + '%';
        // ç•«è³ªåˆ†æ•¸é¡è‰²
        const qEl = document.getElementById('progQuality');
        if (p.quality_score >= 70) qEl.className = 'text-green-400';
        else if (p.quality_score >= 40) qEl.className = 'text-yellow-400';
        else qEl.className = 'text-red-400';
      }
      // New events
      if (msg.new_events && msg.new_events.length > 0) {
        msg.new_events.forEach(ev => addLiveEvent(ev));
      }
    }
  };
  ws.onclose = () => {
    if (detecting) setTimeout(startWS, 2000);
  };
}

function addLiveEvent(ev) {
  const el = document.getElementById('liveEvents');
  if (el.querySelector('.text-gray-600')) el.innerHTML = '';
  const icons = { airplane: 'âœˆï¸', satellite: 'ğŸ›°ï¸', meteor: 'â˜„ï¸', drone: 'ğŸ¤–', ufo: 'ğŸ›¸', unknown: 'â“' };
  const icon = icons[ev.classification] || 'â“';
  const cls = 'cls-' + ev.classification;
  const html = `<div class="bg-gray-900/50 rounded px-2 py-1 flex justify-between items-center">
    <span class="${cls}">${icon} ${ev.classification} <span class="text-gray-500">${(ev.confidence*100).toFixed(0)}%</span></span>
    <span class="text-gray-500">${ev.duration_sec}s</span>
  </div>`;
  el.insertAdjacentHTML('afterbegin', html);
  // ä¿ç•™æœ€è¿‘ 20 æ¢
  while (el.children.length > 20) el.removeChild(el.lastChild);
  // å‘Šè­¦
  if (ev.classification === 'ufo') showAlert(ev);
}

function showAlert(ev) {
  const banner = document.getElementById('alertBanner');
  document.getElementById('alertText').textContent =
    `åµæ¸¬åˆ°ä¸æ˜é£›è¡Œç‰©ï¼ä¿¡å¿ƒåº¦ ${(ev.confidence*100).toFixed(0)}% é€Ÿåº¦ ${ev.avg_speed?.toFixed(0) || '?'}px/s`;
  banner.classList.remove('hidden');
  setTimeout(() => banner.classList.add('hidden'), 10000);
  // ç€è¦½å™¨é€šçŸ¥
  if (Notification.permission === 'granted') {
    new Notification('ğŸ›¸ UFO åµæ¸¬å‘Šè­¦', {
      body: `åˆ†é¡: ${ev.classification} (${(ev.confidence*100).toFixed(0)}%)`,
      icon: 'ğŸ›¸'
    });
  }
}

// --- Sensitivity ---
function debounceSensitivity(val) {
  clearTimeout(sensTimer);
  sensTimer = setTimeout(() => {
    fetch(API + '/api/sensitivity?value=' + val, { method: 'POST' });
  }, 300);
}

// --- Params ---
function sendParams(data) {
  fetch(API + '/api/params', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
}

// --- Alert ---
function setAlert(enabled) {
  fetch(API + '/api/alert?enabled=' + enabled, { method: 'POST' });
}

// --- Camera ---
async function connectCam() {
  const url = document.getElementById('rtspUrl').value.trim();
  if (!url) return;
  const r = await fetch(API + '/api/connect?url=' + encodeURIComponent(url), { method: 'POST' });
  const d = await r.json();
  document.getElementById('connMsg').innerHTML = d.success
    ? '<span class="text-green-400">âœ… é€£ç·šæˆåŠŸ</span>'
    : '<span class="text-red-400">âŒ é€£ç·šå¤±æ•—</span>';
  if (d.success) {
    // å–å¾—ä¾†æºè³‡è¨Š
    const st = await fetch(API + '/api/status').then(r => r.json());
    const typeNames = { rtsp: 'ğŸ“¹ RTSP', http: 'ğŸ“± HTTP/iPhone', local: 'ğŸ’» æœ¬æ©Ÿé¡é ­' };
    document.getElementById('sourceType').textContent = typeNames[st.source_type] || st.source_type;
    document.getElementById('sourceRes').textContent = st.source_resolution || '-';
    document.getElementById('sourceInfo').classList.remove('hidden');
  }
}
async function disconnectCam() {
  await fetch(API + '/api/disconnect', { method: 'POST' });
  document.getElementById('connMsg').innerHTML = '<span class="text-gray-400">å·²æ–·ç·š</span>';
  if (detecting) toggleDetection();
}

// --- Events ---
async function loadEvents() {
  const cls = document.getElementById('filterClass').value;
  const r = await fetch(API + '/api/history?limit=100');
  const d = await r.json();
  let events = d.events || [];
  if (cls) events = events.filter(e => e.classification === cls);
  const el = document.getElementById('eventList');
  if (events.length === 0) {
    el.innerHTML = '<p class="text-gray-500 text-sm">å°šç„¡äº‹ä»¶è¨˜éŒ„</p>';
    return;
  }
  const icons = { airplane: 'âœˆï¸', satellite: 'ğŸ›°ï¸', meteor: 'â˜„ï¸', drone: 'ğŸ¤–', ufo: 'ğŸ›¸', unknown: 'â“' };
  el.innerHTML = events.map(e => `
    <div class="event-card glass rounded-lg px-4 py-3 flex items-center justify-between" onclick="showEvent('${e.event_id}')">
      <div class="flex items-center gap-3">
        <span class="text-xl">${icons[e.classification] || 'â“'}</span>
        <div>
          <span class="cls-${e.classification} font-medium">${e.classification}</span>
          <span class="text-gray-500 text-xs ml-2">${(e.confidence*100).toFixed(0)}%</span>
          <div class="text-xs text-gray-500">${e.start_time || ''}</div>
        </div>
      </div>
      <div class="text-right text-xs text-gray-400">
        <div>${e.duration_sec}s</div>
        <div>${e.avg_speed?.toFixed(0) || '?'} px/s</div>
        <div>${e.is_flashing ? 'ğŸ’¡é–ƒçˆ' : ''}</div>
      </div>
    </div>
  `).join('');
}

async function showEvent(eventId) {
  const r = await fetch(API + '/api/events/' + eventId);
  if (!r.ok) return;
  const e = await r.json();
  document.getElementById('modalTitle').textContent = `${e.classification} â€” ${e.event_id}`;
  const icons = { airplane: 'âœˆï¸', satellite: 'ğŸ›°ï¸', meteor: 'â˜„ï¸', drone: 'ğŸ¤–', ufo: 'ğŸ›¸', unknown: 'â“' };
  document.getElementById('modalContent').innerHTML = `
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="bg-gray-900/50 rounded-lg p-3">
        <div class="text-gray-400 text-xs">åˆ†é¡</div>
        <div class="cls-${e.classification} text-lg">${icons[e.classification]||''} ${e.classification} (${(e.confidence*100).toFixed(0)}%)</div>
      </div>
      <div class="bg-gray-900/50 rounded-lg p-3">
        <div class="text-gray-400 text-xs">æŒçºŒæ™‚é–“</div>
        <div class="text-lg">${e.duration_sec}s</div>
      </div>
      <div class="bg-gray-900/50 rounded-lg p-3">
        <div class="text-gray-400 text-xs">å¹³å‡é€Ÿåº¦</div>
        <div>${e.avg_speed} px/s</div>
      </div>
      <div class="bg-gray-900/50 rounded-lg p-3">
        <div class="text-gray-400 text-xs">æœ€å¤§é€Ÿåº¦</div>
        <div>${e.max_speed} px/s</div>
      </div>
      <div class="bg-gray-900/50 rounded-lg p-3">
        <div class="text-gray-400 text-xs">è»Œè·¡é»æ•¸</div>
        <div>${e.trajectory_points}</div>
      </div>
      <div class="bg-gray-900/50 rounded-lg p-3">
        <div class="text-gray-400 text-xs">è»Œè·¡é•·åº¦</div>
        <div>${e.trajectory_length_px} px</div>
      </div>
      <div class="bg-gray-900/50 rounded-lg p-3">
        <div class="text-gray-400 text-xs">å¹³å‡äº®åº¦</div>
        <div>${e.avg_brightness}</div>
      </div>
      <div class="bg-gray-900/50 rounded-lg p-3">
        <div class="text-gray-400 text-xs">é–ƒçˆ</div>
        <div>${e.is_flashing ? 'æ˜¯ ('+e.flash_frequency+'Hz)' : 'å¦'}</div>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-3 mt-3">
      <div>
        <p class="text-xs text-gray-400 mb-1">æˆªåœ–</p>
        <img src="${API}/api/events/${e.event_id}/screenshot" alt="Event screenshot" class="w-full rounded-lg bg-black" onerror="this.style.display='none'">
      </div>
      <div>
        <p class="text-xs text-gray-400 mb-1">è»Œè·¡åœ–</p>
        <img src="${API}/api/events/${e.event_id}/trail" alt="Event trail" class="w-full rounded-lg bg-black" onerror="this.style.display='none'">
      </div>
    </div>
    <div class="text-xs text-gray-500 mt-2">
      <p>é–‹å§‹: ${e.start_time}</p>
      <p>çµæŸ: ${e.end_time}</p>
    </div>
  `;
  document.getElementById('eventModal').classList.remove('hidden');
}
function closeModal() { document.getElementById('eventModal').classList.add('hidden'); }

// --- Stats ---
async function loadStats() {
  const r = await fetch(API + '/api/stats');
  const s = await r.json();
  // åˆ†é¡çµ±è¨ˆ
  const cc = s.classification_counts || {};
  const icons = { airplane: 'âœˆï¸', satellite: 'ğŸ›°ï¸', meteor: 'â˜„ï¸', drone: 'ğŸ¤–', ufo: 'ğŸ›¸', unknown: 'â“' };
  const classEl = document.getElementById('classStats');
  if (Object.keys(cc).length === 0) {
    classEl.innerHTML = '<p class="text-gray-500 text-sm">å°šç„¡è³‡æ–™</p>';
  } else {
    classEl.innerHTML = Object.entries(cc).sort((a,b) => b[1]-a[1]).map(([k,v]) =>
      `<div class="flex justify-between items-center bg-gray-900/50 rounded-lg px-3 py-2">
        <span class="cls-${k}">${icons[k]||''} ${k}</span>
        <span class="font-bold">${v}</span>
      </div>`
    ).join('');
  }
  // æ¦‚è¦½
  document.getElementById('overviewStats').innerHTML = `
    <div class="flex justify-between"><span class="text-gray-400">ç¸½å¹€æ•¸</span><span>${s.total_frames || 0}</span></div>
    <div class="flex justify-between"><span class="text-gray-400">ç¸½äº‹ä»¶</span><span>${s.total_events || 0}</span></div>
    <div class="flex justify-between"><span class="text-gray-400">UFO æ•¸</span><span class="text-red-400 font-bold">${s.ufo_count || 0}</span></div>
    <div class="flex justify-between"><span class="text-gray-400">å¹³å‡æŒçºŒ</span><span>${s.avg_duration || 0}s</span></div>
    <div class="flex justify-between"><span class="text-gray-400">å¹³å‡é€Ÿåº¦</span><span>${s.avg_speed || 0} px/s</span></div>
    <div class="flex justify-between"><span class="text-gray-400">æ´»èºè¿½è¹¤</span><span>${s.active_tracks || 0}</span></div>
  `;
  // æœ€è¿‘æ´»å‹•
  const hr = await fetch(API + '/api/events?limit=10');
  const hd = await hr.json();
  const actEl = document.getElementById('recentActivity');
  if ((hd.events||[]).length === 0) {
    actEl.innerHTML = '<p class="text-gray-500">å°šç„¡æ´»å‹•</p>';
  } else {
    actEl.innerHTML = (hd.events||[]).map(e =>
      `<div class="flex justify-between bg-gray-900/30 rounded px-2 py-1">
        <span class="cls-${e.classification}">${icons[e.classification]||''} ${e.classification}</span>
        <span class="text-gray-500">${e.start_time?.split('T')[1]?.substring(0,8) || ''}</span>
      </div>`
    ).join('');
  }
}

// --- Preset ---
const presetDescs = {
  auto: 'è‡ªå‹•åµæ¸¬äº®åº¦é¸æ“‡æœ€ä½³æ¨¡å¼',
  daytime: 'ç™½å¤©æ¨¡å¼ â€” é™ä½äº®åº¦é¿å…éæ›',
  night_sky: 'å¤§å…‰åœˆ + ISO 50 ä½é›œè¨Š',
  starfield: 'æœ€å¤§åŒ–æ˜Ÿé»å¯è¦‹åº¦',
  ai_enhanced: 'ï¿½ æ¼¸é€²å¢å¼· â€” æ¯16å¹€åˆä½µ+AIï¼Œç•«è³ªè¶Šä¾†è¶Šå¥½',
  raw: 'åŸå§‹ç•«é¢ï¼ˆä¸è™•ç†ï¼‰',
};
async function setPreset(name) {
  await fetch(API + '/api/preset?name=' + name, { method: 'POST' });
  ['preAuto','preDaytime','preNight','preStarfield','preAI','preRaw'].forEach(id => {
    document.getElementById(id).className = 'px-2 py-1.5 rounded text-xs font-medium bg-gray-800';
  });
  const btnMap = { auto:'preAuto', daytime:'preDaytime', night_sky:'preNight', starfield:'preStarfield', ai_enhanced:'preAI', raw:'preRaw' };
  const btn = document.getElementById(btnMap[name]);
  if (btn) btn.className = 'px-2 py-1.5 rounded text-xs font-medium bg-red-900/60 border border-red-700';
  document.getElementById('presetDesc').textContent = presetDescs[name] || '';
  document.getElementById('progressiveInfo').classList.toggle('hidden', name !== 'ai_enhanced');
}

// --- Init ---
fetch(API + '/api/status').then(r => r.json()).then(d => {
  if (d.connected) {
    document.getElementById('detectDot').className = 'w-2.5 h-2.5 rounded-full bg-yellow-500 inline-block';
    document.getElementById('detectStatus').textContent = 'å·²é€£ç·š';
  }
  if (d.detecting) {
    detecting = true;
    document.getElementById('btnDetect').textContent = 'â¹ åœæ­¢åµæ¸¬';
    document.getElementById('detectDot').className = 'w-2.5 h-2.5 rounded-full bg-red-500 inline-block pulse';
    document.getElementById('detectStatus').textContent = 'åµæ¸¬ä¸­';
    document.getElementById('liveDot').className = 'w-3 h-3 rounded-full bg-red-500 inline-block pulse';
    startWS();
  }
  if (d.preset) setPreset(d.preset);
}).catch(() => {});
</script>
</body>
</html>
