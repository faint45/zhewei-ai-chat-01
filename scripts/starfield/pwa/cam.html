<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0f">
<link rel="manifest" href="/cam/manifest.json">
<link rel="apple-touch-icon" href="/cam/icon-192.png">
<title>UFO Cam</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: #0a0a0f; color: #e5e5e5;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif;
    height: 100vh; overflow: hidden;
    display: flex; flex-direction: column;
  }
  .top-bar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 16px; background: rgba(10,10,15,0.9);
    -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    z-index: 10;
  }
  .top-bar h1 { font-size: 16px; font-weight: 700; }
  .top-bar h1 span { color: #ef4444; }
  .status { display: flex; align-items: center; gap: 6px; font-size: 12px; }
  .dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot-off { background: #555; }
  .dot-on { background: #22c55e; animation: pulse 1.5s infinite; }
  .dot-stream { background: #ef4444; animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .cam-area {
    flex: 1; position: relative; background: #000;
    display: flex; align-items: center; justify-content: center;
  }
  #preview {
    width: 100%; height: 100%; object-fit: cover;
    /* é¡åƒç”± JS æ§åˆ¶ï¼Œå¾Œé¡é ­é è¨­ä¸ç¿»è½‰ */
  }
  .cam-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
  }
  .cam-overlay .info {
    position: absolute; top: 12px; left: 12px;
    background: rgba(0,0,0,0.6); border-radius: 8px; padding: 6px 10px;
    font-size: 11px; color: #aaa;
  }
  .cam-overlay .fps-badge {
    position: absolute; top: 12px; right: 12px;
    background: rgba(0,0,0,0.6); border-radius: 8px; padding: 6px 10px;
    font-size: 13px; font-weight: 700; color: #22c55e;
  }

  .controls {
    padding: 12px 16px 20px;
    background: rgba(10,10,15,0.95);
    -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255,255,255,0.05);
  }
  .ctrl-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
  .ctrl-row:last-child { margin-bottom: 0; }

  .btn {
    flex: 1; padding: 12px; border: none; border-radius: 12px;
    font-size: 14px; font-weight: 600; cursor: pointer;
    transition: all 0.2s;
  }
  .btn-start { background: #16a34a; color: #fff; }
  .btn-start:active { background: #15803d; transform: scale(0.97); }
  .btn-stop { background: #dc2626; color: #fff; }
  .btn-stop:active { background: #b91c1c; transform: scale(0.97); }
  .btn-settings { background: #27272a; color: #ccc; flex: 0 0 48px; }
  .btn-settings:active { background: #3f3f46; }
  .btn-flip { background: #27272a; color: #ccc; flex: 0 0 48px; }

  .settings-panel {
    display: none; padding: 12px; margin-top: 8px;
    background: #18181b; border-radius: 12px;
  }
  .settings-panel.open { display: block; }
  .setting-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 13px;
  }
  .setting-item:last-child { border-bottom: none; }
  .setting-item label { color: #aaa; }
  .setting-item select, .setting-item input {
    background: #27272a; border: 1px solid #3f3f46; color: #fff;
    border-radius: 8px; padding: 6px 10px; font-size: 13px;
  }

  .stat-bar {
    display: flex; gap: 16px; font-size: 11px; color: #666;
    justify-content: center;
  }
  .stat-bar b { color: #aaa; }

  /* é€£ç·šè¨­å®šç•«é¢ */
  .setup-screen {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center; padding: 24px;
  }
  .setup-screen h2 { font-size: 24px; margin-bottom: 8px; }
  .setup-screen p { color: #888; font-size: 14px; margin-bottom: 24px; text-align: center; }
  .setup-input {
    width: 100%; max-width: 360px; padding: 14px 16px;
    background: #18181b; border: 1px solid #3f3f46; border-radius: 12px;
    color: #fff; font-size: 16px; margin-bottom: 12px; text-align: center;
  }
  .setup-input::placeholder { color: #555; }
  .setup-btn {
    width: 100%; max-width: 360px; padding: 14px;
    background: #16a34a; color: #fff; border: none; border-radius: 12px;
    font-size: 16px; font-weight: 700; cursor: pointer;
  }
  .setup-btn:active { background: #15803d; }
  .setup-hint {
    margin-top: 16px; font-size: 12px; color: #555;
    text-align: center; max-width: 360px;
  }
  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- ===== é ‚éƒ¨ç‹€æ…‹åˆ— ===== -->
<div class="top-bar">
  <h1>ğŸ›¸ <span>UFO</span> Cam</h1>
  <div class="status">
    <div class="dot dot-off" id="statusDot"></div>
    <span id="statusText">æœªé€£ç·š</span>
  </div>
</div>

<!-- ===== é€£ç·šè¨­å®šç•«é¢ ===== -->
<div class="setup-screen" id="setupScreen">
  <h2>ğŸ“¡ é€£ç·šè¨­å®š</h2>
  <p id="setupDesc">è¼¸å…¥é›»è…¦çš„ IP ä½å€ï¼ŒiPhone æ”å½±æ©Ÿç•«é¢å°‡ä¸²æµåˆ° UFO åµæ¸¬ç³»çµ±</p>
  <div id="manualInputs">
    <input type="text" class="setup-input" id="serverIp"
           placeholder="é›»è…¦ IPï¼ˆä¾‹å¦‚ 192.168.1.100ï¼‰"
           inputmode="url" autocomplete="off">
    <input type="text" class="setup-input" id="serverPort"
           placeholder="Portï¼ˆé è¨­ 8035ï¼‰" value="8035"
           inputmode="numeric">
  </div>
  <button class="setup-btn" onclick="doConnect()">ğŸ”— é€£ç·šä¸¦é–‹å§‹</button>
  <div class="setup-hint" id="setupHint">
    ç¢ºä¿ iPhone å’Œé›»è…¦åœ¨åŒä¸€å€‹ WiFi ç¶²è·¯<br>
    é›»è…¦ IP å¯åœ¨ UFO Dashboard è¨­å®šé æŸ¥çœ‹
  </div>
</div>

<!-- ===== æ”å½±æ©Ÿç•«é¢ ===== -->
<div class="cam-area hidden" id="camArea">
  <video id="preview" autoplay playsinline muted></video>
  <canvas id="captureCanvas" class="hidden"></canvas>
  <div class="cam-overlay">
    <div class="info">
      <span id="resInfo">-</span> |
      <span id="lensInfo">ä¸»é¡é ­</span>
    </div>
    <div class="fps-badge" id="fpsBadge">-- FPS</div>
  </div>
</div>

<!-- ===== åº•éƒ¨æ§åˆ¶åˆ— ===== -->
<div class="controls hidden" id="controls">
  <div class="ctrl-row">
    <button class="btn btn-start" id="btnStream" onclick="toggleStream()">â–¶ é–‹å§‹ä¸²æµ</button>
    <button class="btn btn-flip" onclick="flipCamera()">ğŸ”„</button>
    <button class="btn btn-settings" onclick="toggleSettings()">âš™ï¸</button>
  </div>

  <div class="settings-panel" id="settingsPanel">
    <div class="setting-item">
      <label>è§£æåº¦</label>
      <select id="selRes" onchange="applySettings()">
        <option value="3840x2160">4K (3840Ã—2160)</option>
        <option value="1920x1080" selected>1080p (1920Ã—1080)</option>
        <option value="1280x720">720p (1280Ã—720)</option>
        <option value="640x480">480p (640Ã—480)</option>
      </select>
    </div>
    <div class="setting-item">
      <label>ç•«è³ª (JPEG %)</label>
      <input type="range" id="qualitySlider" min="30" max="95" value="75"
             oninput="document.getElementById('qualityVal').textContent=this.value"
             onchange="applySettings()">
      <span id="qualityVal">75</span>
    </div>
    <div class="setting-item">
      <label>ç›®æ¨™ FPS</label>
      <select id="selFps" onchange="applySettings()">
        <option value="5">5 FPSï¼ˆçœé›»ï¼‰</option>
        <option value="10">10 FPS</option>
        <option value="15" selected>15 FPS</option>
        <option value="24">24 FPS</option>
        <option value="30">30 FPS</option>
      </select>
    </div>
    <div class="setting-item">
      <label>é¡åƒç¿»è½‰</label>
      <input type="checkbox" id="chkMirror" onchange="applyMirror()">
    </div>
    <div class="setting-item">
      <label>æ‰‹é›»ç­’</label>
      <input type="checkbox" id="chkTorch" onchange="toggleTorch()">
    </div>
  </div>

  <div class="stat-bar" id="statBar">
    <span>å·²å‚³é€: <b id="sentFrames">0</b> å¹€</span>
    <span>æµé‡: <b id="sentBytes">0</b> KB</span>
    <span>å»¶é²: <b id="latency">-</b> ms</span>
  </div>
</div>

<script>
// ===== å…¨åŸŸç‹€æ…‹ =====
let ws = null;
let stream = null;
let streaming = false;
let frameTimer = null;
let facingMode = 'environment'; // 'environment' = å¾Œé¡é ­, 'user' = å‰é¡é ­
let sentFrames = 0;
let sentBytes = 0;
let serverUrl = '';
let currentTrack = null;

// ===== é€£ç·šæ¨¡å¼åµæ¸¬ =====
const isExternal = location.hostname.includes('.') && !location.hostname.match(/^\d/);
// å¤–ç¶²æ¨¡å¼ï¼ˆå¦‚ ufocam.zhe-wei.netï¼‰â†’ ç›´æ¥ç”¨ç•¶å‰ host
// å…§ç¶²æ¨¡å¼ï¼ˆå¦‚ 192.168.1.100:8035ï¼‰â†’ ç”¨ç•¶å‰ host æˆ–æ‰‹å‹•è¼¸å…¥

function doConnect() {
  if (isExternal) {
    // å¤–ç¶²ï¼šç›´æ¥ç”¨ç•¶å‰åŸŸå
    serverUrl = location.host;
  } else {
    const ip = document.getElementById('serverIp').value.trim();
    const port = document.getElementById('serverPort').value.trim() || '8035';
    if (!ip) {
      // å¦‚æœæ²’è¼¸å…¥ IPï¼Œå˜—è©¦ç”¨ç•¶å‰ host
      serverUrl = location.host;
    } else {
      serverUrl = `${ip}:${port}`;
    }
  }
  localStorage.setItem('ufo_cam_server', serverUrl);

  // é–‹å•Ÿæ”å½±æ©Ÿ
  startCamera().then(() => {
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('camArea').classList.remove('hidden');
    document.getElementById('controls').classList.remove('hidden');
    setStatus('ready', 'å·²å°±ç·’');
  }).catch(err => {
    alert('ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿï¼š' + err.message);
  });
}

// ===== æ”å½±æ©Ÿ =====
async function startCamera() {
  const [w, h] = document.getElementById('selRes').value.split('x').map(Number);
  const constraints = {
    video: {
      facingMode: facingMode,
      width: { ideal: w },
      height: { ideal: h },
      frameRate: { ideal: 30 },
    },
    audio: false
  };

  if (stream) {
    stream.getTracks().forEach(t => t.stop());
  }

  stream = await navigator.mediaDevices.getUserMedia(constraints);
  const video = document.getElementById('preview');
  video.srcObject = stream;
  await video.play();

  currentTrack = stream.getVideoTracks()[0];
  const settings = currentTrack.getSettings();
  document.getElementById('resInfo').textContent = `${settings.width}Ã—${settings.height}`;

  return stream;
}

async function flipCamera() {
  facingMode = facingMode === 'environment' ? 'user' : 'environment';
  const isFront = facingMode === 'user';
  document.getElementById('lensInfo').textContent = isFront ? 'å‰é¡é ­' : 'ä¸»é¡é ­';
  // å‰é¡é ­è‡ªå‹•é¡åƒï¼Œå¾Œé¡é ­ä¸é¡åƒ
  document.getElementById('chkMirror').checked = isFront;
  applyMirror();
  await startCamera();
}

async function toggleTorch() {
  if (!currentTrack) return;
  const on = document.getElementById('chkTorch').checked;
  try {
    await currentTrack.applyConstraints({ advanced: [{ torch: on }] });
  } catch (e) {
    console.warn('æ‰‹é›»ç­’ä¸æ”¯æ´:', e);
    document.getElementById('chkTorch').checked = false;
  }
}

function applyMirror() {
  const mirror = document.getElementById('chkMirror').checked;
  document.getElementById('preview').style.transform = mirror ? 'scaleX(-1)' : 'none';
}

async function applySettings() {
  if (stream) await startCamera();
}

// ===== WebSocket ä¸²æµ =====
function toggleStream() {
  if (streaming) stopStream();
  else startStream();
}

function startStream() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${proto}//${serverUrl}/ws/cam-feed`;

  try {
    ws = new WebSocket(wsUrl);
  } catch (e) {
    setStatus('off', 'é€£ç·šå¤±æ•—');
    alert('ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼š' + e.message);
    return;
  }

  ws.binaryType = 'arraybuffer';

  ws.onopen = () => {
    streaming = true;
    setStatus('stream', 'ä¸²æµä¸­');
    document.getElementById('btnStream').textContent = 'â¹ åœæ­¢ä¸²æµ';
    document.getElementById('btnStream').className = 'btn btn-stop';
    sentFrames = 0;
    sentBytes = 0;

    // ç™¼é€è£ç½®è³‡è¨Š
    const settings = currentTrack ? currentTrack.getSettings() : {};
    ws.send(JSON.stringify({
      type: 'init',
      device: 'iPhone',
      userAgent: navigator.userAgent,
      width: settings.width || 0,
      height: settings.height || 0,
    }));

    // é–‹å§‹æ“·å–å¹€
    const fps = parseInt(document.getElementById('selFps').value);
    const interval = Math.round(1000 / fps);
    frameTimer = setInterval(captureAndSend, interval);
  };

  ws.onclose = () => {
    streaming = false;
    if (frameTimer) clearInterval(frameTimer);
    setStatus('ready', 'å·²æ–·ç·š');
    document.getElementById('btnStream').textContent = 'â–¶ é–‹å§‹ä¸²æµ';
    document.getElementById('btnStream').className = 'btn btn-start';
  };

  ws.onerror = (e) => {
    console.error('WebSocket error:', e);
    setStatus('off', 'é€£ç·šéŒ¯èª¤');
  };

  ws.onmessage = (e) => {
    // ä¼ºæœå™¨å›å‚³ç¢ºèª / æŒ‡ä»¤
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'ack') {
        const lat = Date.now() - msg.ts;
        document.getElementById('latency').textContent = lat;
      }
    } catch (_) {}
  };
}

function stopStream() {
  if (frameTimer) clearInterval(frameTimer);
  if (ws) ws.close();
  streaming = false;
  setStatus('ready', 'å·²åœæ­¢');
  document.getElementById('btnStream').textContent = 'â–¶ é–‹å§‹ä¸²æµ';
  document.getElementById('btnStream').className = 'btn btn-start';
}

function captureAndSend() {
  if (!ws || ws.readyState !== WebSocket.OPEN || !stream) return;

  const video = document.getElementById('preview');
  const canvas = document.getElementById('captureCanvas');
  const ctx = canvas.getContext('2d');

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  const quality = parseInt(document.getElementById('qualitySlider').value) / 100;
  canvas.toBlob(blob => {
    if (!blob || !ws || ws.readyState !== WebSocket.OPEN) return;

    // ç™¼é€äºŒé€²ä½ JPEG
    blob.arrayBuffer().then(buf => {
      ws.send(buf);
      sentFrames++;
      sentBytes += buf.byteLength;
      document.getElementById('sentFrames').textContent = sentFrames;
      document.getElementById('sentBytes').textContent = Math.round(sentBytes / 1024);

      // FPS è¨ˆç®—
      document.getElementById('fpsBadge').textContent =
        document.getElementById('selFps').value + ' FPS';
    });
  }, 'image/jpeg', quality);
}

// ===== UI =====
function setStatus(mode, text) {
  const dot = document.getElementById('statusDot');
  dot.className = 'dot ' + (mode === 'stream' ? 'dot-stream' : mode === 'ready' ? 'dot-on' : 'dot-off');
  document.getElementById('statusText').textContent = text;
}

function toggleSettings() {
  document.getElementById('settingsPanel').classList.toggle('open');
}

// ===== åˆå§‹åŒ– =====
if (isExternal) {
  // å¤–ç¶²æ¨¡å¼ï¼šéš±è—æ‰‹å‹•è¼¸å…¥ï¼Œç°¡åŒ– UI
  document.getElementById('manualInputs').classList.add('hidden');
  document.getElementById('setupDesc').textContent = 'é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•Ÿæ”å½±æ©Ÿä¸¦ä¸²æµåˆ° UFO åµæ¸¬ç³»çµ±';
  document.getElementById('setupHint').innerHTML =
    'ğŸŒ å¤–ç¶²æ¨¡å¼ï¼š' + location.hostname + '<br>æ”å½±æ©Ÿç•«é¢å°‡é€éå®‰å…¨é€£ç·š (WSS) å‚³è¼¸';
} else {
  // å…§ç¶²æ¨¡å¼ï¼šæ¢å¾©ä¸Šæ¬¡çš„ä¼ºæœå™¨ä½å€
  const saved = localStorage.getItem('ufo_cam_server');
  if (saved) {
    const parts = saved.split(':');
    if (parts.length >= 2) {
      document.getElementById('serverIp').value = parts.slice(0, -1).join(':');
      document.getElementById('serverPort').value = parts[parts.length - 1];
    }
  }
}

// è¨»å†Š Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/cam/sw.js').catch(() => {});
}

// é˜²æ­¢è¢å¹•ä¼‘çœ ï¼ˆWake Lock APIï¼‰
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      await navigator.wakeLock.request('screen');
    }
  } catch (_) {}
}
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') requestWakeLock();
});
requestWakeLock();
</script>
</body>
</html>
