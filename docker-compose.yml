# Zhe-Wei Tech — Docker Compose v2.0 (優化版)
# Start: docker compose up -d
# Requires CLOUDFLARE_TOKEN in .env

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

x-common: &common
  build: .
  env_file: [.env]
  restart: unless-stopped
  logging: *default-logging
  extra_hosts: ["host.docker.internal:host-gateway"]

services:
  # ── Nginx Gateway (URL Router) ──
  gateway:
    image: nginx:alpine
    container_name: zhewei_gateway
    ports:
      - "8888:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./dist:/app/dist:ro
    restart: unless-stopped
    logging: *default-logging
    depends_on:
      brain_server: { condition: service_started }
      portal: { condition: service_started }
      cms: { condition: service_started }
      codesim: { condition: service_started }
    networks: [default, dify_network]
    extra_hosts: ["host.docker.internal:host-gateway"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost/nginx-health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ── Brain Server ──
  brain_server:
    <<: *common
    container_name: zhewei_brain
    environment:
      BRAIN_WORKSPACE: /app/brain_workspace
      ZHEWEI_MEMORY_ROOT: /memory
      BRAIN_WS_PORT: "8000"
      PORT: "8000"
      AI_COST_MODE: local_only
      PIPER_MODEL_PATH: /app/zhewei_memory/models/piper/zh_CN-huayan-medium.onnx
      OLLAMA_BASE_URL: http://host.docker.internal:11460
      PHONE_ADB_HOST: ${PHONE_ADB_HOST:-192.168.1.100}
      PHONE_ADB_PORT: ${PHONE_ADB_PORT:-5555}
      PHONE_OLLAMA_MODEL: ${PHONE_OLLAMA_MODEL:-qwen3:32b}
      PHONE_VISION_MODEL: ${PHONE_VISION_MODEL:-moondream}
    volumes:
      - .:/app
      - ./zhewei_memory:/memory
    # ports: ["8002:8000"]  # 本機已跑 brain_server.py，不暴露避免衝突
    networks: [default, dify_network]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ── Smart Bridge ──
  smart_bridge:
    <<: *common
    container_name: zhewei_smart_bridge
    environment:
      SMART_BRIDGE_PORT: "8003"
      SMART_BRIDGE_HOST: "0.0.0.0"
      OLLAMA_BASE_URL: http://host.docker.internal:11460
      OLLAMA_MODEL: qwen3:8b
    volumes:
      - .:/app
      - ./bridge_workspace:/app/bridge_workspace
      - ./zhewei_memory:/memory
    ports: ["8003:8003"]
    command: ["python", "smart_bridge.py"]
    networks: [default, dify_network]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ── Portal (PWA 入口) ──
  portal:
    <<: *common
    container_name: zhewei_portal
    environment:
      PORTAL_PORT: "8888"
    volumes:
      - .:/app
      - ./portal:/app/portal
    command: ["python", "portal_server.py"]
    networks: [default, dify_network]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8888/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ── CMS 營建管理系統 ──
  cms:
    <<: *common
    container_name: zhewei_cms
    volumes:
      - .:/app
      - ./construction_mgmt:/app/construction_mgmt
    command: ["python", "construction_mgmt/app.py"]
    networks: [default]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8020/')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ── CodeSim 代碼模擬器 ──
  codesim:
    <<: *common
    container_name: zhewei_codesim
    environment:
      OLLAMA_BASE_URL: http://host.docker.internal:11460
    volumes:
      - .:/app
      - ./simulator:/app/simulator
    command: ["python", "simulator/code_simulator.py"]
    networks: [default]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ── Ntfy 推播通知服務 ──
  ntfy:
    image: binwiederhier/ntfy:latest
    container_name: zhewei_ntfy
    restart: unless-stopped
    logging: *default-logging
    command: ["serve", "--cache-file", "/var/cache/ntfy/cache.db", "--base-url", "https://notify.zhe-wei.net"]
    environment:
      NTFY_AUTH_DEFAULT_ACCESS: "deny-all"
      NTFY_BEHIND_PROXY: "true"
    volumes:
      - ntfy_cache:/var/cache/ntfy
      - ntfy_data:/var/lib/ntfy
      - ntfy_etc:/etc/ntfy
    ports: ["2586:80"]
    networks: [default]
    healthcheck:
      test: ["CMD-SHELL", "wget -q --tries=1 http://localhost:80/v1/health -O - | grep -q healthy || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ── Uptime Kuma 監控 ──
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: zhewei_uptime_kuma
    restart: unless-stopped
    logging: *default-logging
    volumes:
      - uptime_kuma_data:/app/data
    ports: ["3301:3001"]
    networks: [default]
    extra_hosts: ["host.docker.internal:host-gateway"]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const http=require('http');const r=http.get('http://localhost:3001/api/entry-page',res=>{process.exit(res.statusCode===200?0:1)});r.on('error',()=>process.exit(1))\""]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ── Cloudflare Tunnel → Gateway ──
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: zhewei_tunnel
    restart: always
    logging: *default-logging
    command: ["tunnel", "--protocol", "http2", "run", "--token", "${CLOUDFLARE_TOKEN}"]
    depends_on:
      gateway: { condition: service_started }

volumes:
  ntfy_cache:
  ntfy_data:
  ntfy_etc:
  uptime_kuma_data:

networks:
  dify_network:
    external: true
    name: docker_default
