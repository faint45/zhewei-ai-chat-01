import asyncio
import datetime
from winsdk.windows.ui.notifications.management import UserNotificationListener, UserNotificationListenerAccessStatus
from winsdk.windows.ui.notifications import NotificationKinds

async def get_notifications():
    """
    éåŒæ­¥å‡½å¼ï¼šè®€å– Windows é€šçŸ¥ä¸­å¿ƒçš„å…§å®¹
    """
    # 1. å–å¾—ç›£è½å™¨å¯¦ä¾‹
    listener = UserNotificationListener.get_current()

    # 2. è«‹æ±‚å­˜å–æ¬Šé™ (ç¬¬ä¸€æ¬¡åŸ·è¡Œæ™‚ Windows æœƒè·³å‡ºè©¢å•è¦–çª—)
    access_status = await listener.request_access_async()

    if access_status != UserNotificationListenerAccessStatus(ALLOWED):
        print("âŒ å­˜å–è¢«æ‹’çµ•ï¼è«‹è‡³ Windows è¨­å®š > éš±ç§æ¬Š > é€šçŸ¥ > å…è¨±æ‡‰ç”¨ç¨‹å¼å­˜å–é€šçŸ¥ã€‚")
        return []

    # 3. ç²å–æ‰€æœ‰ç¾å­˜çš„é€šçŸ¥ (åŒ…å« Toast å½ˆå‡ºè¨Šæ¯)
    notifications = await listener.get_notifications_async(NotificationKinds.TOAST)
    
    results = []
    
    print(f"ğŸ” æƒæä¸­... ç™¼ç¾ {notifications.size} å‰‡é€šçŸ¥")
    
    for notification in notifications:
        try:
            # å–å¾—æ‡‰ç”¨ç¨‹å¼åç¨± (ä¾‹å¦‚: LINE, WeChat, Outlook)
            app_name = notification.app_info.display_info.display_name
            
            # éæ¿¾ï¼šé€™è£¡å¯ä»¥è¨­å®šåªè®€å–ç‰¹å®šè»Ÿé«”ï¼Œä¾‹å¦‚ 'LINE'
            if "LINE" not in app_name:
                continue 

            # è§£æé€šçŸ¥å…§å®¹ (æ¨™é¡Œèˆ‡å…§æ–‡)
            # Windows é€šçŸ¥é€šå¸¸ç”±å¤šå€‹æ–‡å­—ç¶å®šçµ„æˆ
            bindings = notification.notification.visual.get_binding("ToastGeneric")
            if bindings:
                texts = bindings.get_text_elements()
                title = texts[0].text if len(texts) > 0 else "ç„¡æ¨™é¡Œ"
                body = texts[1].text if len(texts) > 1 else "ç„¡å…§å®¹"
                
                # å–å¾—æ™‚é–“æˆ³è¨˜
                # é€™è£¡åšç°¡å–®çš„æ™‚é–“è½‰æ›ï¼Œå¯¦éš›æ‡‰ç”¨å¯ä¿ç•™åŸå§‹æ ¼å¼
                msg_data = {
                    "app": app_name,
                    "sender": title,   # LINE çš„é€šçŸ¥æ¨™é¡Œé€šå¸¸æ˜¯ç™¼è¨Šè€…
                    "message": body,   # å…§å®¹
                    "time": datetime.datetime.now().strftime("%H:%M:%S")
                }
                results.append(msg_data)
                
                # é¡¯ç¤ºæŠ“å–åˆ°çš„è³‡æ–™ (é™¤éŒ¯ç”¨)
                print(f"âœ… [{app_name}] {title}: {body}")
                
        except Exception as e:
            print(f"âš ï¸ è§£æéŒ¯èª¤: {e}")
            continue
            
    return results

# === åŸ·è¡Œæ¸¬è©¦ ===
if __name__ == "__main__":
    print("=== Windows é€šçŸ¥è®€å–æ¸¬è©¦ (æŒ‰ Ctrl+C çµæŸ) ===")
    print("è«‹ç¢ºä¿ LINE é›»è…¦ç‰ˆå·²é–‹å•Ÿï¼Œä¸”æœ‰äººå‚³è¨Šæ¯çµ¦æ‚¨...")
    
    try:
        # ç°¡å–®çš„è¼ªè©¢ (Polling) æ¨¡æ“¬å¯¦æ™‚ç›£æ§
        while True:
            notifications = asyncio.run(get_notifications())
            if notifications:
                # è™•ç†é€šçŸ¥
                for notification in notifications:
                    print(f"æ”¶åˆ°é€šçŸ¥ï¼š{notification['app']} - {notification['sender']}ï¼š{notification['message']}")
            # æ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œé¿å…ä½”ç”¨éå¤š CPU
            # å¯¦éš›ç”¢å“å»ºè­°ä½¿ç”¨ Event Listener (äº‹ä»¶é©…å‹•) æ¨¡å¼
            import time
            time.sleep(5) 
            print("--- ç­‰å¾…æ–°è¨Šæ¯ ---")
    except KeyboardInterrupt:
        print("\nç¨‹å¼å·²åœæ­¢ã€‚")

    # === äº‹ä»¶é©…å‹•æ¨¡å¼ ===
    def on_notification_arrived(listener, notification):
        print(f"æ”¶åˆ°é€šçŸ¥ï¼š{notification.app_info.display_info.display_name} - {notification.notification.visual.get_binding('ToastGeneric').get_text_elements()[0].text}")
        
    listener = UserNotificationListener.get_current()
    listener.add_on_notification_arrived(on_notification_arrived)
    listener.start()
    
    try:
        while True:
            import time
            time.sleep(1)
    except KeyboardInterrupt:
        print("\nç¨‹å¼å·²åœæ­¢ã€‚")
        listener.stop()