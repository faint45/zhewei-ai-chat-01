# 外網無法連線 — 診斷與修復

## 快速診斷

執行 **`診斷外網連線.bat`**（或 `powershell -ExecutionPolicy Bypass -File scripts/check_external_access.ps1`）  
會自動檢查：CLOUDFLARE_TOKEN、Tunnel 容器、Brain 容器、本機 8002、外網連線。

---

## 現況：Cloudflare Tunnel

外網需透過 **Cloudflare Tunnel** 連到 `https://brain.zhe-wei.net`。  
若外網無法連線，請依序檢查：

---

## 1. 檢查 CLOUDFLARE_TOKEN

```powershell
# 檢查 .env 是否有設定
findstr CLOUDFLARE_TOKEN .env
```

| 狀況 | 對策 |
|------|------|
| 無 CLOUDFLARE_TOKEN | 需從 Cloudflare Zero Trust 取得並寫入 .env |
| Token 為 UUID（如 `ceb56784-ec47-...`） | 錯誤，需改用完整 JWT |
| Token 以 `eyJ` 開頭 | 正確格式 |

**取得正確 Token：**
1. 開啟 https://one.dash.cloudflare.com → **Networks** → **Tunnels**
2. 點你的隧道（或新建）→ **Configure** → **Install connector**
3. 複製完整 Token（整段 `eyJ...` 開頭）
4. 貼到 `.env`：`CLOUDFLARE_TOKEN=eyJ...`

---

## 2. 檢查 Tunnel 容器

```powershell
docker ps -a | findstr tunnel
```

| 狀況 | 對策 |
|------|------|
| 無 tunnel 容器 | 執行 `docker compose up -d` 或 `一鍵啟動.bat` |
| 狀態為 Exited | `docker logs zhe-wei-tech-tunnel-1` 查看錯誤 |
| 顯示 `Provided Tunnel token is not valid` | 更換為正確的 CLOUDFLARE_TOKEN |

---

## 3. 檢查 Cloudflare 公用主機名稱

在 Zero Trust → Tunnels → 你的隧道 → **Public Hostname**：

| 子網域 | 網域 | 類型 | URL |
|--------|------|------|-----|
| brain | zhe-wei.net | HTTP | **brain_server:8000** |

若使用 docker compose，兩容器在同一網路，用 `brain_server:8000`。  
若 brain 在本機跑，則用 `host.docker.internal:8002`。

---

## 4. 檢查 Brain 是否在運行

```powershell
# 本機測試
curl http://127.0.0.1:8002/health

# 或瀏覽器
start http://127.0.0.1:8002/health
```

若本機可連，但外網不行 → 多半是 Tunnel 或 Cloudflare 設定問題。

---

## 5. 快速修復指令

```batch
REM 1. 確認 .env 有 CLOUDFLARE_TOKEN
REM 2. 重啟容器
docker compose down
docker compose up -d

REM 3. 等待 30 秒後測試
timeout /t 30
curl https://brain.zhe-wei.net/health
```

---

## 無 Cloudflare 時的替代方案

若尚未設定 Cloudflare Tunnel，可改用：

| 方案 | 說明 |
|------|------|
| 路由器埠轉發 | 將 8002 轉發到主機；外網用 `http://你的公網IP:8002` |
| Tailscale | 安裝 Tailscale，用 Tailscale IP 連線（VPN 模式） |
| ngrok | `ngrok http 8002` 取得臨時外網網址 |

---

## 常見錯誤

| 錯誤 | 可能原因 |
|------|----------|
| Error 1033 | CLOUDFLARE_TOKEN 為 UUID 而非 JWT |
| 502 Bad Gateway | Tunnel 已連到 Cloudflare，但到 brain_server 失敗；檢查 Public Hostname 的 URL |
| Connection refused | brain_server 容器未啟動 |
| 本機可連、外網不行 | 檢查 Tunnel 容器 logs；確認 Cloudflare 主機名設定 |
