# 築未科技大腦 - 遠端對話系統架構方案

**目標**：從任何設備（PC 筆電、iOS 手機）與築未科技大腦對話，由大腦分配給本地模型進行編碼或創作

**日期**：2026/02/04

---

## 一、現有架構分析

### 1.1 已有服務

| 服務 | 檔案 | 端口 | 功能 | 狀態 |
|------|------|------|------|------|
| **AI 服務** | `ai_service.py` | - | 統一 AI 接口，支援 Ollama/OpenAI/Demo | ✅ 已實作 |
| **大腦服務器** | `brain_server.py` | 8000 | WebSocket + REST API 對話 | ✅ 已實作 |
| **網站服務器** | `website_server.py` | 8000 | 網站 + 對話 + 管理後台 | ✅ 已實作 |
| **Telegram Bot** | `telegram_bot.py` | - | Telegram 對話 + 系統控制 | ✅ 已實作 |
| **監控服務** | `monitoring_service.py` | 8001 | API 監控面板 | ✅ 已實作 |

### 1.2 現有 AI 模型支援

| 模型類型 | 配置方式 | 狀態 |
|----------|----------|------|
| **Ollama (本地)** | `AI_MODEL_TYPE=ollama` | ✅ 支援 |
| **OpenAI (雲端)** | `AI_MODEL_TYPE=openai` | ✅ 支援 |
| **CloudBase AI** | `AI_MODEL_TYPE=cloudbase` | ✅ 支援 |
| **演示模式** | `AI_MODEL_TYPE=demo` | ✅ 支援 |

### 1.3 現有通訊通道

| 通道 | 端點 | 協議 | 狀態 |
|------|------|------|------|
| **WebSocket** | `/ws/chat` | WebSocket | ✅ 已實作 |
| **REST API** | `/api/chat` | HTTP POST | ✅ 已實作 |
| **Telegram** | Bot Token | Telegram Bot API | ✅ 已實作 |

### 1.4 網絡基礎設施

| 基礎設施 | 狀態 | 用途 |
|----------|------|------|
| **Tailscale** | ✅ 已配置 | 內網穿透（100.116.133.23） |
| **OpenSSH** | ✅ 已配置 | 遠端 SSH 訪問 |

---

## 二、架構方案設計

### 2.1 整體架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                        客戶端設備                            │
├─────────────────────────────────────────────────────────────┤
│  PC 筆電              │  iOS 手機              │  其他設備  │
│  - 瀏覽器 (HTTP)      │  - Safari App          │  - 瀏覽器   │
│  - VS Code Remote SSH│  - Shortcuts (快捷指令)│  - SSH      │
└──────────┬────────────┴──────────┬─────────────┴──────────┘
           │                       │
           └───────────┬───────────┘
                       │
        ┌──────────────▼──────────────┐
        │   網絡層 (Tailscale VPN)    │
        │   IP: 100.116.133.23       │
        └──────────────┬──────────────┘
                       │
        ┌──────────────▼──────────────┐
        │    築未科技大腦主機         │
        ├─────────────────────────────┤
        │  統一對話服務器 (8000)      │
        │  - WebSocket (/ws/chat)     │
        │  - REST API (/api/chat)    │
        │  - Telegram Bot            │
        └──────────────┬──────────────┘
                       │
        ┌──────────────▼──────────────┐
        │    任務分配器               │
        │  - 意圖識別                 │
        │  - 模型選擇                 │
        │  - 任務路由                 │
        └──────┬─────────┬───────────┘
               │         │
    ┌──────────▼─┐  ┌──▼──────────────┐
    │  Ollama    │  │  CloudBase AI   │
    │  (本地)    │  │  (雲端)         │
    │  - 編碼    │  │  - 創作         │
    │  - 分析    │  │  - 高級推理    │
    └────────────┘  └─────────────────┘
```

### 2.2 核心設計原則

| 原則 | 說明 |
|------|------|
| **快速響應** | 優先使用本地 Ollama 模型，延遲 < 2 秒 |
| **跨平台連續性** | 不同設備共享同一對話上下文 |
| **穩定可靠** | 雲端備選方案，本地不可用時自動切換 |
| **簡單易用** | 無需複雜配置，一鍵開始對話 |
| **安全可控** | 用戶認證，訪問控制 |

---

## 三、技術方案選擇

### 方案 A：瀏覽器 + WebSocket（推薦）

**最快速、最穩定、最簡單**

#### 優點

| 項目 | 說明 |
|------|------|
| ✅ **實現快速** | 現有 `brain_server.py` 已支援 WebSocket |
| ✅ **跨平台** | 任何有瀏覽器的設備都能使用 |
| ✅ **即時通訊** | WebSocket 支持即時雙向通訊 |
| ✅ **界面友好** | Web 界面直觀，無需安裝 App |
| ✅ **維護簡單** | 單一服務，易於維護 |
| ✅ **成本低** | 無需額外服務或註冊 |

#### 架構

```
客戶端 (瀏覽器)
    ↓
Tailscale VPN
    ↓
brain_server.py (8000)
    ↓ WebSocket
AI 任務分配器
    ↓
Ollama (本地模型)
```

#### 實現步驟

1. **啟動 brain_server.py**（已完成）
   ```bash
   python brain_server.py
   ```

2. **訪問對話界面**
   ```
   本地：http://localhost:8000
   遠端：http://100.116.133.23:8000
   ```

3. **配置 Ollama**
   ```bash
   # 設置環境變量
   AI_MODEL_TYPE=ollama

   # 重啟服務
   ```

#### 工作流程

```
1. 用戶輸入消息 (瀏覽器)
2. 通過 WebSocket 發送到 brain_server
3. brain_server 識別任務類型
4. 分配給 Ollama 本地模型
5. 返回 AI 回應
6. 瀏覽器顯示回應
```

#### iOS 使用方式

```
方式 1：Safari 瀏覽器
- 打開 Safari
- 輸入：http://100.116.133.23:8000
- 開始對話

方式 2：添加到主屏幕
- Safari > 分享 > 添加到主屏幕
- 像原生 App 一樣使用
```

---

### 方案 B：Telegram Bot（已有）

**適合簡單文本對話**

#### 優點

| 項目 | 說明 |
|------|------|
| ✅ **已實作** | `telegram_bot.py` 已完成 |
| ✅ **原生 App** | Telegram 官方 App，體驗好 |
| ✅ **推送通知** | 即時收到回應通知 |
| ✅ **後台運行** | 不需要保持瀏覽器開啟 |

#### 缺點

| 項目 | 說明 |
|------|------|
| ⚠️ **需要 Token** | 需要在 BotFather 創建機器人 |
| ⚠️ **功能受限** | 不適合複雜交互和文件操作 |
| ⚠️ **界面簡單** | 文本為主，無富文本 |

#### iOS 使用方式

```
1. 安裝 Telegram App
2. 搜索您的機器人
3. 發送 /start
4. 開始對話
```

---

### 方案 C：自建 iOS App（不推薦）

**開發週期長，不建議**

#### 缺點

| 項目 | 說明 |
|------|------|
| ❌ **開發複雜** | 需要 Swift/Objective-C 知識 |
| ❌ **審核週期** | App Store 審核需時 |
| ❌ **維護成本** | 需要持續維護和更新 |
| ❌ **過度設計** | 瀏覽器方案已足夠 |

---

### 方案 D：SSH + 終端（技術選項）

**適合技術人員**

#### 優點

| 項目 | 說明 |
|------|------|
| ✅ **已配置** | OpenSSH 已安裝並運行 |
| ✅ **安全** | 加密連接 |
| ✅ **靈活** | 可以執行各種命令 |

#### 缺點

| 項目 | 說明 |
|------|------|
| ⚠️ **門檻高** | 需要命令行知識 |
| ⚠️ **體驗差** | 文本界面，不直觀 |

#### 使用方式

```bash
# 從 PC 筆電 SSH 連接
ssh user@100.116.133.23

# 或使用 VS Code Remote SSH
F1 > Remote-SSH: Connect to Host
```

---

## 四、推薦方案：Web + WebSocket（方案 A）

### 4.1 為什麼選方案 A？

| 對比項 | Web+WebSocket | Telegram | SSH+終端 | iOS App |
|--------|--------------|----------|----------|---------|
| **實現速度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ |
| **跨平台性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐ |
| **用戶體驗** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **維護成本** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **開發成本** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐ |

**綜合評分：Web + WebSocket 獲勝！**

### 4.2 核心功能

#### 基礎功能

| 功能 | 說明 | 優先級 |
|------|------|--------|
| 對話界面 | 美觀的聊天界面 | P0 |
| 即時回應 | WebSocket 即時通訊 | P0 |
| 歷史記錄 | 保存對話歷史 | P0 |
| 會話管理 | 支持多個對話會話 | P1 |
| 模型切換 | 手動/自動切換模型 | P1 |
| 狀態顯示 | 顯示 AI 模型和狀態 | P2 |

#### 進階功能

| 功能 | 說明 | 優先級 |
|------|------|--------|
| 代碼高亮 | 代碼語法高亮 | P1 |
| Markdown 支持 | 富文本渲染 | P1 |
| 文件上傳 | 上傳文件給 AI 分析 | P2 |
| 音頻輸入 | 語音輸入轉文字 | P2 |
| 深色模式 | 深色/淺色主題切換 | P2 |

### 4.3 技術棧

| 層級 | 技術 | 說明 |
|------|------|------|
| **前端** | HTML + CSS + JavaScript | 已有 `remote_brain.html` |
| **通訊** | WebSocket API | 已在 `brain_server.py` 實現 |
| **後端** | FastAPI + Uvicorn | 已實現 |
| **AI** | Ollama (本地) | 可配置 |
| **網絡** | Tailscale VPN | 已配置 |

---

## 五、實作計畫

### 階段 1：基礎功能（1-2 小時）

**目標：實現基本對話功能**

- ✅ 使用現有 `brain_server.py`
- ✅ 使用現有 `remote_brain.html`（如無則創建）
- ✅ 配置 Ollama 連接
- ✅ 測試 WebSocket 連接

### 階段 2：界面優化（2-3 小時）

**目標：美觀易用的界面**

- ✅ 修復/優化 `remote_brain.html`
- ✅ 添加 Markdown 渲染（使用 marked.js）
- ✅ 添加代碼高亮（使用 highlight.js）
- ✅ 響應式設計（適配 iOS Safari）

### 階段 3：進階功能（2-3 小時）

**目標：增強用戶體驗**

- ✅ 對話歷史保存
- ✅ 會話管理
- ✅ 模型狀態顯示
- ✅ 深色模式

### 階段 4：測試與優化（1-2 小時）

**目標：確保穩定可靠**

- ✅ 多設備測試（PC、iOS）
- ✅ 性能優化
- ✅ 錯誤處理
- ✅ 文檔編寫

---

## 六、快速開始指南

### 6.1 最快啟動方式（5 分鐘）

```bash
# 1. 啟動 brain_server.py
python brain_server.py

# 2. 從瀏覽器訪問
# 本地：http://localhost:8000
# 遠端：http://100.116.133.23:8000

# 3. 開始對話
```

### 6.2 配置 Ollama

```bash
# 1. 安裝 Ollama（如果尚未安裝）
# 訪問：https://ollama.ai/
# 下載並安裝

# 2. 拉取模型
ollama pull llama3.2

# 3. 測試本地模型
ollama run llama3.2

# 4. 配置環境變量
# 創建 .env 文件：
AI_MODEL_TYPE=ollama
OLLAMA_BASE_URL=http://localhost:11434

# 5. 重啟 brain_server.py
```

### 6.3 iOS 快捷指令

創建 iOS Shortcuts，實現一鍵對話：

```text
1. 打開 Shortcuts App
2. 創建新快捷指令
3. 添加動作："打開 URL"
4. URL: http://100.116.133.23:8000
5. 命名："築未科技大腦"
6. 添加到主屏幕
```

---

## 七、使用場景

### 7.1 PC 筆電

```
場景 1：編碼助手
1. 打開瀏覽器訪問 http://100.116.133.23:8000
2. 輸入："幫我寫一個 Python 函數來計算斐波那契數列"
3. AI 使用本地 Ollama 模型生成代碼
4. 直接複製代碼使用

場景 2：創作靈感
1. 訪問對話界面
2. 輸入："給我 5 個創業點子"
3. AI 快速回應
4. 選擇感興趣的點子深入討論
```

### 7.2 iOS 手機

```
場景 1：快速查詢
1. 打開 Safari 訪問 http://100.116.133.23:8000
2. 輸入："今天台北天氣如何？"
3. AI 回應天氣信息

場景 2：移動辦公
1. 查看之前的對話歷史
2. 繼續未完成的討論
3. 添加新的任務

場景 3：語音輸入（未來）
1. 點擊麥克風按鈕
2. 語音輸入問題
3. AI 語音回應
```

---

## 八、優化建議

### 8.1 性能優化

| 項目 | 方法 | 預期效果 |
|------|------|----------|
| **模型選擇** | 編碼用 Code Llama，對話用 Llama 3 | 快 30-50% |
| **快取機制** | 快取常見問題和答案 | 快 50-70% |
| **流式輸出** | 逐步輸出回應，減少感知延遲 | 體驗提升 50% |
| **批量處理** | 多個請求合併處理 | 提升 20-30% |

### 8.2 穩定性優化

| 項目 | 方法 | 說明 |
|------|------|------|
| **錯誤重試** | 自動重試失敗的請求 | 3 次重試機制 |
| **健康檢查** | 定期檢查服務狀態 | 每 30 秒檢查一次 |
| **降級策略** | 本地不可用時切換到雲端 | 自動切換 |
| **日誌記錄** | 詳細記錄錯誤信息 | 便於排查問題 |

### 8.3 安全性優化

| 項目 | 方法 | 說明 |
|------|------|------|
| **用戶認證** | 添加簡單的密碼認證 | 防止未授權訪問 |
| **HTTPS** | 使用 SSL/TLS 加密 | Tailscale 已加密 |
| **輸入驗證** | 驗證用戶輸入 | 防止注入攻擊 |
| **速率限制** | 限制請求頻率 | 防止濫用 |

---

## 九、總結

### 9.1 推薦方案

**Web + WebSocket（方案 A）**

- ✅ 最快速（1-2 小時完成基礎功能）
- ✅ 最穩定（現有技術成熟）
- ✅ 最簡單（已有大部分代碼）
- ✅ 跨平台（任何設備都能用）

### 9.2 實施路徑

```
今天：
1. 啟動 brain_server.py (5 分鐘)
2. 測試本地訪問 (5 分鐘)
3. 測試遠端訪問 (5 分鐘)

明天：
1. 優化 remote_brain.html (2-3 小時)
2. 配置 Ollama (30 分鐘)
3. 測試 iOS Safari (30 分鐘)

本週：
1. 添加進階功能 (2-3 小時)
2. 文檔編寫 (1 小時)
3. 全面測試 (1 小時)
```

### 9.3 下一步

1. ✅ **立即開始**：啟動 `brain_server.py`
2. ✅ **測試連接**：從不同設備訪問
3. ✅ **優化界面**：美化 `remote_brain.html`
4. ✅ **配置 Ollama**：使用本地模型
5. ✅ **文檔完善**：編寫使用指南

---

**準備好開始了嗎？讓我們立即實施！** 🚀
