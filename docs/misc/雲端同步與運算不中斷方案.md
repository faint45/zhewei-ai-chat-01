# 築未科技 — 雲端同步與運算不中斷方案

**目的**：將所有關鍵資料同步至雲端硬碟，並在雲端伺服器上運作，確保本機關機時運算不中斷。

---

## 一、架構總覽

```
┌─────────────────────────────────────────────────────────────────────┐
│  本地 (D 槽)                                                         │
│  ├── brain_workspace (熱資料)                                        │
│  ├── zhe-wei-tech (專案)                                            │
│  └── sync_to_cloud.bat → 定期上傳                                    │
└──────────────────────────────┬──────────────────────────────────────┘
                               │ rclone sync
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Google Drive (雲端 4.1TB)                                           │
│  └── Zhewei_Brain/                                                  │
│      ├── workspace_backup     ← brain_workspace 備份                 │
│      ├── tech_repo_backup     ← 專案程式碼備份                        │
│      ├── jarvis_chroma_backup ← 知識庫                               │
│      ├── reports_backup       ← 報表                                 │
│      └── Reports、Rules、Experience  ← Z 槽掛載直接寫入               │
└──────────────────────────────┬──────────────────────────────────────┘
                               │ rclone sync(copy)
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  雲端伺服器 (VPS / Railway / 等)                                     │
│  ├── 拉取雲端資料 → 本地工作目錄                                     │
│  ├── brain_server + Ollama / 雲端 API                               │
│  └── Cloudflare Tunnel → brain.zhe-wei.net                           │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、本地：雲端同步設定

### 2.1 前置條件

- 已安裝 **Rclone** 並設定 **gdrive** 遠端（見 `挂载 Google Drive 为 Z 槽.bat`）
- Z 槽已掛載（或至少 gdrive 可連線）

### 2.2 手動同步

| 腳本 | 用途 |
|------|------|
| `scripts\sync_to_cloud.bat` | 上傳 D 槽與專案至 Google Drive |
| `scripts\sync_from_cloud.bat` | 從雲端還原至本地 |

執行方式：雙擊 `sync_to_cloud.bat`，或於專案根目錄執行：

```powershell
.\scripts\sync_to_cloud.bat
```

### 2.3 自動排程（每小時同步）

以系統管理員身分執行：

```batch
.\scripts\setup_cloud_sync_task.bat
```

排程建立後，每小時會自動將 `brain_workspace`、專案、ChromaDB、reports 同步至 `gdrive:Zhewei_Brain/`。

### 2.4 同步範圍

| 本地路徑 | 雲端路徑 | 排除項目 |
|----------|----------|----------|
| D:\brain_workspace | Zhewei_Brain/workspace_backup | venv、__pycache__、*.pyc |
| 專案根目錄 | Zhewei_Brain/tech_repo_backup | .venv312、node_modules、.git/objects、*.pt、raw_footage |
| Jarvis_Training/chroma_db | Zhewei_Brain/jarvis_chroma_backup | — |
| reports | Zhewei_Brain/reports_backup | self_heal_runs（暫存） |

---

## 三、雲端伺服器：運算不中斷

### 3.1 選型對照

| 方案 | 費用 | 優點 | 缺點 |
|------|------|------|------|
| **Cloudflare Tunnel（本機）** | 免費 | 無需雲端主機 | 本機關機即斷線 |
| **VPS（DigitalOcean/Linode）** | 約 $5–12/月 | 全掌控、可跑 Ollama | 需自行維護 |
| **Railway** | 付費（試用額度） | 一鍵部署 | 月費、環境限制 |
| **Oracle Cloud 免費 tier** | 免費 | 有免費 VPS | 申請較繁、規格限定 |

**建議**：若要「本機關機也運算」，選 **VPS** 或 **Oracle 免費 tier**。

### 3.2 雲端 VPS 部署步驟（以 Ubuntu 為例）

#### 步驟 1：建立 VPS

- DigitalOcean / Linode / Vultr：建立 Ubuntu 22.04 實例，至少 2GB RAM、1 vCPU
- 記錄 SSH 金鑰與 IP

#### 步驟 2：安裝 Rclone 並連結 Google Drive

```bash
# 安裝 rclone
curl https://rclone.org/install.sh | sudo bash

# 設定 gdrive（需在本機完成 rclone config 後，複製 config 到伺服器）
rclone config
# 建立 remote 名稱為 gdrive，類型選 Google Drive
```

可將本機 `%APPDATA%\rclone\rclone.conf` 複製到伺服器 `~/.config/rclone/rclone.conf`（注意權限與安全）。

#### 步驟 3：建立工作目錄並拉取資料

```bash
mkdir -p /opt/zhewei
cd /opt/zhewei

# 從雲端拉取資料
rclone sync gdrive:Zhewei_Brain/workspace_backup ./brain_workspace
rclone sync gdrive:Zhewei_Brain/tech_repo_backup ./zhe-wei-tech
rclone sync gdrive:Zhewei_Brain/jarvis_chroma_backup ./zhe-wei-tech/Jarvis_Training/chroma_db
```

#### 步驟 4：安裝 Docker 與啟動服務

```bash
# 安裝 Docker
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
# 登出再登入

# 複製 .env（需手動建立，含 CLOUDFLARE_TOKEN、API keys）
cd /opt/zhewei/zhe-wei-tech
# 建立 .env 並填入必要變數

# 設定環境變數指向本地路徑
export BRAIN_WORKSPACE=/opt/zhewei/brain_workspace
export ZHEWEI_MEMORY_ROOT=/opt/zhewei/brain_workspace  # 或掛載 gdrive 子目錄

# 啟動（使用雲端專用 compose 覆寫）
export WORK_DIR=/opt/zhewei
docker compose -f docker-compose.yml -f docker-compose.cloud.yml up -d
```

#### 步驟 5：設定 Cloudflare Tunnel

在 `.env` 填入 `CLOUDFLARE_TOKEN`（從 Zero Trust → Tunnels → Install connector 取得），Tunnel 會將 brain.zhe-wei.net 指到此 VPS。

---

## 四、雲端同步排程腳本（伺服器端）

建立 `/opt/zhewei/sync_and_run.sh`：

```bash
#!/bin/bash
# 同步雲端 → 本地，再啟動服務

cd /opt/zhewei
rclone sync gdrive:Zhewei_Brain/workspace_backup ./brain_workspace --quiet
rclone sync gdrive:Zhewei_Brain/tech_repo_backup ./zhe-wei-tech --exclude ".venv312/" --quiet

cd /opt/zhewei/zhe-wei-tech
docker compose up -d
```

加入 crontab 每小時同步一次：

```bash
crontab -e
# 每小時整點同步並重啟
0 * * * * /opt/zhewei/sync_and_run.sh >> /var/log/zhewei_sync.log 2>&1
```

---

## 五、反向同步：雲端結果回傳本地

若在雲端產生新報表、日誌，可定期從雲端拉回：

```bash
# 伺服器端：將結果 push 回 gdrive（若在雲端寫入 Reports）
rclone sync /opt/zhewei/brain_workspace/Reports gdrive:Zhewei_Brain/Reports
```

本地再執行 `sync_from_cloud.bat` 或只拉取 Reports 目錄即可。

---

## 六、快速檢查清單

- [ ] Rclone 已安裝，gdrive 遠端可連線
- [ ] Z 槽已掛載（或至少可 rclone 操作 gdrive）
- [ ] 執行過 `sync_to_cloud.bat` 至少一次
- [ ] 已設定「每小時同步」排程（`setup_cloud_sync_task.bat`）
- [ ] 若需雲端運算：VPS 已建立、Rclone 已設定、Docker 已啟動
- [ ] Cloudflare Tunnel 已指向雲端伺服器（若改用雲端）

---

## 七、進階：Backblaze B2 冷備份

- **設定**：執行 `scripts\setup_b2_rclone.bat` 設定 B2 遠端
- **同步**：執行 `scripts\sync_to_b2.bat` 將 gdrive 或本地資料同步至 B2
- **用途**：異地冷備份，成本低（約 $0.005/GB/月）

---

## 八、注意事項

1. **架構守則**：嚴禁變動 D:/brain_workspace 與 Z:/Zhewei_Brain 的分流架構；報表與長期記憶仍須同步寫入 Z 槽。
2. **敏感資料**：`.env` 含 API Key，勿透過 sync 上傳；雲端伺服器需手動建立。
3. **大型檔案**：`raw_footage`、`*.pt` 模型已排除，避免佔用雲端空間與同步時間。
4. **首次同步**：資料量較大時，首次 `sync_to_cloud.bat` 可能需數十分鐘，請保持網路穩定。
