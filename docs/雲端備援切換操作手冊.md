# 築未科技 — 雲端備援切換操作手冊

**情境**：本地電腦故障、關機或維修時，改由雲端 VPS 接手 brain.zhe-wei.net。

---

## 一、平時準備（未故障時完成）

### 1.1 本地同步至雲端

- 執行 `一鍵同步至雲端.bat` 或確保排程每小時執行
- 確認 Google Drive `Zhewei_Brain/` 有最新資料

### 1.2 冷備份至 B2（可選）

- 執行 `scripts\setup_b2_rclone.bat` 設定 B2
- 執行 `scripts\sync_to_b2.bat` 建立冷備份

### 1.3 Oracle Cloud VPS 已建立

- 依 `docs\Oracle_Cloud_免費VPS建立指南.md` 完成
- Rclone 已設定 gdrive（可複製本機 config）
- Docker 已安裝

---

## 二、故障發生時：手動切換流程

### 步驟 1：SSH 登入 VPS

```bash
ssh -i /path/to/oracle-key.key ubuntu@<VPS公網IP>
```

### 步驟 2：執行備援腳本

```bash
cd /opt/zhewei
./sync_and_run.sh
```

腳本會：
1. 從 gdrive 拉取最新 workspace、專案、ChromaDB
2. 啟動 Docker（brain_server + Cloudflare Tunnel）

### 步驟 3：確認 Cloudflare Tunnel 指向 VPS

- 若 Tunnel 已在本機跑：**先停止本機 Docker**（`docker compose down`），避免兩個 Tunnel 衝突
- 若 VPS 與本機共用同一 Tunnel Token：**不能同時跑**，關本機後 VPS 會自動接手
- 若使用不同 Tunnel：需在 Cloudflare 將 brain.zhe-wei.net 改指到 VPS 的 Tunnel

### 步驟 4：驗證

```bash
curl https://brain.zhe-wei.net/health
```

---

## 三、VPS 初次部署（尚未執行過）

在本機執行：

```bash
# 上傳腳本至 VPS
./scripts/deploy_failover_to_vps.sh <VPS_IP> <SSH_KEY路徑>
```

登入 VPS 後：

```bash
# 1. 複製 rclone config（若本機已設定）
# 在本機執行：
scp -i KEY "$HOME/.config/rclone/rclone.conf" ubuntu@<VPS_IP>:~/.config/rclone/
# Windows: scp ... %APPDATA%\rclone\rclone.conf ...

# 2. 建立 .env（手動編輯）
mkdir -p /opt/zhewei/zhe-wei-tech
nano /opt/zhewei/zhe-wei-tech/.env
# 填入：CLOUDFLARE_TOKEN=eyJ...、GEMINI_API_KEY=... 等

# 3. 執行備援
/opt/zhewei/sync_and_run.sh
```

---

## 四、設定 crontab 定期同步（可選）

VPS 上每小時從雲端拉取最新資料：

```bash
crontab -e
# 加入：
0 * * * * /opt/zhewei/sync_and_run.sh >> /var/log/zhewei_failover.log 2>&1
```

---

## 五、本地恢復後

1. 本機開機、啟動「啟動完整跑.bat」
2. 若 Tunnel 在本機：VPS 可停止（`docker compose down`）
3. 執行 `一鍵同步至雲端.bat` 將 VPS 期間產生的變更拉回（若 VPS 有寫入 Reports）
