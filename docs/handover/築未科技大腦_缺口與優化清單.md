# 築未科技大腦 — 還缺什麼、可優化什麼

依「一套遠端/本地皆可運行的 AI 模組 → 軟件/APP 接入 → 商用訂閱」的架構，整理目前**還缺什麼**與**可優化項目**，方便排優先順序。

**已實作（商用／穩定導向）**：API 日誌、/ready 健康檢查、備份含 Chroma＋排程用 .bat、smoke test、依 user_id/API Key 用量統計、依用戶限流、Session 持久化、輸入驗證、CORS 可設定、Demo 頁用量與錯誤重試。

---

## 一、還缺什麼（缺口）

### 1. 商用訂閱相關（若要做訂閱制）

| 項目 | 現狀 | 缺口 |
|------|------|------|
| **方案分級** | 無 | 免費/個人/團隊/企業等方案；不同方案對應不同額度或 API Key 群組。 |
| **依用戶用量** | 僅「全站」累計 + 當月預算 | 依 `user_id` 或 API Key（訂閱帳號）分開統計用量，才能依方案限額、計費。 |
| **額度檢查** | 僅「全站」預算達上限停付費 AI | 呼叫前檢查「該用戶/該 Key 是否超過方案額度」，超過則 403 或降級。 |
| **計費與帳單** | 無 | 依用量或方案產生帳單；對接金流（Stripe、藍新）或內部帳務（可後期）。 |
| **授權驗證** | 無 | 軟件/APP 啟動時驗證訂閱是否有效（可透過現有 `/auth/me` 或新端點擴充）。 |

**建議**：先做「依 user_id / API Key 的用量統計」與「方案額度檢查」，再談計費與金流。

---

### 2. 認證與安全

| 項目 | 現狀 | 缺口／優化 |
|------|------|------------|
| **Session 持久化** | Session 存在記憶體，重啟即清空 | 商用可改存 Redis 或 DB，避免重啟後全員重登。 |
| **密碼儲存** | AUTH_USERS 支援明碼或 sha256 | 建議一律改為僅存 hash（已支援），勿在 .env 寫明碼。 |
| **API Key 輪換** | 單一 BRAIN_BRIDGE_API_KEY | 多 Key、過期日、輪換機制，利於撤銷或分環境。 |
| **依用戶限流** | 目前限流依 IP | 訂閱制建議改為「依 user_id 或 API Key」限流，避免單一用戶佔滿。 |

---

### 3. 可觀測性與維運

| 項目 | 現狀 | 缺口 |
|------|------|------|
| **API 呼叫日誌** | 無系統性紀錄 | 誰、何時、哪個端點、user_id；可寫入 log 檔或 DB，利於稽核與除錯。 |
| **健康與依賴** | 有 `/health` 基本檢查 | 可加「依賴健康」：Ollama 是否可連、知識庫/Chroma 是否可用，回傳在 `/health` 或 `/ready`。 |
| **告警** | 無 | 服務掛掉、錯誤率過高、預算快用盡時，發送郵件或 Webhook（可後期）。 |
| **備份自動化** | 有 `scripts/backup-brain-data.py` | 未排程、未含 Chroma DB；可加排程（Windows 工作排程器或 cron）及 Chroma 目錄。 |

---

### 4. 對外介面與版本

| 項目 | 現狀 | 缺口／優化 |
|------|------|------------|
| **API 版本** | 無路徑版本（如 /v1） | 可加 `/v1/compute` 等，未來變更時不影響既有客戶端。 |
| **OpenAPI 文件** | FastAPI 內建 /docs | 可補各端點說明、範例、錯誤碼，方便軟件/APP 開發者對接。 |
| **錯誤碼統一** | 依賴 HTTP 狀態碼與 detail | 可訂統一格式（如 code + message），方便客戶端處理。 |

---

### 5. 測試與品質

| 項目 | 現狀 | 缺口 |
|------|------|------|
| **API 自動化測試** | 無 | 至少 smoke test：/health、/auth/login、/compute 等，部署前或 CI 跑一輪。 |
| **回歸測試** | 無 | 關鍵流程（登入 → 呼叫 /compute → 檢查回覆）可寫成腳本，避免改壞。 |

---

## 二、可優化項目（不一定要補）

### 1. 效能

| 項目 | 說明 |
|------|------|
| **熱門查詢快取** | 對相同或相似問題快取回覆（TTL 短），減少重複呼叫 AI。 |
| **檢索優化** | 知識庫/Chroma 已可調；必要時可再調 chunk 大小、limit、模型。 |
| **連線池** | 對外 HTTP（如 AI API）已用 requests；若量大有需要可考慮 httpx 連線池。 |

### 2. 安全

| 項目 | 說明 |
|------|------|
| **HTTPS** | 本地為 HTTP；上雲（Render 等）由平台提供 HTTPS。自建時請用 Nginx 反代 + SSL。 |
| **CORS** | 目前 allow_origins=["*"]；正式對外可縮小為指定網域。 |
| **輸入驗證** | 對 message、user_id 長度與字元做限制，避免濫用或注入。 |

### 3. 使用體驗

| 項目 | 說明 |
|------|------|
| **Demo 頁** | brain-api-demo 可顯示「當前用量/額度」、錯誤時重試按鈕。 |
| **登入頁** | 可加「忘記密碼」流程（若帳號來源改為 DB 再做）。 |
| **錯誤訊息** | 客戶端可依統一錯誤格式顯示友善訊息（如「額度已用盡」）。 |

### 4. 文件與範例

| 項目 | 說明 |
|------|------|
| **接入範例** | 已有多端點說明；可補「各語言」最小範例（Python、JS、curl）。 |
| **環境變數總表** | .env.example 已有；可單獨一頁「部署必設 / 選設」清單。 |

---

## 三、建議優先順序（依目標）

### 若目標是「先讓多套軟件/APP 穩定接入」

1. **API 呼叫日誌**（誰、何時、哪個端點）— 利於除錯與稽核。  
2. **健康檢查擴充**（依賴狀態）— 維運時快速判斷問題。  
3. **備份排程**（含 Chroma）— 資料不丟失。  
4. **簡單 API 測試**（/health、/login、/compute）— 部署或改版後快速驗證。

### 若目標是「盡快支援訂閱制」

1. **依 user_id / API Key 的用量統計**（擴充 ai_cost_tracker 或 DB）。  
2. **方案額度檢查**（呼叫前檢查該用戶/Key 是否超額）。  
3. **依用戶/Key 的限流**（取代或補足現有依 IP 限流）。  
4. **Session 持久化**（Redis 或 DB）— 避免重啟全員重登。

### 若目標是「先優化體驗與安全」

1. **密碼一律 hash、CORS 縮小、輸入驗證**。  
2. **Demo 頁顯示用量/額度、錯誤重試**。  
3. **OpenAPI 文件補齊說明與範例**。

---

## 四、小結

| 類別 | 還缺什麼 | 可優化 |
|------|----------|--------|
| **商用訂閱** | 方案分級、依用戶用量與額度、計費/帳單、授權驗證 | — |
| **認證與安全** | Session 持久化、API Key 輪換、依用戶限流 | 密碼僅 hash、CORS、輸入驗證 |
| **維運** | API 日誌、依賴健康、告警、備份排程 | — |
| **介面** | API 版本路徑、統一錯誤碼 | OpenAPI 說明與範例 |
| **品質** | API 自動化 / smoke 測試 | — |
| **效能與體驗** | — | 快取、Demo 用量顯示、錯誤重試 |

目前**已有**：統一 API、認證（Key + 帳密 Session）、全站預算與用量追蹤、遠端/本地部署、產品架構與上架說明。  
依「先接入、再訂閱、再優化」的順序，從上面優先順序挑幾項做，大系統就會更完整、更利於商用化。
