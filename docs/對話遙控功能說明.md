# 對話遙控功能說明

## 概述

對話遙控（Conversational Remote）是一個讓使用者透過自然語言對話來控制本地電腦的系統。無需觀看螢幕，像聊天一樣發送指令即可執行開啟軟體、執行命令等操作。

## 存取方式

- **本地測試**: http://localhost:8002/chat-remote
- **正式環境**: https://zhe-wei.net/chat-remote

## API 端點

### 1. 執行對話遙控

```http
POST /api/chat/remote
Content-Type: application/json

{
  "message": "開啟記事本",
  "execute": true,
  "provider": "gemini"
}
```

**參數說明**:
- `message`: 自然語言指令（必填）
- `execute`: 是否執行動作，預設 `true`
- `provider`: LLM 供應商，預設 `gemini`

**回應**:
```json
{
  "ok": true,
  "response": "✅ 已完成 1 個步驟，耗時 2.61 秒。",
  "result": {
    "success": true,
    "steps_executed": 1,
    "parsed": {
      "intent": "開啟記事本",
      "type": "open_app",
      "plan": [{"action": "open_app", "target": "notepad"}]
    }
  }
}
```

### 2. 取得對話歷史

```http
GET /api/chat/remote/history?limit=20
```

### 3. 清除對話歷史

```http
POST /api/chat/remote/clear
```

### 4. 取得系統狀態

```http
GET /api/chat/remote/status
```

## 支援的指令

### 開啟軟體

| 指令範例 | 目標程式 |
|---------|---------|
| 開啟記事本 | notepad |
| 開啟計算機 | calc |
| 開啟檔案總管 | explorer |
| 開啟Chrome瀏覽器 | chrome |
| 開啟Edge | edge |
| 開啟VSCode | code |
| 開啟Word | winword |
| 開啟Excel | excel |
| 開啟PowerPoint | powerpoint |
| 開啟Terminal | cmd |
| 開啟PowerShell | powershell |

### 執行命令

| 指令範例 | 執行動作 |
|---------|---------|
| 執行dir命令 | 執行 dir 命令 |
| 列出檔案 | 執行 dir 命令 |
| 執行ipconfig | 執行 ipconfig 命令 |

### 系統狀態查詢

| 指令範例 | 功能 |
|---------|------|
| 檢查系統狀態 | 取得 CPU、記憶體、視窗數量等資訊 |
| 系統狀態 | 同上 |

## 系統架構

```
用戶輸入 → API 端點 → ConversationalRemote
                         ↓
                  _parse_conversational (LLM 解析)
                         ↓
                  SmartRemoteAgent._parse_instruction (任務規劃)
                         ↓
                  _execute_step (執行步驟)
                         ↓
                  Host API (本地執行)
```

## 核心檔案

| 檔案 | 功能 |
|-----|------|
| `scripts/conversational_remote.py` | 對話遙控主程式 |
| `scripts/smart_remote_agent.py` | 智慧遙控代理 |
| `scripts/host_api.py` | 本地主機 API |
| `brain_workspace/static/chat-remote.html` | 前端介面 |
| `brain_server.py` | API 端點路由 |

## 故障排除

### 問題: 返回 "未知動作: execute"

**原因**: `_parse_instruction` 的 fallback 產生 `action: "execute"`，但 `_execute_step` 沒有處理。

**解決**: 已修復，fallback 會智慧解析常見軟體名稱。

### 問題: Brain Server 返回空值

**原因**: Docker 容器未更新。

**解決**: 
```bash
docker compose down brain_server
docker compose build --no-cache brain_server
docker compose up -d brain_server
```

### 問題: Host API 未運行

**解決**: 啟動 Host API
```bash
python scripts/host_api.py
```

## 部署到正式環境

1. 確保 Docker Desktop 運行
2. 執行部署指令:
```bash
docker compose down
docker compose build --no-cache
docker compose up -d
```

3. 驗證:
```bash
curl http://localhost:8002/api/chat/remote -X POST -d '{"message":"開啟記事本","execute":true}'
```

## 監控

- 健康檢查: http://localhost:8002/health
- 用量儀表板: http://localhost:8002/usage-dashboard
