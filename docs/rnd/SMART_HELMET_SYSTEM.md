# 智慧安全帽系統 — 待研發規劃

> 狀態：**待研發** | 建立日期：2026-02-27

---

## 系統概述

ESP32 LoRa 開發板 + OLED + 擴音 + LED 警示，安裝於安全帽上，透過 LoRa 無線電與工務所 AI 伺服器通訊。支援：

- 總機個別/廣播推播語音提醒
- AI 攝影機偵測危險 → 主動推播到指定帽子
- SOS 一鍵求救 + 人員心跳追蹤
- 水情警報系統整合（撤離廣播）

---

## 硬體方案

### 推薦開發板

| 產品 | 價格(TWD) | 特色 |
|------|-----------|------|
| **Heltec WiFi LoRa 32 V3** | $400~550 | LoRa + WiFi + BLE + 0.96" OLED 全內建 |
| LILYGO T3-S3 LoRa | $500~700 | ESP32-S3 + LoRa + OLED + Type-C |
| LILYGO T-Beam Supreme | $800~1,100 | LoRa + GPS + 18650 電池座 |

### 擴充模組

| 模組 | 功能 | 價格 |
|------|------|------|
| MAX98357 I2S 擴音板 | 喇叭輸出 | $60~100 |
| 3W 小型喇叭 40mm | 噪音環境播放 | $30~50 |
| 震動馬達 3V 微型 | 觸覺回饋 | $15~30 |
| WS2812 LED ×3 | 紅/黃/綠警示燈 | $20~40 |
| 微動開關 | SOS 按鈕 | $10 |

### 供電方案

| 方案 | 電池 | 太陽能 | 總重 | 續航 | 成本 |
|------|------|--------|------|------|------|
| 室內/隧道 | 2500mAh LiPo | 無 | ~90g | 22hr | $100 |
| 室外工地（推薦） | 1800mAh LiPo | 1W 軟性面板 | ~95g | 24hr+ | $160 |
| 長時間值班 | 4000mAh LiPo | 2.5W 面板 | ~140g | 36hr+ | $260 |

### 單台原型成本

| 項目 | 金額 |
|------|------|
| Heltec WiFi LoRa 32 V3 | $450 |
| 505060 LiPo 2500mAh 3.7V | $100 |
| TP4056 Type-C 充放電模組 | $15 |
| 5V/1W 軟性太陽能板 | $60 |
| MAX98357 I2S 擴音板 | $80 |
| 3W 小型喇叭 40mm | $30 |
| 震動馬達 3V 微型 | $15 |
| WS2812 LED ×3 | $20 |
| 微動開關（SOS） | $10 |
| **合計** | **$780** |

### 重量分析（CNS 安全帽上限 500g）

- 標準安全帽：300~400g
- 模組總重：~130g
- 含帽總重：~480g ✅ 在規範內

---

## 通訊架構

```
築未 AI 伺服器（工務所）
    │
LoRa Gateway (SX1276 / ESP32)     ← 複用 water_alert/lora_gateway.py
    │ LoRa 915MHz
    │ 室外 1~5km
    ├──→ 🪖 帽-01 (addr=0x10) ── 工頭
    ├──→ 🪖 帽-02 (addr=0x11) ── 鋼筋工
    ├──→ 🪖 帽-03 (addr=0x12) ── 板模工
    │         │
    │         └── Mesh 中繼 ──→ 🪖 帽-04（死角區域）
    │
    └──→ 📱 Android 手機（WiFi 近距離控制）
```

### LoRa 封包協定（擴充現有 water_alert/lora_gateway.py）

```python
MSG_TYPES = {
    0x01: "sensor_data",      # 既有：水位/溫濕度
    0x02: "alert",            # 既有：警報
    # ─── 新增：安全帽 ───
    0x10: "helmet_text",      # 文字訊息 → OLED 顯示
    0x11: "helmet_alert",     # 警報等級 → LED + 蜂鳴 + 震動
    0x12: "helmet_voice",     # 預錄語音編號 → 喇叭播放
    0x13: "helmet_sos",       # 帽端 → 總站：SOS 求救
    0x14: "helmet_heartbeat", # 帽端 → 總站：存活 + 電量
}
```

---

## 功能模組

### 帽端功能

```
🪖 智慧安全帽模組
├── 📺 OLED 顯示：訊息/天氣/警報等級/電量/信號
├── 🔊 擴音：蜂鳴警報(4級) + 預錄語音 + 提示音
├── 💡 LED 警示：綠=安全 / 黃=注意 / 紅閃=撤離
├── 📳 震動：噪音環境觸覺提醒
├── 🆘 SOS 按鈕：一鍵求救
└── 📡 LoRa：接收指令 + 發送心跳/SOS + Mesh 中繼
```

### 預錄語音庫（帽端 Flash 存儲，節省 LoRa 頻寬）

| ID | 語音內容 | 觸發條件 |
|----|----------|----------|
| 01 | 請戴上安全帽 | YOLOv8 偵測 |
| 02 | 請穿上反光背心 | YOLOv8 偵測 |
| 03 | 注意頭頂吊掛物 | 吊車作業區 |
| 04 | 水位警戒，請往高處移動 | 水情等級 ≥ 2 |
| 05 | 立即撤離！ | 水情等級 ≥ 4 |
| 06 | 休息時間到，請補充水分 | 定時（夏季每 2hr） |
| 07 | 監造到場，請準備 | 工頭手動 |
| 08 | 收到新訊息，請查看螢幕 | 文字訊息 |

### 深度睡眠省電策略

```
正常模式：每 30 秒喚醒 → 監聽 LoRa 3 秒 → 無訊息 → 深度睡眠
平均電流 ≈ 20~30mA → 2500mAh 電池可撐 80~120hr（3~5天）
加太陽能板 → 理論上一週不充電
```

---

## AI 攝影機 + 帽子整合場景

### 場景 1：AI 主動偵測推播

```
📷 RTSP 攝影機 (每5秒抽幀)
    → YOLOv8 偵測（未戴帽/未穿背心/禁區入侵）
    → construction_brain/safety_engine.py 判斷
    → LoRa 推播到指定帽子
```

### 場景 2：總機個別推播語音

```
工頭 PWA → 選擇帽子 → 輸入文字
    → brain_server API
    → LoRa Gateway → 定向發送
    → 帽端 OLED 顯示 + 喇叭播放
    → 工人按確認 → LoRa 回傳「已讀」
```

### 場景 3：RSSI 三角定位

```
帽端 LoRa 心跳包（每 30 秒）
    → 多 Gateway 接收 RSSI
    → 三角定位估算位置
    → 比對攝影機畫面中的人員
    → 精準推播到正確的帽子
```

---

## 預計 API 端點（helmet_service.py）

| 方法 | 端點 | 功能 |
|------|------|------|
| POST | /api/helmet/send | 推送訊息到指定帽子 |
| POST | /api/helmet/broadcast | 全員廣播 |
| POST | /api/helmet/voice | 推送語音到指定帽子 |
| GET | /api/helmet/status | 所有帽子狀態 |
| GET | /api/helmet/locations | 帽子位置估算 |
| POST | /api/helmet/alert | AI 觸發警報 |
| GET | /api/helmet/sos | SOS 記錄列表 |

---

## 整合現有模組

| 模組 | 整合方式 |
|------|----------|
| `water_alert/lora_gateway.py` | 擴充封包協定，新增安全帽訊息類型 |
| `water_alert/flood_decision_engine.py` | 水情等級 ≥ 2 觸發帽端警報 |
| `construction_brain/safety_engine.py` | YOLOv8 偵測結果觸發帽端推播 |
| `vision.zhe-wei.net` (YOLOv8) | RTSP 攝影機抽幀偵測 |
| Ntfy 推播 | 同時推送到工頭手機 |
| `phone_agent.py` | 手機控制 + 帽子控制統一管理 |

---

## 執行計畫

| 階段 | 內容 | 時間 | 成本 |
|------|------|------|------|
| 1. 原型驗證 | 買 2 片 Heltec LoRa V3 + 擴音板，跑通收發 | 1~2 週 | $1,200 |
| 2. 帽端韌體 | Arduino/MicroPython 寫 ESP32 程式 | 1~2 週 | $0 |
| 3. Gateway 整合 | 擴充 lora_gateway.py 安全帽封包 | 2~3 天 | $0 |
| 4. 後端服務 | helmet_service.py FastAPI + AI 觸發 | 1 週 | $0 |
| 5. 外殼設計 | 3D 列印安全帽卡扣模組 | 3~5 天 | $200 |
| 6. 小量測試 | 5~10 台部署到工地測試 | 1 週 | $5,000~8,000 |

---

## 採購清單（原型 2 台）

| # | 品名 | 數量 | 單價 | 小計 |
|---|------|------|------|------|
| 1 | Heltec WiFi LoRa 32 V3 (915MHz) | 2 | $450 | $900 |
| 2 | MAX98357 I2S 擴音板 | 1 | $80 | $80 |
| 3 | 3W 喇叭 40mm | 1 | $30 | $30 |
| 4 | 505060 LiPo 2500mAh 3.7V (JST) | 1 | $100 | $100 |
| 5 | TP4056 Type-C 充放電模組 | 1 | $15 | $15 |
| 6 | 5V/1W 軟性太陽能板 | 1 | $60 | $60 |
| 7 | 杜邦線/麵包板 | 1組 | $50 | $50 |
| | **合計** | | | **$1,235** |

蝦皮搜尋關鍵字：`Heltec LoRa V3 915`、`MAX98357 I2S`、`3.7V 鋰聚合物 2500mAh JST`

---

## 商業價值

- **AI 主動安全**：攝影機 + AI 自動偵測推播，不需人盯
- **個別通訊**：取代對講機，精準傳達
- **零月費**：LoRa 免執照免 SIM
- **已讀回報**：確認工人收到指令
- **SOS 求救**：工安事故第一時間反應
- **人員追蹤**：RSSI 定位知道誰在哪
- **全系統整合**：水情 + 工安 + 進度 + 通訊一站式
