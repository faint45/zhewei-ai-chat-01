# 築未科技 — 佈署指南

## 一、本地佈署（最低門檻）

### 1. 前置條件

- Python 3.10+，已安裝 `requirements-brain.txt`：`pip install -r requirements-brain.txt`
- （可選）Z 槽已掛載或 Rclone 可自動掛載；未掛載時預檢會嘗試喚醒 Rclone

### 2. 一鍵啟動（推薦）

在專案根目錄執行：

```batch
啟動_築未科技大腦_2.1版.bat
```

會依序：環境診斷 → 守護進程 (guardian_master) → WebSocket 服務 (brain_server, Port 8000) → 邊緣監控 (site_monitor)。

### 3. 僅啟動大腦（無守護、無監控）

```powershell
cd c:\Users\user\Desktop\zhe-wei-tech
python startup_diagnostics.py
python brain_server.py
```

或直接（略過診斷）：`python brain_server.py`。服務位址：`http://<本機IP>:8000`，`/health` 健康檢查。

---

## 二、D 槽對齊（全系統依架構守則）

依 `brain_workspace/DEPLOY.md`：

1. 將 `brain_workspace` 複製到 `D:\brain_workspace`，或於 D 槽建立 `input`、`processed`、`models` 並放入 `vision_worker.py`、`report_tools.py`、`site_monitor.py`、`start_all.ps1`。
2. 視覺用 Python 3.12 虛擬環境：`D:\brain_workspace` 下 `py -3.12 -m venv venv_vision`，啟用後 `pip install ultralytics torch`。
3. 全系統啟動：`cd D:\brain_workspace` → `.\start_all.ps1`。

主腦仍可從專案根目錄執行 `python brain_server.py`（或複製必要檔到 D 槽後從 D 槽執行）。

---

## 三、Windows 服務佈署（開機自動）

1. 安裝 NSSM：將 `nssm.exe` 置於 `C:\tools\nssm\`（或修改批次檔內 `NSSM` 路徑）。
2. **以系統管理員身分**執行：`安装築未大腦服務.bat`。
3. 服務名稱：`ZheweiBrain`，執行：`python brain_server.py`，工作目錄為專案根目錄。
4. 卸載：`卸載築未大腦服務.bat`（需管理員）。

---

## 四、Docker 佈署

```bash
docker build -t zhewei-brain .
docker run -p 8000:8000 --env-file .env zhewei-brain
```

映像內執行 `python brain_server.py`，端口 8000。若需掛載 D/Z 槽或本地目錄，請在 `docker run` 加上 `-v` 參數。

---

## 五、Render 雲端佈署

1. Render Dashboard → New → Blueprint → 連 GitHub 選此專案，指向 `render.yaml`。
2. 部署後在 Environment 設定：`GEMINI_API_KEY`、`AUTH_USERS`、`BRAIN_BRIDGE_API_KEY`、`BRAIN_BRIDGE_PORT`（可選）。
3. **注意**：`render.yaml` 目前指定 `brain_bridge_fastapi:app` 與 `requirements.txt`；專案內若尚無 `brain_bridge_fastapi` 模組，需先實作或改為 `brain_server:app` 並使用 `requirements-brain.txt`，否則建置會失敗。

---

## 六、Docker Compose（大腦 + Cloudflare Tunnel）

專案根目錄 `docker-compose.yml` 提供：

- **brain_server**：築未大腦核心，port 8000，掛載 `D:/brain_workspace` → `/app`、`Z:/Zhewei_Brain` → `/memory`。
- **tunnel**：Cloudflare cloudflared，以 `CLOUDFLARE_TOKEN` 跑加密隧道。

啟動：`docker compose up -d`。需在 `.env` 設定 `CLOUDFLARE_TOKEN`（見下方七、隧道設定）。

---

## 七、Cloudflare Tunnel（對外入口 brain.zhe-wei.net）

隧道將地端 FastAPI（localhost:8000）對外暴露為 **https://brain.zhe-wei.net**。

### 7.1 第一步：Cloudflare 端點映射 (Public Hostname)

在 Cloudflare Zero Trust 控制台將網域指向本地服務：

1. 導航至 **Networks > Tunnels**，選擇你建立的 **Zhewei_Brain_Home** 隧道。
2. 點擊 **Configure > Public Hostname > Add a public hostname**。
3. 設定內容：

| 項目 | 輸入內容 | 說明 |
|------|----------|------|
| **Subdomain** | brain | 入口為 brain.zhe-wei.net |
| **Domain** | zhe-wei.net | 選擇已加入 Cloudflare 的網域 |
| **Service Type** | HTTP | 內部通訊使用 HTTP 即可 |
| **URL** | localhost:8000 | 對應 brain_server.py 的埠口 |

### 7.2 第二步：開啟雲端 WebSocket 開關

此步驟若未做，遠端連線會被 Cloudflare 阻斷：

1. 回到 **Cloudflare 主儀表板**（非 Zero Trust 介面）。
2. 選擇 **zhe-wei.net** 網域。
3. 點擊左側選單 **Network（網路）**。
4. 找到 **WebSockets** 選項，將其切換為 **On（開啟）**。

管理介面 `brain_workspace/static/index.html` 已改為依頁面協議自動使用 **ws**（地端）或 **wss**（透過 https 存取時），無須手動改網址。

### 7.3 使用方式

- **Docker Compose**：`docker compose up -d` 會啟動 brain_server 與 tunnel；tunnel 使用 `.env` 內 `CLOUDFLARE_TOKEN`（建立隧道時由 Cloudflare 提供）。
- **本機僅 tunnel**：先確保 `python brain_server.py` 或 Windows 服務已在 8000 埠運行，再執行 `cloudflared tunnel --no-autoupdate run --token <你的TOKEN>`，或使用設定檔：複製 `cloudflared-config.yml.example` 為 `cloudflared-config.yml`，填入 tunnel ID 與 credentials-file 後執行 `cloudflared tunnel --config cloudflared-config.yml run`。

對外存取：`https://brain.zhe-wei.net`（根路由、`/health`、`/static/index.html`、`/ws` WebSocket）。

### 7.4 存取政策（Ah-Kai-Only）

於 Cloudflare Zero Trust / Access 建立政策，僅允許指定信箱以 OTP 登入：

| 項目 | 設定 | 說明 |
|------|------|------|
| **政策名稱** | Ah-Kai-Only | 僅限本人存取 |
| **包含條件 (Include)** | Emails | 輸入個人電子信箱 |
| **認證方式** | One-time PIN (OTP) | 開啟一次性驗證碼 |

效果：無論在哪個工地，只要輸入信箱收到的驗證碼即可通過；在連線延遲低於 $50\,\mathrm{ms}$ 的狀態下開始與大腦對話。

---

## 八、佈署方式對照

| 方式 | 適用情境 | 前置 |
|------|----------|------|
| 一鍵啟動 .bat | 本機開發／演示 | Python + 依賴、可選 Z 槽 |
| D 槽對齊 + start_all.ps1 | 全系統（主腦+視覺+監控） | D:\brain_workspace、venv_vision |
| Windows 服務 | 本機常駐、開機自啟 | NSSM、管理員 |
| Docker | 隔離環境、一致埠位 | Docker、.env |
| Docker Compose + Tunnel | 地端大腦 + 對外 https | Docker、.env、CLOUDFLARE_TOKEN |
| Render | 雲端 API | brain_bridge_fastapi 或改 yaml |

---

*佈署時請遵守 `架構守則` 與 `全系統架構鎖定規則`（D/Z 分流、agent_tools 213–234 行、report_generator 分流路徑）。*
