# 築未科技大腦 — 建置狀況與交接清單

**日期**：2026-02-08  
**狀態**：Docker 容器已停止；本機 brain_server 可獨立運行。

---

## 一、目前建置狀況

### 1.1 已停止項目

| 項目 | 說明 |
|------|------|
| **Docker Compose** | 已執行 `docker compose down`，brain_server（容器名 zhewei_brain）、tunnel 已停止 |

### 1.2 核心組件狀態（程式碼就緒）

| 組件 | 檔案 | 狀態 |
|------|------|------|
| 入口服務 | brain_server.py | ✅ 就緒（/、/health、/static、/ws、CORS、進度廣播） |
| 決策中樞 | agent_logic.py | ✅ 就緒（8 階段、引擎分流、11 工具含新三項） |
| 工具箱 | agent_tools.py | ✅ 就緒（路徑限 D/Z、run_vision_engine 鎖定） |
| AI 引擎 | ai_service.py | ✅ 就緒（Gemini + Ollama） |
| 報表 | report_generator.py | ✅ 就緒（影像 JSONL/CSV、語音 Markdown、LaTeX） |
| 視覺 | brain_workspace/vision_worker.py | ✅ 就緒 |
| 管理介面 | brain_workspace/static/index.html | ✅ 就緒（Vue 3、ws/wss 自動、快截、代理人輪詢） |

### 1.3 佈署與對外

| 項目 | 狀態 |
|------|------|
| **DNS** | brain.zhe-wei.net → CNAME 9d65a17a-9915-475b-9499-7508e457d0e1.cfargotunnel.com ✅ |
| **Cloudflare Tunnel** | Token 已設於 .env；容器停止時無法從外網連線 |
| **本機 8000** | 可透過 `python brain_server.py` 或 Windows 服務 ZheweiBrain 提供 |

---

## 二、交接清單（接手者必讀）

### 2.1 環境與依賴

- [ ] **Python 3.10+**，已安裝 `pip install -r requirements-brain.txt`
- [ ] **.env**：專案根目錄需有 `.env`（可複製 `.env.example`），至少設定：
  - `CLOUDFLARE_TOKEN`（Docker tunnel 用）
  - `GEMINI_API_KEY`（可選，有則用 Gemini）
- [ ] **Ollama**（可選）：本機 `http://localhost:11434` 若已安裝，地端檢核可用
- [ ] **D 槽**（可選）：有 `D:\brain_workspace` 時可掛載；無則 docker-compose 已改為 `.:/app`、`./zhewei_memory:/memory`
- [ ] **Z 槽**（可選）：有 Rclone 掛載 `Z:\Zhewei_Brain` 時，報表與長期記憶寫 Z 槽；無則用 `./zhewei_memory`

### 2.2 啟動方式（擇一）

| 方式 | 指令／步驟 |
|------|------------|
| **本機僅大腦** | `cd c:\Users\user\Desktop\zhe-wei-tech` → `python brain_server.py` |
| **本機 + 診斷** | `python startup_diagnostics.py` → `python brain_server.py` |
| **Windows 服務** | 以系統管理員執行 `安装築未大腦服務.bat`（需 NSSM） |
| **Docker Compose** | `.env` 有 `CLOUDFLARE_TOKEN` → `docker compose up -d` |
| **一鍵佈署** | 執行 `一鍵完整佈署.bat`，選 1 本機 / 2 Docker / 3 僅診斷 |

### 2.3 停止方式

| 方式 | 指令 |
|------|------|
| **Docker Compose** | `cd c:\Users\user\Desktop\zhe-wei-tech` → `docker compose down` |
| **Windows 服務** | `nssm stop ZheweiBrain` 或 卸載築未大腦服務.bat |

### 2.4 測試指令

| 項目 | 指令 |
|------|------|
| 環境診斷 | `python startup_diagnostics.py` |
| brain_server 健康與靜態 | 先啟動 brain_server，再 `python scripts/test_brain_server.py` |

### 2.5 對外網址（需 tunnel 運行）

- **https://brain.zhe-wei.net** — 根路由
- **https://brain.zhe-wei.net/health** — 健康檢查
- **https://brain.zhe-wei.net/static/index.html** — 管理介面

---

## 三、關鍵檔案一覽

| 類別 | 檔案 | 用途 |
|------|------|------|
| **入口** | brain_server.py | FastAPI、CORS、/static、/ws、進度廣播、/api/progress、/api/agents |
| **邏輯** | agent_logic.py | AgentManager、8 階段、引擎分流、ReAct、SYSTEM_PROMPT |
| **工具** | agent_tools.py | TOOLS 11 項、_path_allowed、run_vision_engine（鎖定） |
| **佈署** | docker-compose.yml | brain_server + tunnel；volume 為 .:/app、./zhewei_memory:/memory |
| **佈署** | Dockerfile | python:3.12-slim、libgl1+libglib2.0-0、brain_server.py |
| **管理介面** | brain_workspace/static/index.html | Vue 3、ws/wss 自動、LaTeX 進度、快截、/api/agents 輪詢 |
| **排查** | brain.zhe-wei.net_無法登入排查.md | DNS 1033、Error 1033、Access OTP、WebSocket |
| **佈署說明** | 佈署指南.md | 本地、D 槽、服務、Docker、Tunnel、Access |
| **快速指令** | 佈署指令_快速複製.md | 三種佈署指令可複製 |
| **一鍵佈署** | 一鍵完整佈署.bat | 三種模式：本機 / Docker / 僅診斷；Docker 會檢查 .env、建置、啟動、驗證 |
| **本地手腳** | 執行_單次任務.bat、執行_視覺與報表.bat、scripts/run_workflow_step.py | 雙擊或 CLI 執行單次任務、運算、生成；見 本地手腳說明.md |

---

## 四、已知問題與待辦（交接後可處理）

| 項目 | 說明 |
|------|------|
| **brain.zhe-wei.net 顯示 "unable to handle this request"** | 曾發生於 Docker 運行時；已改 volume 為 `.:/app`、`./zhewei_memory:/memory`。若再發生，請執行 `docker compose logs brain_server` 查看錯誤（服務名為 brain_server，容器名為 zhewei_brain）。 |
| **CLOUDFLARE_TOKEN 未設** | `.env` 未建或未含 `CLOUDFLARE_TOKEN` 時，tunnel 無法連線，外網會 Error 1033。 |
| **preflight_check 編碼** | Windows cp950 主控台已避免 emoji，改為 [OK]/[X]/[*] 等。 |

---

## 五、文件索引（交接可一併交付）

| 文件 | 用途 |
|------|------|
| 各項工作流完成說明.md | 編碼、撰寫、運算、分配、執行、回饋、生成 — 由誰完成、用何工具、產出何處 |
| 本地手腳說明.md | 本地執行入口：run_workflow_step.py、執行_單次任務.bat、執行_視覺與報表.bat |
| 需求到完成八階段流程.md | 八階段定義、對應組件、與通用執行引擎對照 |
| 系統運作方式彙整.md | 架構、組件、請求流程、鎖定項 |
| 佈署指南.md | 本地、D 槽、服務、Docker、Tunnel、Access、DNS |
| 佈署指令_快速複製.md | 三種佈署指令 |
| brain.zhe-wei.net_無法登入排查.md | DNS / 1033 / Access / WebSocket 排查 |
| 系統完整度彙整與優化建議_2026-02-08.md | 完整度、測試、優化建議 |
| 全系統功能測試報告_2026-02-05.md | 環境檢查、驗證鏈條、行號對照 |
| 交接清單_2026-02-08.md | 本文件 |

---

**交接完成後**：請依「二、交接清單」勾選環境與依賴，並以「二、啟動方式」任選一種啟動；對外需 https://brain.zhe-wei.net 時，請確保 `.env` 有 `CLOUDFLARE_TOKEN` 並執行 `docker compose up -d`。
