# 築未科技 — 系統完整度彙整與優化建議

**彙整日期**：2026-02-08  
**範圍**：全系統完整度檢視、測試與修復、優化建議。

---

## 一、系統完整度總覽

### 1.1 核心組件與狀態

| 組件 | 檔案 | 狀態 | 備註 |
|------|------|------|------|
| **入口服務** | brain_server.py | ✅ 就緒 | /、/health、/static、/ws；靜態目錄支援本機 fallback |
| **決策中樞** | agent_logic.py | ✅ 就緒 | 8 階段、引擎分流、SYSTEM_PROMPT 已含新工具 |
| **工具箱** | agent_tools.py | ✅ 就緒 | 11 工具含 generate_media、deploy_service、update_web_admin；路徑限 D/Z |
| **AI 引擎** | ai_service.py | ✅ 就緒 | Gemini + Ollama |
| **報表** | report_generator.py | ✅ 就緒 | 影像 JSONL/CSV、語音 Markdown；LaTeX 進度 |
| **視覺** | brain_workspace/vision_worker.py | ✅ 就緒 | YOLOv8，由 run_vision_engine 呼叫 |
| **管理介面** | brain_workspace/static/index.html | ✅ 就緒 | Vue 3、WebSocket、日誌/進度/代理人狀態；已修 content/result 與連線檢查 |

### 1.2 工具註冊一覽（agent_tools.TOOLS）

| 工具名 | 用途 |
|--------|------|
| run_command | 執行系統指令（cwd 限 D/Z） |
| read_file / write_file / list_dir | 檔案與目錄（路徑限 D/Z） |
| vision_analyze | 本機 YOLOv8 辨識（可選） |
| run_vision_engine | **鎖定** 跨環境 3.12 venv_vision 視覺引擎 |
| manage_construction_log | 寫入 Z 槽 Daily_Report.md |
| generate_progress_report | 影像報表 → Z 槽 JSONL + CSV |
| generate_voice_report | 語音報表 → Z 槽 Daily_Voice_Logs.md（async） |
| **generate_media** | 影像/影片生成 → D:\\brain_workspace\\output（預留 API） |
| **deploy_service** | 佈署指令（如 nssm start）（預留） |
| **update_web_admin** | 即時進度同步 → D 槽 web_admin_progress.json 或後台（預留） |

### 1.3 鎖定與禁止修改項（已遵守）

- agent_tools.py **run_vision_engine** 跨環境呼叫邏輯不變。
- report_generator.py 影像/語音報表分流路徑不變。
- D/Z 分流架構不變；代碼更新為完整覆蓋。

---

## 二、本輪測試與修復

### 2.1 已執行測試

| 項目 | 結果 | 說明 |
|------|------|------|
| startup_diagnostics.py | ✅ 通過 | Z 槽、Python、核心檔案、依賴、目錄、Port 8000 |
| agent_logic + agent_tools 匯入 | ✅ 通過 | TOOLS 含 11 項；generate_media/deploy_service/update_web_admin 已註冊 |
| brain_server /health、/ | ✅ 通過 | 200，含 status / healthy |
| brain_server /static/index.html | ✅ 已修 | 本機無 D 槽 static 時改為專案 brain_workspace/static |

### 2.2 本輪修復項目

1. **agent_logic.py**  
   - SYSTEM_PROMPT 補上 `generate_media`、`deploy_service`、`update_web_admin`，使 AI 可呼叫三項新工具。

2. **brain_workspace/static/index.html**  
   - 日誌顯示改為 `log.content || log.result || ''`，兼容 step/result 等訊息。  
   - 發送前檢查 `socket.readyState === WebSocket.OPEN`，未連線時提示錯誤。  
   - 日誌項改用 index 為 key，避免重複 time 導致 Vue 警告。

3. **brain_server.py**  
   - 靜態目錄：當 `BRAIN_WORKSPACE/static` 不存在或無 `index.html` 時，改為使用 `ROOT/brain_workspace/static`，本機開發可直接開啟 `/static/index.html`。

4. **agent_tools.py**  
   - 模組 docstring 中 `\%` 改為 `\\%`，消除 SyntaxWarning。

### 2.3 測試腳本

- **scripts/test_brain_server.py**（新增）  
  - 驗證 `GET /health`、`GET /`、`GET /static/index.html`。  
  - 使用方式：先啟動 `python brain_server.py`，再執行 `python scripts/test_brain_server.py`。  
  - 若曾修改 brain_server 靜態目錄邏輯，需**重啟 brain_server** 後再跑測試，`/static/index.html` 才會通過。  
  - 預設 BASE_URL=`http://127.0.0.1:8000`，可設環境變數 `BRAIN_SERVER_URL` 覆寫。

---

## 三、建議優化（依優先順序）

### 3.1 高優先：接線與營運

1. **generate_media 實際 API**  
   - 對接 Jimeng 或 Grok API，將產出寫入 `D:\brain_workspace\output`，回傳路徑或錯誤訊息。  
   - 目前為 stub（建立空檔並回傳路徑）。

2. **update_web_admin 與網頁同步**  
   - 選項 A：brain_server 訂閱/讀取 `D:\brain_workspace\output\web_admin_progress.json`，經 WebSocket 廣播給所有連線的管理介面。  
   - 選項 B：階段完成時在 agent_logic 內呼叫 `update_web_admin(進度 LaTeX)`，再由後台輪詢或 WS 推播。  
   - 管理介面可解析推送中的 `content`，若含 `$數字\%$` 則更新「當前總進度」。

3. **deploy_service 實際指令**  
   - 確認 nssm 路徑（如 `C:\tools\nssm\nssm.exe`）或改用批次檔白名單（僅允許 D/Z 下或固定目錄），避免任意指令執行。

### 3.2 中優先：體驗與可維護性

4. **管理介面進度顯示**  
   - 目前 step 時以 `logs.length * 10` 估算進度；建議改為解析伺服端推送的 `content` 內 LaTeX（如 `$95\%$`）再更新 `latexProgress`。

5. **常用工具快截按鈕**  
   - 「產出影像報表」「重啟 Ollama」「打開 Cursor」可綁定實際行為：  
     - 產出報表：透過 WebSocket 發送 `{ "text": "列出 input 目錄並產出今日影像報表" }` 等固定指令。  
     - 重啟 Ollama：可呼叫 deploy_service 或 run_command（需限制路徑/白名單）。

6. **健康檢查格式統一**  
   - 目前 /health 回傳 `{"status": "healthy", "engine": "i7-14700-Core"}`；若需與既有監控或 bridge 相容，可保留或增加 `ok: true`、`service: "zhewei_brain"` 等欄位。

### 3.3 低優先：長期

7. **代理人狀態真實化**  
   - 管理介面左欄「Gemini Admin / Claude Dev / Ollama Local / Media Gen」目前為靜態。可改為由 brain_server 或 agent_logic 回報各引擎可用性（例如 ping Ollama、檢查 API key），再經 WS 推播。

8. **E2E 自動化**  
   - 在 Z 槽與 D:\\brain_workspace 就緒、且具備 test.jpg 的環境下，新增一則「影像分析＋報表」E2E 測試（含 run_vision_engine → generate_progress_report → Z 槽寫入驗證）。

9. **日誌與追蹤**  
   - 關鍵步驟（含工具呼叫、報表寫入、update_web_admin）寫入 D 槽或 Z 槽日誌，方便除錯與稽核。

---

## 四、文件與啟動檢查清單

- **系統運作方式彙整.md**：已涵蓋架構、組件、請求流程、鎖定項；可補「網頁管理介面」一節（路徑 `D:\brain_workspace\static\index.html` 或本機 fallback、/static 掛載）。
- **全系統功能測試報告_2026-02-05.md**：仍適用；本報告為 2026-02-08 完整度與優化補充。
- **啟動前**：執行 `python startup_diagnostics.py`；啟動服務後執行 `python scripts/test_brain_server.py` 驗證 /health、/、/static/index.html。

---

## 五、總結

| 項目 | 狀態 |
|------|------|
| 核心伺服器與管理網頁 | ✅ 就緒；靜態目錄已支援本機 fallback |
| 影像／佈署／網頁後台三工具 | ✅ 已註冊並納入 SYSTEM_PROMPT；實作為預留介面 |
| 測試與修復 | ✅ 診斷通過、匯入正常、brain_server 路由與靜態已修 |
| 建議優化 | 見第三節；優先接線 generate_media、update_web_admin、deploy_service 與進度顯示 |

系統已達「全功能伺服器大腦與管理網頁」可運作狀態；後續依優先順序接線 API、推播與佈署指令即可強化完整度。
