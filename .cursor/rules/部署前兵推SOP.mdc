---
description: ç¯‰æœªç§‘æŠ€éƒ¨ç½²å‰å…µæ¨ SOP v1.0 â€” Docker rebuild / æ¨¡çµ„é‡æ§‹å‰çš„å…­é—œå¼·åˆ¶é©—è­‰
alwaysApply: true
---

# ç¯‰æœªç§‘æŠ€ â€” éƒ¨ç½²å‰å…µæ¨ SOP (v1.0) [cite: 2026-02-27]

> **æ ¸å¿ƒåŸå‰‡ï¼šå…ˆå…µæ¨å¾Œéƒ¨ç½²ã€‚** çµ•ä¸ç›´æ¥ docker-compose buildã€‚

## è§¸ç™¼æ¢ä»¶ï¼ˆä»»ä¸€æˆç«‹å³å•Ÿå‹•å…µæ¨ï¼‰

- æ–°å¢æˆ–ä¿®æ”¹ â‰¥3 å€‹ .py æª”æ¡ˆ
- ä¿®æ”¹ Dockerfile / requirements / docker-compose.yml
- æ‹†åˆ†æˆ–åˆä½µæ¨¡çµ„ï¼ˆå¦‚ brain_server.py â†’ routers/ï¼‰
- è®Šæ›´è·¨æ¨¡çµ„ import è·¯å¾‘

## å…­é—œæª¢æŸ¥æµç¨‹

### ç¬¬ä¸€é—œï¼šèªæ³•æª¢æŸ¥

å°æ‰€æœ‰æ–°å¢/ä¿®æ”¹çš„ .py åŸ·è¡Œï¼š
```
python -m py_compile <file.py>
```
å…¨éƒ¨é€šéæ‰é€²ä¸‹ä¸€é—œã€‚

### ç¬¬äºŒé—œï¼šImport éˆé©—è­‰

1. åˆ—å‡ºå…±ç”¨æ¨¡çµ„ï¼ˆå¦‚ `routers/deps.py`ï¼‰æ‰€æœ‰åŒ¯å‡ºç¬¦è™Ÿ
2. é€ä¸€æ¯”å°æ¯å€‹æ¶ˆè²»ç«¯çš„ `from xxx import` è¡Œ
3. è£½è¡¨è¨˜éŒ„ï¼Œç¼ºä¸€å€‹æ¨™ ğŸ”´ï¼Œå…¨å°æ¨™ âœ…

### ç¬¬ä¸‰é—œï¼šç¡¬ä¾è³´å­˜åœ¨æ€§

1. æ‰¾å‡ºæ‰€æœ‰ **é try/except** çš„ import
2. ç¢ºèªå°æ‡‰ .py å­˜åœ¨ã€class/function åç¨±æ­£ç¢º
3. **ç‰¹åˆ¥æ³¨æ„åˆ¥å**ï¼š`GeminiService = AIService`ã€`AgentManager` åœ¨ `agent_logic` ä¸åœ¨ `ai_service`

### ç¬¬å››é—œï¼šå‡½å¼ç°½ååŒ¹é…

1. è·¨æ¨¡çµ„ class å¯¦ä¾‹åŒ– â†’ æª¢æŸ¥ `__init__` å¿…å¡«åƒæ•¸
2. è·¨æ¨¡çµ„å‡½å¼å‘¼å« â†’ æª¢æŸ¥åƒæ•¸åèˆ‡é †åº

### ç¬¬äº”é—œï¼šDocker Context å„ªåŒ–

1. `.dockerignore` æ’é™¤å¤§å‹ç›®éŒ„ï¼Œç›®æ¨™ context < 150MB
2. å¿…æ’ï¼š`stable-diffusion-webui-forge/`, `LivePortrait/`, `ai_engines/`, `memU/`, `workspace/`, `.git/`, `ComfyUI/`, `Wav2Lip/`, `archive/`

### ç¬¬å…­é—œï¼šBuild & å•Ÿå‹•é©—è­‰

1. `docker-compose build <service>`ï¼ˆä¸€æ¬¡åªè·‘ä¸€å€‹ï¼Œç¦æ­¢ä¸¦è¡Œï¼‰
2. `docker-compose up -d <service>`
3. é©—è­‰ï¼š`/healthz`, `/health`, `/api/auth/me`
4. æ—¥èªŒï¼š`docker-compose logs --tail=50 <service>`

## å…µæ¨å ±å‘Šæ ¼å¼ï¼ˆå¯«å…¥ brain_workspace/reports/ï¼‰

```json
{
  "aiName": "Cascade",
  "taskName": "deploy_dryrun",
  "status": "completed",
  "checks": {
    "syntax": { "pass": true, "count": 15 },
    "import_chain": { "pass": true, "mismatches": 0 },
    "hard_deps": { "pass": false, "bugs": ["file:line description"] },
    "signatures": { "pass": true },
    "docker_context": { "pass": true, "size_mb": 95 }
  },
  "conclusion": "N bugs found, fix before build",
  "timestamp": "ISO-8601"
}
```

## æ­·å²æ•™è¨“

| æ—¥æœŸ | æ•™è¨“ |
|------|------|
| 2026-02-27 | `AgentManager` åœ¨ `agent_logic.py` ä¸åœ¨ `ai_service.py`ï¼Œå…µæ¨ç¬¬ä¸‰é—œæ””æˆª |
| 2026-02-27 | Docker context 734MB â†’ å„ªåŒ– `.dockerignore` é™è‡³ ~95MB |
| 2026-02-27 | å¤šå€‹ `docker-compose build` ä¸¦è¡Œäº’ç›¸é˜»å¡ï¼Œåªèƒ½ä¸²è¡Œ |
