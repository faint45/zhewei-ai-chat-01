---
description: ç¯‰æœªç§‘æŠ€æ¨¡çµ„åŒ–é–‹ç™¼è¦ç¯„ v1.0 â€” Brain Server Router æ¶æ§‹å¼·åˆ¶æ¨™æº–
alwaysApply: true
---

# ç¯‰æœªç§‘æŠ€ â€” æ¨¡çµ„åŒ–é–‹ç™¼è¦ç¯„ (v1.0) [cite: 2026-02-27]

> **æ ¸å¿ƒåŸå‰‡ï¼šæ–°åŠŸèƒ½ä¸€å¾‹å¯«é€²å°æ‡‰ Routerï¼Œç¦æ­¢ç›´æ¥ä¿®æ”¹ä¸»æª”åŠ ç«¯é»ã€‚**

## 1. æ¶æ§‹ç¸½è¦½

```
brain_server_v2.py          â† ç²¾ç°¡ä¸»æª”ï¼ˆåƒ… app åˆå§‹åŒ– + WebSocket + å•Ÿå‹•ï¼‰
routers/
  deps.py                   â† å…±ç”¨ä¾è³´ï¼ˆèªè­‰ã€AI æœå‹™ã€ç‹€æ…‹ã€å·¥å…·å‡½å¼ã€Pydantic æ¨¡å‹ï¼‰
  auth.py                   â† èªè­‰ + API Key ç®¡ç†
  pages.py                  â† HTML é é¢è·¯ç”±
  system.py                 â† ç³»çµ±å¥åº· + æ¨¡å¼åˆ‡æ›
  commercial.py             â† æˆæ¬Š + ç§Ÿæˆ¶ + æ”¯ä»˜ + ç‡Ÿæ”¶
  usage.py                  â† ç”¨é‡ + ç›£æ§ + ç‡Ÿé‹é€šçŸ¥
  proxy.py                  â† AI API ä»£ç†ï¼ˆOpenAI ç›¸å®¹ï¼‰
  asset.py                  â† è³‡ç”¢ç®¡ç†
  host_phone.py             â† ä¸»æ©Ÿä»£ç† + Phone Agent
  smart_chat.py             â† æ™ºæ…§é™æ§ + å°è©±é™æ§ + Vision Edge
  agent.py                  â† Agent ä»»å‹™ + Playbook + Butler + Graph-RAG
  jarvis.py                 â† Jarvis AIï¼ˆç”Ÿåœ–/å­¸ç¿’/è§’è‰²/å·¥ä½œæµ/ä»£ç¢¼ç”Ÿæˆï¼‰
  extras.py                 â† memU è¨˜æ†¶ + Ntfy æ¨æ’­
```

## 2. æ–°å¢ç«¯é»è¦å‰‡

| è¦å‰‡ | èªªæ˜ |
|------|------|
| **é¸æ“‡ Router** | ä¾åŠŸèƒ½é ˜åŸŸæ”¾å…¥å°æ‡‰ routerï¼›ç„¡æ³•æ­¸é¡å‰‡æ–°å»º router |
| **Pydantic é©—è­‰** | æ‰€æœ‰ POST/PUT ç«¯é»çš„ request body å¿…é ˆç”¨ Pydantic `BaseModel` |
| **èªè­‰å®ˆè¡›** | æ•æ„Ÿç«¯é»å¿…é ˆåŠ  `_require_jwt` / `_require_admin` / `_require_superadmin` |
| **çµæ§‹åŒ–å›æ‡‰** | çµ±ä¸€ `{"ok": bool, ...}` æ ¼å¼ |
| **éŒ¯èª¤è™•ç†** | ç”¨ `HTTPException` æˆ– try/except + `{"ok": False, "error": "..."}` |
| **å¯é¸ä¾è³´** | éæ ¸å¿ƒæ¨¡çµ„ç”¨ `try: import xxx` + `except ImportError` ä¿è­· |
| **æ—¥èªŒ** | ç”¨ `logger` ä¸ç”¨ `print`ï¼›éŒ¯èª¤ç”¨ `logger.error` æˆ– `logger.exception` |

## 3. deps.py ç®¡ç†è¦å‰‡

- æ–°å¢å…±ç”¨å‡½å¼/ç‹€æ…‹ â†’ åŠ åˆ° `deps.py`
- æ–°å¢ Pydantic æ¨¡å‹ â†’ åŠ åˆ° `deps.py` åº•éƒ¨
- **ç¦æ­¢** åœ¨ router å…§å®šç¾©æ‡‰è©²å…±ç”¨çš„ç‹€æ…‹ï¼ˆå¦‚ dictã€Queueï¼‰
- **ç¦æ­¢** åœ¨ router å…§é‡è¤‡ import å·²åœ¨ deps ä¸­å°è£çš„æ¨¡çµ„

## 4. ç¦æ­¢äº‹é …

| ğŸ”´ ç¦æ­¢ | èªªæ˜ |
|---------|------|
| ç›´æ¥ä¿®æ”¹ `brain_server_v2.py` åŠ ç«¯é» | æ–°ç«¯é»ä¸€å¾‹æ”¾ router |
| å–®å€‹ .py è¶…é 800 è¡Œ | è¶…éå‰‡æ‹†åˆ†æ–° router |
| åœ¨ router å…§ `import auth_manager` | çµ±ä¸€å¾ `deps` å–ç”¨ |
| ç¡¬ç·¨ç¢¼ API Key / å¯†ç¢¼ | ç”¨ `os.environ.get()` |
| `print()` è¼¸å‡º | ç”¨ `logger.info/warning/error` |
| è·³éå…µæ¨ç›´æ¥ build | å¿…é ˆå…ˆéå…­é—œï¼ˆè¦‹ éƒ¨ç½²å‰å…µæ¨SOP.mdcï¼‰ |

## 5. æ–° Router ç¯„æœ¬

```python
# -*- coding: utf-8 -*-
"""ç¯‰æœªç§‘æŠ€ â€” [åŠŸèƒ½åç¨±] Router"""
from fastapi import APIRouter, Request, HTTPException
from routers.deps import _extract_token, _require_admin, logger

router = APIRouter(tags=["åŠŸèƒ½æ¨™ç±¤"])

@router.get("/api/xxx/health")
async def api_xxx_health():
    return {"ok": True, "service": "xxx"}

@router.post("/api/xxx/action")
async def api_xxx_action(request: Request):
    _require_admin(request)
    payload = await request.json()
    # ... æ¥­å‹™é‚è¼¯ ...
    return {"ok": True}
```

æ–° router å»ºå®Œå¾Œï¼Œåˆ° `brain_server_v2.py` åŠ å…©è¡Œï¼š
```python
from routers.new_module import router as new_module_router
app.include_router(new_module_router)
```

## 6. ä¿®æ”¹æ—¢æœ‰ç«¯é»æµç¨‹

1. æ‰¾åˆ°ç«¯é»æ‰€åœ¨ router
2. ä¿®æ”¹é‚è¼¯
3. è‹¥éœ€æ–°å…±ç”¨å‡½å¼ â†’ åŠ åˆ° `deps.py`
4. åŸ·è¡Œå…µæ¨ SOP ç¬¬ä¸€ï½å››é—œ
5. æœ¬åœ°æ¸¬è©¦é€šé â†’ Docker rebuild
