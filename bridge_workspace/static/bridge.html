<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Bridge - ç¯‰æœªç§‘æŠ€ AI å”ä½œå¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* å‹•ç•« */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(6, 182, 212, 0.5); }
            50% { box-shadow: 0 0 20px rgba(6, 182, 212, 0.8); }
        }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        @keyframes slide-in {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-in { animation: slide-in 0.3s ease-out; }
        
        .gradient-text {
            background: linear-gradient(135deg, #22d3ee 0%, #a855f7 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-slate-900/80 backdrop-blur border-b border-slate-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-bridge text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg gradient-text">Smart Bridge</h1>
                        <p class="text-xs text-slate-400">å…©éšæ®µæ™ºæ…§ç”Ÿæˆ Â· å³æ™‚å”ä½œ</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-xs">
                        <span class="w-2 h-2 rounded-full bg-green-500 pulse-glow"></span>
                        <span class="text-slate-400">Ollama</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        <span class="text-slate-400">Gemini</span>
                    </div>
                </div>
            </div>
            <!-- å°ˆæ¡ˆåˆ†é  -->
            <div class="flex items-center gap-2 overflow-x-auto pb-2">
                <button onclick="goToHomePage()" class="flex-shrink-0 px-3 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 rounded-lg text-xs transition font-semibold" title="è¿”å›ä¸»é ">
                    <i class="fas fa-home mr-1"></i>ä¸»é 
                </button>
                <div id="project-tabs" class="flex gap-2 flex-1"></div>
                <button onclick="exportCurrentProject()" class="flex-shrink-0 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs transition" title="åŒ¯å‡ºç•¶å‰å°ˆæ¡ˆ">
                    <i class="fas fa-download mr-1"></i>åŒ¯å‡º
                </button>
                <button onclick="document.getElementById('importFile').click()" class="flex-shrink-0 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs transition" title="åŒ¯å…¥å°ˆæ¡ˆ">
                    <i class="fas fa-upload mr-1"></i>åŒ¯å…¥
                </button>
                <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleImportFile(event)">
                <button onclick="syncProjects()" class="flex-shrink-0 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs transition" title="åŒæ­¥é ç«¯èˆ‡æœ¬åœ°å°ˆæ¡ˆè³‡æ–™">
                    <i class="fas fa-sync-alt mr-1"></i>åŒæ­¥
                </button>
                <button onclick="showNewProjectDialog()" class="flex-shrink-0 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs transition">
                    <i class="fas fa-plus mr-1"></i>æ–°å°ˆæ¡ˆ
                </button>
            </div>
        </div>
    </nav>

    <!-- æ–°å¢å°ˆæ¡ˆå°è©±æ¡† -->
    <div id="newProjectDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden items-center justify-center">
        <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 gradient-text">å»ºç«‹æ–°å°ˆæ¡ˆ</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-slate-400 mb-1 block">å°ˆæ¡ˆåç¨±</label>
                    <input id="newProjectName" type="text" placeholder="ä¾‹å¦‚ï¼šAI èŠå¤©æ©Ÿå™¨äºº" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-500">
                </div>
                <div>
                    <label class="text-sm text-slate-400 mb-1 block">æè¿°ï¼ˆé¸å¡«ï¼‰</label>
                    <textarea id="newProjectDesc" placeholder="å°ˆæ¡ˆç°¡ä»‹..." rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-500"></textarea>
                </div>
                <div>
                    <label class="text-sm text-slate-400 mb-1 block">é¡è‰²</label>
                    <div class="flex gap-2">
                        <button onclick="selectColor('cyan')" class="w-8 h-8 rounded-full bg-cyan-500 hover:ring-2 ring-cyan-400" data-color="cyan"></button>
                        <button onclick="selectColor('purple')" class="w-8 h-8 rounded-full bg-purple-500 hover:ring-2 ring-purple-400" data-color="purple"></button>
                        <button onclick="selectColor('pink')" class="w-8 h-8 rounded-full bg-pink-500 hover:ring-2 ring-pink-400" data-color="pink"></button>
                        <button onclick="selectColor('green')" class="w-8 h-8 rounded-full bg-green-500 hover:ring-2 ring-green-400" data-color="green"></button>
                        <button onclick="selectColor('orange')" class="w-8 h-8 rounded-full bg-orange-500 hover:ring-2 ring-orange-400" data-color="orange"></button>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideNewProjectDialog()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">å–æ¶ˆ</button>
                <button onclick="createNewProject()" class="flex-1 px-4 py-2 bg-gradient-to-r from-cyan-500 to-purple-600 hover:shadow-lg rounded-lg text-sm font-semibold transition">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- é€²åº¦æ¦‚è¦½ -->
        <div class="mb-6 glass-panel rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <span id="status-icon" class="text-2xl">âš¡</span>
                    <div>
                        <div id="stage-label" class="font-medium text-slate-200">å°±ç·’</div>
                        <div id="stage-desc" class="text-xs text-slate-500">ç­‰å¾…è¼¸å…¥...</div>
                    </div>
                </div>
                <div class="text-right">
                    <div id="progress-text" class="text-2xl font-bold gradient-text">0%</div>
                    <div class="text-xs text-slate-500">å®Œæˆåº¦</div>
                </div>
            </div>
            <div class="h-3 bg-slate-800 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-cyan-500 via-purple-500 to-pink-500 w-0 transition-all duration-500 ease-out"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦å´ï¼šå°è©±å€ -->
            <div class="lg:col-span-2 space-y-4">
                <div class="glass-panel rounded-xl overflow-hidden flex flex-col" style="height: 600px;">
                    <div class="bg-slate-800/50 px-4 py-3 border-b border-slate-700 flex items-center justify-between">
                        <h2 class="font-semibold"><i class="fas fa-comments mr-2 text-cyan-400"></i>å”ä½œå°è©± <span id="current-project-name" class="text-xs text-slate-500"></span></h2>
                        <div class="flex gap-2">
                            <button onclick="clearChat()" class="text-xs text-slate-500 hover:text-slate-300">
                                <i class="fas fa-trash mr-1"></i>æ¸…é™¤
                            </button>
                            <button onclick="deleteCurrentProject()" class="text-xs text-red-500 hover:text-red-400" id="deleteProjectBtn">
                                <i class="fas fa-times mr-1"></i>åˆªé™¤å°ˆæ¡ˆ
                            </button>
                        </div>
                    </div>
                    
                    <!-- è¨Šæ¯å€ -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div class="text-center text-slate-500 py-8">
                            <i class="fas fa-robot text-4xl mb-3 opacity-50"></i>
                            <p>å—¨ï¼æˆ‘æ˜¯ä½ çš„ AI ç¨‹å¼è¨­è¨ˆåŠ©æ‰‹</p>
                            <p class="text-xs mt-2">æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«å¿™çš„å—ï¼Ÿ</p>
                        </div>
                    </div>
                    
                    <!-- è¼¸å…¥å€ -->
                    <div class="p-4 border-t border-slate-700 bg-slate-800/30">
                        <div class="flex gap-2 mb-2">
                            <select id="ai-mode" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-500 font-semibold">
                                <option value="code_gen">ğŸ§  æ·±åº¦æ¨ç†æ¨¡å¼ï¼ˆDeepSeek-R1 14Bï¼‰</option>
                                <option value="two_phase">âš¡ å…©éšæ®µæ¨¡å¼ï¼ˆå¯¦é©—æ€§ï¼‰</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <div class="flex-1 relative">
                                <input id="message-input" type="text" placeholder="æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«å¿™çš„ï¼Ÿ" 
                                       class="w-full bg-slate-700 border border-slate-600 rounded-lg pl-4 pr-12 py-2 text-sm focus:outline-none focus:border-cyan-500"
                                       onkeypress="if(event.key==='Enter')sendMessage()">
                                <button onclick="sendMessage()" class="absolute right-2 top-1/2 -translate-y-1/2 text-cyan-400 hover:text-cyan-300">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šé‹ä½œéç¨‹ -->
            <div class="space-y-4">
                <!-- AI é‹ä½œéç¨‹ -->
                <div class="glass-panel rounded-xl overflow-hidden" style="height: 350px;">
                    <div class="bg-slate-800/50 px-4 py-3 border-b border-slate-700">
                        <h2 class="font-semibold text-sm"><i class="fas fa-cogs mr-2 text-purple-400"></i>AI é‹ä½œéç¨‹</h2>
                    </div>
                    <div id="operations-log" class="h-[calc(100%-48px)] overflow-y-auto p-3 space-y-2 text-xs font-mono">
                        <div class="text-slate-500 text-center py-4">ç­‰å¾…é€£æ¥...</div>
                    </div>
                </div>

                <!-- æˆæœ¬çµ±è¨ˆ -->
                <div class="glass-panel rounded-xl p-4">
                    <h2 class="font-semibold text-sm mb-3"><i class="fas fa-chart-pie mr-2 text-green-400"></i>æˆæœ¬æ•ˆç›Š</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-400">æœ¬æ¬¡æˆæœ¬</span>
                            <span id="cost-current" class="text-sm font-mono text-slate-200">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-400">ç¯€çœé‡‘é¡</span>
                            <span id="cost-saved" class="text-sm font-mono text-green-400">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-400">æ•ˆç‡æå‡</span>
                            <span id="efficiency-rate" class="text-sm font-mono text-cyan-400">-</span>
                        </div>
                        <hr class="border-slate-700">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-400">ç¸½è«‹æ±‚æ•¸</span>
                            <span id="total-requests" class="text-sm font-mono">-</span>
                        </div>
                    </div>
                </div>

                <!-- æœ¬åœ°æ¨¡å‹æ§åˆ¶ -->
                <div class="glass-panel rounded-xl p-4">
                    <h2 class="font-semibold text-sm mb-3"><i class="fas fa-brain mr-2 text-pink-400"></i>æœ¬åœ°æ¨¡å‹æ§åˆ¶</h2>
                    <div class="space-y-2">
                        <button onclick="checkOllamaStatus()" class="w-full bg-slate-700 hover:bg-slate-600 text-xs py-2 px-3 rounded-lg transition-colors text-left">
                            <i class="fas fa-heartbeat mr-2 text-green-400"></i>æª¢æŸ¥ Ollama ç‹€æ…‹
                        </button>
                        <button onclick="listModels()" class="w-full bg-slate-700 hover:bg-slate-600 text-xs py-2 px-3 rounded-lg transition-colors text-left">
                            <i class="fas fa-list mr-2 text-cyan-400"></i>åˆ—å‡ºå¯ç”¨æ¨¡å‹
                        </button>
                        <button onclick="startLearning()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-xs py-2 px-3 rounded-lg transition-colors text-left">
                            <i class="fas fa-graduation-cap mr-2"></i>å•Ÿå‹•å­¸ç¿’æ¨¡å¼
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ”¹é€²é»é¡¯ç¤º -->
        <div id="improvements-panel" class="mt-6 glass-panel rounded-xl p-4 hidden">
            <h3 class="font-semibold text-sm mb-3"><i class="fas fa-magic mr-2 text-yellow-400"></i>Phase 2 ç²¾ä¿®æ”¹é€²</h3>
            <ul id="improvements-list" class="space-y-2 text-sm"></ul>
        </div>
    </main>

    <script>
        // â”€â”€ å°ˆæ¡ˆç®¡ç† â”€â”€
        let currentProject = null;
        let projects = [];
        let selectedColor = 'purple';

        async function loadProjects() {
            try {
                const res = await fetch('/api/projects');
                const data = await res.json();
                projects = data.projects || [];
                renderProjectTabs();
                if (projects.length > 0 && !currentProject) {
                    switchProject(projects[0].id);
                }
            } catch (err) {
                console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', err);
            }
        }

        function renderProjectTabs() {
            const container = document.getElementById('project-tabs');
            container.innerHTML = projects.map(p => `
                <button onclick="switchProject('${p.id}')" 
                        class="px-4 py-1.5 rounded-lg text-xs transition ${currentProject?.id === p.id ? 'bg-'+p.color+'-600 text-white' : 'bg-slate-700 hover:bg-slate-600'}"
                        data-project="${p.id}">
                    <i class="fas fa-${p.icon || 'folder'} mr-1"></i>${p.name}
                    ${p.stats?.messages ? `<span class="ml-1 text-xs opacity-70">(${p.stats.messages})</span>` : ''}
                </button>
            `).join('');
        }

        async function switchProject(projectId) {
            try {
                const res = await fetch(`/api/projects/${projectId}`);
                const data = await res.json();
                currentProject = data.project;
                
                // æ›´æ–° UI
                renderProjectTabs();
                document.getElementById('current-project-name').textContent = `(${currentProject.name})`;
                document.getElementById('deleteProjectBtn').style.display = projectId === 'default' ? 'none' : 'inline-block';
                
                // è¼‰å…¥å°ˆæ¡ˆå°è©±æ­·å²
                loadProjectHistory();
            } catch (err) {
                console.error('åˆ‡æ›å°ˆæ¡ˆå¤±æ•—:', err);
            }
        }

        function loadProjectHistory() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            if (currentProject.history && currentProject.history.length > 0) {
                currentProject.history.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });
            } else {
                chatMessages.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <i class="fas fa-robot text-4xl mb-3 opacity-50"></i>
                        <p>é–‹å§‹å°è©±ï¼ŒAI æœƒå³æ™‚é¡¯ç¤ºé‹ä½œéç¨‹</p>
                        <p class="text-xs mt-2">Phase 1: ä½æˆæœ¬æ¨¡å‹ 80% | Phase 2: é«˜å“è³ªç²¾ä¿® 20%</p>
                    </div>
                `;
            }
        }

        function showNewProjectDialog() {
            document.getElementById('newProjectDialog').classList.remove('hidden');
            document.getElementById('newProjectDialog').classList.add('flex');
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectDesc').value = '';
            selectedColor = 'purple';
        }

        function hideNewProjectDialog() {
            document.getElementById('newProjectDialog').classList.add('hidden');
            document.getElementById('newProjectDialog').classList.remove('flex');
        }

        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('[data-color]').forEach(btn => {
                btn.classList.toggle('ring-2', btn.dataset.color === color);
            });
        }

        async function createNewProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const description = document.getElementById('newProjectDesc').value.trim();
            
            if (!name) {
                alert('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±');
                return;
            }
            
            try {
                const res = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, description, color: selectedColor})
                });
                const data = await res.json();
                
                if (data.ok) {
                    hideNewProjectDialog();
                    await loadProjects();
                    switchProject(data.project.id);
                }
            } catch (err) {
                alert('å»ºç«‹å°ˆæ¡ˆå¤±æ•—ï¼š' + err.message);
            }
        }

        async function deleteCurrentProject() {
            if (!currentProject || currentProject.id === 'default') return;
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å°ˆæ¡ˆã€Œ${currentProject.name}ã€å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) return;
            
            try {
                const res = await fetch(`/api/projects/${currentProject.id}`, {method: 'DELETE'});
                if (res.ok) {
                    await loadProjects();
                    switchProject('default');
                }
            } catch (err) {
                alert('åˆªé™¤å°ˆæ¡ˆå¤±æ•—ï¼š' + err.message);
            }
        }

        async function clearChat() {
            if (!currentProject) return;
            
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ­¤å°ˆæ¡ˆçš„å°è©±æ­·å²å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/projects/${currentProject.id}/history`, {method: 'DELETE'});
                if (res.ok) {
                    await switchProject(currentProject.id);
                }
            } catch (err) {
                alert('æ¸…é™¤å¤±æ•—ï¼š' + err.message);
            }
        }

        async function syncProjects() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin');
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/projects/sync', {method: 'POST'});
                const data = await res.json();
                
                if (data.ok) {
                    await loadProjects();
                    if (currentProject) {
                        await switchProject(currentProject.id);
                    }
                    addOperation('âœ… å°ˆæ¡ˆè³‡æ–™å·²åŒæ­¥', 'success');
                }
            } catch (err) {
                addOperation('âš ï¸ åŒæ­¥å¤±æ•—: ' + err.message, 'error');
            } finally {
                icon.classList.remove('fa-spin');
                btn.disabled = false;
            }
        }

        // è‡ªå‹•åŒæ­¥æ©Ÿåˆ¶ï¼ˆæ¯ 30 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰
        setInterval(async () => {
            try {
                const res = await fetch('/api/projects/sync', {method: 'POST'});
                const data = await res.json();
                if (data.ok) {
                    // éœé»˜åŒæ­¥ï¼Œä¸é‡æ–°è¼‰å…¥ç•¶å‰å°ˆæ¡ˆï¼ˆé¿å…æ‰“æ–·ç”¨æˆ¶ï¼‰
                    const currentId = currentProject?.id;
                    await loadProjects();
                    if (currentId && currentId !== currentProject?.id) {
                        // åƒ…åœ¨ç•¶å‰å°ˆæ¡ˆè¢«åˆªé™¤æ™‚æ‰åˆ‡æ›
                        if (!projects.find(p => p.id === currentId)) {
                            await switchProject('default');
                        }
                    }
                }
            } catch (err) {
                console.log('èƒŒæ™¯åŒæ­¥å¤±æ•—:', err);
            }
        }, 30000);

        // â”€â”€ åŒ¯å…¥åŒ¯å‡ºåŠŸèƒ½ â”€â”€
        async function exportCurrentProject() {
            if (!currentProject) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å°ˆæ¡ˆ');
                return;
            }
            
            try {
                const res = await fetch(`/api/projects/${currentProject.id}/export`);
                const data = await res.json();
                
                // ä¸‹è¼‰ç‚º JSON æª”æ¡ˆ
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentProject.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                addOperation(`âœ… å·²åŒ¯å‡ºå°ˆæ¡ˆã€Œ${currentProject.name}ã€`, 'success');
            } catch (err) {
                alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
            }
        }

        async function exportAllProjects() {
            try {
                const res = await fetch('/api/projects/export/all');
                const data = await res.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `smart_bridge_projects_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                addOperation('âœ… å·²åŒ¯å‡ºæ‰€æœ‰å°ˆæ¡ˆ', 'success');
            } catch (err) {
                alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
            }
        }

        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // è©¢å•åŒ¯å…¥æ¨¡å¼
                const mode = await showImportModeDialog();
                if (!mode) {
                    event.target.value = '';
                    return;
                }
                
                const res = await fetch('/api/projects/import', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({data, mode})
                });
                const result = await res.json();
                
                if (result.ok) {
                    const msg = `âœ… åŒ¯å…¥å®Œæˆï¼\n` +
                                `- å·²åŒ¯å…¥ï¼š${result.imported.length} å€‹\n` +
                                `- å·²è·³éï¼š${result.skipped.length} å€‹\n` +
                                `- éŒ¯èª¤ï¼š${result.errors.length} å€‹`;
                    alert(msg);
                    addOperation(msg.replace(/\n/g, ' '), 'success');
                    await loadProjects();
                } else {
                    alert('åŒ¯å…¥å¤±æ•—ï¼š' + result.error);
                }
            } catch (err) {
                alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
            } finally {
                event.target.value = '';
            }
        }

        function showImportModeDialog() {
            return new Promise((resolve) => {
                const mode = prompt(
                    'é¸æ“‡åŒ¯å…¥æ¨¡å¼ï¼š\n' +
                    '1. skip - è·³éå·²å­˜åœ¨çš„å°ˆæ¡ˆ\n' +
                    '2. overwrite - è¦†è“‹å·²å­˜åœ¨çš„å°ˆæ¡ˆ\n' +
                    '3. merge - åˆä½µå°è©±æ­·å²\n\n' +
                    'è«‹è¼¸å…¥ 1ã€2 æˆ– 3ï¼š'
                );
                
                const modes = {'1': 'skip', '2': 'overwrite', '3': 'merge'};
                resolve(modes[mode] || null);
            });
        }

        function goToHomePage() {
            // è¿”å› Portal æœå‹™é¸æ“‡é é¢
            window.location.href = 'https://zhe-wei.net/';
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadProjects();
        });

        // WebSocket é€£æ¥
        const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws`);
        
        ws.onopen = () => {
            addOperation('ğŸŸ¢ WebSocket é€£æ¥æˆåŠŸ', 'success');
        };
        
        ws.onclose = () => {
            addOperation('ğŸ”´ WebSocket é€£æ¥æ–·é–‹', 'error');
        };
        
        ws.onerror = (e) => {
            addOperation('âš ï¸ WebSocket éŒ¯èª¤', 'error');
        };
        
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            handleMessage(msg);
        };

        function handleMessage(msg) {
            switch(msg.type) {
                case 'connected':
                    // Session ID å·²é€£æ¥
                    addOperation(`âœ… ${msg.message}`, 'success');
                    msg.features.forEach(f => addOperation(`  â€¢ ${f}`, 'info'));
                    break;
                    
                case 'operation':
                    const opColor = msg.stage?.includes('fail') ? 'error' :
                                    msg.stage?.includes('complete') ? 'success' :
                                    msg.stage?.includes('start') ? 'start' : 'info';
                    addOperation(`[${msg.stage}] ${msg.message}`, opColor);
                    
                    // æ›´æ–°é€²åº¦
                    if (msg.progress !== undefined) {
                        updateProgress(msg.progress, msg.stage);
                    }
                    break;
                    
                case 'response':
                    addMessage('ai', msg.content);
                    updateStats(msg.meta);
                    
                    // é¡¯ç¤ºæ”¹é€²é»
                    if (msg.meta.improvements && msg.meta.improvements.length > 0) {
                        showImprovements(msg.meta.improvements);
                    }
                    updateProgress(100, 'complete');
                    break;
                    
                case 'learn_status':
                    const status = msg.status === 'online' ? 'âœ… ç·šä¸Š' : 'âŒ é›¢ç·š';
                    addOperation(`Ollama ç‹€æ…‹: ${status}`, msg.status === 'online' ? 'success' : 'error');
                    if (msg.models) {
                        addOperation(`å¯ç”¨æ¨¡å‹: ${msg.models.length} å€‹`, 'info');
                    }
                    break;
                    
                case 'error':
                    addOperation(`âŒ éŒ¯èª¤: ${msg.message}`, 'error');
                    break;
            }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            const aiMode = document.getElementById('ai-mode').value;
            
            if (!text) return;
            
            addMessage('user', text);
            ws.send(JSON.stringify({
                type: 'chat',
                text: text,
                task_type: 'code',  // é è¨­ç‚º code é¡å‹
                mode: aiMode
            }));
            
            input.value = '';
            updateProgress(0, 'waiting');
            
            // éš±è—æ”¹é€²é»é¢æ¿
            document.getElementById('improvements-panel').classList.add('hidden');
        }

        function addMessage(role, content) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `slide-in ${role === 'user' ? 'text-right' : 'text-left'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `inline-block max-w-[80%] px-4 py-3 rounded-2xl ${
                role === 'user' 
                    ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-br-md' 
                    : 'bg-slate-800 border border-slate-700 text-slate-200 rounded-bl-md'
            }`;
            
            // è™•ç† Markdown ç¨‹å¼ç¢¼å€å¡Šï¼ŒåŠ å…¥è¤‡è£½æŒ‰éˆ•
            let codeBlockId = 0;
            let formattedContent = content
                .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    const id = `code-${Date.now()}-${codeBlockId++}`;
                    const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `<div class="relative my-2">
                        <div class="flex items-center justify-between bg-slate-900 px-3 py-1 rounded-t-lg border-b border-slate-700">
                            <span class="text-xs text-slate-400">${lang || 'code'}</span>
                            <button onclick="copyCode('${id}')" class="text-xs text-cyan-400 hover:text-cyan-300">
                                <i class="fas fa-copy mr-1"></i>è¤‡è£½
                            </button>
                        </div>
                        <pre class="bg-slate-950 p-3 rounded-b-lg overflow-x-auto text-xs font-mono"><code id="${id}">${escapedCode}</code></pre>
                    </div>`;
                })
                .replace(/`([^`]+)`/g, '<code class="bg-slate-700 px-1.5 py-0.5 rounded text-xs">$1</code>')
                .replace(/\n/g, '<br>');
            
            bubble.innerHTML = formattedContent;
            div.appendChild(bubble);
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const text = codeElement.textContent;
            navigator.clipboard.writeText(text).then(() => {
                // é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-1"></i>å·²è¤‡è£½';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }

        function addOperation(text, type) {
            const container = document.getElementById('operations-log');
            if (container.children.length === 1 && container.children[0].textContent === 'ç­‰å¾…é€£æ¥...') {
                container.innerHTML = '';
            }
            
            const div = document.createElement('div');
            const colors = {
                success: 'text-green-400',
                error: 'text-red-400',
                start: 'text-cyan-400',
                info: 'text-slate-400'
            };
            
            const time = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            div.className = `${colors[type] || 'text-slate-400'} slide-in`;
            div.innerHTML = `<span class="text-slate-600">[${time}]</span> ${text}`;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function updateProgress(percent, stage) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-text').textContent = percent + '%';
            
            const stages = {
                'waiting': { icon: 'â³', label: 'ç­‰å¾…ä¸­', desc: 'æº–å‚™é–‹å§‹...' },
                'phase1_start': { icon: 'ğŸš€', label: 'Phase 1 é–‹å§‹', desc: 'ä½æˆæœ¬æ¨¡å‹å»ºç«‹æ¡†æ¶...' },
                'phase1_try': { icon: 'ğŸ”„', label: 'Phase 1 å˜—è©¦', desc: 'æ¸¬è©¦ä½æˆæœ¬æ¨¡å‹...' },
                'phase1_complete': { icon: 'âœ…', label: 'Phase 1 å®Œæˆ', desc: 'æ¡†æ¶å·²å»ºç«‹' },
                'phase2_start': { icon: 'ğŸ¯', label: 'Phase 2 é–‹å§‹', desc: 'é«˜å“è³ªæ¨¡å‹ç²¾ä¿®...' },
                'phase2_try': { icon: 'ğŸ¨', label: 'Phase 2 ç²¾ä¿®', desc: 'å„ªåŒ–å…§å®¹å“è³ª...' },
                'complete': { icon: 'ğŸ‰', label: 'å®Œæˆ', desc: 'æ‰€æœ‰éšæ®µå·²å®Œæˆ' },
            };
            
            const s = stages[stage] || { icon: 'âš¡', label: stage, desc: 'è™•ç†ä¸­...' };
            document.getElementById('status-icon').textContent = s.icon;
            document.getElementById('stage-label').textContent = s.label;
            document.getElementById('stage-desc').textContent = s.desc;
        }

        function updateStats(meta) {
            document.getElementById('cost-current').textContent = `$${meta.cost_usd.toFixed(4)}`;
            document.getElementById('cost-saved').textContent = `$${meta.saved_usd.toFixed(4)}`;
            
            const efficiency = meta.saved_usd / (meta.cost_usd + meta.saved_usd) * 100;
            document.getElementById('efficiency-rate').textContent = `${efficiency.toFixed(1)}%`;
        }

        function showImprovements(improvements) {
            const panel = document.getElementById('improvements-panel');
            const list = document.getElementById('improvements-list');
            
            list.innerHTML = improvements.map(imp => 
                `<li class="flex items-start gap-2">
                    <i class="fas fa-check-circle text-green-400 mt-0.5"></i>
                    <span class="text-slate-300">${imp}</span>
                </li>`
            ).join('');
            
            panel.classList.remove('hidden');
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = `
                <div class="text-center text-slate-500 py-8">
                    <i class="fas fa-robot text-4xl mb-3 opacity-50"></i>
                    <p>é–‹å§‹å°è©±ï¼ŒAI æœƒå³æ™‚é¡¯ç¤ºé‹ä½œéç¨‹</p>
                    <p class="text-xs mt-2">Phase 1: ä½æˆæœ¬æ¨¡å‹ 80% | Phase 2: é«˜å“è³ªç²¾ä¿® 20%</p>
                </div>
            `;
        }

        // æœ¬åœ°æ¨¡å‹æ§åˆ¶
        function checkOllamaStatus() {
            ws.send(JSON.stringify({ type: 'learn', action: 'status' }));
        }

        function listModels() {
            ws.send(JSON.stringify({ type: 'learn', action: 'status' }));
        }

        function startLearning() {
            const topic = prompt('è«‹è¼¸å…¥è¦å­¸ç¿’çš„ä¸»é¡Œï¼š');
            if (topic) {
                ws.send(JSON.stringify({ 
                    type: 'learn', 
                    action: 'learn_topic',
                    topic: topic
                }));
            }
        }

        // è¼‰å…¥å…¨å±€æˆæœ¬çµ±è¨ˆ
        async function loadGlobalStats() {
            try {
                const res = await fetch('/api/cost-stats');
                const data = await res.json();
                if (data.ok) {
                    document.getElementById('total-requests').textContent = data.total_requests;
                }
            } catch(e) {
                console.log('è¼‰å…¥çµ±è¨ˆå¤±æ•—', e);
            }
        }

        loadGlobalStats();
    </script>
</body>
</html>
