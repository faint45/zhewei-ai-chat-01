<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>AI å‰µä½œå·¥ä½œå®¤ - ç„¡é™ç”Ÿåœ– Â· ç”Ÿå½±ç‰‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.puter.com/v2/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body{font-family:'Noto Sans TC',sans-serif;margin:0;height:100vh;overflow:hidden}
        ::-webkit-scrollbar{width:5px}
        ::-webkit-scrollbar-track{background:#0f172a}
        ::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
        .glass{background:rgba(15,23,42,.7);-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px);border:1px solid rgba(148,163,184,.08)}
        .gradient-text{background:linear-gradient(135deg,#f472b6,#a855f7,#22d3ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        @keyframes fade-up{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .fade-up{animation:fade-up .25s ease-out}
        .gallery-item{transition:all .2s}
        .gallery-item:hover{transform:scale(1.02);box-shadow:0 12px 32px rgba(0,0,0,.4)}
        .tab-active{background:linear-gradient(135deg,rgba(168,85,247,.2),rgba(236,72,153,.2));border-color:rgba(168,85,247,.5);color:#e9d5ff}
        .model-chip{transition:all .15s}
        .model-chip:hover{transform:translateY(-1px)}
        .model-chip.active{background:linear-gradient(135deg,#7c3aed,#db2777);color:white;border-color:transparent}
        .nsfw-toggle{position:relative;width:40px;height:22px;border-radius:11px;cursor:pointer;transition:all .2s}
        .nsfw-toggle .dot{position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:white;transition:all .2s}
        .nsfw-toggle.on{background:linear-gradient(135deg,#ef4444,#dc2626)}.nsfw-toggle.on .dot{left:20px}
        .nsfw-toggle.off{background:#334155}
        .drop-zone{border:2px dashed #475569;transition:all .2s}
        .drop-zone:hover,.drop-zone.dragover{border-color:#a855f7;background:rgba(168,85,247,.05)}
        .drop-zone.has-image{border-style:solid;border-color:#475569}
    </style>
</head>
<body class="bg-slate-950 text-slate-100 flex flex-col h-screen">

<!-- é ‚éƒ¨ -->
<nav class="flex-shrink-0 glass border-b border-slate-800 px-4 py-2.5 z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="/" class="text-slate-400 hover:text-white transition" title="è¿”å›"><i class="fas fa-arrow-left"></i></a>
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-pink-500 to-violet-600 flex items-center justify-center">
                <i class="fas fa-palette text-white text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm gradient-text leading-tight">AI å‰µä½œå·¥ä½œå®¤</h1>
                <p class="text-[10px] text-slate-500 leading-tight">ç„¡é™ç”Ÿåœ– Â· åœ–ç‰‡ç”Ÿå½±ç‰‡ Â· <span id="planBadge" class="text-emerald-400">å…è²»é«”é©—</span></p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- æœ¬åœ°æ¨¡å¼é–‹é—œ -->
            <div class="flex items-center gap-1.5">
                <span class="text-[10px] text-emerald-500" id="localModeLabel">â˜ï¸ é›²ç«¯</span>
                <div id="localToggle" class="nsfw-toggle off" onclick="toggleLocalMode()" title="æœ¬åœ°æ¨¡å¼ï¼šå…¨éƒ¨ä½¿ç”¨æœ¬åœ° GPU é‹ç®—ï¼Œ0 token æ¶ˆè€—">
                    <div class="dot"></div>
                </div>
            </div>
            <!-- æˆäººæ¨¡å¼é–‹é—œ -->
            <div class="flex items-center gap-1.5">
                <span class="text-[10px] text-slate-500">ç„¡å¯©æŸ¥</span>
                <div id="nsfwToggle" class="nsfw-toggle off" onclick="toggleNSFW()" title="æˆäººæ¨¡å¼ï¼ˆé—œé–‰å®‰å…¨éæ¿¾å™¨ï¼‰">
                    <div class="dot"></div>
                </div>
            </div>
            <span class="text-[10px] text-slate-500">ä»Šæ—¥ï¼š<span id="todayCount">0</span> å¼µ</span>
            <a href="/payment" id="upgradeBtn" class="text-[10px] bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white px-2.5 py-1 rounded-lg font-medium transition">å‡ç´šæ–¹æ¡ˆ</a>
        </div>
    </div>
</nav>

<!-- åˆ†é  -->
<div class="flex-shrink-0 border-b border-slate-800/50 px-4">
    <div class="max-w-7xl mx-auto flex gap-1 py-1.5">
        <button onclick="switchTab('image')" id="tabImage" class="tab-active px-4 py-1.5 rounded-lg text-xs font-medium border border-transparent transition">
            <i class="fas fa-image mr-1"></i>æ–‡å­—ç”Ÿåœ–
        </button>
        <button onclick="switchTab('img2vid')" id="tabImg2vid" class="px-4 py-1.5 rounded-lg text-xs font-medium text-slate-400 border border-transparent hover:bg-slate-800 transition">
            <i class="fas fa-photo-film mr-1"></i>åœ–ç‰‡ç”Ÿå½±ç‰‡
        </button>
        <button onclick="switchTab('video')" id="tabVideo" class="px-4 py-1.5 rounded-lg text-xs font-medium text-slate-400 border border-transparent hover:bg-slate-800 transition">
            <i class="fas fa-video mr-1"></i>æ–‡å­—ç”Ÿå½±ç‰‡
        </button>
        <button onclick="switchTab('gallery')" id="tabGallery" class="px-4 py-1.5 rounded-lg text-xs font-medium text-slate-400 border border-transparent hover:bg-slate-800 transition">
            <i class="fas fa-images mr-1"></i>ä½œå“åº«
        </button>
    </div>
</div>

<!-- ä¸»é«” -->
<div class="flex-1 flex overflow-hidden">

    <!-- ===== æ–‡å­—ç”Ÿåœ– ===== -->
    <div id="panelImage" class="flex-1 flex overflow-hidden">
        <div class="w-full lg:w-[380px] flex-shrink-0 flex flex-col border-r border-slate-800/60 overflow-y-auto">
            <div class="p-3 space-y-3">
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1 uppercase tracking-wider">æè¿°ä½ æƒ³è¦çš„åœ–ç‰‡</label>
                    <textarea id="imgPrompt" rows="3" placeholder="ä¾‹å¦‚ï¼šä¸€éš»ç©¿è‘—å¤ªç©ºè¡£çš„æŸ´çŠ¬åœ¨æœˆçƒä¸Šæ•£æ­¥ï¼ŒèƒŒæ™¯æ˜¯åœ°çƒï¼Œé›»å½±ç´šå…‰å½±..."
                        class="w-full bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-sm resize-none focus:outline-none focus:border-violet-500/50 focus:ring-1 focus:ring-violet-500/20 transition placeholder:text-slate-600"></textarea>
                </div>
                <!-- åƒè€ƒåœ–ä¸Šå‚³ -->
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">åƒè€ƒåœ–ç‰‡ï¼ˆå¯é¸ï¼‰</label>
                    <div id="refDropZone" class="drop-zone rounded-xl p-4 text-center cursor-pointer" onclick="document.getElementById('refFileInput').click()">
                        <div id="refPreview" class="hidden relative">
                            <img id="refPreviewImg" class="max-h-32 mx-auto rounded-lg" alt="åƒè€ƒåœ–ç‰‡">
                            <button onclick="event.stopPropagation(); clearRefImage()" class="absolute top-1 right-1 w-5 h-5 bg-red-600 hover:bg-red-500 rounded-full flex items-center justify-center text-[10px] text-white" title="ç§»é™¤"><i class="fas fa-xmark"></i></button>
                            <p class="text-[10px] text-slate-400 mt-1.5">AI å°‡ä»¥æ­¤åœ–ç‚ºåŸºç¤ï¼Œä¾æ–‡å­—æè¿°ä¿®æ”¹</p>
                        </div>
                        <div id="refPlaceholder">
                            <i class="fas fa-image text-lg text-slate-600 mb-1"></i>
                            <p class="text-[10px] text-slate-500">æ‹–æ”¾æˆ–é»æ“Šä¸Šå‚³åƒè€ƒåœ–ï¼ˆå¯é¸ï¼‰</p>
                        </div>
                    </div>
                    <input type="file" id="refFileInput" accept="image/*" class="hidden" onchange="handleRefUpload(this)">
                    <!-- ä¿®æ”¹å¼·åº¦ -->
                    <div id="refStrengthWrap" class="hidden mt-2">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-slate-500">ä¿®æ”¹å¼·åº¦</label>
                            <span id="refStrengthVal" class="text-[10px] text-violet-400">0.7</span>
                        </div>
                        <input type="range" id="refStrength" min="0.1" max="1.0" step="0.05" value="0.7"
                            class="w-full h-1 mt-1 accent-violet-500" oninput="document.getElementById('refStrengthVal').textContent=this.value">
                        <div class="flex justify-between text-[9px] text-slate-600 mt-0.5">
                            <span>ä¿ç•™åŸåœ–</span><span>å®Œå…¨é‡ç¹ª</span>
                        </div>
                    </div>
                </div>
                <!-- AI æç¤ºè©å¢å¼· -->
                <div class="flex gap-1.5">
                    <button onclick="enhancePrompt()" id="enhanceBtn" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 py-1.5 rounded-lg text-[11px] transition flex items-center justify-center gap-1" title="æ™ºæ…§è·¯ç”± AI å¢å¼·ï¼ˆGroq 70B â†’ Gemini â†’ Grok â†’ Ollamaï¼‰">
                        <i class="fas fa-magic"></i>AI å¢å¼· <span class="text-[9px] text-violet-400 opacity-70">æ™ºæ…§è·¯ç”±</span>
                    </button>
                    <select id="enhanceStyle" title="é¢¨æ ¼é¸æ“‡" class="bg-slate-900 border border-slate-800 rounded-lg text-[10px] text-slate-400 px-2 py-1 focus:outline-none">
                        <option value="photorealistic">å¯«å¯¦</option>
                        <option value="anime">å‹•æ¼«</option>
                        <option value="illustration">æ’ç•«</option>
                        <option value="cinematic">é›»å½±</option>
                        <option value="abstract">æŠ½è±¡</option>
                        <option value="3d_render">3D æ¸²æŸ“</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">æ¨¡å‹</label>
                    <div class="flex flex-wrap gap-1.5" id="imgModels">
                        <button onclick="selectImgModel(this,'dall-e-3')" class="model-chip active px-2.5 py-1 rounded-lg text-[11px] border border-slate-700">DALLÂ·E 3</button>
                        <button onclick="selectImgModel(this,'gpt-image-1')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">GPT Image</button>
                        <button onclick="selectImgModel(this,'black-forest-labs/FLUX.1-schnell')" data-together="1" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">Flux Schnell âš¡</button>
                        <button onclick="selectImgModel(this,'black-forest-labs/FLUX.1-dev')" data-together="1" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">Flux Dev</button>
                        <button onclick="selectImgModel(this,'stabilityai/stable-diffusion-xl-base-1.0')" data-together="1" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">SDXL</button>
                        <button onclick="selectImgModel(this,'google/imagen-4.0-fast')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">Imagen 4</button>
                        <button onclick="selectImgModel(this,'ideogram/ideogram-3.0')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">Ideogram 3</button>
                        <button onclick="selectImgModel(this,'ByteDance-Seed/Seedream-4.0')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">Seedream 4</button>
                        <span class="w-full h-0 border-t border-slate-800/50"></span>
                        <button onclick="selectImgModel(this,'__comfyui__')" data-local="1" data-together="1" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-emerald-800 text-emerald-400 bg-emerald-950/30">
                            <i class="fas fa-server mr-0.5"></i>ComfyUI <span id="comfyuiDot" class="inline-block w-1.5 h-1.5 rounded-full bg-slate-600 ml-0.5"></span> <span class="text-[9px] opacity-60">0 token</span>
                        </button>
                        <button onclick="selectImgModel(this,'__forge__')" data-local="1" data-together="1" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-amber-800 text-amber-400 bg-amber-950/30">
                            <i class="fas fa-bolt mr-0.5"></i>Forge <span id="forgeDot" class="inline-block w-1.5 h-1.5 rounded-full bg-slate-600 ml-0.5"></span> <span class="text-[9px] opacity-60">0 token</span>
                        </button>
                    </div>
                    <!-- æˆäººæ¨¡å¼å°ˆç”¨æ¨¡å‹ï¼ˆéš±è—ï¼Œé–‹å•Ÿæ™‚é¡¯ç¤ºï¼‰ -->
                    <div id="nsfwModelsHint" class="hidden mt-2 p-2 bg-red-950/30 border border-red-900/30 rounded-lg">
                        <p class="text-[10px] text-red-400"><i class="fas fa-fire mr-1"></i>ç„¡å¯©æŸ¥æ¨¡å¼ â€” <b>Flux Schnellâš¡/ Flux Dev / SDXL / æœ¬åœ° Forge</b> æœ‰æ•ˆ</p>
                        <p class="text-[9px] text-red-400/60 mt-0.5">DALLÂ·Eã€GPT Imageã€Imagenã€Seedreamã€Ideogram ç„¡æ³•ç¹éã€‚<b>Forge æœ¬åœ°ç„¡ä»»ä½•é™åˆ¶</b></p>
                    </div>
                </div>
                <!-- åœ–ç‰‡å°ºå¯¸ -->
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">å°ºå¯¸</label>
                    <div class="flex flex-wrap gap-1.5" id="imgSizes">
                        <button onclick="selectImgSize(this,'1024x1024')" class="model-chip active px-2.5 py-1 rounded-lg text-[11px] border border-slate-700">1:1</button>
                        <button onclick="selectImgSize(this,'1280x720')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">16:9 æ©«</button>
                        <button onclick="selectImgSize(this,'720x1280')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">9:16 ç›´</button>
                        <button onclick="selectImgSize(this,'1152x896')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">4:3</button>
                        <button onclick="selectImgSize(this,'896x1152')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">3:4</button>
                    </div>
                </div>
                <!-- é€²éšè¨­å®šï¼ˆå¯æ‘ºç–Šï¼‰ -->
                <details class="group">
                    <summary class="text-[10px] text-slate-500 cursor-pointer hover:text-slate-300 transition uppercase tracking-wider flex items-center gap-1">
                        <i class="fas fa-sliders text-[9px]"></i>é€²éšè¨­å®š
                        <i class="fas fa-chevron-down text-[8px] ml-auto group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="mt-2 space-y-2 p-2 bg-slate-900/50 rounded-lg border border-slate-800/50">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-slate-500">æ­¥æ•¸ (Steps)</label>
                            <span id="imgStepsVal" class="text-[10px] text-violet-400">25</span>
                        </div>
                        <input type="range" id="imgSteps" min="4" max="50" step="1" value="25" class="w-full h-1 accent-violet-500" oninput="document.getElementById('imgStepsVal').textContent=this.value">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-slate-500">CFG Scale</label>
                            <span id="imgCfgVal" class="text-[10px] text-violet-400">7.0</span>
                        </div>
                        <input type="range" id="imgCfg" min="1" max="20" step="0.5" value="7" class="w-full h-1 accent-violet-500" oninput="document.getElementById('imgCfgVal').textContent=parseFloat(this.value).toFixed(1)">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-slate-500">è² é¢æç¤ºè©</label>
                        </div>
                        <input type="text" id="imgNegPrompt" value="blurry, low quality, distorted, watermark, text, ugly, deformed" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-2 py-1.5 text-[10px] text-slate-400 focus:outline-none focus:border-violet-500/50">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-slate-500">æ‰¹æ¬¡æ•¸é‡</label>
                            <div class="flex gap-1">
                                <button onclick="setBatchCount(1)" id="batch1" class="model-chip active px-2 py-0.5 rounded text-[10px] border border-slate-700">1 å¼µ</button>
                                <button onclick="setBatchCount(2)" id="batch2" class="model-chip px-2 py-0.5 rounded text-[10px] border border-slate-700 text-slate-400">2 å¼µ</button>
                                <button onclick="setBatchCount(4)" id="batch4" class="model-chip px-2 py-0.5 rounded text-[10px] border border-slate-700 text-slate-400">4 å¼µ</button>
                            </div>
                        </div>
                    </div>
                </details>
                <button onclick="generateImage()" id="imgGenBtn"
                    class="w-full bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white font-semibold py-3 rounded-xl text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-wand-magic-sparkles"></i>ç”Ÿæˆåœ–ç‰‡
                </button>
                <div id="imgStatus" class="hidden text-center py-2">
                    <div class="inline-flex items-center gap-2 text-xs text-violet-300">
                        <div class="w-4 h-4 border-2 border-violet-400 border-t-transparent rounded-full animate-spin"></div>
                        <span id="imgStatusText">ç”Ÿæˆä¸­...</span>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">å¿«æ·éˆæ„Ÿ</label>
                    <div class="grid grid-cols-2 gap-1.5">
                        <button onclick="setImgPrompt('ä¸€éš»ç©¿è‘—å¤ªç©ºè¡£çš„æŸ´çŠ¬åœ¨æœˆçƒä¸Šæ•£æ­¥ï¼ŒèƒŒæ™¯æ˜¯åœ°çƒï¼Œé›»å½±ç´šå…‰å½±ï¼Œè¶…å¯«å¯¦')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸ• å¤ªç©ºæŸ´çŠ¬</button>
                        <button onclick="setImgPrompt('è³½åšæœ‹å…‹åŸå¸‚å¤œæ™¯ï¼Œéœ“è™¹ç‡ˆå€’æ˜ åœ¨é›¨æ°´ä¸­ï¼Œé£›è¡Œæ±½è»Šç©¿æ¢­ï¼Œ8Kè¶…é«˜æ¸…')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸŒƒ è³½åšåŸå¸‚</button>
                        <button onclick="setImgPrompt('æ°´å¢¨ç•«é¢¨æ ¼çš„å°ç£å±±è„ˆï¼Œé›²éœ§ç¹šç¹ï¼Œæ—¥å‡ºé‡‘å…‰ï¼Œå‚³çµ±æ±æ–¹ç¾å­¸')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸ”ï¸ æ°´å¢¨å±±è„ˆ</button>
                        <button onclick="setImgPrompt('å¯æ„›çš„è²“å’ªååœ¨å’–å•¡æ¯è£¡ï¼Œå‘¨åœæ˜¯ç”œé»å’ŒèŠ±æœµï¼ŒæŸ”å’Œçš„ç²‰è‰²èª¿ï¼Œæ’ç•«é¢¨æ ¼')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸ± æ¯ä¸­è²“å’ª</button>
                        <button onclick="setImgPrompt('æœªä¾†ç§‘æŠ€å¯¦é©—å®¤ï¼Œå…¨æ¯æŠ•å½±é¡¯ç¤ºDNAçµæ§‹ï¼Œç§‘å­¸å®¶åœ¨å·¥ä½œï¼Œè—è‰²å†·å…‰èª¿')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸ”¬ ç§‘æŠ€å¯¦é©—å®¤</button>
                        <button onclick="setImgPrompt('å¥‡å¹»æ£®æ—ä¸­çš„ç²¾éˆåŸå ¡ï¼Œå·¨å¤§çš„ç™¼å…‰è˜‘è‡ï¼Œè¢ç«èŸ²é£›èˆï¼Œé­”å¹»å¯«å¯¦é¢¨æ ¼')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸ° ç²¾éˆåŸå ¡</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-1 flex items-center justify-center p-4 overflow-auto bg-slate-950">
            <div id="imgEmpty" class="text-center fade-up">
                <div class="text-5xl mb-3">ğŸ¨</div>
                <h2 class="text-lg font-bold text-slate-300 mb-1">ç„¡é™ AI ç”Ÿåœ–</h2>
                <p class="text-xs text-slate-500 max-w-xs">è¼¸å…¥æè¿°æˆ–é»æ“Šéˆæ„Ÿï¼Œå…è²»ç”Ÿæˆç„¡é™å¼µåœ–ç‰‡</p>
                <p class="text-[10px] text-slate-600 mt-2">DALLÂ·E 3 Â· GPT Image Â· Flux Â· SDXL Â· Imagen 4 Â· Forge æœ¬åœ°</p>
            </div>
            <div id="imgResult" class="hidden max-w-full">
                <div id="imgContainer" class="relative rounded-xl overflow-hidden shadow-2xl border border-slate-800"></div>
                <div class="flex items-center justify-center gap-2 mt-3 flex-wrap">
                    <button onclick="downloadCurrentImage()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs transition"><i class="fas fa-download mr-1"></i>ä¸‹è¼‰</button>
                    <button onclick="sendImgToI2V()" class="px-3 py-1.5 bg-violet-800 hover:bg-violet-700 rounded-lg text-xs transition"><i class="fas fa-photo-film mr-1"></i>è½‰å½±ç‰‡</button>
                    <button onclick="upscaleCurrentImage()" id="upscaleBtn" class="px-3 py-1.5 bg-emerald-800 hover:bg-emerald-700 rounded-lg text-xs transition"><i class="fas fa-expand mr-1"></i>æ”¾å¤§ 2x</button>
                    <button onclick="generateImage()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs transition"><i class="fas fa-rotate mr-1"></i>é‡æ–°ç”Ÿæˆ</button>
                    <span id="imgMeta" class="text-[10px] text-slate-600 ml-2"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== åœ–ç‰‡ç”Ÿå½±ç‰‡ (Image-to-Video) ===== -->
    <div id="panelImg2vid" class="flex-1 flex overflow-hidden hidden">
        <div class="w-full lg:w-[380px] flex-shrink-0 flex flex-col border-r border-slate-800/60 overflow-y-auto">
            <div class="p-3 space-y-3">
                <!-- ä¸Šå‚³åœ–ç‰‡å€ -->
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">ä¸Šå‚³åƒè€ƒåœ–ç‰‡</label>
                    <div id="i2vDropZone" class="drop-zone rounded-xl p-6 text-center cursor-pointer" onclick="document.getElementById('i2vFileInput').click()">
                        <div id="i2vPreview" class="hidden">
                            <img id="i2vPreviewImg" class="max-h-40 mx-auto rounded-lg" alt="">
                            <p class="text-[10px] text-slate-400 mt-2">é»æ“Šæ›´æ›åœ–ç‰‡</p>
                        </div>
                        <div id="i2vPlaceholder">
                            <i class="fas fa-cloud-arrow-up text-2xl text-slate-600 mb-2"></i>
                            <p class="text-xs text-slate-500">æ‹–æ”¾åœ–ç‰‡æˆ–é»æ“Šä¸Šå‚³</p>
                            <p class="text-[10px] text-slate-600 mt-1">æ”¯æ´ JPG / PNG / WebP</p>
                        </div>
                    </div>
                    <input type="file" id="i2vFileInput" accept="image/*" class="hidden" onchange="handleI2VUpload(this)">
                </div>
                <!-- å‹•æ…‹æè¿° -->
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1 uppercase tracking-wider">å‹•æ…‹æè¿°ï¼ˆå¯é¸ï¼‰</label>
                    <textarea id="i2vPrompt" rows="2" placeholder="æè¿°ä½ æƒ³è¦çš„å‹•æ…‹æ•ˆæœï¼Œä¾‹å¦‚ï¼šé¡é ­ç·©æ…¢æ¨é€²ï¼Œé ­é«®éš¨é¢¨é£„å‹•..."
                        class="w-full bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-sm resize-none focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/20 transition placeholder:text-slate-600"></textarea>
                </div>
                <!-- æ¨¡å‹ -->
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">æ¨¡å‹</label>
                    <div class="flex flex-wrap gap-1.5" id="i2vModels">
                        <button onclick="selectI2VModel(this,'sora-2')" class="model-chip active px-2.5 py-1 rounded-lg text-[11px] border border-slate-700">Sora 2</button>
                        <button onclick="selectI2VModel(this,'sora-2-pro')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">Sora 2 Pro</button>
                        <button onclick="selectI2VModel(this,'kling-video/kolors-image-to-video')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-cyan-800 text-cyan-400 bg-cyan-950/20">Kling</button>
                        <button onclick="selectI2VModel(this,'luma/ray-2-flash')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-cyan-800 text-cyan-400 bg-cyan-950/20">Luma Ray2</button>
                        <button onclick="selectI2VModel(this,'minimax/image-to-video-01')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-cyan-800 text-cyan-400 bg-cyan-950/20">MiniMax</button>
                        <button onclick="selectI2VModel(this,'wan-ai/wan2.1-i2v-480p')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-cyan-800 text-cyan-400 bg-cyan-950/20">Wan2.1</button>
                        <span class="w-full h-0 border-t border-slate-800/50"></span>
                        <button onclick="selectI2VModel(this,'__comfyui_vid__')" data-local="1" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-emerald-800 text-emerald-400 bg-emerald-950/30">
                            <i class="fas fa-server mr-0.5"></i>ComfyUI æœ¬åœ° <span class="text-[9px] opacity-60">0 token</span>
                        </button>
                    </div>
                </div>
                <!-- æ™‚é•· -->
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">æ™‚é•·</label>
                    <div class="flex gap-1.5">
                        <button onclick="selectI2VDur(this,4)" class="model-chip active px-3 py-1 rounded-lg text-[11px] border border-slate-700">4 ç§’</button>
                        <button onclick="selectI2VDur(this,8)" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">8 ç§’</button>
                        <button onclick="selectI2VDur(this,10)" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">10 ç§’</button>
                    </div>
                </div>
                <!-- è§£æåº¦ -->
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">è§£æåº¦</label>
                    <div class="flex gap-1.5">
                        <button onclick="selectI2VRes(this,'720p')" class="model-chip active px-3 py-1 rounded-lg text-[11px] border border-slate-700">720p</button>
                        <button onclick="selectI2VRes(this,'1080p')" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">1080p</button>
                    </div>
                </div>
                <button onclick="generateI2V()" id="i2vGenBtn"
                    class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-semibold py-3 rounded-xl text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-photo-film"></i>ç”Ÿæˆå½±ç‰‡
                </button>
                <div id="i2vStatus" class="hidden text-center py-2">
                    <div class="inline-flex items-center gap-2 text-xs text-cyan-300">
                        <div class="w-4 h-4 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
                        <span id="i2vStatusText">å½±ç‰‡ç”Ÿæˆä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-1 flex items-center justify-center p-4 overflow-auto bg-slate-950">
            <div id="i2vEmpty" class="text-center fade-up">
                <div class="text-5xl mb-3">ğŸï¸</div>
                <h2 class="text-lg font-bold text-slate-300 mb-1">åœ–ç‰‡ç”Ÿå½±ç‰‡</h2>
                <p class="text-xs text-slate-500 max-w-xs">ä¸Šå‚³ä¸€å¼µåœ–ç‰‡ï¼ŒAI è®“å®ƒå‹•èµ·ä¾†</p>
                <p class="text-[10px] text-slate-600 mt-2">Sora 2 Â· Kling Â· Luma Ray2 Â· MiniMax Â· Wan2.1</p>
            </div>
            <div id="i2vResult" class="hidden max-w-full w-full max-w-2xl">
                <div id="i2vContainer" class="relative rounded-xl overflow-hidden shadow-2xl border border-slate-800 bg-black"></div>
                <div class="flex items-center justify-center gap-2 mt-3">
                    <button onclick="downloadI2V()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs transition"><i class="fas fa-download mr-1"></i>ä¸‹è¼‰</button>
                    <button onclick="generateI2V()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs transition"><i class="fas fa-rotate mr-1"></i>é‡æ–°ç”Ÿæˆ</button>
                    <span id="i2vMeta" class="text-[10px] text-slate-600 ml-2"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== æ–‡å­—ç”Ÿå½±ç‰‡ ===== -->
    <div id="panelVideo" class="flex-1 flex overflow-hidden hidden">
        <div class="w-full lg:w-[380px] flex-shrink-0 flex flex-col border-r border-slate-800/60 overflow-y-auto">
            <div class="p-3 space-y-3">
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1 uppercase tracking-wider">æè¿°ä½ æƒ³è¦çš„å½±ç‰‡</label>
                    <textarea id="vidPrompt" rows="3" placeholder="ä¾‹å¦‚ï¼šæ—¥å‡ºæ™‚åˆ†ï¼Œç„¡äººæ©Ÿé£›è¶Šå¹³éœçš„æµ·é¢ï¼Œé‡‘è‰²é™½å…‰ç‘åœ¨æ³¢æµªä¸Š..."
                        class="w-full bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-sm resize-none focus:outline-none focus:border-pink-500/50 focus:ring-1 focus:ring-pink-500/20 transition placeholder:text-slate-600"></textarea>
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">æ¨¡å‹</label>
                    <div class="flex flex-wrap gap-1.5" id="vidModels">
                        <button onclick="selectVidModel(this,'sora-2')" class="model-chip active px-2.5 py-1 rounded-lg text-[11px] border border-slate-700">Sora 2</button>
                        <button onclick="selectVidModel(this,'sora-2-pro')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">Sora 2 Pro</button>
                        <button onclick="selectVidModel(this,'luma/ray-2-flash')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-rose-800 text-rose-400 bg-rose-950/20">Luma Ray2</button>
                        <button onclick="selectVidModel(this,'minimax/video-01')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-rose-800 text-rose-400 bg-rose-950/20">MiniMax</button>
                        <button onclick="selectVidModel(this,'wan-ai/wan2.1-t2v-480p')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-rose-800 text-rose-400 bg-rose-950/20">Wan2.1</button>
                        <button onclick="selectVidModel(this,'kling-video/kolors-text-to-video')" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-rose-800 text-rose-400 bg-rose-950/20">Kling</button>
                        <span class="w-full h-0 border-t border-slate-800/50"></span>
                        <button onclick="selectVidModel(this,'__comfyui_vid__')" data-local="1" class="model-chip px-2.5 py-1 rounded-lg text-[11px] border border-emerald-800 text-emerald-400 bg-emerald-950/30">
                            <i class="fas fa-server mr-0.5"></i>ComfyUI æœ¬åœ° <span class="text-[9px] opacity-60">0 token</span>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">æ™‚é•·</label>
                    <div class="flex gap-1.5">
                        <button onclick="selectVidDuration(this,4)" class="model-chip active px-3 py-1 rounded-lg text-[11px] border border-slate-700">4 ç§’</button>
                        <button onclick="selectVidDuration(this,8)" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">8 ç§’</button>
                        <button onclick="selectVidDuration(this,12)" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">12 ç§’</button>
                        <button onclick="selectVidDuration(this,16)" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">16 ç§’</button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">å°ºå¯¸</label>
                    <div class="flex flex-wrap gap-1.5">
                        <button onclick="selectVidSize(this,'1280x720')" class="model-chip active px-3 py-1 rounded-lg text-[11px] border border-slate-700">720p æ©«</button>
                        <button onclick="selectVidSize(this,'720x1280')" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">720p ç›´</button>
                        <button onclick="selectVidSize(this,'1920x1080')" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">1080p æ©«</button>
                        <button onclick="selectVidSize(this,'1080x1920')" class="model-chip px-3 py-1 rounded-lg text-[11px] border border-slate-700 text-slate-400">1080p ç›´</button>
                    </div>
                </div>
                <button onclick="generateVideo()" id="vidGenBtn"
                    class="w-full bg-gradient-to-r from-rose-600 to-pink-600 hover:from-rose-500 hover:to-pink-500 text-white font-semibold py-3 rounded-xl text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-film"></i>ç”Ÿæˆå½±ç‰‡
                </button>
                <div id="vidStatus" class="hidden text-center py-2">
                    <div class="inline-flex items-center gap-2 text-xs text-pink-300">
                        <div class="w-4 h-4 border-2 border-pink-400 border-t-transparent rounded-full animate-spin"></div>
                        <span id="vidStatusText">å½±ç‰‡ç”Ÿæˆä¸­ï¼ˆç´„ 1-3 åˆ†é˜ï¼‰...</span>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1.5 uppercase tracking-wider">å¿«æ·éˆæ„Ÿ</label>
                    <div class="grid grid-cols-2 gap-1.5">
                        <button onclick="setVidPrompt('æ—¥å‡ºæ™‚åˆ†ç„¡äººæ©Ÿé£›è¶Šå¹³éœçš„æµ·é¢ï¼Œé‡‘è‰²é™½å…‰ç‘åœ¨æ³¢æµªä¸Šï¼Œé›»å½±ç´šç•«è³ª')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸŒ… æµ·ä¸Šæ—¥å‡º</button>
                        <button onclick="setVidPrompt('ä¸€éš»ç‹ç‹¸åœ¨é»ƒæ˜çš„é›ªåœ°æ£®æ—ä¸­å¥”è·‘ï¼Œé›ªèŠ±é£›èˆï¼Œæ…¢å‹•ä½œï¼Œé›»å½±æ„Ÿ')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸ¦Š é›ªåœ°ç‹ç‹¸</button>
                        <button onclick="setVidPrompt('å¤ªç©ºç«™çª—å¤–çš„åœ°çƒç·©æ…¢æ—‹è½‰ï¼Œæ˜Ÿæ˜Ÿé–ƒçˆï¼Œå¯§éœçš„å¤ªç©ºå ´æ™¯')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸŒ å¤ªç©ºåœ°çƒ</button>
                        <button onclick="setVidPrompt('ç¹å¿™çš„æ±äº¬è¡—é ­å¤œæ™¯ï¼Œéœ“è™¹ç‡ˆé–ƒçˆï¼Œè¡Œäººç©¿æ¢­ï¼Œç¸®æ™‚æ”å½±é¢¨æ ¼')" class="text-left p-2 bg-slate-900/80 hover:bg-slate-800 rounded-lg border border-slate-800/50 transition text-[10px] text-slate-400">ğŸ—¼ æ±äº¬å¤œæ™¯</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-1 flex items-center justify-center p-4 overflow-auto bg-slate-950">
            <div id="vidEmpty" class="text-center fade-up">
                <div class="text-5xl mb-3">ğŸ¬</div>
                <h2 class="text-lg font-bold text-slate-300 mb-1">ç„¡é™ AI ç”Ÿå½±ç‰‡</h2>
                <p class="text-xs text-slate-500 max-w-xs">è¼¸å…¥æè¿°ï¼ŒAI ç”Ÿæˆé›»å½±ç´šçŸ­ç‰‡</p>
                <p class="text-[10px] text-slate-600 mt-2">Sora 2 Â· Luma Ray2 Â· MiniMax Â· Wan2.1 Â· Kling Â· æœ€é•· 16s</p>
            </div>
            <div id="vidResult" class="hidden max-w-full w-full max-w-2xl">
                <div id="vidContainer" class="relative rounded-xl overflow-hidden shadow-2xl border border-slate-800 bg-black"></div>
                <div class="flex items-center justify-center gap-2 mt-3">
                    <button onclick="downloadCurrentVideo()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs transition"><i class="fas fa-download mr-1"></i>ä¸‹è¼‰</button>
                    <button onclick="generateVideo()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs transition"><i class="fas fa-rotate mr-1"></i>é‡æ–°ç”Ÿæˆ</button>
                    <span id="vidMeta" class="text-[10px] text-slate-600 ml-2"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ä½œå“åº« ===== -->
    <div id="panelGallery" class="flex-1 overflow-y-auto p-4 hidden">
        <div class="max-w-6xl mx-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-bold text-slate-300">æˆ‘çš„ä½œå“</h2>
                <button onclick="clearGallery()" class="text-[10px] text-red-400 hover:text-red-300 transition">æ¸…ç©ºå…¨éƒ¨</button>
            </div>
            <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <div class="text-center text-xs text-slate-600 col-span-full py-12">å°šç„¡ä½œå“ï¼Œå»ç”Ÿæˆä¸€äº›å§ï¼</div>
            </div>
        </div>
    </div>
</div>

<script>
// â”€â”€ ç‹€æ…‹ â”€â”€
let currentImgModel = 'dall-e-3';
let currentImgSize = '1024x1024';
let currentVidModel = 'sora-2';
let currentVidDuration = 4;
let currentVidSize = '1280x720';
let currentI2VModel = 'sora-2';
let currentI2VDur = 4;
let currentI2VRes = '720p';
let currentImgElement = null;
let currentVidElement = null;
let currentI2VElement = null;
let i2vImageDataUrl = null;
let refImageBase64 = null;
let refImageMime = null;
let batchCount = 1;
let localMode = localStorage.getItem('ai_studio_local') === 'true';
let comfyuiVideoSupport = { animatediff: false, svd: false, wan: false, vhs: false };
let nsfwMode = localStorage.getItem('ai_studio_nsfw') === 'true';
let comfyuiOnline = false;
let comfyuiModels = [];
let forgeOnline = false;
let forgeModels = [];
let forgeCurrentModel = '';
let gallery = JSON.parse(localStorage.getItem('ai_studio_gallery') || '[]');
let todayCount = parseInt(localStorage.getItem('ai_studio_today_' + new Date().toDateString()) || '0');
document.getElementById('todayCount').textContent = todayCount;

// â”€â”€ è¨‚é–±/ä»˜è²»ç‰†ç³»çµ± â”€â”€
let userPlan = 'creator_free'; // creator_free | creator_basic | creator_pro | creator_ultra
let planLimits = { creator_free: {images:20,videos:5,nsfw:false,local:false}, creator_basic: {images:200,videos:30,nsfw:false,local:false}, creator_pro: {images:-1,videos:100,nsfw:true,local:true}, creator_ultra: {images:-1,videos:-1,nsfw:true,local:true} };
let monthlyImageCount = 0;
let monthlyVideoCount = 0;

async function checkSubscription() {
    try {
        const token = localStorage.getItem('jarvis_token');
        if (!token) { updatePlanUI('creator_free'); return; }
        const r = await fetch('/api/revenue/subscriptions?product=ai_creator', { headers: { 'Authorization': 'Bearer ' + token } });
        const d = await r.json();
        if (d.ok && d.subscriptions && d.subscriptions.length > 0) {
            const sub = d.subscriptions[d.subscriptions.length - 1];
            userPlan = sub.plan;
        }
    } catch(e) { console.log('Subscription check failed:', e); }
    updatePlanUI(userPlan);
}

function updatePlanUI(plan) {
    const badge = document.getElementById('planBadge');
    const upgradeBtn = document.getElementById('upgradeBtn');
    const names = { creator_free:'å…è²»é«”é©—', creator_basic:'åŸºç¤ç‰ˆ', creator_pro:'å°ˆæ¥­ç‰ˆ', creator_ultra:'ç„¡é™ç‰ˆ' };
    const colors = { creator_free:'text-slate-400', creator_basic:'text-emerald-400', creator_pro:'text-pink-400', creator_ultra:'text-violet-400' };
    badge.textContent = names[plan] || 'å…è²»é«”é©—';
    badge.className = colors[plan] || 'text-slate-400';
    upgradeBtn.classList.toggle('hidden', plan === 'creator_ultra');
}

function canGenerate(type) {
    const limits = planLimits[userPlan] || planLimits.creator_free;
    if (type === 'image' && limits.images !== -1 && todayCount >= Math.ceil(limits.images / 30)) {
        showPaywall('ä»Šæ—¥åœ–ç‰‡é¡åº¦å·²ç”¨å®Œ', `æ‚¨çš„ ${userPlan === 'creator_free' ? 'å…è²»' : 'åŸºç¤'}æ–¹æ¡ˆæ¯æ—¥å¯ç”Ÿæˆç´„ ${Math.ceil(limits.images/30)} å¼µåœ–ç‰‡ã€‚å‡ç´šä»¥ç²å¾—æ›´å¤šé¡åº¦ï¼`);
        return false;
    }
    if (type === 'video' && limits.videos !== -1 && monthlyVideoCount >= limits.videos) {
        showPaywall('æœ¬æœˆå½±ç‰‡é¡åº¦å·²ç”¨å®Œ', `å‡ç´šåˆ°å°ˆæ¥­ç‰ˆä»¥ç²å¾—æ›´å¤šå½±ç‰‡ç”Ÿæˆé¡åº¦ï¼`);
        return false;
    }
    return true;
}

function canUseNSFW() {
    const limits = planLimits[userPlan] || planLimits.creator_free;
    if (!limits.nsfw) {
        showPaywall('ç„¡å¯©æŸ¥æ¨¡å¼éœ€è¦å°ˆæ¥­ç‰ˆ', 'å‡ç´šåˆ°å°ˆæ¥­ç‰ˆï¼ˆ$799/æœˆï¼‰å³å¯è§£é–ç„¡å¯©æŸ¥æ¨¡å¼ï¼Œä½¿ç”¨ Forge æœ¬åœ°ç„¡é™åˆ¶ç”Ÿåœ–ã€‚');
        return false;
    }
    return true;
}

function canUseLocal() {
    // æœ¬åœ°æ¨¡å‹ä½¿ç”¨è‡ªå·±çš„ GPUï¼Œä¸æ¶ˆè€—ä»»ä½• tokenï¼Œæ°¸é å…è¨±
    return true;
}

function showPaywall(title, desc) {
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black/70 z-[999] flex items-center justify-center p-4';
    overlay.innerHTML = `<div class="glass rounded-2xl p-6 max-w-md w-full text-center">
        <div class="text-4xl mb-3">ğŸ”’</div>
        <h3 class="text-lg font-bold mb-2">${title}</h3>
        <p class="text-sm text-slate-400 mb-4">${desc}</p>
        <div class="flex gap-2 justify-center">
            <a href="/payment" class="bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white px-6 py-2.5 rounded-xl text-sm font-medium transition">å‡ç´šæ–¹æ¡ˆ</a>
            <button onclick="this.closest('.fixed').remove()" class="bg-slate-800 hover:bg-slate-700 px-6 py-2.5 rounded-xl text-sm transition">ç¨å¾Œ</button>
        </div>
        <div class="mt-4 grid grid-cols-3 gap-2 text-[10px]">
            <div class="p-2 bg-slate-900/50 rounded-lg"><div class="text-pink-400 font-bold">åŸºç¤ $299</div><div class="text-slate-500">200 åœ–/æœˆ</div></div>
            <div class="p-2 bg-pink-950/30 rounded-lg border border-pink-900/30"><div class="text-pink-400 font-bold">å°ˆæ¥­ $799</div><div class="text-slate-500">ç„¡é™+NSFW</div></div>
            <div class="p-2 bg-violet-950/30 rounded-lg border border-violet-900/30"><div class="text-violet-400 font-bold">ç„¡é™ $1,999</div><div class="text-slate-500">å…¨éƒ¨ç„¡é™</div></div>
        </div>
    </div>`;
    document.body.appendChild(overlay);
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
}

checkSubscription();

// â”€â”€ æˆäººæ¨¡å¼ â”€â”€
function toggleNSFW() {
    if (!nsfwMode && !canUseNSFW()) return;
    nsfwMode = !nsfwMode;
    localStorage.setItem('ai_studio_nsfw', nsfwMode);
    updateNSFWUI();
}
function updateNSFWUI() {
    const tog = document.getElementById('nsfwToggle');
    const hint = document.getElementById('nsfwModelsHint');
    const chips = document.querySelectorAll('#imgModels .model-chip');
    if (nsfwMode) {
        tog.classList.remove('off'); tog.classList.add('on');
        hint.classList.remove('hidden');
        // ç°æ‰ä¸æ”¯æ´çš„æ¨¡å‹ï¼Œé«˜äº® Together æ¨¡å‹
        chips.forEach(c => {
            if (!c.dataset.together) {
                c.style.opacity = '0.35';
                c.style.pointerEvents = 'none';
            } else {
                c.style.opacity = ''; c.style.pointerEvents = '';
            }
        });
        // è‡ªå‹•åˆ‡æ›åˆ° Flux Schnellï¼ˆå¦‚æœç•¶å‰é¸çš„ä¸æ”¯æ´ï¼‰
        const cur = document.querySelector('#imgModels .model-chip.active');
        if (cur && !cur.dataset.together) {
            const fluxBtn = document.querySelector('#imgModels .model-chip[data-together]');
            if (fluxBtn) fluxBtn.click();
        }
    } else {
        tog.classList.remove('on'); tog.classList.add('off');
        hint.classList.add('hidden');
        chips.forEach(c => { c.style.opacity = ''; c.style.pointerEvents = ''; });
    }
}
updateNSFWUI();

// â”€â”€ æœ¬åœ°æ¨¡å¼ â”€â”€
function toggleLocalMode() {
    localMode = !localMode;
    localStorage.setItem('ai_studio_local', localMode);
    updateLocalModeUI();
}
function updateLocalModeUI() {
    const tog = document.getElementById('localToggle');
    const label = document.getElementById('localModeLabel');
    if (localMode) {
        tog.classList.remove('off'); tog.classList.add('on');
        tog.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        label.textContent = 'ğŸ–¥ï¸ æœ¬åœ°';
        label.className = 'text-[10px] text-emerald-400 font-bold';
        // è‡ªå‹•é¸æ“‡ Forgeï¼ˆå¦‚æœåœ¨ç·šï¼‰æˆ– ComfyUI
        if (forgeOnline) {
            const forgeBtn = document.querySelector('#imgModels [data-local][onclick*="__forge__"]');
            if (forgeBtn) forgeBtn.click();
        } else if (comfyuiOnline) {
            const comfyBtn = document.querySelector('#imgModels [data-local][onclick*="__comfyui__"]');
            if (comfyBtn) comfyBtn.click();
        }
        // ç°æ‰é›²ç«¯æ¨¡å‹
        document.querySelectorAll('#imgModels .model-chip:not([data-local])').forEach(c => {
            c.style.opacity = '0.3'; c.style.pointerEvents = 'none';
        });
        document.querySelectorAll('#imgModels .model-chip[data-local]').forEach(c => {
            c.style.opacity = ''; c.style.pointerEvents = '';
        });
    } else {
        tog.classList.remove('on'); tog.classList.add('off');
        tog.style.background = '';
        label.textContent = 'â˜ï¸ é›²ç«¯';
        label.className = 'text-[10px] text-slate-500';
        // æ¢å¾©æ‰€æœ‰æ¨¡å‹
        document.querySelectorAll('#imgModels .model-chip').forEach(c => {
            c.style.opacity = ''; c.style.pointerEvents = '';
        });
    }
}
updateLocalModeUI();

// æª¢æŸ¥ ComfyUI å½±ç‰‡æ”¯æ´
async function checkComfyUIVideo() {
    try {
        const r = await fetch('/api/comfyui/video-status');
        const d = await r.json();
        comfyuiVideoSupport = d;
    } catch { comfyuiVideoSupport = { online: false, animatediff: false, svd: false, wan: false, vhs: false }; }
}
checkComfyUIVideo();

// æ™ºæ…§ç¿»è­¯ï¼ˆGroq 70B â†’ Gemini â†’ Grok â†’ Ollama fallbackï¼‰
async function translatePromptLocal(prompt) {
    try {
        const r = await fetch('/api/ai/translate-prompt', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ prompt, local_only: localMode })
        });
        const d = await r.json();
        if (d.ok && d.translated) {
            const provider = d.provider || '';
            const stxt = document.getElementById('imgStatusText');
            if (stxt && provider && provider !== 'none') stxt.textContent = `[${provider}] ç¿»è­¯å®Œæˆ â†’ ç”Ÿæˆä¸­...`;
            return d.translated;
        }
    } catch {}
    return prompt; // fallback: åŸæ–‡
}

// æœ¬åœ° ComfyUI å½±ç‰‡ç”Ÿæˆ
async function generateLocalVideo(prompt, opts = {}) {
    const r = await fetch('/api/comfyui/generate-video', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
            prompt,
            width: opts.width || 512,
            height: opts.height || 512,
            frames: opts.frames || 16,
            fps: opts.fps || 8,
            steps: opts.steps || 20,
            cfg: opts.cfg || 7.0,
            init_image: opts.init_image || null,
        })
    });
    const d = await r.json();
    if (d.error) {
        let errMsg = d.error;
        if (d.install_guide) errMsg += '\n\n' + d.install_guide;
        if (d.download_url) errMsg += '\nä¸‹è¼‰: ' + d.download_url;
        if (d.url) errMsg += '\né€£ç·šä½å€: ' + d.url;
        throw new Error(errMsg);
    }
    return d.video; // data:video/mp4;base64,... or data:image/gif;base64,...
}

// â”€â”€ åˆ†é åˆ‡æ› â”€â”€
const TABS = ['image','img2vid','video','gallery'];
function switchTab(tab) {
    TABS.forEach(t => {
        const panelId = 'panel' + t.charAt(0).toUpperCase() + t.slice(1);
        const tabId = 'tab' + t.charAt(0).toUpperCase() + t.slice(1);
        document.getElementById(panelId).classList.toggle('hidden', t !== tab);
        const el = document.getElementById(tabId);
        if (t === tab) { el.classList.add('tab-active'); el.classList.remove('text-slate-400'); }
        else { el.classList.remove('tab-active'); el.classList.add('text-slate-400'); }
    });
    if (tab === 'gallery') renderGallery();
}

// â”€â”€ æ¨¡å‹é¸æ“‡ â”€â”€
function selectChip(containerId, btn) {
    document.querySelectorAll('#' + containerId + ' .model-chip').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-400'); });
    btn.classList.add('active'); btn.classList.remove('text-slate-400');
}
function selectImgModel(btn, model) { currentImgModel = model; selectChip('imgModels', btn); }
function selectImgSize(btn, size) { currentImgSize = size; btn.parentElement.querySelectorAll('.model-chip').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-400'); }); btn.classList.add('active'); btn.classList.remove('text-slate-400'); }
function selectVidModel(btn, model) { currentVidModel = model; selectChip('vidModels', btn); }
function selectI2VModel(btn, model) { currentI2VModel = model; selectChip('i2vModels', btn); }
function selectVidDuration(btn, dur) { currentVidDuration = dur; btn.parentElement.querySelectorAll('.model-chip').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-400'); }); btn.classList.add('active'); btn.classList.remove('text-slate-400'); }
function selectVidSize(btn, size) { currentVidSize = size; btn.parentElement.querySelectorAll('.model-chip').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-400'); }); btn.classList.add('active'); btn.classList.remove('text-slate-400'); }
function selectI2VDur(btn, dur) { currentI2VDur = dur; btn.parentElement.querySelectorAll('.model-chip').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-400'); }); btn.classList.add('active'); btn.classList.remove('text-slate-400'); }
function selectI2VRes(btn, res) { currentI2VRes = res; btn.parentElement.querySelectorAll('.model-chip').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-400'); }); btn.classList.add('active'); btn.classList.remove('text-slate-400'); }
function setBatchCount(n) { batchCount = n; [1,2,4].forEach(v => { const el = document.getElementById('batch'+v); if(el){ if(v===n){el.classList.add('active');el.classList.remove('text-slate-400');}else{el.classList.remove('active');el.classList.add('text-slate-400');} } }); }

// â”€â”€ AI æç¤ºè©å¢å¼·ï¼ˆæ™ºæ…§è·¯ç”±ï¼šGroq 70B â†’ Gemini â†’ Grok â†’ Ollamaï¼‰ â”€â”€
async function enhancePrompt() {
    const prompt = document.getElementById('imgPrompt').value.trim();
    if (!prompt) { alert('è«‹å…ˆè¼¸å…¥æè¿°'); return; }
    const btn = document.getElementById('enhanceBtn');
    const style = document.getElementById('enhanceStyle').value;
    btn.disabled = true; btn.innerHTML = '<div class="w-3 h-3 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div>å¢å¼·ä¸­...';
    try {
        const r = await fetch('/api/ai/enhance-prompt', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ prompt, style, local_only: localMode })
        });
        const d = await r.json();
        if (d.ok && d.enhanced) {
            document.getElementById('imgPrompt').value = d.enhanced;
            document.getElementById('imgPrompt').style.borderColor = 'rgba(168,85,247,0.5)';
            setTimeout(() => document.getElementById('imgPrompt').style.borderColor = '', 2000);
            // é¡¯ç¤ºä½¿ç”¨çš„ AI æä¾›è€…
            const provider = d.provider || 'AI';
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-magic"></i>âœ… ${provider}`;
            setTimeout(() => { btn.innerHTML = '<i class="fas fa-magic"></i>AI å¢å¼· <span class="text-[9px] text-violet-400 opacity-70">æ™ºæ…§è·¯ç”±</span>'; }, 3000);
            return;
        } else {
            alert('å¢å¼·å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
    } catch(e) { alert('AI å¢å¼·æœå‹™ä¸å¯ç”¨'); }
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i>AI å¢å¼· <span class="text-[9px] text-violet-400 opacity-70">æ™ºæ…§è·¯ç”±</span>';
}

// â”€â”€ å¿«æ·å¡«å…¥ â”€â”€
function setImgPrompt(p) { document.getElementById('imgPrompt').value = p; }
function setVidPrompt(p) { document.getElementById('vidPrompt').value = p; }

// â”€â”€ åƒè€ƒåœ–ä¸Šå‚³ â”€â”€
function handleRefUpload(input) {
    const file = input.files[0];
    if (!file) return;
    refImageMime = file.type || 'image/png';
    const reader = new FileReader();
    reader.onload = (e) => {
        const dataUrl = e.target.result;
        refImageBase64 = dataUrl.split(',')[1];
        document.getElementById('refPreviewImg').src = dataUrl;
        document.getElementById('refPreview').classList.remove('hidden');
        document.getElementById('refPlaceholder').classList.add('hidden');
        document.getElementById('refDropZone').classList.add('has-image');
        document.getElementById('refStrengthWrap').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
}
function clearRefImage() {
    refImageBase64 = null; refImageMime = null;
    document.getElementById('refPreview').classList.add('hidden');
    document.getElementById('refPlaceholder').classList.remove('hidden');
    document.getElementById('refDropZone').classList.remove('has-image');
    document.getElementById('refStrengthWrap').classList.add('hidden');
    document.getElementById('refFileInput').value = '';
}
(function() {
    const rdz = document.getElementById('refDropZone');
    if (!rdz) return;
    rdz.addEventListener('dragover', e => { e.preventDefault(); rdz.classList.add('dragover'); });
    rdz.addEventListener('dragleave', () => rdz.classList.remove('dragover'));
    rdz.addEventListener('drop', e => {
        e.preventDefault(); rdz.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const dt = new DataTransfer(); dt.items.add(file);
            document.getElementById('refFileInput').files = dt.files;
            handleRefUpload(document.getElementById('refFileInput'));
        }
    });
})();

// â”€â”€ åœ–ç‰‡ç”Ÿå½±ç‰‡ï¼šä¸Šå‚³è™•ç† â”€â”€
function handleI2VUpload(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        i2vImageDataUrl = e.target.result;
        document.getElementById('i2vPreviewImg').src = i2vImageDataUrl;
        document.getElementById('i2vPreview').classList.remove('hidden');
        document.getElementById('i2vPlaceholder').classList.add('hidden');
        document.getElementById('i2vDropZone').classList.add('has-image');
    };
    reader.readAsDataURL(file);
}
// æ‹–æ”¾
const dz = document.getElementById('i2vDropZone');
if (dz) {
    dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', e => {
        e.preventDefault(); dz.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const dt = new DataTransfer(); dt.items.add(file);
            document.getElementById('i2vFileInput').files = dt.files;
            handleI2VUpload(document.getElementById('i2vFileInput'));
        }
    });
}

// â”€â”€ å¾ç”Ÿåœ–çµæœç›´æ¥è½‰å½±ç‰‡ â”€â”€
function sendImgToI2V() {
    if (!currentImgElement || !currentImgElement.src) return;
    i2vImageDataUrl = currentImgElement.src;
    document.getElementById('i2vPreviewImg').src = i2vImageDataUrl;
    document.getElementById('i2vPreview').classList.remove('hidden');
    document.getElementById('i2vPlaceholder').classList.add('hidden');
    document.getElementById('i2vDropZone').classList.add('has-image');
    switchTab('img2vid');
}

// â”€â”€ ComfyUI ç‹€æ…‹æª¢æŸ¥ â”€â”€
async function checkComfyUI() {
    try {
        const r = await fetch('/api/comfyui/status');
        const d = await r.json();
        comfyuiOnline = d.online;
        comfyuiModels = d.models || [];
        const dot = document.getElementById('comfyuiDot');
        if (dot) dot.className = 'inline-block w-1.5 h-1.5 rounded-full ml-0.5 ' + (comfyuiOnline ? 'bg-emerald-400' : 'bg-red-500');
    } catch { comfyuiOnline = false; }
}
checkComfyUI();
setInterval(checkComfyUI, 30000);

// â”€â”€ Forge Chroma ç‹€æ…‹æª¢æŸ¥ â”€â”€
async function checkForge() {
    try {
        const r = await fetch('/api/forge/status');
        const d = await r.json();
        forgeOnline = d.online;
        forgeModels = d.models || [];
        forgeCurrentModel = d.current_model || '';
        const dot = document.getElementById('forgeDot');
        if (dot) dot.className = 'inline-block w-1.5 h-1.5 rounded-full ml-0.5 ' + (forgeOnline ? 'bg-amber-400' : 'bg-red-500');
    } catch { forgeOnline = false; }
}
checkForge();
setInterval(checkForge, 30000);

// â”€â”€ Forge Chroma ç”Ÿåœ– â”€â”€
async function generateViaForge(prompt, opts = {}) {
    // è‡ªå‹•ç¿»è­¯ä¸­æ–‡ promptï¼ˆForge ç”¨è‹±æ–‡æ•ˆæœæ›´å¥½ï¼‰
    const hasChinese = /[\u4e00-\u9fff]/.test(prompt);
    if (hasChinese) {
        const stxt = document.getElementById('imgStatusText');
        if (stxt) stxt.textContent = '[æœ¬åœ° Ollama] ç¿»è­¯ä¸­æ–‡ prompt â†’ è‹±æ–‡...';
        prompt = await translatePromptLocal(prompt);
    }
    const [w, h] = currentImgSize.split('x').map(Number);
    const neg = document.getElementById('imgNegPrompt')?.value || 'blurry, low quality, distorted, watermark, text, ugly, deformed';
    const steps = parseInt(document.getElementById('imgSteps')?.value || '25');
    const cfg = parseFloat(document.getElementById('imgCfg')?.value || '7');
    const hasRef = !!refImageBase64;

    // img2img æ¨¡å¼ï¼ˆæœ‰åƒè€ƒåœ–æ™‚ï¼‰
    if (hasRef) {
        const strength = parseFloat(document.getElementById('refStrength')?.value || '0.7');
        const body = {
            prompt, negative_prompt: neg,
            init_image: refImageBase64,
            denoising_strength: strength,
            width: w, height: h, steps, cfg_scale: cfg,
            sampler_name: 'Euler a', seed: -1,
        };
        const r = await fetch('/api/forge/img2img', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const d = await r.json();
        if (d.error) throw new Error(d.error);
        return d.image;
    }

    // æ‰¹æ¬¡æ¨¡å¼
    if (batchCount > 1) {
        const body = {
            prompt, negative_prompt: neg,
            width: w, height: h, steps, cfg_scale: cfg,
            sampler_name: 'Euler a', batch_size: batchCount,
        };
        const r = await fetch('/api/forge/batch', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const d = await r.json();
        if (d.error) throw new Error(d.error);
        return d.images; // è¿”å›é™£åˆ—
    }

    // æ¨™æº– txt2img
    const body = {
        prompt, negative_prompt: neg,
        width: w, height: h, steps, cfg_scale: cfg,
        sampler_name: 'Euler a', seed: -1,
    };
    const r = await fetch('/api/forge/generate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const d = await r.json();
    if (d.error) throw new Error(d.error);
    return d.image;
}

// â”€â”€ æœ¬åœ° ComfyUI ç”Ÿåœ– â”€â”€
async function generateViaComfyUI(prompt) {
    // è‡ªå‹•ç¿»è­¯ä¸­æ–‡ prompt
    const hasChinese = /[\u4e00-\u9fff]/.test(prompt);
    if (hasChinese) {
        const stxt = document.getElementById('imgStatusText');
        if (stxt) stxt.textContent = '[æœ¬åœ° Ollama] ç¿»è­¯ä¸­æ–‡ prompt â†’ è‹±æ–‡...';
        prompt = await translatePromptLocal(prompt);
    }
    const ckpt = comfyuiModels.length > 0 ? comfyuiModels[0] : 'v1-5-pruned-emaonly.safetensors';
    const isFlux = ckpt.toLowerCase().includes('flux');
    const body = {
        prompt,
        checkpoint: ckpt,
        width: isFlux ? 1024 : 512,
        height: isFlux ? 1024 : 512,
        steps: isFlux ? 4 : 20,
        cfg: isFlux ? 1.0 : 7.0,
        sampler: isFlux ? 'euler' : 'euler_ancestral',
    };
    const r = await fetch('/api/comfyui/generate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const d = await r.json();
    if (d.error) throw new Error(d.error);
    return d.image;
}

// â”€â”€ æ–‡å­—ç”Ÿåœ– â”€â”€
async function generateImage() {
    const prompt = document.getElementById('imgPrompt').value.trim();
    if (!prompt) return;
    const isLocalCheck = currentImgModel === '__comfyui__' || currentImgModel === '__forge__';
    // æœ¬åœ°æ¨¡å‹ä¸å—ä»˜è²»ç‰†é™åˆ¶ï¼ˆä½¿ç”¨è‡ªå·±çš„ GPUï¼Œ0 tokenï¼‰
    if (!isLocalCheck && !localMode) {
        if (!canGenerate('image')) return;
    }
    const btn = document.getElementById('imgGenBtn');
    const status = document.getElementById('imgStatus');
    const stxt = document.getElementById('imgStatusText');
    btn.disabled = true;
    btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>ç”Ÿæˆä¸­...';
    status.classList.remove('hidden');

    const isLocal = currentImgModel === '__comfyui__' || currentImgModel === '__forge__';
    const isForge = currentImgModel === '__forge__';
    const hasRef = !!refImageBase64;
    const t0 = Date.now();

    try {
        let imgSrc;
        let isBatch = false;
        if (isForge) {
            if (!forgeOnline) throw new Error('Forge Chroma æœªå•Ÿå‹•ï¼ˆè«‹å…ˆé–‹å•Ÿ Forgeï¼‰');
            const mName = forgeCurrentModel || forgeModels[0] || 'NoobAI-XL';
            const modeStr = hasRef ? '[img2img] ' : (batchCount > 1 ? `[æ‰¹æ¬¡ Ã—${batchCount}] ` : '');
            stxt.textContent = `[æœ¬åœ° Forge] ${modeStr}ä½¿ç”¨ ${mName} ç”Ÿæˆä¸­...`;
            const result = await generateViaForge(prompt);
            if (Array.isArray(result)) {
                isBatch = true;
                imgSrc = result;
            } else {
                imgSrc = result;
            }
        } else if (isLocal) {
            if (!comfyuiOnline) throw new Error('ComfyUI æœªå•Ÿå‹•ï¼ˆè«‹å…ˆé–‹å•Ÿ ComfyUIï¼‰');
            const ckptName = comfyuiModels[0] || 'SD 1.5';
            stxt.textContent = `[æœ¬åœ° ComfyUI] ä½¿ç”¨ ${ckptName} ç”Ÿæˆä¸­...`;
            imgSrc = await generateViaComfyUI(prompt);
        } else {
            const opts = { model: currentImgModel };
            if (nsfwMode) opts.disable_safety_checker = true;
            // å‚³éå°ºå¯¸çµ¦é›²ç«¯æ¨¡å‹
            const [imgW, imgH] = currentImgSize.split('x').map(Number);
            if (imgW && imgH) { opts.width = imgW; opts.height = imgH; }
            if (hasRef) {
                const strength = parseFloat(document.getElementById('refStrength').value);
                const m = currentImgModel.toLowerCase();
                if (m.includes('gemini') || m.includes('imagen')) {
                    opts.provider = 'gemini';
                    if (!m.includes('gemini')) opts.model = 'gemini-2.5-flash-image-preview';
                    opts.input_image = refImageBase64;
                    opts.input_image_mime_type = refImageMime || 'image/png';
                } else if (m.includes('gpt-image') || m === 'dall-e-3') {
                    opts.provider = 'openai-image-generation';
                    if (!m.includes('gpt-image')) opts.model = 'gpt-image-1';
                    opts.image = refImageBase64;
                } else {
                    opts.provider = 'together';
                    opts.image_base64 = refImageBase64;
                    opts.prompt_strength = strength;
                }
            }
            const modeLabel = nsfwMode ? '[ç„¡å¯©æŸ¥] ' : '';
            const refLabel = hasRef ? '[åƒè€ƒåœ–] ' : '';
            stxt.textContent = `${modeLabel}${refLabel}ä½¿ç”¨ ${currentImgModel} ç”Ÿæˆä¸­...`;
            const imgEl = await puter.ai.txt2img(prompt, opts);
            imgSrc = imgEl.src;
        }

        const ms = Date.now() - t0;
        document.getElementById('imgEmpty').classList.add('hidden');
        document.getElementById('imgResult').classList.remove('hidden');
        const container = document.getElementById('imgContainer');
        container.innerHTML = '';

        if (isBatch && Array.isArray(imgSrc)) {
            // æ‰¹æ¬¡çµæœï¼šç¶²æ ¼é¡¯ç¤º
            container.style.display = 'grid';
            container.style.gridTemplateColumns = imgSrc.length <= 2 ? 'repeat(2,1fr)' : 'repeat(2,1fr)';
            container.style.gap = '4px';
            imgSrc.forEach((src, i) => {
                const img = new Image();
                img.src = src;
                img.style.width = '100%';
                img.style.maxHeight = '35vh';
                img.style.objectFit = 'contain';
                img.style.display = 'block';
                img.style.cursor = 'pointer';
                img.title = `é»æ“Šé¸å–ç¬¬ ${i+1} å¼µ`;
                img.onclick = () => { currentImgElement = img; document.querySelectorAll('#imgContainer img').forEach(x => x.style.outline=''); img.style.outline='2px solid #a855f7'; };
                container.appendChild(img);
                if (i === 0) currentImgElement = img;
                addToGallery({ type: 'image', prompt, model: `Forge batch ${i+1}/${imgSrc.length}`, src, time: new Date().toISOString(), duration_ms: ms });
            });
        } else {
            container.style.display = '';
            container.style.gridTemplateColumns = '';
            container.style.gap = '';
            const img = new Image();
            img.src = imgSrc;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '70vh';
            img.style.display = 'block';
            container.appendChild(img);
            currentImgElement = img;
            addToGallery({ type: 'image', prompt, model: isForge ? `Forge ${forgeCurrentModel||'Local'}` : isLocal ? 'ComfyUI' : currentImgModel, src: imgSrc, time: new Date().toISOString(), duration_ms: ms });
        }

        const modelName = isForge ? `Forge ${forgeCurrentModel || 'Local'}` : isLocal ? `ComfyUI` : currentImgModel;
        const label = `${modelName}${hasRef ? ' [åƒè€ƒåœ–]' : ''}${isBatch ? ` [Ã—${imgSrc.length}]` : ''}${nsfwMode && !isLocal ? ' [ç„¡å¯©æŸ¥]' : ''}`;
        document.getElementById('imgMeta').textContent = `${label} Â· ${currentImgSize} Â· ${(ms/1000).toFixed(1)}s`;
        stxt.textContent = `âœ… å®Œæˆï¼ˆ${(ms/1000).toFixed(1)}sï¼‰`;
        incrementCount();
    } catch (e) {
        stxt.textContent = 'âŒ ' + (e.message || 'ç”Ÿæˆå¤±æ•—');
    }
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i>ç”Ÿæˆåœ–ç‰‡';
    setTimeout(() => status.classList.add('hidden'), 3000);
}

// â”€â”€ åœ–ç‰‡æ”¾å¤§ (Upscale) â”€â”€
async function upscaleCurrentImage() {
    if (!currentImgElement || !currentImgElement.src) { alert('è«‹å…ˆç”Ÿæˆä¸€å¼µåœ–ç‰‡'); return; }
    const btn = document.getElementById('upscaleBtn');
    btn.disabled = true; btn.innerHTML = '<div class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></div>æ”¾å¤§ä¸­...';
    try {
        const r = await fetch('/api/forge/upscale', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ image: currentImgElement.src, upscaler: 'R-ESRGAN 4x+', scale: 2 })
        });
        const d = await r.json();
        if (d.error) throw new Error(d.error);
        currentImgElement.src = d.image;
        document.getElementById('imgMeta').textContent += ' â†’ 2x æ”¾å¤§';
        addToGallery({ type: 'image', prompt: '[Upscale 2x]', model: 'R-ESRGAN 4x+', src: d.image, time: new Date().toISOString(), duration_ms: 0 });
    } catch(e) {
        alert('æ”¾å¤§å¤±æ•—ï¼š' + (e.message || 'éœ€è¦ Forge é‹è¡Œä¸­'));
    }
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-expand mr-1"></i>æ”¾å¤§ 2x';
}

// â”€â”€ åœ–ç‰‡ç”Ÿå½±ç‰‡ â”€â”€
async function generateI2V() {
    if (!i2vImageDataUrl) { alert('è«‹å…ˆä¸Šå‚³ä¸€å¼µåœ–ç‰‡'); return; }
    const isLocalVid = currentI2VModel === '__comfyui_vid__' || localMode;
    if (!isLocalVid) { if (!canGenerate('video')) return; }
    let prompt = document.getElementById('i2vPrompt').value.trim() || 'smooth cinematic motion';
    const btn = document.getElementById('i2vGenBtn');
    const status = document.getElementById('i2vStatus');
    const stxt = document.getElementById('i2vStatusText');
    btn.disabled = true;
    btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>ç”Ÿæˆä¸­...';
    status.classList.remove('hidden');

    const t0 = Date.now();
    try {
        if (isLocalVid) {
            // æœ¬åœ° ComfyUI å½±ç‰‡ç”Ÿæˆï¼ˆ0 tokenï¼‰
            if (/[\u4e00-\u9fff]/.test(prompt)) {
                stxt.textContent = '[æœ¬åœ° Ollama] ç¿»è­¯ prompt...';
                prompt = await translatePromptLocal(prompt);
            }
            stxt.textContent = '[æœ¬åœ° ComfyUI] AnimateDiff å½±ç‰‡ç”Ÿæˆä¸­ï¼ˆ0 tokenãƒ»ç´„ 2-10 åˆ†é˜ï¼‰...';
            const fps = 8;
            const frames = currentI2VDur * fps;
            const vidDataUrl = await generateLocalVideo(prompt, { width: 512, height: 512, frames, fps, init_image: i2vImageDataUrl });
            const ms = Date.now() - t0;
            document.getElementById('i2vEmpty').classList.add('hidden');
            document.getElementById('i2vResult').classList.remove('hidden');
            const container = document.getElementById('i2vContainer');
            container.innerHTML = '';
            const isGif = vidDataUrl.startsWith('data:image/gif');
            if (isGif) {
                const img = new Image(); img.src = vidDataUrl; img.style.width = '100%'; img.style.maxHeight = '70vh'; img.style.display = 'block';
                container.appendChild(img); currentI2VElement = img;
            } else {
                const vid = document.createElement('video'); vid.src = vidDataUrl; vid.style.width = '100%'; vid.style.maxHeight = '70vh'; vid.style.display = 'block'; vid.controls = true; vid.autoplay = true; vid.loop = true;
                container.appendChild(vid); currentI2VElement = vid;
            }
            document.getElementById('i2vMeta').textContent = `ComfyUI æœ¬åœ° Â· ${frames} frames Â· 0 token Â· ${(ms/1000).toFixed(1)}s`;
            stxt.textContent = `âœ… æœ¬åœ°å®Œæˆï¼ˆ${(ms/1000).toFixed(1)}sãƒ»0 tokenï¼‰`;
            addToGallery({ type: 'video', prompt: '[I2V æœ¬åœ°] ' + prompt, model: 'ComfyUI Local', src: vidDataUrl, time: new Date().toISOString(), duration_ms: ms });
            incrementCount();
        } else {
            // é›²ç«¯æ¨¡å‹
            const modelShort = currentI2VModel.includes('/') ? currentI2VModel.split('/').pop() : currentI2VModel;
            stxt.textContent = `ä½¿ç”¨ ${modelShort} åœ–ç‰‡ç”Ÿå½±ç‰‡ä¸­ï¼ˆ${currentI2VRes}ãƒ»${currentI2VDur}sãƒ»ç´„ 1-3 åˆ†é˜ï¼‰...`;
            const i2vOpts = { model: currentI2VModel, seconds: currentI2VDur, image: i2vImageDataUrl };
            if (currentI2VRes === '1080p') { i2vOpts.size = '1920x1080'; }
            const vidEl = await puter.ai.txt2vid(prompt, i2vOpts);
            const ms = Date.now() - t0;
            document.getElementById('i2vEmpty').classList.add('hidden');
            document.getElementById('i2vResult').classList.remove('hidden');
            const container = document.getElementById('i2vContainer');
            container.innerHTML = '';
            vidEl.style.width = '100%'; vidEl.style.maxHeight = '70vh'; vidEl.style.display = 'block'; vidEl.controls = true;
            container.appendChild(vidEl); currentI2VElement = vidEl;
            document.getElementById('i2vMeta').textContent = `${modelShort} Â· ${currentI2VRes} Â· ${currentI2VDur}s Â· ${(ms/1000).toFixed(1)}s`;
            stxt.textContent = `âœ… å®Œæˆï¼ˆ${(ms/1000).toFixed(1)}sï¼‰`;
            addToGallery({ type: 'video', prompt: '[I2V] ' + prompt, model: modelShort, src: vidEl.src, time: new Date().toISOString(), duration_ms: ms });
            incrementCount();
        }
    } catch (e) {
        stxt.textContent = 'âŒ ' + (e.message || 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¢ºèªåœ–ç‰‡æ ¼å¼');
    }
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-photo-film"></i>ç”Ÿæˆå½±ç‰‡';
    setTimeout(() => status.classList.add('hidden'), 5000);
}

// â”€â”€ æ–‡å­—ç”Ÿå½±ç‰‡ â”€â”€
async function generateVideo() {
    let prompt = document.getElementById('vidPrompt').value.trim();
    if (!prompt) return;
    const isLocalVid = currentVidModel === '__comfyui_vid__' || localMode;
    if (!isLocalVid) { if (!canGenerate('video')) return; }
    const btn = document.getElementById('vidGenBtn');
    const status = document.getElementById('vidStatus');
    const stxt = document.getElementById('vidStatusText');
    btn.disabled = true;
    btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>ç”Ÿæˆä¸­...';
    status.classList.remove('hidden');
    const t0 = Date.now();
    try {
        if (isLocalVid) {
            // æœ¬åœ° ComfyUI å½±ç‰‡ç”Ÿæˆï¼ˆ0 tokenï¼‰
            if (/[\u4e00-\u9fff]/.test(prompt)) {
                stxt.textContent = '[æœ¬åœ° Ollama] ç¿»è­¯ prompt...';
                prompt = await translatePromptLocal(prompt);
            }
            stxt.textContent = '[æœ¬åœ° ComfyUI] AnimateDiff å½±ç‰‡ç”Ÿæˆä¸­ï¼ˆ0 tokenãƒ»ç´„ 2-10 åˆ†é˜ï¼‰...';
            const [vw, vh] = currentVidSize.split('x').map(Number);
            const fps = 8;
            const frames = Math.min(currentVidDuration * fps, 32); // AnimateDiff æœ€å¤š ~32 frames
            const vidDataUrl = await generateLocalVideo(prompt, { width: Math.min(vw, 512), height: Math.min(vh, 512), frames, fps });
            const ms = Date.now() - t0;
            document.getElementById('vidEmpty').classList.add('hidden');
            document.getElementById('vidResult').classList.remove('hidden');
            const container = document.getElementById('vidContainer');
            container.innerHTML = '';
            const isGif = vidDataUrl.startsWith('data:image/gif');
            if (isGif) {
                const img = new Image(); img.src = vidDataUrl; img.style.width = '100%'; img.style.maxHeight = '70vh'; img.style.display = 'block';
                container.appendChild(img); currentVidElement = img;
            } else {
                const vid = document.createElement('video'); vid.src = vidDataUrl; vid.style.width = '100%'; vid.style.maxHeight = '70vh'; vid.style.display = 'block'; vid.controls = true; vid.autoplay = true; vid.loop = true;
                container.appendChild(vid); currentVidElement = vid;
            }
            document.getElementById('vidMeta').textContent = `ComfyUI æœ¬åœ° Â· ${frames} frames Â· 0 token Â· ${(ms/1000).toFixed(1)}s`;
            stxt.textContent = `âœ… æœ¬åœ°å®Œæˆï¼ˆ${(ms/1000).toFixed(1)}sãƒ»0 tokenï¼‰`;
            addToGallery({ type: 'video', prompt, model: 'ComfyUI Local', src: vidDataUrl, time: new Date().toISOString(), duration_ms: ms });
            incrementCount();
        } else {
            // é›²ç«¯æ¨¡å‹
            const vidModelShort = currentVidModel.includes('/') ? currentVidModel.split('/').pop() : currentVidModel;
            stxt.textContent = `ä½¿ç”¨ ${vidModelShort} ç”Ÿæˆä¸­ï¼ˆ${currentVidSize}ãƒ»${currentVidDuration}sãƒ»ç´„ 1-3 åˆ†é˜ï¼‰...`;
            const vidEl = await puter.ai.txt2vid(prompt, { model: currentVidModel, seconds: currentVidDuration, size: currentVidSize });
            const ms = Date.now() - t0;
            document.getElementById('vidEmpty').classList.add('hidden');
            document.getElementById('vidResult').classList.remove('hidden');
            const container = document.getElementById('vidContainer');
            container.innerHTML = '';
            vidEl.style.width = '100%'; vidEl.style.maxHeight = '70vh'; vidEl.style.display = 'block'; vidEl.controls = true;
            container.appendChild(vidEl); currentVidElement = vidEl;
            document.getElementById('vidMeta').textContent = `${vidModelShort} Â· ${currentVidSize} Â· ${currentVidDuration}s Â· ${(ms/1000).toFixed(1)}s`;
            stxt.textContent = `âœ… å®Œæˆï¼ˆ${(ms/1000).toFixed(1)}sï¼‰`;
            addToGallery({ type: 'video', prompt, model: vidModelShort, src: vidEl.src, time: new Date().toISOString(), duration_ms: ms });
            incrementCount();
        }
    } catch (e) {
        stxt.textContent = 'âŒ ' + (e.message || 'ç”Ÿæˆå¤±æ•—');
    }
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-film"></i>ç”Ÿæˆå½±ç‰‡';
    setTimeout(() => status.classList.add('hidden'), 5000);
}

// â”€â”€ ä¸‹è¼‰ â”€â”€
function downloadCurrentImage() {
    if (!currentImgElement) return;
    const a = document.createElement('a'); a.href = currentImgElement.src; a.download = 'ai-image-' + Date.now() + '.png'; a.click();
}
function downloadCurrentVideo() {
    if (!currentVidElement) return;
    const a = document.createElement('a'); a.href = currentVidElement.src; a.download = 'ai-video-' + Date.now() + '.mp4'; a.click();
}
function downloadI2V() {
    if (!currentI2VElement) return;
    const a = document.createElement('a'); a.href = currentI2VElement.src; a.download = 'ai-i2v-' + Date.now() + '.mp4'; a.click();
}

// â”€â”€ ä½œå“åº« â”€â”€
function addToGallery(item) {
    gallery.unshift(item);
    if (gallery.length > 100) gallery = gallery.slice(0, 100);
    localStorage.setItem('ai_studio_gallery', JSON.stringify(gallery));
}
function incrementCount() {
    todayCount++;
    document.getElementById('todayCount').textContent = todayCount;
    localStorage.setItem('ai_studio_today_' + new Date().toDateString(), todayCount);
}
function renderGallery() {
    const grid = document.getElementById('galleryGrid');
    if (gallery.length === 0) {
        grid.innerHTML = '<div class="text-center text-xs text-slate-600 col-span-full py-12">å°šç„¡ä½œå“ï¼Œå»ç”Ÿæˆä¸€äº›å§ï¼</div>';
        return;
    }
    grid.innerHTML = gallery.map((item, i) => {
        if (item.type === 'image') {
            return `<div class="gallery-item rounded-xl overflow-hidden border border-slate-800 bg-slate-900 cursor-pointer" onclick="viewGalleryItem(${i})">
                <img src="${item.src}" class="w-full aspect-square object-cover" loading="lazy" alt="">
                <div class="p-2">
                    <div class="text-[10px] text-slate-400 truncate">${escHtml(item.prompt)}</div>
                    <div class="text-[9px] text-slate-600 mt-0.5">${item.model} Â· ${new Date(item.time).toLocaleString('zh-TW',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
                </div>
            </div>`;
        } else {
            return `<div class="gallery-item rounded-xl overflow-hidden border border-slate-800 bg-slate-900 cursor-pointer" onclick="viewGalleryItem(${i})">
                <div class="w-full aspect-video bg-black flex items-center justify-center text-2xl">ğŸ¬</div>
                <div class="p-2">
                    <div class="text-[10px] text-slate-400 truncate">${escHtml(item.prompt)}</div>
                    <div class="text-[9px] text-slate-600 mt-0.5">${item.model} Â· ${new Date(item.time).toLocaleString('zh-TW',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
                </div>
            </div>`;
        }
    }).join('');
}
function viewGalleryItem(i) {
    const item = gallery[i];
    if (item.type === 'image') {
        switchTab('image');
        document.getElementById('imgPrompt').value = item.prompt;
        document.getElementById('imgEmpty').classList.add('hidden');
        document.getElementById('imgResult').classList.remove('hidden');
        const container = document.getElementById('imgContainer');
        container.innerHTML = `<img src="${item.src}" style="max-width:100%;max-height:70vh;display:block">`;
        currentImgElement = container.querySelector('img');
    }
}
function clearGallery() {
    if (!confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ä½œå“ï¼Ÿ')) return;
    gallery = [];
    localStorage.setItem('ai_studio_gallery', '[]');
    renderGallery();
}
function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â”€â”€ å¿«æ·éµ â”€â”€
document.getElementById('imgPrompt').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateImage(); }
});
document.getElementById('vidPrompt').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateVideo(); }
});
document.getElementById('i2vPrompt').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateI2V(); }
});
</script>
</body>
</html>
