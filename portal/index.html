<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>築未科技 Zhe-Wei Tech - 服務入口</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="AI 驅動的智慧服務平台 - 統一管理入口">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="築未科技">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .service-card {
            transition: all 0.3s cubic-bezier(.4,0,.2,1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .service-card::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102,126,234,0.04), transparent);
            transition: left 0.6s;
        }
        .service-card:hover::before { left: 100%; }
        .service-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background: #10b981; box-shadow: 0 0 8px #10b981; animation: glow 2s infinite; }
        .status-offline { background: #ef4444; box-shadow: 0 0 6px #ef4444; }
        .status-checking { background: #f59e0b; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 6px #10b981; }
            50% { box-shadow: 0 0 14px #10b981; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fadeInUp 0.5s ease-out both; }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .tab-btn { color: #9ca3af; transition: all 0.2s; }
        .tab-btn.active { color: #667eea; font-weight: 600; }
        .attach-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb; }
        .attach-item { position: relative; flex-shrink: 0; }
        .attach-remove { position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .wf-card { transition: all 0.2s; }
        .wf-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .wf-step { border-left: 3px solid #e5e7eb; padding-left: 12px; margin-left: 8px; }
        .wf-step.done { border-left-color: #10b981; }
        .wf-step.running { border-left-color: #3b82f6; }
        .wf-step.error { border-left-color: #ef4444; }
        #homeView { padding-bottom: 70px; }
        .stat-card { background: rgba(255,255,255,0.08); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 16px 20px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 800; line-height: 1.2; }
        .stat-label { font-size: 0.75rem; opacity: 0.8; margin-top: 4px; }
        .quick-link { transition: all 0.2s; }
        .quick-link:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
        /* 功能頁 */
        .feat-section { margin-bottom: 3rem; }
        .feat-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .feat-icon-box { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; }
        .feat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .feat-item { background: white; border-radius: 14px; padding: 20px; border: 1px solid #e5e7eb; transition: all 0.25s; }
        .feat-item:hover { border-color: #667eea; box-shadow: 0 8px 24px rgba(102,126,234,0.12); transform: translateY(-2px); }
        .feat-item-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; margin-bottom: 12px; }
        .feat-tag { display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 6px; font-weight: 500; }
        .feat-back-top { position: fixed; bottom: 80px; right: 20px; z-index: 45; }
        /* 帳戶申請 Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; border-radius: 16px; padding: 32px; max-width: 420px; width: 90%; box-shadow: 0 25px 60px rgba(0,0,0,0.3); transform: translateY(20px); transition: transform 0.3s; }
        .modal-overlay.active .modal-box { transform: translateY(0); }
        .form-input { width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: border-color 0.2s, box-shadow 0.2s; outline: none; }
        .form-input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.15); }
        .btn-primary { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: box-shadow 0.2s, transform 0.1s; }
        .btn-primary:hover { box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .form-msg { text-align: center; padding: 10px; border-radius: 8px; font-size: 14px; margin-top: 12px; display: none; }
        .form-msg.success { display: block; background: #ecfdf5; color: #065f46; }
        .form-msg.error { display: block; background: #fef2f2; color: #991b1b; }
        /* 登入閘門 */
        #authGate { position: fixed; inset: 0; z-index: 9999; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; }
        #authGate .auth-card { background: white; border-radius: 20px; padding: 36px; max-width: 420px; width: 92%; box-shadow: 0 30px 80px rgba(0,0,0,0.3); }
        #authGate .auth-tabs { display: flex; gap: 0; border-radius: 10px; overflow: hidden; border: 2px solid #e5e7eb; margin-bottom: 24px; }
        #authGate .auth-tab { flex: 1; padding: 10px; text-align: center; font-weight: 600; font-size: 14px; cursor: pointer; background: #f9fafb; color: #6b7280; transition: all 0.2s; border: none; }
        #authGate .auth-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        #portalContent { display: none; }
        #portalContent.authed { display: block; }
        .user-bar { background: rgba(255,255,255,0.15); padding: 4px 14px; border-radius: 20px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; transition: background 0.2s; }
        .user-bar:hover { background: rgba(255,255,255,0.25); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 登入閘門已移至 /app -->

    <!-- ===== Portal 主內容（公開） ===== -->
    <div id="portalContent" class="authed">
    <!-- PWA 安裝提示 -->
    <div id="installPrompt" class="install-prompt" style="display: none;">
        <div class="bg-white rounded-lg shadow-2xl p-4 flex items-center gap-4 max-w-md">
            <div class="bg-gradient-to-br from-blue-500 to-purple-600 w-12 h-12 rounded-lg flex items-center justify-center text-white text-2xl">
                <i class="fas fa-download"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-gray-800">安裝築未科技 PWA</h3>
                <p class="text-sm text-gray-600">快速訪問，離線可用</p>
            </div>
            <button onclick="installPWA()" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition">
                安裝
            </button>
            <button onclick="dismissInstall()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 底部導航 -->
    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-50 flex">
        <button onclick="switchTab('home')" class="flex-1 py-3 text-center tab-btn active" data-tab="home">
            <i class="fas fa-home text-lg"></i><div class="text-xs mt-1">首頁</div>
        </button>
        <button onclick="switchTab('chat')" class="flex-1 py-3 text-center tab-btn" data-tab="chat">
            <i class="fas fa-comments text-lg"></i><div class="text-xs mt-1">對話</div>
        </button>
        <button onclick="switchTab('features')" class="flex-1 py-3 text-center tab-btn" data-tab="features">
            <i class="fas fa-th-large text-lg"></i><div class="text-xs mt-1">功能</div>
        </button>
        <button onclick="switchTab('workflow')" class="flex-1 py-3 text-center tab-btn" data-tab="workflow">
            <i class="fas fa-tasks text-lg"></i><div class="text-xs mt-1">工作流</div>
        </button>
    </nav>

    <!-- 對話面板（全屏） -->
    <div id="chatView" class="fixed inset-0 bg-white z-40" style="display:none;">
        <div class="flex flex-col h-full">
            <div class="gradient-bg text-white p-4 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-2">
                    <i class="fas fa-robot"></i><span class="font-bold">AI 助手</span>
                    <span id="wsStatus" class="text-xs bg-white/20 px-2 py-0.5 rounded-full">連接中...</span>
                </div>
                <button onclick="switchTab('home')" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div class="text-center text-gray-400 text-sm py-8">
                    <i class="fas fa-robot text-5xl mb-3 block"></i>
                    <p>我是你的 AI 助手</p>
                    <p class="mt-1">支援文字對話、圖片上傳、檔案傳送</p>
                </div>
            </div>
            <!-- 附件預覽區 -->
            <div id="attachPreview" class="px-4 bg-white border-t flex gap-2 overflow-x-auto py-2" style="display:none;"></div>
            <!-- 輸入區 -->
            <div class="p-3 bg-white border-t flex-shrink-0" style="padding-bottom: calc(0.75rem + 60px);">
                <div class="flex gap-2 items-end">
                    <button onclick="document.getElementById('fileInput')?.click()" class="text-gray-500 hover:text-purple-600 p-2" title="上傳圖片/檔案">
                        <i class="fas fa-paperclip text-xl"></i>
                    </button>
                    <button onclick="document.getElementById('imageInput')?.click()" class="text-gray-500 hover:text-purple-600 p-2" title="拍照/選擇圖片">
                        <i class="fas fa-camera text-xl"></i>
                    </button>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip,.json,.py,.js,.html,.css,.md,.jpg,.jpeg,.png,.gif,.webp" class="hidden" onchange="handleFileSelect(this)">
                    <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden" onchange="handleFileSelect(this)">
                    <input type="text" id="chatInput" placeholder="輸入訊息..." class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 工作流面板（全屏） -->
    <div id="workflowView" class="fixed inset-0 bg-gray-50 z-40" style="display:none;">
        <div class="flex flex-col h-full">
            <div class="gradient-bg text-white p-4 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-2">
                    <i class="fas fa-tasks"></i><span class="font-bold">工作流管理</span>
                </div>
                <button onclick="createWorkflowPrompt()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-sm"><i class="fas fa-plus mr-1"></i>新增</button>
            </div>
            <div id="workflowList" class="flex-1 overflow-y-auto p-4" style="padding-bottom:80px;">
                <div class="text-center text-gray-400 py-12">
                    <i class="fas fa-tasks text-5xl mb-3 block"></i>
                    <p>載入中...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- 功能頁面（全屏） -->
    <div id="featuresView" class="bg-gray-50 min-h-screen" style="display:none; padding-bottom:70px;">
        <!-- 功能頁 Header -->
        <div class="gradient-bg text-white py-10">
            <div class="max-w-6xl mx-auto px-4 text-center">
                <h1 class="text-3xl font-bold mb-2"><i class="fas fa-th-large mr-3"></i>平台功能總覽</h1>
                <p class="text-gray-200">築未科技所有服務的完整功能介紹</p>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 py-8">

            <!-- ① Jarvis AI Brain -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-blue-500 to-purple-600"><i class="fas fa-brain"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Jarvis AI Brain</h2>
                        <p class="text-gray-500 text-sm">主要 AI 大腦系統 — <a href="https://jarvis.zhe-wei.net" target="_blank" rel="noopener" class="text-blue-600 hover:underline">jarvis.zhe-wei.net</a></p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-blue-100 text-blue-600"><i class="fas fa-comments"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">AI 智慧對話</h4>
                        <p class="text-gray-500 text-sm mb-2">多模型切換（Groq、DeepSeek、Gemini、Ollama 本地），支援上下文記憶、串流回應</p>
                        <span class="feat-tag bg-blue-50 text-blue-600">核心功能</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-purple-100 text-purple-600"><i class="fas fa-database"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">知識庫管理</h4>
                        <p class="text-gray-500 text-sm mb-2">ChromaDB 向量資料庫，支援文件上傳、語意搜尋、RAG 增強生成，14000+ 筆知識</p>
                        <span class="feat-tag bg-purple-50 text-purple-600">RAG</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-green-100 text-green-600"><i class="fas fa-tasks"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">工作流自動化</h4>
                        <p class="text-gray-500 text-sm mb-2">自定義多步驟工作流，進度追蹤、狀態管理、自動化執行</p>
                        <span class="feat-tag bg-green-50 text-green-600">自動化</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-amber-100 text-amber-600"><i class="fas fa-coins"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">Token 省費機制</h4>
                        <p class="text-gray-500 text-sm mb-2">智慧快取 + 對話歷史壓縮，重複問題直接命中快取，節省 API 費用</p>
                        <span class="feat-tag bg-amber-50 text-amber-600">成本優化</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-rose-100 text-rose-600"><i class="fas fa-graduation-cap"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">學習大模型精華</h4>
                        <p class="text-gray-500 text-sm mb-2">自動向外部大模型提問，本地 Ollama 萃取精華寫入知識庫，持續自我進化</p>
                        <span class="feat-tag bg-rose-50 text-rose-600">自學習</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-indigo-100 text-indigo-600"><i class="fas fa-shield-alt"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">系統自檢 & 修復</h4>
                        <p class="text-gray-500 text-sm mb-2">6 項自動檢查（Ollama、Embedding、生成模型、ChromaDB、API Keys、E2E），一鍵修復</p>
                        <span class="feat-tag bg-indigo-50 text-indigo-600">運維</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-cyan-100 text-cyan-600"><i class="fas fa-image"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">AI 圖片生成</h4>
                        <p class="text-gray-500 text-sm mb-2">ComfyUI + Stable Diffusion 本地生圖，RTX 4060 Ti 加速，文字轉圖片</p>
                        <span class="feat-tag bg-cyan-50 text-cyan-600">生成式 AI</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-teal-100 text-teal-600"><i class="fas fa-bell"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">推播通知</h4>
                        <p class="text-gray-500 text-sm mb-2">Ntfy SSE 即時推播，支援 iOS PWA、Android、桌面，自動重連</p>
                        <span class="feat-tag bg-teal-50 text-teal-600">即時通訊</span>
                    </div>
                </div>
            </div>

            <!-- ② Smart Bridge -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-cyan-500 to-purple-600"><i class="fas fa-bridge-water"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Smart Bridge</h2>
                        <p class="text-gray-500 text-sm">智慧對話橋接 — <a href="https://bridge.zhe-wei.net" target="_blank" rel="noopener" class="text-blue-600 hover:underline">bridge.zhe-wei.net</a></p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-cyan-100 text-cyan-600"><i class="fas fa-layer-group"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">兩階段生成</h4>
                        <p class="text-gray-500 text-sm mb-2">先用本地小模型草擬，再用雲端大模型精修，節省 80% API 成本</p>
                        <span class="feat-tag bg-cyan-50 text-cyan-600">成本優化</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-purple-100 text-purple-600"><i class="fas fa-robot"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">本地模型學習</h4>
                        <p class="text-gray-500 text-sm mb-2">Ollama 本地推理，自動學習使用者偏好，離線也能對話</p>
                        <span class="feat-tag bg-purple-50 text-purple-600">本地 AI</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-orange-100 text-orange-600"><i class="fas fa-bolt"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">即時串流對話</h4>
                        <p class="text-gray-500 text-sm mb-2">WebSocket 即時串流回應，打字機效果，低延遲體驗</p>
                        <span class="feat-tag bg-orange-50 text-orange-600">即時</span>
                    </div>
                </div>
            </div>

            <!-- ③ Dify AI Platform -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-indigo-500 to-pink-600"><i class="fas fa-project-diagram"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Dify AI Platform</h2>
                        <p class="text-gray-500 text-sm">AI 工作流平台 — <a href="https://dify.zhe-wei.net" target="_blank" rel="noopener" class="text-blue-600 hover:underline">dify.zhe-wei.net</a></p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-indigo-100 text-indigo-600"><i class="fas fa-sitemap"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">視覺化工作流</h4>
                        <p class="text-gray-500 text-sm mb-2">拖放式 AI 工作流編排，支援條件分支、迴圈、API 呼叫</p>
                        <span class="feat-tag bg-indigo-50 text-indigo-600">低代碼</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-pink-100 text-pink-600"><i class="fas fa-puzzle-piece"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">插件生態</h4>
                        <p class="text-gray-500 text-sm mb-2">豐富的插件市場，快速整合外部工具與 API</p>
                        <span class="feat-tag bg-pink-50 text-pink-600">擴展</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-yellow-100 text-yellow-600"><i class="fas fa-rocket"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">一鍵部署 AI 應用</h4>
                        <p class="text-gray-500 text-sm mb-2">將工作流發布為 API 或聊天機器人，快速上線</p>
                        <span class="feat-tag bg-yellow-50 text-yellow-600">部署</span>
                    </div>
                </div>
            </div>

            <!-- ④ 營建管理系統 -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-orange-500 to-red-600"><i class="fas fa-hard-hat"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">營建管理系統</h2>
                        <p class="text-gray-500 text-sm">工程專案管理 — <a href="https://cms.zhe-wei.net" target="_blank" rel="noopener" class="text-blue-600 hover:underline">cms.zhe-wei.net</a></p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-orange-100 text-orange-600"><i class="fas fa-clipboard-list"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">施工日誌</h4>
                        <p class="text-gray-500 text-sm mb-2">每日施工記錄、天氣、人力、機具、材料追蹤，符合公共工程規範</p>
                        <span class="feat-tag bg-orange-50 text-orange-600">工程管理</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-red-100 text-red-600"><i class="fas fa-microphone"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">語音日報</h4>
                        <p class="text-gray-500 text-sm mb-2">語音辨識自動轉文字，AI 整理成結構化施工日報</p>
                        <span class="feat-tag bg-red-50 text-red-600">語音 AI</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-yellow-100 text-yellow-600"><i class="fas fa-search"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">智慧文件搜尋</h4>
                        <p class="text-gray-500 text-sm mb-2">語意搜尋工程文件、規範、合約，AI 摘要回答</p>
                        <span class="feat-tag bg-yellow-50 text-yellow-600">RAG</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-blue-100 text-blue-600"><i class="fas fa-chart-bar"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">進度追蹤</h4>
                        <p class="text-gray-500 text-sm mb-2">甘特圖、里程碑、完成率統計，專案進度一目了然</p>
                        <span class="feat-tag bg-blue-50 text-blue-600">追蹤</span>
                    </div>
                </div>
            </div>

            <!-- ⑤ AI 視覺辨識 -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-green-500 to-teal-600"><i class="fas fa-eye"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">AI 視覺辨識</h2>
                        <p class="text-gray-500 text-sm">YOLOv8 物件偵測 — <a href="https://vision.zhe-wei.net" target="_blank" rel="noopener" class="text-blue-600 hover:underline">vision.zhe-wei.net</a></p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-green-100 text-green-600"><i class="fas fa-crosshairs"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">物件偵測</h4>
                        <p class="text-gray-500 text-sm mb-2">YOLOv8 Nano/Small/Medium/Large 多模型，支援自訂模型上傳</p>
                        <span class="feat-tag bg-green-50 text-green-600">YOLO</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-teal-100 text-teal-600"><i class="fas fa-font"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">OCR 文字辨識</h4>
                        <p class="text-gray-500 text-sm mb-2">EasyOCR 繁中+英文，車牌、標示牌、文件自動辨識</p>
                        <span class="feat-tag bg-teal-50 text-teal-600">OCR</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-red-100 text-red-600"><i class="fas fa-hard-hat"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">工程安全偵測</h4>
                        <p class="text-gray-500 text-sm mb-2">安全帽、反光背心 HSV 顏色分析，自動標記違規</p>
                        <span class="feat-tag bg-red-50 text-red-600">安全</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-blue-100 text-blue-600"><i class="fas fa-columns"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">施工前後比對</h4>
                        <p class="text-gray-500 text-sm mb-2">雙圖偵測 + diff 分析 + 並排標註圖，工程進度視覺化</p>
                        <span class="feat-tag bg-blue-50 text-blue-600">比對</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-purple-100 text-purple-600"><i class="fas fa-layer-group"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">批次偵測</h4>
                        <p class="text-gray-500 text-sm mb-2">最多 20 張圖片同時偵測，AI 智慧分析報告</p>
                        <span class="feat-tag bg-purple-50 text-purple-600">批次</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-amber-100 text-amber-600"><i class="fas fa-history"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">歷史記錄</h4>
                        <p class="text-gray-500 text-sm mb-2">SQLite 儲存所有偵測結果，分頁查詢、CSV 匯出</p>
                        <span class="feat-tag bg-amber-50 text-amber-600">記錄</span>
                    </div>
                </div>
            </div>

            <!-- ⑥ 代碼模擬器 -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-gray-700 to-gray-900"><i class="fas fa-code"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">代碼模擬器</h2>
                        <p class="text-gray-500 text-sm">在線代碼執行 — <a href="https://codesim.zhe-wei.net" target="_blank" rel="noopener" class="text-blue-600 hover:underline">codesim.zhe-wei.net</a></p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-gray-100 text-gray-700"><i class="fas fa-play"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">多語言執行</h4>
                        <p class="text-gray-500 text-sm mb-2">支援 Python、JavaScript、TypeScript 在線執行，即時查看結果</p>
                        <span class="feat-tag bg-gray-100 text-gray-600">執行</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-blue-100 text-blue-600"><i class="fas fa-magic"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">AI 代碼分析</h4>
                        <p class="text-gray-500 text-sm mb-2">AI 自動分析代碼品質、效能瓶頸、安全漏洞，提供優化建議</p>
                        <span class="feat-tag bg-blue-50 text-blue-600">AI</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-purple-100 text-purple-600"><i class="fas fa-folder-open"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">項目管理</h4>
                        <p class="text-gray-500 text-sm mb-2">代碼片段儲存、版本管理、分享功能</p>
                        <span class="feat-tag bg-purple-50 text-purple-600">管理</span>
                    </div>
                </div>
            </div>

            <!-- ⑦ 檔案傳輸站 -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-pink-500 to-rose-600"><i class="fas fa-exchange-alt"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">檔案傳輸站</h2>
                        <p class="text-gray-500 text-sm">跨裝置檔案傳輸 — <a href="https://jarvis.zhe-wei.net/transfer" target="_blank" rel="noopener" class="text-blue-600 hover:underline">jarvis.zhe-wei.net/transfer</a></p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-pink-100 text-pink-600"><i class="fas fa-qrcode"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">QR Code 配對</h4>
                        <p class="text-gray-500 text-sm mb-2">掃碼即連，手機電腦自動配對，無需安裝 App</p>
                        <span class="feat-tag bg-pink-50 text-pink-600">快速配對</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-rose-100 text-rose-600"><i class="fas fa-cloud-upload-alt"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">拖放上傳</h4>
                        <p class="text-gray-500 text-sm mb-2">拖放檔案即上傳，支援多檔案批次傳輸</p>
                        <span class="feat-tag bg-rose-50 text-rose-600">便捷</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-purple-100 text-purple-600"><i class="fas fa-mobile-alt"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">跨裝置同步</h4>
                        <p class="text-gray-500 text-sm mb-2">手機、平板、電腦之間無縫傳輸，不限檔案類型</p>
                        <span class="feat-tag bg-purple-50 text-purple-600">跨平台</span>
                    </div>
                </div>
            </div>

            <!-- ⑧ 商用授權系統 -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-violet-500 to-fuchsia-600"><i class="fas fa-key"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">商用授權系統</h2>
                        <p class="text-gray-500 text-sm">License 管理 + 用量計量 — <a href="https://jarvis.zhe-wei.net/admin-commercial" target="_blank" rel="noopener" class="text-blue-600 hover:underline">管理後台</a></p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-violet-100 text-violet-600"><i class="fas fa-id-card"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">License 離線驗證</h4>
                        <p class="text-gray-500 text-sm mb-2">HMAC-SHA256 簽章，客戶端離線也能驗證授權，裝置綁定</p>
                        <span class="feat-tag bg-violet-50 text-violet-600">安全</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-fuchsia-100 text-fuchsia-600"><i class="fas fa-chart-pie"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">用量計量</h4>
                        <p class="text-gray-500 text-sm mb-2">SQLite + NDJSON 雙寫，按 Provider/用戶統計，配額控制</p>
                        <span class="feat-tag bg-fuchsia-50 text-fuchsia-600">計量</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-pink-100 text-pink-600"><i class="fas fa-sync-alt"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">知識庫快照同步</h4>
                        <p class="text-gray-500 text-sm mb-2">全量/差量匯出匯入，客戶端離線知識庫自動更新</p>
                        <span class="feat-tag bg-pink-50 text-pink-600">同步</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-indigo-100 text-indigo-600"><i class="fas fa-crown"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">三級訂閱方案</h4>
                        <p class="text-gray-500 text-sm mb-2">Free / Professional / Enterprise，功能分級、配額分級</p>
                        <span class="feat-tag bg-indigo-50 text-indigo-600">訂閱</span>
                    </div>
                </div>
            </div>

            <!-- ⑨ 平台基礎設施 -->
            <div class="feat-section">
                <div class="feat-header">
                    <div class="feat-icon-box bg-gradient-to-br from-slate-600 to-slate-800"><i class="fas fa-server"></i></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">平台基礎設施</h2>
                        <p class="text-gray-500 text-sm">安全、部署、監控</p>
                    </div>
                </div>
                <div class="feat-grid">
                    <div class="feat-item">
                        <div class="feat-item-icon bg-blue-100 text-blue-600"><i class="fas fa-shield-alt"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">Cloudflare Tunnel</h4>
                        <p class="text-gray-500 text-sm mb-2">零信任安全通道，所有服務透過加密隧道對外，無需開放端口</p>
                        <span class="feat-tag bg-blue-50 text-blue-600">安全</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-cyan-100 text-cyan-600"><i class="fab fa-docker"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">Docker 容器化</h4>
                        <p class="text-gray-500 text-sm mb-2">所有服務 Docker 部署，docker-compose 一鍵啟動</p>
                        <span class="feat-tag bg-cyan-50 text-cyan-600">容器</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-green-100 text-green-600"><i class="fas fa-user-lock"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">JWT 認證系統</h4>
                        <p class="text-gray-500 text-sm mb-2">自製輕量 JWT（HS256），角色權限控制（superadmin/admin/subscriber）</p>
                        <span class="feat-tag bg-green-50 text-green-600">認證</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-orange-100 text-orange-600"><i class="fas fa-download"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">PWA 離線應用</h4>
                        <p class="text-gray-500 text-sm mb-2">Service Worker 快取，安裝到桌面，離線可用，自動更新</p>
                        <span class="feat-tag bg-orange-50 text-orange-600">PWA</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-purple-100 text-purple-600"><i class="fas fa-desktop"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">Host API</h4>
                        <p class="text-gray-500 text-sm mb-2">JarvisHostAPI.exe 本地代理，截圖、系統資訊、GPU 監控</p>
                        <span class="feat-tag bg-purple-50 text-purple-600">本地</span>
                    </div>
                    <div class="feat-item">
                        <div class="feat-item-icon bg-rose-100 text-rose-600"><i class="fas fa-plug"></i></div>
                        <h4 class="font-bold text-gray-800 mb-1">10+ AI Provider</h4>
                        <p class="text-gray-500 text-sm mb-2">Groq、DeepSeek、Gemini、Mistral、Ollama 等 10 個 AI 提供者整合</p>
                        <span class="feat-tag bg-rose-50 text-rose-600">多模型</span>
                    </div>
                </div>
            </div>

        </div><!-- /max-w-6xl -->

        <!-- 回到頂部按鈕 -->
        <button onclick="document.getElementById('featuresView').scrollTo({top:0,behavior:'smooth'})" 
                class="feat-back-top bg-white shadow-lg rounded-full w-10 h-10 flex items-center justify-center text-gray-500 hover:text-purple-600 hover:shadow-xl transition" title="回到頂部">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div><!-- /featuresView -->

    <!-- 首頁內容 -->
    <div id="homeView">
    <header class="gradient-bg text-white py-16">
        <div class="max-w-7xl mx-auto px-4">
            <div class="text-center">
                <h1 class="text-5xl font-bold mb-4">
                    <i class="fas fa-cube mr-3"></i>築未科技 Zhe-Wei Tech
                </h1>
                <p class="text-xl text-gray-100 mb-4">AI 驅動的智慧服務平台</p>
                <a href="/app" class="inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 backdrop-blur px-6 py-2.5 rounded-full text-white font-semibold transition mb-2">
                    <i class="fas fa-rocket"></i>進入應用平台
                </a>
                <div class="flex justify-center gap-3 text-sm flex-wrap mb-6">
                    <div class="bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                        <i class="fas fa-server mr-2"></i><span id="headerOnlineCount">...</span> 個服務運行中
                    </div>
                    <div class="bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                        <i class="fas fa-clock mr-2"></i>24/7 在線
                    </div>
                    <div class="bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                        <i class="fas fa-shield-alt mr-2"></i>Cloudflare 加密
                    </div>
                    <div id="versionBadge" class="bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                        <i class="fas fa-code-branch mr-2"></i><span id="currentVersion">載入中...</span>
                    </div>
                    <button onclick="checkForUpdates()" class="bg-white/30 hover:bg-white/40 backdrop-blur px-4 py-2 rounded-full transition">
                        <i class="fas fa-sync-alt mr-2"></i>檢查更新
                    </button>
                </div>
                <!-- 即時統計面板 -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-3xl mx-auto">
                    <div class="stat-card">
                        <div class="stat-number" id="statServices">-</div>
                        <div class="stat-label"><i class="fas fa-server mr-1"></i>服務在線</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statKB">-</div>
                        <div class="stat-label"><i class="fas fa-database mr-1"></i>知識庫筆數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statTokenSaved">-</div>
                        <div class="stat-label"><i class="fas fa-coins mr-1"></i>Token 已節省</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statModels">3</div>
                        <div class="stat-label"><i class="fas fa-robot mr-1"></i>本地模型</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Services Grid -->
    <main class="max-w-7xl mx-auto px-4 py-12">
        <!-- 核心 AI 服務 -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-brain text-purple-600 mr-3"></i>核心 AI 服務
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Jarvis AI Brain -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-blue-500 to-purple-600 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-brain"></i>
                        </div>
                        <span class="status-dot status-checking" id="status-jarvis"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Jarvis AI Brain</h3>
                    <p class="text-gray-600 text-sm mb-4">主要 AI 大腦系統，提供智慧對話、知識管理、工作流自動化</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">AI 對話</span>
                        <span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">知識庫</span>
                        <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded">工作流</span>
                    </div>
                    <a href="https://jarvis.zhe-wei.net" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>開啟服務
                    </a>
                </div>

                <!-- Smart Bridge -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-cyan-500 to-purple-600 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-bridge-water"></i>
                        </div>
                        <span class="status-dot status-checking" id="status-bridge"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Smart Bridge</h3>
                    <p class="text-gray-600 text-sm mb-4">智慧對話橋接，兩階段生成節省 80% 成本，本地模型學習控制</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-cyan-100 text-cyan-700 text-xs px-2 py-1 rounded">成本優化</span>
                        <span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">即時對話</span>
                        <span class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded">本地學習</span>
                    </div>
                    <a href="https://bridge.zhe-wei.net" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-cyan-500 to-purple-600 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>開啟服務
                    </a>
                </div>

                <!-- Dify AI Platform -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-indigo-500 to-pink-600 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <span class="status-dot status-checking" id="status-dify"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Dify AI Platform</h3>
                    <p class="text-gray-600 text-sm mb-4">AI 工作流平台，視覺化編排 AI 應用與自動化流程</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded">工作流</span>
                        <span class="bg-pink-100 text-pink-700 text-xs px-2 py-1 rounded">低代碼</span>
                        <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded">插件</span>
                    </div>
                    <a href="https://dify.zhe-wei.net" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-indigo-500 to-pink-600 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>開啟服務
                    </a>
                </div>
            </div>
        </section>

        <!-- 專業應用服務 -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-tools text-orange-600 mr-3"></i>專業應用服務
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Construction Management -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-orange-500 to-red-600 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-hard-hat"></i>
                        </div>
                        <span class="status-dot status-checking" id="status-cms"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">營建管理系統</h3>
                    <p class="text-gray-600 text-sm mb-4">工程專案管理、施工日誌、語音日報、文件搜尋、進度追蹤</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded">工程管理</span>
                        <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded">語音辨識</span>
                        <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded">文件搜尋</span>
                    </div>
                    <a href="https://cms.zhe-wei.net" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-orange-500 to-red-600 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>開啟服務
                    </a>
                </div>

                <!-- AI Vision Recognition -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-green-500 to-teal-600 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-eye"></i>
                        </div>
                        <span class="status-dot status-checking" id="status-vision"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">AI 視覺辨識</h3>
                    <p class="text-gray-600 text-sm mb-4">YOLOv8 物件偵測、OCR 文字辨識、工程安全檢測、施工比對</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded">物件偵測</span>
                        <span class="bg-teal-100 text-teal-700 text-xs px-2 py-1 rounded">OCR</span>
                        <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">安全檢測</span>
                    </div>
                    <a href="https://vision.zhe-wei.net" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-green-500 to-teal-600 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>開啟服務
                    </a>
                </div>

                <!-- Code Simulator -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-gray-700 to-gray-900 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-code"></i>
                        </div>
                        <span class="status-dot status-checking" id="status-codesim"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">代碼模擬器</h3>
                    <p class="text-gray-600 text-sm mb-4">在線執行 Python/JS/TS，AI 代碼分析、優化、修復、生成</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">代碼執行</span>
                        <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">AI 分析</span>
                        <span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">項目管理</span>
                    </div>
                    <a href="https://codesim.zhe-wei.net" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-gray-700 to-gray-900 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>開啟服務
                    </a>
                </div>
            </div>
        </section>

        <!-- 工具與實用服務 -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-wrench text-teal-600 mr-3"></i>工具與實用服務
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 檔案傳輸站 -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-pink-500 to-rose-600 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span class="status-dot status-checking" id="status-transfer"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">檔案傳輸站</h3>
                    <p class="text-gray-600 text-sm mb-4">手機電腦互傳檔案，QR Code 配對，支援拖放上傳</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-pink-100 text-pink-700 text-xs px-2 py-1 rounded">QR 配對</span>
                        <span class="bg-rose-100 text-rose-700 text-xs px-2 py-1 rounded">拖放上傳</span>
                        <span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">跨裝置</span>
                    </div>
                    <a href="https://jarvis.zhe-wei.net/transfer" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-pink-500 to-rose-600 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>開啟服務
                    </a>
                </div>

                <!-- Open WebUI -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-cyan-600 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-comments"></i>
                        </div>
                        <span class="status-dot status-checking" id="status-openwebui"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Open WebUI</h3>
                    <p class="text-gray-600 text-sm mb-4">本地 Ollama 對話介面，支援多模型切換、歷史記錄</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded">本地模型</span>
                        <span class="bg-cyan-100 text-cyan-700 text-xs px-2 py-1 rounded">免費</span>
                        <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">多模型</span>
                    </div>
                    <a href="http://localhost:3000" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-emerald-500 to-cyan-600 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>開啟服務（本地）
                    </a>
                </div>

                <!-- 推播通知 -->
                <div class="service-card bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 w-14 h-14 rounded-lg flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-bell"></i>
                        </div>
                        <span class="status-dot status-online"></span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">推播通知</h3>
                    <p class="text-gray-600 text-sm mb-4">Ntfy 即時推播，支援 iOS PWA、Android、桌面通知</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-amber-100 text-amber-700 text-xs px-2 py-1 rounded">即時推播</span>
                        <span class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded">跨平台</span>
                        <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded">SSE</span>
                    </div>
                    <a href="https://jarvis.zhe-wei.net/push-demo" target="_blank" rel="noopener"
                       class="block w-full bg-gradient-to-r from-amber-500 to-orange-600 text-white text-center py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-external-link-alt mr-2"></i>推播測試台
                    </a>
                </div>
            </div>
        </section>

        <!-- 系統狀態 -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-chart-line text-green-600 mr-3"></i>系統狀態
            </h2>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="text-4xl font-bold gradient-text mb-2" id="uptime">99.9%</div>
                        <div class="text-gray-600 text-sm">正常運行率</div>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl font-bold gradient-text mb-2" id="response-time">~200ms</div>
                        <div class="text-gray-600 text-sm">平均響應時間</div>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl font-bold gradient-text mb-2" id="services-online">-/-</div>
                        <div class="text-gray-600 text-sm">服務在線</div>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl font-bold gradient-text mb-2" id="docker-count">-</div>
                        <div class="text-gray-600 text-sm">Docker 容器</div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t">
                    <h4 class="text-sm font-semibold text-gray-500 mb-3">各服務狀態</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="serviceStatusGrid"></div>
                </div>
            </div>
        </section>

        <!-- 快速連結 -->
        <section>
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-link text-blue-600 mr-3"></i>快速連結
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="/app" 
                   class="quick-link bg-white rounded-lg p-4 shadow hover:shadow-lg text-center">
                    <i class="fas fa-rocket text-2xl text-blue-600 mb-2"></i>
                    <div class="text-sm font-semibold text-gray-800">應用平台</div>
                </a>
                <a href="/app" 
                   class="quick-link bg-white rounded-lg p-4 shadow hover:shadow-lg text-center">
                    <i class="fas fa-palette text-2xl text-purple-600 mb-2"></i>
                    <div class="text-sm font-semibold text-gray-800">AI 創作室</div>
                </a>
                <a href="/app" 
                   class="quick-link bg-white rounded-lg p-4 shadow hover:shadow-lg text-center">
                    <i class="fas fa-hard-hat text-2xl text-orange-600 mb-2"></i>
                    <div class="text-sm font-semibold text-gray-800">營建管理</div>
                </a>
                <a href="/app" 
                   class="quick-link bg-white rounded-lg p-4 shadow hover:shadow-lg text-center">
                    <i class="fas fa-exchange-alt text-2xl text-pink-600 mb-2"></i>
                    <div class="text-sm font-semibold text-gray-800">檔案傳輸</div>
                </a>
                <a href="http://localhost:3000" target="_blank" 
                   class="quick-link bg-white rounded-lg p-4 shadow hover:shadow-lg text-center">
                    <i class="fas fa-comments text-2xl text-emerald-600 mb-2"></i>
                    <div class="text-sm font-semibold text-gray-800">Open WebUI</div>
                </a>
                <a href="https://jarvis.zhe-wei.net/push-demo" target="_blank" 
                   class="quick-link bg-white rounded-lg p-4 shadow hover:shadow-lg text-center">
                    <i class="fas fa-bell text-2xl text-orange-600 mb-2"></i>
                    <div class="text-sm font-semibold text-gray-800">推播測試</div>
                </a>
                <a href="https://dify.zhe-wei.net" target="_blank" 
                   class="quick-link bg-white rounded-lg p-4 shadow hover:shadow-lg text-center">
                    <i class="fas fa-project-diagram text-2xl text-indigo-600 mb-2"></i>
                    <div class="text-sm font-semibold text-gray-800">Dify 工作流</div>
                </a>
                <a href="https://vision.zhe-wei.net" target="_blank" 
                   class="quick-link bg-white rounded-lg p-4 shadow hover:shadow-lg text-center">
                    <i class="fas fa-eye text-2xl text-teal-600 mb-2"></i>
                    <div class="text-sm font-semibold text-gray-800">AI 視覺</div>
                </a>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-400 mb-4">&copy; 2026 築未科技 Zhe-Wei Tech. All rights reserved.</p>
            <div class="flex justify-center gap-6 text-sm">
                <a href="mailto:allen34556@gmail.com" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-envelope mr-2"></i>聯絡我們
                </a>
                <a href="https://github.com/faint45" target="_blank" rel="noopener" class="text-gray-400 hover:text-white transition">
                    <i class="fab fa-github mr-2"></i>GitHub
                </a>
                <span class="text-gray-400">
                    <i class="fas fa-server mr-2"></i>Powered by Cloudflare Tunnel
                </span>
            </div>
        </div>
    </footer>
    </div><!-- /homeView -->
    </div><!-- /portalContent -->

    <script>
        // ── 全域狀態 ──
        let deferredPrompt, ws = null;
        let pendingAttachments = []; // {file, file_id, filename, size, type, url}

        // ── Tab 切換 ──
        function switchTab(tab) {
            document.getElementById('homeView')?.style.display = tab === 'home' ? '' : 'none';
            document.getElementById('chatView')?.style.display = tab === 'chat' ? '' : 'none';
            document.getElementById('featuresView')?.style.display = tab === 'features' ? '' : 'none';
            document.getElementById('workflowView')?.style.display = tab === 'workflow' ? '' : 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
            if (tab === 'chat' && !ws) connectWebSocket();
            if (tab === 'workflow') loadWorkflows();
        }

        // ── PWA ──
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                // ?clear_cache=1 強制清除所有快取
                if (new URLSearchParams(location.search).has('clear_cache')) {
                    const keys = await caches.keys();
                    await Promise.all(keys.map(k => caches.delete(k)));
                    const regs = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(regs.map(r => r.unregister()));
                    console.log('🧹 快取已全部清除');
                    window.location.replace('/');
                    return;
                }
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('SW registered:', reg.scope);
                        // 每次載入都檢查更新
                        reg.update();
                    })
                    .catch(err => console.error('SW failed:', err));
            });
        }
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault(); deferredPrompt = e;
            document.getElementById('installPrompt')?.style.display = 'block';
        });
        function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('installPrompt')?.style.display = 'none'; });
        }
        function dismissInstall() { document.getElementById('installPrompt')?.style.display = 'none'; }

        // ── WebSocket 對話 ──
        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws/chat`);
            const st = document.getElementById('wsStatus');
            ws.onopen = () => { st.textContent = '已連接'; st.className = 'text-xs bg-green-400/30 px-2 py-0.5 rounded-full'; };
            ws.onmessage = e => {
                const d = JSON.parse(e.data);
                if (d.type === 'message' || d.type === 'system') addMessage(d.type === 'system' ? '系統' : 'AI', d.content, d.type === 'system' ? 'system' : 'ai');
                else if (d.type === 'auth_request') showAuthRequest(d);
            };
            ws.onerror = () => { st.textContent = '錯誤'; st.className = 'text-xs bg-red-400/30 px-2 py-0.5 rounded-full'; };
            ws.onclose = () => { st.textContent = '已斷開'; st.className = 'text-xs bg-gray-400/30 px-2 py-0.5 rounded-full'; ws = null; };
        }

        // ── 檔案上傳 ──
        async function handleFileSelect(input) {
            for (const file of input.files) {
                if (file.size > 10 * 1024 * 1024) { alert(`${file.name} 超過 10MB 限制`); continue; }
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const r = await fetch('/api/upload', { method: 'POST', body: formData });
                    const data = await r.json();
                    if (data.ok) {
                        pendingAttachments.push(data);
                        renderAttachPreview();
                    } else { alert(data.error || '上傳失敗'); }
                } catch (e) { alert('上傳失敗: ' + e.message); }
            }
            input.value = '';
        }

        function renderAttachPreview() {
            const box = document.getElementById('attachPreview');
            box.style.display = pendingAttachments.length ? 'flex' : 'none';
            box.innerHTML = '';
            pendingAttachments.forEach((a, i) => {
                const div = document.createElement('div');
                div.className = 'attach-item';
                if (a.type === 'image') {
                    div.innerHTML = `<img src="${a.url}" class="attach-thumb"><div class="attach-remove" onclick="removeAttach(${i})"><i class="fas fa-times"></i></div>`;
                } else {
                    div.innerHTML = `<div class="attach-thumb bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-file text-xl"></i></div><div class="attach-remove" onclick="removeAttach(${i})"><i class="fas fa-times"></i></div><div class="text-xs text-center mt-1 w-16 truncate">${a.filename}</div>`;
                }
                box.appendChild(div);
            });
        }

        function removeAttach(i) { pendingAttachments.splice(i, 1); renderAttachPreview(); }

        // ── 發送訊息 ──
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if ((!msg && !pendingAttachments.length) || !ws || ws.readyState !== WebSocket.OPEN) return;

            // 顯示用戶訊息（含附件預覽）
            let html = msg;
            if (pendingAttachments.length) {
                html += '<div class="flex gap-1 mt-2 flex-wrap">';
                pendingAttachments.forEach(a => {
                    if (a.type === 'image') html += `<img src="${a.url}" class="w-16 h-16 object-cover rounded">`;
                    else html += `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded"><i class="fas fa-file mr-1"></i>${a.filename}</span>`;
                });
                html += '</div>';
            }
            addMessageHTML('你', html, 'user');

            ws.send(JSON.stringify({
                type: 'message',
                content: msg || `[已上傳 ${pendingAttachments.length} 個檔案]`,
                attachments: pendingAttachments.map(a => ({ file_id: a.file_id, filename: a.filename, size: a.size, type: a.type, url: a.url }))
            }));
            input.value = '';
            pendingAttachments = [];
            renderAttachPreview();
        }

        function addMessage(sender, content, type) {
            addMessageHTML(sender, content.replace(/\n/g, '<br>'), type);
        }

        function addMessageHTML(sender, html, type) {
            const box = document.getElementById('chatMessages');
            const d = document.createElement('div');
            d.className = `mb-3 ${type === 'user' ? 'text-right' : ''}`;
            const colors = { user: 'bg-gradient-to-r from-blue-500 to-purple-600 text-white', ai: 'bg-white border border-gray-200 text-gray-800', system: 'bg-gray-200 text-gray-600 text-sm', error: 'bg-red-100 text-red-600 text-sm' };
            d.innerHTML = `<div class="inline-block px-4 py-2 rounded-lg max-w-[85%] text-left ${colors[type] || colors.ai}"><div class="font-semibold text-xs mb-1 opacity-70">${sender}</div><div>${html}</div></div>`;
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        function showAuthRequest(data) {
            const box = document.getElementById('chatMessages');
            const d = document.createElement('div');
            d.className = 'mb-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4';
            d.innerHTML = `<div class="flex items-start gap-3"><i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i><div class="flex-1"><h4 class="font-bold text-gray-800 mb-2">授權請求</h4><p class="text-gray-700 mb-3">${data.message}</p><div class="flex gap-2"><button onclick="respondAuth('${data.request_id}',true)" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600"><i class="fas fa-check mr-1"></i>批准</button><button onclick="respondAuth('${data.request_id}',false)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"><i class="fas fa-times mr-1"></i>拒絕</button></div></div></div>`;
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        function respondAuth(id, approved) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'auth_response', request_id: id, approved }));
                addMessage('系統', approved ? '授權已批准' : '授權已拒絕', 'system');
            }
        }

        // ── 工作流管理 ──
        async function loadWorkflows() {
            const box = document.getElementById('workflowList');
            try {
                const r = await fetch('/api/workflows');
                const data = await r.json();
                const wfs = data.workflows || [];
                if (!wfs.length) {
                    box.innerHTML = '<div class="text-center text-gray-400 py-12"><i class="fas fa-tasks text-5xl mb-3 block"></i><p>尚無工作流</p><p class="text-sm mt-2">點擊右上角「新增」建立工作流</p></div>';
                    return;
                }
                box.innerHTML = '';
                wfs.forEach(wf => {
                    const statusIcon = { completed: 'fa-check-circle text-green-500', running: 'fa-spinner fa-spin text-blue-500', error: 'fa-times-circle text-red-500', pending: 'fa-clock text-gray-400' };
                    const icon = statusIcon[wf.status] || statusIcon.pending;
                    const card = document.createElement('div');
                    card.className = 'wf-card bg-white rounded-xl p-4 mb-3 shadow-sm';
                    let stepsHTML = '';
                    wf.steps.forEach((s, i) => {
                        const sc = s.status === 'done' ? 'done' : s.status === 'running' ? 'running' : s.status === 'error' ? 'error' : '';
                        const si = { done: 'fa-check text-green-500', running: 'fa-spinner fa-spin text-blue-500', error: 'fa-times text-red-500', pending: 'fa-circle text-gray-300' };
                        const sIcon = si[s.status] || si.pending;
                        stepsHTML += `<div class="wf-step ${sc} py-1 flex items-center justify-between"><div><i class="fas ${sIcon} mr-2 text-xs"></i><span class="text-sm">${s.name}</span></div>`;
                        if (s.status === 'pending' || s.status === 'running') {
                            stepsHTML += `<div class="flex gap-1"><button onclick="updateStep('${wf.id}',${i},'done')" class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded hover:bg-green-200">完成</button><button onclick="updateStep('${wf.id}',${i},'running')" class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded hover:bg-blue-200">進行</button></div>`;
                        }
                        stepsHTML += '</div>';
                    });
                    card.innerHTML = `<div class="flex items-center justify-between mb-3"><div class="flex items-center gap-2"><i class="fas ${icon}"></i><span class="font-bold">${wf.name}</span><span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">${wf.category}</span></div><button onclick="deleteWorkflow('${wf.id}')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-sm"></i></button></div><div class="mb-2"><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all" style="width:${wf.progress}%"></div></div><div class="text-xs text-gray-500 mt-1">${wf.progress}% 完成</div></div><div class="mt-2">${stepsHTML}</div>`;
                    box.appendChild(card);
                });
            } catch (e) {
                box.innerHTML = '<div class="text-center text-red-400 py-12"><i class="fas fa-exclamation-circle text-3xl mb-2 block"></i><p>載入失敗</p></div>';
            }
        }

        async function createWorkflowPrompt() {
            const name = prompt('工作流名稱：');
            if (!name) return;
            const stepsStr = prompt('步驟（用逗號分隔）：\n例如：設計,開發,測試,部署');
            if (!stepsStr) return;
            const category = prompt('分類（可選）：', 'general') || 'general';
            const steps = stepsStr.split(',').map(s => s.trim()).filter(Boolean);
            try {
                await fetch('/api/workflows', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, steps, category })
                });
                loadWorkflows();
            } catch (e) { alert('建立失敗: ' + e.message); }
        }

        async function updateStep(wfId, stepIndex, status) {
            try {
                await fetch(`/api/workflows/${wfId}/steps/${stepIndex}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                loadWorkflows();
            } catch (e) { alert('更新失敗'); }
        }

        async function deleteWorkflow(wfId) {
            if (!confirm('確定刪除此工作流？')) return;
            try {
                await fetch(`/api/workflows/${wfId}`, { method: 'DELETE' });
                loadWorkflows();
            } catch (e) { alert('刪除失敗'); }
        }

        // ── 服務狀態檢測 ──
        const services = [
            { id: 'jarvis', name: 'Jarvis AI', url: 'https://jarvis.zhe-wei.net/health', icon: 'fa-brain', color: 'blue' },
            { id: 'bridge', name: 'Smart Bridge', url: 'https://bridge.zhe-wei.net/health', icon: 'fa-bridge-water', color: 'cyan' },
            { id: 'dify', name: 'Dify', url: 'https://dify.zhe-wei.net/health', icon: 'fa-project-diagram', color: 'indigo' },
            { id: 'cms', name: 'CMS', url: 'https://cms.zhe-wei.net/health', icon: 'fa-hard-hat', color: 'orange' },
            { id: 'vision', name: 'Vision', url: 'https://vision.zhe-wei.net/healthz', icon: 'fa-eye', color: 'green' },
            { id: 'codesim', name: 'CodeSim', url: 'https://codesim.zhe-wei.net/health', icon: 'fa-code', color: 'gray' },
            { id: 'transfer', name: '檔案傳輸', url: 'https://jarvis.zhe-wei.net/transfer', icon: 'fa-exchange-alt', color: 'pink' },
            { id: 'openwebui', name: 'Open WebUI', url: 'http://localhost:3000', icon: 'fa-comments', color: 'emerald', local: true }
        ];

        async function checkAllServices() {
            let online = 0;
            const total = services.length;
            const gridEl = document.getElementById('serviceStatusGrid');
            if (gridEl) gridEl.innerHTML = '';

            const checks = services.map(async (svc) => {
                const dot = document.getElementById(`status-${svc.id}`);
                let isOnline = false;
                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 5000);
                    await fetch(svc.url, { method: 'HEAD', mode: 'no-cors', cache: 'no-cache', signal: controller.signal });
                    clearTimeout(timeout);
                    isOnline = true;
                } catch { isOnline = false; }

                if (dot) dot.className = `status-dot ${isOnline ? 'status-online' : 'status-offline'}`;
                if (isOnline) online++;

                // 離線提示
                if (!isOnline && dot) {
                    const card = dot.closest('.service-card');
                    if (card && !card.querySelector('.offline-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'offline-badge text-xs bg-red-100 text-red-600 px-2 py-1 rounded mt-2 text-center';
                        badge.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>服務未啟動';
                        card.querySelector('.flex.flex-wrap')?.after(badge);
                    }
                }

                // 狀態格子
                if (gridEl) {
                    const item = document.createElement('div');
                    item.className = `flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${isOnline ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-600'}`;
                    item.innerHTML = `<i class="fas ${svc.icon}"></i><span>${svc.name}</span><span class="ml-auto"><i class="fas ${isOnline ? 'fa-check-circle' : 'fa-times-circle'}"></i></span>`;
                    gridEl.appendChild(item);
                }

                return isOnline;
            });

            await Promise.allSettled(checks);

            const el = document.getElementById('services-online');
            if (el) el.textContent = `${online}/${total}`;
            const hdr = document.getElementById('headerOnlineCount');
            if (hdr) hdr.textContent = online;
            const stat = document.getElementById('statServices');
            if (stat) stat.textContent = `${online}/${total}`;
        }

        // 載入知識庫統計
        async function loadPortalStats() {
            try {
                const r = await fetch('https://jarvis.zhe-wei.net/api/jarvis/learning-stats', { mode: 'cors' }).catch(() => null);
                if (r && r.ok) {
                    const d = await r.json();
                    const el = document.getElementById('statKB');
                    if (el && d.total !== undefined) el.textContent = d.total.toLocaleString();
                }
            } catch {}
            // Token 省費統計
            try {
                let total = 0, chars = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('jarvis_cache_')) {
                        total++;
                        try { chars += JSON.parse(localStorage.getItem(key)).response.length; } catch {}
                    }
                }
                const el = document.getElementById('statTokenSaved');
                if (el) el.textContent = Math.floor(chars / 4).toLocaleString();
            } catch {}
        }

        // ── 版本檢查與更新 ──
        let currentPortalVersion = null;

        async function loadVersion() {
            try {
                const res = await fetch('/api/version');
                const data = await res.json();
                currentPortalVersion = data.version;
                const el = document.getElementById('currentVersion');
                if (el) el.textContent = `v${data.version}`;
            } catch (err) {
                console.error('Failed to load version:', err);
            }
        }

        async function checkForUpdates() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin');
            btn.disabled = true;

            try {
                const res = await fetch('/api/version');
                const serverData = await res.json();
                
                if (serverData.version !== currentPortalVersion) {
                    if (confirm(`發現新版本 v${serverData.version}！\n目前版本：v${currentPortalVersion}\n\n是否立即更新？`)) {
                        await updateApp();
                    }
                } else {
                    alert(`✅ 已是最新版本 v${currentPortalVersion}`);
                }
            } catch (err) {
                alert('檢查更新失敗：' + err.message);
            } finally {
                icon.classList.remove('fa-spin');
                btn.disabled = false;
            }
        }

        async function updateApp() {
            try {
                if ('serviceWorker' in navigator) {
                    const reg = await navigator.serviceWorker.getRegistration();
                    if (reg) {
                        await reg.unregister();
                        console.log('Service Worker unregistered');
                    }
                    
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    console.log('All caches cleared');
                }
                
                alert('✅ 更新完成！頁面即將重新載入...');
                setTimeout(() => location.reload(true), 500);
            } catch (err) {
                alert('更新失敗：' + err.message);
            }
        }

        // ── 登入已移至 /app ──

        window.addEventListener('load', () => {
            loadVersion();
            checkAllServices();
            loadPortalStats();
            setInterval(checkAllServices, 30000);
            setInterval(loadPortalStats, 60000);
            // 測量實際響應時間
            const t0 = performance.now();
            fetch('/api/version', { cache: 'no-cache' }).then(() => {
                const ms = Math.round(performance.now() - t0);
                const rt = document.getElementById('response-time');
                if (rt) rt.textContent = `~${ms}ms`;
            }).catch(() => {});
            // 卡片入場動畫
            document.querySelectorAll('.service-card').forEach((card, i) => {
                card.style.animationDelay = `${i * 0.08}s`;
                card.classList.add('fade-in-up');
            });
        });
    </script>
</body>
</html>
